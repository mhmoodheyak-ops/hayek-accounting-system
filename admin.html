<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HAYEK SPOT â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <meta name="theme-color" content="#071820" />

  <style>
    :root{
      --bg:#071820; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.12);
      --txt:#eaf4ff; --mut:#a7bdd0; --blue:#1f62ff; --danger:#ff6b6b; --ok:#49e39a;
    }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Tahoma,Arial}
    body{margin:0;min-height:100vh;background:radial-gradient(1200px 600px at 30% 20%, #0f3a3f 0%, var(--bg) 55%);color:var(--txt)}
    .wrap{max-width:1100px;margin:18px auto;padding:16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
    .btnSmall{border:none;border-radius:999px;padding:10px 14px;background:rgba(255,255,255,.08);color:#fff;cursor:pointer}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:22px;box-shadow:0 20px 70px rgba(0,0,0,.45);backdrop-filter:blur(10px);overflow:hidden}
    .head{padding:16px;border-bottom:1px solid var(--line);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:rgba(0,0,0,.12);color:#fff}
    .pill-ok{border-color:var(--ok);color:var(--ok)}
    .mut{color:var(--mut);font-size:13px}
    .body{padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    label{display:block;color:var(--mut);font-size:13px;margin:0 0 6px}
    input,select{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--txt);font-size:15px;outline:none
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:none;border-radius:14px;padding:12px 14px;background:rgba(255,255,255,.10);color:#fff;cursor:pointer}
    .btn.blue{background:var(--blue)}
    .btn.danger{background:rgba(255,107,107,.25);border:1px solid rgba(255,107,107,.35)}
    .btn.ok{background:rgba(73,227,154,.18);border:1px solid rgba(73,227,154,.30)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px dashed rgba(255,255,255,.12);font-size:14px;text-align:right}
    th{background:rgba(255,255,255,.06);color:rgba(255,255,255,.85)}
    .err{color:var(--danger);min-height:18px;font-size:13px;margin-top:8px}
    #lock{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:9999;display:none;align-items:center;justify-content:center;padding:16px}
    #lock .box{width:min(520px,100%);background:#0b1820;border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:18px;text-align:center}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <div id="lock">
    <div class="box">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨</h3>
      <p style="color:#b9cde0;margin:0 0 12px">ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ØªØµÙØ­ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¯ÙˆÙ† ØµÙ„Ø§Ø­ÙŠØ© Ø£Ø¯Ù…Ù†.</p>
      <button class="btnSmall" id="goLogin">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div>
        <div style="font-weight:900;font-size:18px">HAYEK SPOT â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</div>
        <div class="mut">Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† + Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ§ØªÙŠØ±</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span class="pill pill-ok" id="adminPill">Ø£Ø¯Ù…Ù†: Ù…ØªØµÙ„</span>
        <button class="btnSmall" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="card">
      <div class="head">
        <div class="pill">Ø§Ù„ÙØªØ±Ø©:</div>
        <select id="range" style="width:auto;min-width:220px">
          <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
          <option value="7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
          <option value="30">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</option>
          <option value="all">Ø§Ù„ÙƒÙ„</option>
        </select>
        <button class="btnSmall" id="refreshBtn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <span class="mut" id="hint">Ø¬Ø§Ù‡Ø²</span>
      </div>

      <div class="body">
        <div class="grid">
          <div>
            <div style="font-weight:900;margin-bottom:10px">Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯</div>
            <div class="row">
              <div style="flex:1;min-width:200px">
                <label>Ø§Ù„Ø§Ø³Ù…</label>
                <input id="newU" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
              </div>
              <div style="flex:1;min-width:200px">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
                <input id="newP" placeholder="â€¢â€¢â€¢â€¢">
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn ok" id="addUserBtn">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
              <button class="btn blue" id="addAdminBtn">ØªØ±Ù‚ÙŠØ© Ù„Ø£Ø¯Ù…Ù†</button>
            </div>
            <div class="err" id="err"></div>
          </div>

          <div>
            <div style="font-weight:900;margin-bottom:10px">Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
            <div class="row">
              <div class="pill">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: <b id="usersCount">0</b></div>
              <div class="pill">Ø§Ù„ÙÙˆØ§ØªÙŠØ±: <b id="invCount">0</b></div>
            </div>
            <div class="mut" style="margin-top:10px">ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØºÙ„Ù‚Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</div>
          </div>
        </div>

        <div style="margin-top:20px;font-weight:900">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
        <div style="overflow:auto;border:1px solid var(--line);border-radius:16px;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th>ÙÙˆØ§ØªÙŠØ±</th>
                <th>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="usersRows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase Ù…Ø¯Ù…Ø¬Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„
  const SB_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
  const SB_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";
  const sb = supabase.createClient(SB_URL, SB_KEY);

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¨Ø³ÙŠØ·)
  const session = JSON.parse(localStorage.getItem("HAYEK_SESSION") || "null");
  if (!session || session.role !== "admin") {
      $("lock").style.display = "flex";
  }

  $("goLogin").onclick = () => location.href = "index.html";
  $("logoutBtn").onclick = () => { localStorage.removeItem("HAYEK_SESSION"); location.href = "index.html"; };

  function setErr(msg, isOk=false){ 
      $("err").textContent = msg || ""; 
      $("err").style.color = isOk ? "var(--ok)" : "var(--danger)";
  }

  async function loadData() {
    $("hint").textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
    try {
      // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      const { data: users, error: uErr } = await sb.from('app_users').select('*');
      if (uErr) throw uErr;
      $("usersCount").textContent = users.length;

      // 2. Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙÙˆØ§ØªÙŠØ±
      const { data: invs, error: iErr } = await sb.from('app_invoices').select('username, created_at').eq('status', 'closed');
      if (iErr) throw iErr;
      $("invCount").textContent = invs.length;

      // 3. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const tbody = $("usersRows");
      tbody.innerHTML = "";
      users.forEach(u => {
          const isBlocked = u.blocked === true;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><b>${u.username}</b> ${u.is_admin ? '<small>(Admin)</small>':''}</td>
            <td>${invs.filter(i => i.username === u.username).length}</td>
            <td>${u.device_id ? 'Ø¬Ù‡Ø§Ø² Ù…Ø±ØªØ¨Ø·' : 'Ù„Ù… ÙŠØ¯Ø®Ù„ Ø¨Ø¹Ø¯'}</td>
            <td>${isBlocked ? 'ğŸ”´ Ù…Ø­Ø¸ÙˆØ±' : 'ğŸŸ¢ ÙØ¹Ø§Ù„'}</td>
            <td>
                <button class="btnSmall ${isBlocked?'ok':'danger'}" onclick="toggleBlock('${u.username}', ${isBlocked})">
                    ${isBlocked ? 'ÙÙƒ Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±'}
                </button>
                <button class="btnSmall danger" onclick="deleteUser('${u.username}')">Ø­Ø°Ù</button>
            </td>
          `;
          tbody.appendChild(tr);
      });
      $("hint").textContent = "ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ“";
    } catch (e) {
      console.error(e);
      $("hint").textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
    }
  }

  window.toggleBlock = async (uname, currentStatus) => {
      const { error } = await sb.from('app_users').update({ blocked: !currentStatus }).eq('username', uname);
      if (!error) loadData();
  };

  window.deleteUser = async (uname) => {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù " + uname + "ØŸ")) return;
      const { error } = await sb.from('app_users').delete().eq('username', uname);
      if (!error) loadData();
  };

  async function addNewUser(isAdmin) {
      setErr("");
      const u = $("newU").value.trim();
      const p = $("newP").value.trim();
      if (!u || !p) return setErr("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

      const { error } = await sb.from('app_users').insert([{
          username: u,
          pass: p,
          is_admin: isAdmin,
          blocked: false
      }]);

      if (error) setErr("Ø®Ø·Ø£: Ø§Ù„Ø§Ø³Ù… Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…Ø³ØªØ®Ø¯Ù…Ø§Ù‹");
      else {
          setErr("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­", true);
          $("newU").value = ""; $("newP").value = "";
          loadData();
      }
  }

  $("addUserBtn").onclick = () => addNewUser(false);
  $("addAdminBtn").onclick = () => addNewUser(true);
  $("refreshBtn").onclick = () => loadData();

  loadData();
})();
</script>
</body>
</html>
