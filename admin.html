
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” HAYEK SPOT</title>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    :root{ --bg:#071820; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.12); --txt:#eaf4ff; --mut:#a7bdd0; --blue:#1f62ff; --green:#49e39a; --red:#ff6b6b; --amber:#ffcc66; }
    *{box-sizing:border-box; font-family:system-ui, sans-serif}
    body{margin:0; min-height:100vh; background:var(--bg); color:var(--txt); direction:rtl}
    .wrap{max-width:1200px; margin:20px auto; padding:20px}
    .topbar{display:flex; justify-content:space-between; align-items:center; margin-bottom:25px}
    .btn{border:none; border-radius:12px; padding:10px 18px; cursor:pointer; font-weight:bold; transition:0.3s}
    .btn-blue{background:var(--blue); color:#fff}
    .btn-danger{background:rgba(255,107,107,.2); color:var(--red); border:1px solid var(--red)}
    .btn-outline{background:transparent; border:1px solid var(--line); color:var(--txt)}
    
    .stats-row{display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:30px}
    .stat-card{background:var(--panel); border:1px solid var(--line); padding:20px; border-radius:18px; text-align:center}
    .stat-card .val{font-size:32px; font-weight:bold; color:var(--blue); margin-top:5px}
    
    .main-card{background:var(--panel); border:1px solid var(--line); border-radius:20px; overflow:hidden}
    .card-header{padding:20px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center}
    
    table{width:100%; border-collapse:collapse}
    th, td{padding:15px; text-align:right; border-bottom:1px solid var(--line)}
    th{color:var(--mut); font-size:13px}
    .user-name{color:var(--blue); cursor:pointer; font-weight:bold; text-decoration:underline}
    
    .modal-overlay{position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; align-items:center; justify-content:center; z-index:1000; backdrop-filter:blur(5px)}
    .modal-content{background:#0b1d26; width:90%; max-width:800px; padding:30px; border-radius:25px; border:1px solid var(--line); max-height:85vh; overflow-y:auto}
  </style>
</head>
<body>

  <div id="authLock" class="modal-overlay" style="display:flex">
    <div class="modal-content" style="text-align:center">
      <h2>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <button class="btn btn-blue" onclick="location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <h2>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… HAYEK SPOT</h2>
      <div style="display:flex; gap:10px">
        <button class="btn btn-outline" onclick="loadAdminData()">ØªØ­Ø¯ÙŠØ« ğŸ”„</button>
        <button class="btn btn-danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card"><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div><div class="val" id="totalUsers">0</div></div>
      <div class="stat-card"><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div><div class="val" id="totalInvs">0</div></div>
      <div class="stat-card"><div>Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</div><div class="val" id="activeNow">0</div></div>
    </div>

    <div class="main-card">
      <div class="card-header">
        <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆÙ†Ø´Ø§Ø·Ù‡Ù…</h3>
        <input type="text" id="searchBar" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." style="background:rgba(0,0,0,0.2); border:1px solid var(--line); padding:8px; border-radius:10px; color:#fff" oninput="filterUsers()">
      </div>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø±ØªØ¨Ø©</th>
              <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
            </tr>
          </thead>
          <tbody id="userTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="invoiceModal" class="modal-overlay">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; margin-bottom:20px">
        <h3 id="modalUserName">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <div>
          <button class="btn btn-blue" onclick="downloadPDF()">ØªØµØ¯ÙŠØ± PDF ğŸ“„</button>
          <button class="btn btn-outline" onclick="closeInvModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
          </tr>
        </thead>
        <tbody id="invoiceTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const SB_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
    const SB_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let allUsers = [];
    let selectedUserForPdf = "";

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†
    function checkAuth() {
        const sess = JSON.parse(localStorage.getItem("HAYEK_SESSION") || "{}");
        if (sess.role === "admin") {
            document.getElementById("authLock").style.display = "none";
            loadAdminData();
        }
    }

    async function loadAdminData() {
        const { data: users } = await sb.from('app_users').select('*').order('created_at', {ascending:false});
        const { count: invCount } = await sb.from('app_invoices').select('*', { count: 'exact', head: true });
        
        allUsers = users || [];
        document.getElementById("totalUsers").textContent = allUsers.length;
        document.getElementById("totalInvs").textContent = invCount || 0;
        
        renderTable(allUsers);
    }

    function renderTable(data) {
        const tbody = document.getElementById("userTableBody");
        tbody.innerHTML = "";
        data.forEach(u => {
            tbody.innerHTML += `
                <tr>
                    <td><span class="user-name" onclick="showInvoices('${u.username}')">${u.username}</span></td>
                    <td><span style="color:${u.blocked ? 'var(--red)' : 'var(--green)'}">${u.blocked ? 'Ù…Ø­Ø¸ÙˆØ±' : 'Ù†Ø´Ø·'}</span></td>
                    <td>${u.is_admin ? 'Ø£Ø¯Ù…Ù†' : 'Ù…Ø³ØªØ®Ø¯Ù…'}</td>
                    <td style="font-size:11px">${u.device_id || 'ØºÙŠØ± Ù…Ø±ØªØ¨Ø·'}</td>
                    <td>
                        <button class="btn btn-outline" style="padding:5px" onclick="resetDevice('${u.username}')">Ù…Ø³Ø­ Ø¬Ù‡Ø§Ø²</button>
                        <button class="btn btn-danger" style="padding:5px" onclick="toggleBlock('${u.username}', ${u.blocked})">${u.blocked ? 'ÙÙƒ Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±'}</button>
                    </td>
                </tr>`;
        });
    }

    async function showInvoices(username) {
        selectedUserForPdf = username;
        document.getElementById("modalUserName").textContent = `ÙÙˆØ§ØªÙŠØ±: ${username}`;
        document.getElementById("invoiceModal").style.display = "flex";
        
        const { data: invs } = await sb.from('app_invoices').select('*').eq('username', username);
        const tbody = document.getElementById("invoiceTableBody");
        tbody.innerHTML = invs.length ? "" : "<tr><td colspan='3'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";
        invs.forEach(i => {
            tbody.innerHTML += `<tr><td>#${i.id}</td><td>${new Date(i.created_at).toLocaleDateString()}</td><td>${i.total}</td></tr>`;
        });
    }

    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`Activity Report: ${selectedUserForPdf}`, 10, 10);
        doc.autoTable({ html: '#invoiceTableBody' });
        doc.save(`Report_${selectedUserForPdf}.pdf`);
    }

    async function resetDevice(user) {
        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ")) {
            await sb.from('app_users').update({ device_id: null }).eq('username', user);
            loadAdminData();
        }
    }

    async function toggleBlock(user, current) {
        await sb.from('app_users').update({ blocked: !current }).eq('username', user);
        loadAdminData();
    }

    function filterUsers() {
        const val = document.getElementById("searchBar").value.toLowerCase();
        const filtered = allUsers.filter(u => u.username.toLowerCase().includes(val));
        renderTable(filtered);
    }

    function closeInvModal() { document.getElementById("invoiceModal").style.display = "none"; }
    function logout() { localStorage.clear(); location.href="index.html"; }

    window.onload = checkAuth;
  </script>
</body>
</html>
