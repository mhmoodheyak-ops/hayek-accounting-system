<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>لوحة الأدمن - HAYEK</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121823; --txt:#e8eefc; --muted:#9aa7bd;
      --line:#243041; --btn:#1a2432; --btn2:#233044; --danger:#ff4d4d; --ok:#22c55e;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#070a0f 0%, #0b0f14 40%, #0b0f14 100%);
      color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      min-height:100vh; display:flex; justify-content:center; padding:16px;
    }
    .wrap{width:100%; max-width:1050px;}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin:8px 0 16px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .dot{width:12px;height:12px;border-radius:50%; background:var(--ok); box-shadow:0 0 0 6px rgba(34,197,94,.15)}
    .title{font-weight:800; letter-spacing:.3px}
    .sub{color:var(--muted); font-size:13px}
    .grid{display:grid; gap:14px}
    @media(min-width:900px){ .grid{grid-template-columns: 420px 1fr;} }

    .card{
      background:rgba(18,24,35,.92);
      border:1px solid rgba(36,48,65,.7);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(8px);
    }
    h2{margin:0 0 10px; font-size:16px}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
    input, select{
      width:100%; padding:12px 12px;
      border-radius:12px; border:1px solid rgba(36,48,65,.85);
      background:#0e141e; color:var(--txt);
      outline:none;
    }
    input:focus{border-color:#3b82f6; box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    .row{display:flex; gap:10px; align-items:center}
    .row > *{flex:1}
    .btn{
      border:1px solid rgba(36,48,65,.85);
      background:var(--btn);
      color:var(--txt);
      padding:11px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      transition:.15s;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); background:var(--btn2)}
    .btn.primary{background:#1d4ed8; border-color:#1d4ed8}
    .btn.primary:hover{background:#2563eb}
    .btn.danger{background:#3a1414; border-color:#5a1f1f; color:#ffd4d4}
    .btn.danger:hover{background:#4a1818}
    .btn.ghost{background:transparent}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(36,48,65,.85);
      color:var(--muted); font-size:12px;
    }
    .pill b{color:var(--txt)}
    .sep{height:1px; background:rgba(36,48,65,.7); margin:12px 0}
    .list{display:flex; flex-direction:column; gap:10px}
    .item{
      border:1px solid rgba(36,48,65,.75);
      border-radius:14px;
      padding:10px;
      background:rgba(10,14,20,.55);
    }
    .itemHead{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .itemTitle{font-weight:800}
    .meta{color:var(--muted); font-size:12px; margin-top:6px}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start}
    .small{padding:8px 10px; border-radius:10px; font-size:12px}
    .hint{color:var(--muted); font-size:12px; line-height:1.6}
    .error{
      color:#ffd0d0; background:rgba(255,77,77,.08);
      border:1px solid rgba(255,77,77,.25);
      padding:10px; border-radius:12px; margin-top:10px; display:none;
      white-space:pre-wrap;
    }
    .okbox{
      color:#c9ffe0; background:rgba(34,197,94,.08);
      border:1px solid rgba(34,197,94,.25);
      padding:10px; border-radius:12px; margin-top:10px; display:none;
      white-space:pre-wrap;
    }
    .hide{display:none !important;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">HAYEK — لوحة الأدمن</div>
          <div class="sub" id="subTitle">تسجيل دخول الأدمن</div>
        </div>
      </div>
      <div class="pill" id="sessionPill"><b>غير مسجل</b></div>
    </div>

    <div class="grid">
      <div class="card" id="loginCard">
        <h2>تسجيل دخول الأدمن</h2>
        <div class="hint">افتراضي: <b>admin</b> / <b>admin123</b> (غيّره لاحقاً)</div>
        <label>اسم المستخدم</label>
        <input id="loginUser" autocomplete="username" placeholder="admin" />
        <label>كلمة السر</label>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••••" />
        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnLogin">دخول</button>
          <button class="btn ghost" id="btnClear">تفريغ</button>
        </div>
        <div class="error" id="loginErr"></div>
        <div class="okbox" id="loginOk"></div>
      </div>

      <div class="card hide" id="dashCard">
        <div class="row" style="align-items:flex-start">
          <div style="flex:1">
            <h2 style="margin-bottom:6px">المستخدمين</h2>
            <div class="hint">إضافة/حظر/فك/حذف — كل شيء من هنا.</div>
          </div>
          <div style="display:flex; gap:10px; justify-content:flex-end">
            <button class="btn" id="btnRefresh">تحديث</button>
            <button class="btn danger" id="btnLogout">خروج</button>
          </div>
        </div>

        <div class="sep"></div>

        <h2>إضافة مستخدم</h2>
        <div class="row">
          <div>
            <label>اسم المستخدم</label>
            <input id="newUsername" placeholder="مثال: user1" />
          </div>
          <div>
            <label>كلمة السر</label>
            <input id="newPassword" placeholder="مثال: 1234" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>اسم كامل</label>
            <input id="newFullName" placeholder="اسم الزبون/المستخدم" />
          </div>
          <div>
            <label>هاتف</label>
            <input id="newPhone" placeholder="اختياري" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>صلاحية</label>
            <select id="newRole">
              <option value="user">مستخدم</option>
              <option value="admin">أدمن</option>
            </select>
          </div>
          <div style="display:flex; align-items:flex-end">
            <button class="btn primary" id="btnAddUser" style="width:100%">إضافة مستخدم</button>
          </div>
        </div>

        <div class="error" id="dashErr"></div>
        <div class="okbox" id="dashOk"></div>

        <div class="sep"></div>

        <h2>قائمة المستخدمين</h2>
        <div class="list" id="usersList"></div>

        <div class="sep"></div>

        <h2>آخر الفواتير</h2>
        <div class="list" id="invList"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ✅ مفاتيحك الصحيحة
    const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0aWR3cXZ5cmp5ZG1lZ2p6dXZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTAyNzQsImV4cCI6MjA4NTk4NjI3NH0.N1X39yfO6CLYu8UpbZsmlkIUELN_mmAzxUCQBCV7O8g";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id)=>document.getElementById(id);

    const loginCard = el("loginCard");
    const dashCard  = el("dashCard");
    const loginErr  = el("loginErr");
    const loginOk   = el("loginOk");
    const dashErr   = el("dashErr");
    const dashOk    = el("dashOk");
    const usersList = el("usersList");
    const invList   = el("invList");
    const subTitle  = el("subTitle");
    const sessionPill = el("sessionPill");

    let ADMIN = null;

    function showErr(box, msg){
      box.style.display = "block";
      box.textContent = msg;
    }
    function showOk(box, msg){
      box.style.display = "block";
      box.textContent = msg;
      setTimeout(()=> box.style.display="none", 2200);
    }
    function clearBox(box){ box.style.display="none"; box.textContent=""; }

    function setSessionPill(){
      if(!ADMIN){
        sessionPill.innerHTML = "<b>غير مسجل</b>";
        return;
      }
      sessionPill.innerHTML = `<b>${ADMIN.username}</b> — أدمن`;
    }

    async function adminLogin(){
      clearBox(loginErr); clearBox(loginOk);

      const username = el("loginUser").value.trim();
      const password = el("loginPass").value.trim();
      if(!username || !password){
        showErr(loginErr, "اكتب اسم المستخدم وكلمة السر.");
        return;
      }

      const { data, error } = await supabase
        .from("app_users")
        .select("*")
        .eq("username", username)
        .limit(1);

      if(error){
        showErr(loginErr, "خطأ Supabase:\n" + (error.message || JSON.stringify(error)));
        return;
      }
      if(!data || !data.length){
        showErr(loginErr, "المستخدم غير موجود.");
        return;
      }

      const u = data[0];
      if(u.password !== password){
        showErr(loginErr, "كلمة السر غير صحيحة.");
        return;
      }
      if(!u.is_admin){
        showErr(loginErr, "هذا الحساب ليس أدمن.");
        return;
      }
      if(u.is_blocked){
        showErr(loginErr, "هذا الأدمن محظور.");
        return;
      }

      ADMIN = u;
      localStorage.setItem("HAYEK_ADMIN_SESSION", JSON.stringify({ id:u.id, username:u.username }));
      loginCard.classList.add("hide");
      dashCard.classList.remove("hide");
      subTitle.textContent = "لوحة الإدارة";
      setSessionPill();
      showOk(loginOk, "تم تسجيل الدخول ✅");
      await refreshAll();
    }

    function logout(){
      ADMIN = null;
      localStorage.removeItem("HAYEK_ADMIN_SESSION");
      dashCard.classList.add("hide");
      loginCard.classList.remove("hide");
      subTitle.textContent = "تسجيل دخول الأدمن";
      setSessionPill();
    }

    async function restoreSession(){
      try{
        const s = JSON.parse(localStorage.getItem("HAYEK_ADMIN_SESSION") || "null");
        if(!s?.id) return;
        const { data } = await supabase.from("app_users").select("*").eq("id", s.id).limit(1);
        if(data?.length && data[0].is_admin && !data[0].is_blocked){
          ADMIN = data[0];
          loginCard.classList.add("hide");
          dashCard.classList.remove("hide");
          subTitle.textContent = "لوحة الإدارة";
          setSessionPill();
          await refreshAll();
        }
      }catch{}
    }

    function userCard(u){
      const role = u.is_admin ? "أدمن" : "مستخدم";
      const blocked = u.is_blocked ? "محظور" : "فعّال";
      const badge = u.is_blocked ? "style='color:#ffd0d0'" : "style='color:#c9ffe0'";
      const created = new Date(u.created_at).toLocaleString();

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="itemHead">
          <div>
            <div class="itemTitle">${u.username} — <span ${badge}>${blocked}</span></div>
            <div class="meta">
              ${u.full_name ? ("الاسم: " + u.full_name + " — ") : ""}
              ${u.phone ? ("هاتف: " + u.phone + " — ") : ""}
              الصلاحية: ${role} — بتاريخ: ${created}
            </div>
          </div>
          <div class="actions">
            ${u.is_blocked
              ? `<button class="btn small" data-act="unblock" data-id="${u.id}">فك الحظر</button>`
              : `<button class="btn small" data-act="block" data-id="${u.id}">حظر</button>`
            }
            <button class="btn danger small" data-act="del" data-id="${u.id}">حذف</button>
          </div>
        </div>
      `;
      div.addEventListener("click", async (e)=>{
        const b = e.target.closest("button");
        if(!b) return;
        const act = b.dataset.act;
        const id  = b.dataset.id;
        if(act==="del"){
          if(!confirm("تأكيد حذف المستخدم؟")) return;
          await supabase.from("app_users").delete().eq("id", id);
          await refreshUsers();
          return;
        }
        if(act==="block"){
          await supabase.from("app_users").update({ is_blocked:true }).eq("id", id);
          await refreshUsers();
          return;
        }
        if(act==="unblock"){
          await supabase.from("app_users").update({ is_blocked:false }).eq("id", id);
          await refreshUsers();
          return;
        }
      });
      return div;
    }

    function invoiceCard(inv){
      const created = new Date(inv.created_at).toLocaleString();
      const status = inv.status === "closed" ? "مغلقة" : "مفتوحة";
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="itemHead">
          <div>
            <div class="itemTitle">${inv.customer_name} — ${status}</div>
            <div class="meta">المجموع: <b>${inv.total}</b> — بتاريخ: ${created}</div>
          </div>
          <div class="pill"><b>${(inv.lines||[]).length}</b> عمليات</div>
        </div>
      `;
      return div;
    }

    async function refreshUsers(){
      clearBox(dashErr);
      usersList.innerHTML = "";
      const { data, error } = await supabase
        .from("app_users")
        .select("*")
        .order("created_at",{ascending:false});

      if(error){
        showErr(dashErr, "خطأ Supabase (Users):\n" + (error.message || JSON.stringify(error)));
        return;
      }
      (data||[]).forEach(u=> usersList.appendChild(userCard(u)));
      if(!data?.length){
        usersList.innerHTML = `<div class="hint">لا يوجد مستخدمين.</div>`;
      }
    }

    async function refreshInvoices(){
      invList.innerHTML = "";
      const { data, error } = await supabase
        .from("app_invoices")
        .select("*")
        .order("created_at",{ascending:false})
        .limit(30);

      if(error){
        showErr(dashErr, "خطأ Supabase (Invoices):\n" + (error.message || JSON.stringify(error)));
        return;
      }
      (data||[]).forEach(i=> invList.appendChild(invoiceCard(i)));
      if(!data?.length){
        invList.innerHTML = `<div class="hint">لا يوجد فواتير بعد.</div>`;
      }
    }

    async function refreshAll(){
      await refreshUsers();
      await refreshInvoices();
    }

    async function addUser(){
      clearBox(dashErr); clearBox(dashOk);
      const username = el("newUsername").value.trim();
      const password = el("newPassword").value.trim();
      const full_name = el("newFullName").value.trim();
      const phone = el("newPhone").value.trim();
      const role = el("newRole").value;

      if(!username || !password){
        showErr(dashErr, "اكتب اسم المستخدم وكلمة السر للمستخدم الجديد.");
        return;
      }

      const payload = {
        username, password,
        full_name: full_name || null,
        phone: phone || null,
        is_admin: role === "admin",
        is_blocked: false
      };

      const { error } = await supabase.from("app_users").insert(payload);
      if(error){
        showErr(dashErr, "فشل إضافة المستخدم:\n" + (error.message || JSON.stringify(error)));
        return;
      }

      el("newUsername").value = "";
      el("newPassword").value = "";
      el("newFullName").value = "";
      el("newPhone").value = "";
      el("newRole").value = "user";
      showOk(dashOk, "تمت الإضافة ✅");
      await refreshUsers();
    }

    el("btnLogin").addEventListener("click", adminLogin);
    el("btnClear").addEventListener("click", ()=>{
      el("loginUser").value=""; el("loginPass").value="";
      clearBox(loginErr); clearBox(loginOk);
    });
    el("btnLogout").addEventListener("click", logout);
    el("btnRefresh").addEventListener("click", refreshAll);
    el("btnAddUser").addEventListener("click", addUser);

    restoreSession();
    setSessionPill();
  </script>
</body>
</html>
