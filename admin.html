
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HAYEK SPOT â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</title>
  <meta name="theme-color" content="#071820" />

  <style>
    :root{
      --bg:#071820; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.12);
      --txt:#eaf4ff; --mut:#a7bdd0; --blue:#1f62ff; --danger:#ff6b6b; --ok:#49e39a;
    }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Tahoma,Arial}
    body{margin:0;min-height:100vh;background:radial-gradient(1200px 600px at 30% 20%, #0f3a3f 0%, var(--bg) 55%);color:var(--txt)}
    .wrap{max-width:1100px;margin:18px auto;padding:16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
    .btnSmall{border:none;border-radius:999px;padding:10px 14px;background:rgba(255,255,255,.08);color:#fff;cursor:pointer}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:22px;box-shadow:0 20px 70px rgba(0,0,0,.45);backdrop-filter:blur(10px);overflow:hidden}
    .head{padding:16px;border-bottom:1px solid var(--line);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:rgba(0,0,0,.12);color:#fff}
    .mut{color:var(--mut);font-size:13px}
    .body{padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }

    label{display:block;color:var(--mut);font-size:13px;margin:0 0 6px}
    input,select{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--txt);font-size:15px;outline:none
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:none;border-radius:14px;padding:12px 14px;background:rgba(255,255,255,.10);color:#fff;cursor:pointer}
    .btn.blue{background:var(--blue)}
    .btn.danger{background:rgba(255,107,107,.25);border:1px solid rgba(255,107,107,.35)}
    .btn.ok{background:rgba(73,227,154,.18);border:1px solid rgba(73,227,154,.30)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px dashed rgba(255,255,255,.12);font-size:14px;text-align:right}
    th{background:rgba(255,255,255,.06);color:rgba(255,255,255,.85)}
    .err{color:var(--danger);min-height:18px;font-size:13px;margin-top:8px}
    /* lock */
    #lock{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:9999;display:none;align-items:center;justify-content:center;padding:16px}
    #lock .box{width:min(520px,100%);background:#0b1820;border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:18px;text-align:center}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js?v=1"></script>
  <script src="./auth.js?v=1"></script>
</head>
<body>

  <div id="lock">
    <div class="box">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨</h3>
      <p style="color:#b9cde0;margin:0 0 12px">ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ ØªØµÙØ­ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¯ÙˆÙ† ØµÙ„Ø§Ø­ÙŠØ© Ø£Ø¯Ù…Ù†.</p>
      <button class="btnSmall" id="goLogin">Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div>
        <div style="font-weight:900;font-size:18px">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</div>
        <div class="mut">Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† + Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ§ØªÙŠØ±</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span class="pill" id="adminPill">â€”</span>
        <button class="btnSmall" id="logoutBtn">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="card">
      <div class="head">
        <div class="pill">Ø§Ù„ÙØªØ±Ø©:</div>
        <select id="range" style="width:auto;min-width:220px">
          <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
          <option value="7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
          <option value="30">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</option>
          <option value="all">Ø§Ù„ÙƒÙ„</option>
        </select>

        <button class="btnSmall" id="refreshBtn">ØªØ­Ø¯ÙŠØ«</button>
        <span class="mut" id="hint">â€”</span>
      </div>

      <div class="body">
        <div class="grid">

          <div>
            <div style="font-weight:900;margin-bottom:10px">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</div>
            <div class="row">
              <div style="flex:1;min-width:220px">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input id="newU" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø¨Ùˆ Ù‚Ø±ÙˆØ¨">
              </div>
              <div style="flex:1;min-width:220px">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
                <input id="newP" placeholder="1234">
              </div>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn ok" id="addUserBtn">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…</button>
              <button class="btn blue" id="addAdminBtn">Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ù…Ù†</button>
            </div>

            <div class="err" id="err"></div>
          </div>

          <div>
            <div style="font-weight:900;margin-bottom:10px">Ù…Ù„Ø®Øµ</div>
            <div class="row">
              <div class="pill">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: <b id="usersCount">0</b></div>
              <div class="pill">Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ø§Ù„ÙØªØ±Ø©): <b id="invCount">0</b></div>
            </div>
            <div class="mut" style="margin-top:10px">
              Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ app_invoices (status = closed).
            </div>
          </div>

        </div>

        <div style="margin-top:16px;font-weight:900">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
        <div class="mut">Ù…Ø±ØªÙ‘Ø¨Ø© Ù…Ù† Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‹Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ (Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©)</div>

        <div style="overflow:auto;border:1px solid rgba(255,255,255,.12);border-radius:16px;margin-top:10px">
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th>ÙÙˆØ§ØªÙŠØ±</th>
                <th>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·</th>
                <th>Ø­Ø§Ù„Ø©</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="usersRows"></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const lock = $("lock");
  $("goLogin").onclick = () => location.href = "index.html?v=" + Date.now();

  if (!window.HAYEK_AUTH || !window.__HAYEK_AUTH_LOADED__ || !window.HAYEK_AUTH.isAuthed()) {
    lock.style.display = "flex"; return;
  }
  const session = window.HAYEK_AUTH.getUser() || {};
  if (session.role !== "admin") { lock.style.display="flex"; return; }

  $("adminPill").textContent = "Ø£Ø¯Ù…Ù†: " + (session.username||"â€”");
  $("logoutBtn").onclick = () => { window.HAYEK_AUTH.logout(); location.href="index.html?v="+Date.now(); };

  function setErr(msg){ $("err").textContent = msg || ""; }

  function getSB(){
    const cfg = window.APP_CONFIG || {};
    if(!cfg.SUPABASE_URL || !cfg.SUPABASE_ANON_KEY) return null;
    return supabase.createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);
  }

  function isoDayStart(d){
    const x = new Date(d); x.setHours(0,0,0,0); return x.toISOString();
  }
  function daysAgo(n){
    const d = new Date();
    d.setDate(d.getDate() - n);
    return d;
  }

  function getRangeFilter(){
    const v = $("range").value;
    if (v === "all") return null;
    if (v === "today") return isoDayStart(new Date());
    return isoDayStart(daysAgo(Number(v)));
  }

  // username column might be username or t in app_users
  function rowUsername(row){ return row?.username ?? row?.t ?? ""; }

  async function loadUsersAndStats(){
    setErr("");
    $("hint").textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
    const sb = getSB();
    if(!sb){ setErr("Supabase ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·."); return; }

    // 1) users
    const { data: users, error: eU } = await sb.from(window.APP_CONFIG.TABLE_USERS).select("*");
    if(eU){ console.log(eU); setErr("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†."); return; }

    $("usersCount").textContent = String(users.length);

    // 2) invoices in range (only closed)
    const fromIso = getRangeFilter();
    let q = sb.from(window.APP_CONFIG.TABLE_INVOICES).select("username,closed_at,created_at,status,total", { count: "exact" });
    q = q.eq("status", "closed");
    if(fromIso) q = q.gte("closed_at", fromIso);

    const { data: inv, error: eI, count } = await q;
    if(eI){ console.log(eI); setErr("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±."); return; }

    $("invCount").textContent = String(count ?? inv?.length ?? 0);

    // aggregate counts + last activity
    const map = new Map(); // username -> {count,last}
    (inv||[]).forEach(x=>{
      const u = x.username || "";
      if(!u) return;
      const t = x.closed_at || x.created_at || null;
      const prev = map.get(u) || { count:0, last:null };
      prev.count += 1;
      if (t && (!prev.last || new Date(t) > new Date(prev.last))) prev.last = t;
      map.set(u, prev);
    });

    // build rows sorted desc by count
    const rows = users
      .filter(u => (u.is_admin !== true)) // show users first
      .map(u => {
        const name = rowUsername(u);
        const stat = map.get(name) || {count:0,last:null};
        return { row:u, name, count: stat.count, last: stat.last };
      })
      .sort((a,b)=> b.count - a.count);

    // render
    const tbody = $("usersRows");
    tbody.innerHTML = rows.map(r=>{
      const blocked = r.row.blocked === true;
      const status = blocked ? "Ù…Ø­Ø¸ÙˆØ±" : "ÙØ¹Ø§Ù„";
      const last = r.last ? new Date(r.last).toLocaleString() : "â€”";
      return `
        <tr>
          <td><b>${escapeHtml(r.name||"â€”")}</b></td>
          <td>${r.count}</td>
          <td>${escapeHtml(last)}</td>
          <td>${blocked ? "ğŸ”´ Ù…Ø­Ø¸ÙˆØ±" : "ğŸŸ¢ ÙØ¹Ø§Ù„"}</td>
          <td style="white-space:nowrap">
            <button class="btn ${blocked ? "ok" : "danger"}" data-act="${blocked ? "unblock" : "block"}" data-u="${escapeAttr(r.name)}">
              ${blocked ? "ÙÙƒ Ø­Ø¸Ø±" : "Ø­Ø¸Ø±"}
            </button>
            <button class="btn danger" data-act="del" data-u="${escapeAttr(r.name)}">Ø­Ø°Ù</button>
          </td>
        </tr>
      `;
    }).join("");

    // attach handlers
    tbody.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.onclick = async ()=>{
        const act = btn.getAttribute("data-act");
        const u = btn.getAttribute("data-u");
        await doAction(act, u);
      };
    });

    $("hint").textContent = "ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ“";
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(s){ return escapeHtml(s).replaceAll('"',"&quot;"); }

  async function doAction(act, username){
    setErr("");
    const sb = getSB();
    if(!sb){ setErr("Supabase ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·."); return; }

    // app_users username might be in column username OR t, so update with OR
    try{
      if(act === "block" || act === "unblock"){
        const blocked = (act === "block");
        const { error } = await sb.from(window.APP_CONFIG.TABLE_USERS)
          .update({ blocked })
          .or(`username.eq.${username},t.eq.${username}`);
        if(error) throw error;
      }

      if(act === "del"){
        // delete user
        const { error } = await sb.from(window.APP_CONFIG.TABLE_USERS)
          .delete()
          .or(`username.eq.${username},t.eq.${username}`);
        if(error) throw error;
      }

      await loadUsersAndStats();
    }catch(e){
      console.log(e);
      setErr("ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
    }
  }

  async function addUser(isAdmin){
    setErr("");
    const u = ($("newU").value||"").trim();
    const p = ($("newP").value||"").trim();
    if(!u || !p){ setErr("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±."); return; }

    const sb = getSB();
    if(!sb){ setErr("Supabase ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ·."); return; }

    try{
      const payload = {
        username: u,   // we store in "username" (SQL below creates it)
        pass: p,
        is_admin: !!isAdmin,
        blocked: false,
        device_id: null,
      };

      const { error } = await sb.from(window.APP_CONFIG.TABLE_USERS).insert([payload]);
      if(error) throw error;

      $("newU").value = "";
      $("newP").value = "";
      await loadUsersAndStats();
    }catch(e){
      console.log(e);
      setErr("ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯).");
    }
  }

  $("addUserBtn").onclick  = ()=> addUser(false);
  $("addAdminBtn").onclick = ()=> addUser(true);
  $("refreshBtn").onclick  = ()=> loadUsersAndStats();
  $("range").onchange = ()=> loadUsersAndStats();

  loadUsersAndStats();

  // SW
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
})();
</script>
</body>
</html>
