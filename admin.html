<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تسجيل دخول الأدمن</title>
  <style>
    body{margin:0;font-family:system-ui;background:#0b0f14;color:#e8eefc;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:16px}
    .card{width:min(420px,100%);border:1px solid #243044;border-radius:16px;background:#121823;padding:16px}
    h2{margin:0 0 10px 0}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid #243044;background:#0f1622;color:#e8eefc;outline:none;margin-top:10px}
    button{width:100%;padding:12px;border-radius:12px;border:1px solid #243044;background:#1a2433;color:#e8eefc;font-weight:700;margin-top:12px;cursor:pointer}
    .msg{margin-top:10px;color:#9aa7bd;font-size:13px}
    .err{color:#ff4d4d}
  </style>
</head>
<body>
  <div class="card">
    <h2>تسجيل دخول الأدمن</h2>
    <input id="u" placeholder="اسم المستخدم" autocomplete="username" />
    <input id="p" placeholder="كلمة السر" type="password" autocomplete="current-password" />
    <button id="login">دخول</button>
    <div class="msg" id="msg">—</div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "PASTE_SUPABASE_URL_HERE";
    const SUPABASE_ANON_KEY = "PASTE_SUPABASE_ANON_KEY_HERE";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const msg = (t, isErr=false)=> {
      const el=document.getElementById("msg");
      el.textContent=t;
      el.className="msg"+(isErr?" err":"");
    };

    function getOrCreateDeviceId(){
      const key="HAYEK_DEVICE_ID";
      let id=localStorage.getItem(key);
      if(!id){
        id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+"-"+Math.random());
        localStorage.setItem(key,id);
      }
      return id;
    }

    document.getElementById("login").addEventListener("click", async ()=>{
      const username = document.getElementById("u").value.trim();
      const pass = document.getElementById("p").value.trim();
      if(!username || !pass){ msg("أدخل الاسم وكلمة السر", true); return; }

      msg("جارٍ التحقق...");

      try{
        const device_id = getOrCreateDeviceId();

        // 1) تحقق من الحساب
        const { data: user, error } = await supabase
          .from("app_users")
          .select("id,username,pass,is_admin,blocked,device_id")
          .eq("username", username)
          .eq("pass", pass)
          .maybeSingle();

        if(error) throw error;
        if(!user) { msg("بيانات الدخول غير صحيحة", true); return; }
        if(user.blocked) { msg("هذا الحساب محظور", true); return; }
        if(!user.is_admin) { msg("هذا الحساب ليس أدمن", true); return; }

        // 2) ربط بجهاز واحد (device_id)
        const existing = (user.device_id || "").trim();
        if(existing && existing !== device_id){
          msg("هذا الأدمن مربوط بجهاز آخر", true);
          return;
        }

        // إذا ما كان مربوط، اربطه الآن
        if(!existing){
          const { error: e2 } = await supabase
            .from("app_users")
            .update({ device_id })
            .eq("id", user.id);
          if(e2) throw e2;
        }

        // 3) حفظ جلسة أدمن محلية
        localStorage.setItem("HAYEK_ADMIN_SESSION", JSON.stringify({
          id: user.id,
          username: user.username,
          device_id
        }));

        msg("تم تسجيل الدخول ✅");
        location.href = "./admin.html";
      }catch(e){
        console.error(e);
        msg("فشل الدخول: " + (e.message || e), true);
      }
    });
  </script>
</body>
</html>
