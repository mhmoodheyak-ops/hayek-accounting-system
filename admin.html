<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <title>HAYEK SPOT — لوحة الأدمن</title>

  <!-- Supabase UMD (واحد فقط) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#111823;
      --card2:#0f1620;
      --txt:#e9f0ff;
      --muted:#9fb0c9;
      --line:rgba(255,255,255,.10);
      --green:#24d18f;
      --red:#ff5a6b;
      --yellow:#f6c34b;
      --blue:#4ea1ff;
      --shadow:0 18px 40px rgba(0,0,0,.45);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(36,209,143,.18), transparent 55%),
        radial-gradient(900px 700px at 80% 20%, rgba(78,161,255,.16), transparent 55%),
        var(--bg);
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Tahoma, Arial, "Noto Sans Arabic","Noto Naskh Arabic", sans-serif;
      padding:16px;
    }
    .wrap{max-width:1100px;margin:0 auto;display:grid;gap:14px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background:rgba(17,24,35,.70);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px 14px;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;flex-direction:column;gap:4px}
    .brand b{font-size:16px;letter-spacing:.2px}
    .brand span{font-size:12px;color:var(--muted)}
    .barActions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      padding:9px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      font-weight:900;font-size:12px;min-width:110px;
    }
    .pill.open{background:rgba(36,209,143,.14);border-color:rgba(36,209,143,.35);color:#bfffe8}
    .pill.closed{background:rgba(255,90,107,.14);border-color:rgba(255,90,107,.35);color:#ffd2d7}

    .btn{
      user-select:none;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      font-weight:900;
      cursor:pointer;
      transition:.15s transform,.15s opacity;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.98);opacity:.9}
    .btn.green{background:rgba(36,209,143,.18);border-color:rgba(36,209,143,.35)}
    .btn.red{background:rgba(255,90,107,.16);border-color:rgba(255,90,107,.35)}
    .btn.yellow{background:rgba(246,195,75,.14);border-color:rgba(246,195,75,.35);color:#111}
    .btn.blue{background:rgba(78,161,255,.14);border-color:rgba(78,161,255,.35)}
    .btn.gray{background:rgba(255,255,255,.04)}
    .btn.block{width:100%}

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .hd h2{margin:0;font-size:14px}
    .hd .muted{font-size:12px;color:var(--muted)}
    .bd{padding:14px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row + .row{margin-top:10px}
    .field{flex:1 1 180px;display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted);font-weight:900}
    input,select{
      width:100%;
      padding:11px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(17,19,21,.40);
      color:var(--txt);
      outline:none;
      font-size:14px;
    }
    input:focus,select:focus{border-color:rgba(78,161,255,.45);box-shadow:0 0 0 4px rgba(78,161,255,.14)}
    input::placeholder{color:rgba(233,240,255,.45)}

    .note{font-size:12px;color:var(--muted);line-height:1.7}

    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border:1px solid var(--line);border-radius:16px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.10);font-size:13px;text-align:right;vertical-align:middle}
    th{color:#cfe0ff;background:rgba(255,255,255,.05);font-weight:900;font-size:12px}
    tr:last-child td{border-bottom:none}
    tr:hover td{background:rgba(255,255,255,.03)}

    .badge{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);font-weight:900;font-size:12px;
    }
    .badge.ok{border-color:rgba(36,209,143,.35);background:rgba(36,209,143,.12)}
    .badge.no{border-color:rgba(255,90,107,.35);background:rgba(255,90,107,.12)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;direction:ltr;text-align:left}

    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}

    /* Login view */
    .center{display:grid;place-items:center}
    .loginCard{max-width:520px;width:100%}

    /* printable */
    #printArea{
      display:none;
      background:#fff;
      color:#111;
      padding:14px;
      border-radius:14px;
    }
    #printArea table{border:1px solid #ddd}
    #printArea th{background:#f2f2f2;color:#111}
    #printArea td,#printArea th{border-bottom:1px solid #eee}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <b>HAYEK SPOT — لوحة الأدمن</b>
        <span>إدارة المستخدمين + الفواتير + PDF</span>
      </div>

      <div class="barActions">
        <div id="pill" class="pill closed">مغلق</div>
        <button class="btn gray" id="goUserBtn" title="فتح صفحة المستخدم">صفحة المستخدم</button>
        <button class="btn red" id="logoutTopBtn" style="display:none">خروج</button>
      </div>
    </div>

    <!-- LOGIN VIEW -->
    <div id="loginView" class="center">
      <div class="card loginCard">
        <div class="hd">
          <h2>تسجيل دخول الأدمن</h2>
          <div class="muted">ممنوع الدخول لغير الأدمن</div>
        </div>
        <div class="bd">
          <div class="row">
            <div class="field">
              <label>اسم الأدمن</label>
              <input id="adminUser" placeholder="مثال: admin" autocomplete="username" />
            </div>
            <div class="field">
              <label>كلمة السر</label>
              <input id="adminPass" type="password" placeholder="••••" autocomplete="current-password" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn green block" id="adminLoginBtn">دخول</button>
          </div>

          <div class="note" style="margin-top:10px">
            ✅ هذه الصفحة لا تفتح إلا بحساب <b>Admin</b> داخل جدول <span class="mono">app_users</span> (حقل <span class="mono">is_admin = true</span>).<br>
            ⚠️ إذا ما عندك أدمن جاهز: أنشئ صف واحد في Supabase بيدك (username/pass/is_admin=true/blocked=false).
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL VIEW -->
    <div id="panelView" style="display:none">
      <div class="grid">

        <!-- USERS -->
        <div class="card">
          <div class="hd">
            <h2>المستخدمين</h2>
            <div class="muted">إضافة / بحث / حظر / حذف</div>
          </div>
          <div class="bd">
            <div class="row">
              <div class="field">
                <label>اسم المستخدم</label>
                <input id="newUsername" placeholder="مثال: محمود" />
              </div>
              <div class="field">
                <label>كلمة السر</label>
                <input id="newPass" placeholder="مثال: 123456" />
              </div>
              <div class="field" style="max-width:200px">
                <label>الصلاحية</label>
                <select id="newRole">
                  <option value="user">User</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
            </div>

            <div class="row">
              <button class="btn yellow" id="btnGenPass">توليد كلمة سر</button>
              <button class="btn green" id="btnAddUser">إضافة مستخدم</button>
              <button class="btn" id="btnReloadUsers">تحديث</button>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="field" style="flex:1 1 280px">
                <label>بحث (جزء من الاسم)</label>
                <input id="searchUser" placeholder="اكتب جزء من الاسم..." />
              </div>
              <button class="btn" id="btnPrevUsers">السابق</button>
              <button class="btn" id="btnNextUsers">التالي</button>
            </div>

            <div style="margin-top:12px;overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th style="width:26%">الاسم</th>
                    <th style="width:18%">السر</th>
                    <th style="width:12%">Admin</th>
                    <th style="width:12%">الحالة</th>
                    <th>إجراءات</th>
                  </tr>
                </thead>
                <tbody id="usersTbody"></tbody>
              </table>
            </div>

            <div class="note" style="margin-top:10px">
              ✅ زر <b>اختيار</b> يحمّل فواتير هذا المستخدم في الصندوق الثاني.<br>
              ⚠ لا تشارك رابط الأدمن أو بياناته مع أي شخص.
            </div>
          </div>
        </div>

        <!-- INVOICES -->
        <div class="card">
          <div class="hd">
            <h2>الفواتير</h2>
            <div class="muted">اختيار مستخدم → قائمة فواتير → فتح/حذف/PDF</div>
          </div>
          <div class="bd">
            <div class="row">
              <div class="field" style="flex:1 1 320px">
                <label>اختر المستخدم</label>
                <select id="userSelect">
                  <option value="">— اختر المستخدم —</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label>من تاريخ (اختياري)</label>
                <input id="fromDate" type="date" />
              </div>
              <div class="field">
                <label>إلى تاريخ (اختياري)</label>
                <input id="toDate" type="date" />
              </div>
            </div>

            <div class="row">
              <button class="btn" id="btnToday">اليوم</button>
              <button class="btn" id="btnLast7">آخر 7 أيام</button>
              <button class="btn" id="btnClearDates">مسح التواريخ</button>
              <button class="btn blue" id="btnLoadInvoices">تحميل الفواتير</button>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="field" style="flex:1 1 420px">
                <label>اختر فاتورة</label>
                <select id="invoiceSelect">
                  <option value="">— اختر فاتورة —</option>
                </select>
              </div>
            </div>

            <div class="row">
              <button class="btn green" id="btnOpenInvoice">فتح الفاتورة</button>
              <button class="btn red" id="btnDeleteInvoice">حذف الفاتورة</button>
              <button class="btn yellow" id="btnPDF">تصدير PDF</button>
            </div>

            <div class="row" style="margin-top:10px">
              <div class="badge" id="invMeta">—</div>
              <div class="badge" id="totalBadge">المجموع: 0</div>
            </div>

            <div style="margin-top:12px;overflow:auto">
              <table>
                <thead>
                  <tr>
                    <th style="width:25%">الوقت</th>
                    <th style="width:35%">البيان</th>
                    <th style="width:20%">العملية</th>
                    <th style="width:20%">النتيجة</th>
                  </tr>
                </thead>
                <tbody id="opsTbody"></tbody>
              </table>
            </div>

            <!-- printable -->
            <div id="printArea">
              <h3 style="margin:0 0 8px 0">فاتورة — HAYEK SPOT</h3>
              <div id="printMeta" style="font-size:12px;color:#333;margin-bottom:6px"></div>
              <div id="printTotal" style="font-weight:900;margin-bottom:10px"></div>
              <div id="printTable"></div>
            </div>

            <div class="note" style="margin-top:10px">
              ملاحظة: إذا فاتورة قديمة ما بتظهر عملياتها، ممكن تكون عمليات قديمة بدون <b>invoice_id</b>.
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
  const SUPABASE_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const pill = $("pill");

  function setPill(ok, msg){
    pill.textContent = msg || (ok ? "مفتوح" : "مغلق");
    pill.classList.toggle("open", !!ok);
    pill.classList.toggle("closed", !ok);
  }

  function toast(msg){
    const d = document.createElement("div");
    d.textContent = msg;
    Object.assign(d.style, {
      position:"fixed", bottom:"18px", left:"50%",
      transform:"translateX(-50%)",
      background:"rgba(17,19,21,.88)",
      color:"#fff", padding:"10px 14px",
      borderRadius:"14px", fontWeight:"900",
      zIndex:99999, backdropFilter:"blur(8px)",
      border:"1px solid rgba(255,255,255,.18)",
      maxWidth:"92vw", textAlign:"center"
    });
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 1700);
  }

  const K_DEVICE = "hs_device_id_v1";
  function getDeviceId(){
    let id = localStorage.getItem(K_DEVICE);
    if (id) return id;
    const rnd = crypto?.getRandomValues ? crypto.getRandomValues(new Uint32Array(4)) : [Date.now(), Math.random()*1e9, Math.random()*1e9, Math.random()*1e9];
    id = `dev_${Array.from(rnd).map(n=>Number(n).toString(16)).join("")}_${Date.now().toString(16)}`;
    localStorage.setItem(K_DEVICE, id);
    return id;
  }

  function safeNum(x){
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }
  function fmtDateTime(ts){
    try{
      const d = new Date(ts);
      return d.toLocaleString("ar", { hour:"2-digit", minute:"2-digit", second:"2-digit", year:"numeric", month:"2-digit", day:"2-digit" });
    }catch{ return String(ts||""); }
  }
  function ymd(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  // =========================
  // Supabase
  // =========================
  let client = null;
  function initClient(){
    if (!window.supabase?.createClient){
      setPill(false, "مغلق");
      alert("مكتبة Supabase لم تُحمّل. تأكد من الاتصال.");
      return;
    }
    client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession:false } });
    setPill(true, "جاهز");
  }

  // =========================
  // Admin Session
  // =========================
  const K_ADMIN = "hs_admin_session_v1";

  function saveAdminSession(obj){ localStorage.setItem(K_ADMIN, JSON.stringify(obj)); }
  function loadAdminSession(){ try { return JSON.parse(localStorage.getItem(K_ADMIN) || "null"); } catch { return null; } }
  function clearAdminSession(){ try { localStorage.removeItem(K_ADMIN); } catch(_){} }

  function showLogin(){
    $("loginView").style.display = "grid";
    $("panelView").style.display = "none";
    $("logoutTopBtn").style.display = "none";
    setPill(false, "مغلق");
  }
  function showPanel(){
    $("loginView").style.display = "none";
    $("panelView").style.display = "block";
    $("logoutTopBtn").style.display = "inline-flex";
    setPill(true, "مفتوح");
  }

  async function adminLogin(){
    const u = ($("adminUser").value || "").trim();
    const p = ($("adminPass").value || "").trim();
    if(!u || !p){ toast("اكتب اسم الأدمن وكلمة السر"); return; }

    const deviceId = getDeviceId();

    // ✅ لازم يكون is_admin = true
    const { data, error } = await client
      .from("app_users")
      .select("id,username,pass,is_admin,blocked,device_id")
      .eq("username", u)
      .eq("pass", p)
      .eq("is_admin", true)
      .limit(1);

    if(error){ console.error(error); toast("خطأ اتصال بقاعدة البيانات"); return; }

    const admin = Array.isArray(data) ? data[0] : null;
    if(!admin){ toast("بيانات الأدمن غير صحيحة"); return; }
    if(admin.blocked){ toast("لا يمكن الدخول الآن"); return; }

    // ربط الأدمن بالجهاز (اختياري — نفس منطق المستخدم)
    if(!admin.device_id){
      const { error: e2 } = await client.from("app_users")
        .update({ device_id: deviceId, last_seen: new Date().toISOString() })
        .eq("id", admin.id);
      if(e2){ console.warn(e2); }
    }else if(admin.device_id !== deviceId){
      toast("حساب الأدمن مرتبط بجهاز آخر");
      return;
    }else{
      try{
        await client.from("app_users").update({ last_seen: new Date().toISOString() }).eq("id", admin.id);
      }catch(_){}
    }

    saveAdminSession({ id: admin.id, username: admin.username, is_admin:true, device_id: deviceId, ts: Date.now() });
    showPanel();
    await loadUsers(true);
    toast("تم الدخول ✅");
  }

  function logout(){
    clearAdminSession();
    showLogin();
    toast("تم الخروج");
  }

  // =========================
  // Users
  // =========================
  const state = { page: 0, pageSize: 12, lastUsers: [], currentUser: "" };

  function genPassword(){
    const p = Math.floor(100000 + Math.random()*900000);
    $("newPass").value = String(p);
    toast("تم توليد كلمة سر");
  }

  async function loadUsers(reset=false){
    if(reset) state.page = 0;

    const search = ($("searchUser").value || "").trim();
    let q = client
      .from("app_users")
      .select("id,username,pass,is_admin,blocked,created_at", { count:"exact" })
      .order("created_at", { ascending:false })
      .range(state.page * state.pageSize, state.page * state.pageSize + state.pageSize - 1);

    if(search) q = q.ilike("username", `%${search}%`);

    const { data, error } = await q;
    if(error){ console.error(error); toast("فشل تحميل المستخدمين"); return; }

    state.lastUsers = data || [];
    renderUsersTable(state.lastUsers);
    fillUserSelect(state.lastUsers);
  }

  function fillUserSelect(users){
    const sel = $("userSelect");
    const current = sel.value;
    const names = Array.from(new Set((users||[]).map(u => u.username).filter(Boolean)));

    // لا نمسح إذا المستخدم مختار ومو موجود بالصفحة — بس نعيد البناء بشكل آمن
    sel.innerHTML = `<option value="">— اختر المستخدم —</option>`;
    names.forEach(name=>{
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    });

    if(current) sel.value = current;
  }

  function renderUsersTable(users){
    const tb = $("usersTbody");
    tb.innerHTML = "";

    (users || []).forEach(u=>{
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.textContent = u.username || "";

      const tdPass = document.createElement("td");
      tdPass.textContent = u.pass || "";

      const tdAdmin = document.createElement("td");
      tdAdmin.innerHTML = u.is_admin ? `<span class="badge ok">YES</span>` : `<span class="badge">NO</span>`;

      const tdState = document.createElement("td");
      tdState.innerHTML = u.blocked ? `<span class="badge no">مقفل</span>` : `<span class="badge ok">مفعل</span>`;

      const tdAct = document.createElement("td");
      tdAct.className = "actions";

      const btnPick = document.createElement("button");
      btnPick.className = "btn";
      btnPick.textContent = "اختيار";
      btnPick.onclick = async () => {
        $("userSelect").value = u.username || "";
        state.currentUser = u.username || "";
        await loadInvoicesForUser();
        toast("تم اختيار المستخدم");
      };

      const btnBlock = document.createElement("button");
      btnBlock.className = "btn yellow";
      btnBlock.textContent = u.blocked ? "فك" : "حظر";
      btnBlock.onclick = async () => {
        const { error } = await client.from("app_users")
          .update({ blocked: !u.blocked })
          .eq("id", u.id);
        if(error){ console.error(error); toast("فشل التعديل"); return; }
        await loadUsers(false);
      };

      const btnReset = document.createElement("button");
      btnReset.className = "btn blue";
      btnReset.textContent = "تغيير السر";
      btnReset.onclick = async () => {
        const np = prompt("اكتب كلمة سر جديدة:", u.pass || "");
        if(!np) return;
        const { error } = await client.from("app_users")
          .update({ pass: String(np) })
          .eq("id", u.id);
        if(error){ console.error(error); toast("فشل تغيير السر"); return; }
        await loadUsers(false);
        toast("تم تغيير السر ✅");
      };

      const btnDel = document.createElement("button");
      btnDel.className = "btn red";
      btnDel.textContent = "حذف";
      btnDel.onclick = async () => {
        if(!confirm(`تأكيد حذف المستخدم "${u.username}" ؟`)) return;
        const { error } = await client.from("app_users").delete().eq("id", u.id);
        if(error){ console.error(error); toast("فشل الحذف"); return; }
        await loadUsers(true);
        toast("تم الحذف");
      };

      tdAct.append(btnPick, btnBlock, btnReset, btnDel);
      tr.append(tdName, tdPass, tdAdmin, tdState, tdAct);
      tb.appendChild(tr);
    });
  }

  async function addUser(){
    const username = ($("newUsername").value || "").trim();
    const pass = ($("newPass").value || "").trim();
    const role = $("newRole").value;
    if(!username || !pass){ toast("اكتب الاسم وكلمة السر"); return; }

    const payload = {
      username,
      pass,
      is_admin: role === "admin",
      blocked: false,
      device_id: null,
      created_at: new Date().toISOString()
    };

    const { error } = await client.from("app_users").insert(payload);
    if(error){ console.error(error); toast("فشل إضافة المستخدم (ربما الاسم مكرر)"); return; }

    $("newUsername").value = "";
    $("newPass").value = "";
    toast("تم إضافة المستخدم ✅");
    await loadUsers(true);
  }

  // =========================
  // Invoices + Operations
  // =========================
  let currentOps = [];

  function invoiceLabel(inv){
    const dt = fmtDateTime(inv.created_at);
    const total = safeNum(inv.total).toFixed(2);
    const cust = (inv.customer_name || "").trim();
    const shortId = String(inv.id || "").slice(-6);
    return `${dt} — ${cust ? ("العميل: " + cust + " — ") : ""}مجموع: ${total} — #${shortId}`;
  }

  async function loadInvoicesForUser(){
    const username = ($("userSelect").value || "").trim();
    if(!username){ toast("اختر مستخدم أولاً"); return; }
    state.currentUser = username;

    $("invoiceSelect").innerHTML = `<option value="">— اختر فاتورة —</option>`;
    $("opsTbody").innerHTML = "";
    $("invMeta").textContent = "—";
    $("totalBadge").textContent = "المجموع: 0";
    currentOps = [];

    const from = ($("fromDate").value || "").trim();
    const to = ($("toDate").value || "").trim();

    let q = client
      .from("app_invoices")
      .select("*")
      .eq("username", username)
      .order("created_at", { ascending:false });

    if(from) q = q.gte("created_at", from + "T00:00:00");
    if(to)   q = q.lte("created_at", to   + "T23:59:59");

    const { data, error } = await q;
    if(error){ console.error(error); toast("فشل تحميل الفواتير"); return; }

    const sel = $("invoiceSelect");
    sel.innerHTML = `<option value="">— اختر فاتورة —</option>`;
    (data || []).forEach(inv=>{
      const opt = document.createElement("option");
      opt.value = inv.id;
      opt.textContent = invoiceLabel(inv);
      sel.appendChild(opt);
    });

    toast(`تم تحميل ${ (data||[]).length } فاتورة`);
  }

  async function openSelectedInvoice(){
    const username = state.currentUser || ($("userSelect").value || "").trim();
    if(!username){ toast("اختر مستخدم"); return; }

    const invoiceId = ($("invoiceSelect").value || "").trim();
    if(!invoiceId){ toast("اختر فاتورة"); return; }

    // Load operations for this invoice
    const { data, error } = await client
      .from("app_operations")
      .select("created_at,label,operation,result,invoice_id")
      .eq("invoice_id", invoiceId)
      .order("created_at", { ascending:true });

    if(error){ console.error(error); toast("فشل فتح الفاتورة"); return; }

    currentOps = data || [];
    renderOps(currentOps);

    // get invoice meta (for total/customer)
    const { data: invRow, error: invErr } = await client
      .from("app_invoices")
      .select("*")
      .eq("id", invoiceId)
      .maybeSingle();

    if(invErr){ console.warn(invErr); }

    const total = invRow?.total != null ? safeNum(invRow.total) : currentOps.reduce((a,r)=> a + safeNum(r.result), 0);
    const cust = (invRow?.customer_name || "").trim();
    $("invMeta").textContent = cust ? `فاتورة — العميل: ${cust}` : "فاتورة";
    $("totalBadge").textContent = "المجموع: " + total.toFixed(2);

    toast("تم فتح الفاتورة ✅");
  }

  function renderOps(ops){
    const tb = $("opsTbody");
    tb.innerHTML = "";

    (ops || []).forEach(r=>{
      const tr = document.createElement("tr");

      const tdT = document.createElement("td");
      tdT.textContent = fmtDateTime(r.created_at);

      const tdL = document.createElement("td");
      tdL.textContent = r.label || "—";

      const tdO = document.createElement("td");
      tdO.className = "mono";
      tdO.textContent = r.operation || "";

      const tdR = document.createElement("td");
      tdR.className = "mono";
      tdR.textContent = (r.result ?? "");

      tr.append(tdT, tdL, tdO, tdR);
      tb.appendChild(tr);
    });
  }

  async function deleteSelectedInvoice(){
    const invoiceId = ($("invoiceSelect").value || "").trim();
    const username = state.currentUser || ($("userSelect").value || "").trim();
    if(!username){ toast("اختر مستخدم"); return; }
    if(!invoiceId){ toast("اختر فاتورة"); return; }

    if(!confirm("تأكيد حذف الفاتورة المختارة؟")) return;

    // safest: delete ops then invoice
    try{
      await client.from("app_operations").delete().eq("invoice_id", invoiceId);
    }catch(_){}

    const { error } = await client.from("app_invoices").delete().eq("id", invoiceId);
    if(error){ console.error(error); toast("فشل حذف الفاتورة"); return; }

    $("invoiceSelect").value = "";
    $("opsTbody").innerHTML = "";
    $("invMeta").textContent = "—";
    $("totalBadge").textContent = "المجموع: 0";
    toast("تم حذف الفاتورة ✅");
    await loadInvoicesForUser();
  }

  async function exportPdf(){
    const username = (state.currentUser || $("userSelect").value || "").trim();
    const invText = $("invoiceSelect").selectedOptions?.[0]?.textContent || "";
    if(!username){ toast("اختر مستخدم"); return; }
    if(!invText){ toast("اختر فاتورة"); return; }

    // Build printable
    $("printMeta").textContent = `المستخدم: ${username} | ${invText}`;
    const totalText = $("totalBadge").textContent || "";
    $("printTotal").textContent = totalText;

    const rowsHtml = Array.from($("opsTbody").querySelectorAll("tr")).map(tr=>{
      const tds = tr.querySelectorAll("td");
      return `<tr>
        <td>${tds[0]?.textContent||""}</td>
        <td>${tds[1]?.textContent||""}</td>
        <td>${tds[2]?.textContent||""}</td>
        <td>${tds[3]?.textContent||""}</td>
      </tr>`;
    }).join("");

    $("printTable").innerHTML = `
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th>الوقت</th><th>البيان</th><th>العملية</th><th>النتيجة</th>
          </tr>
        </thead>
        <tbody>${rowsHtml}</tbody>
      </table>
    `;

    const area = $("printArea");
    area.style.display = "block";

    try{
      const opt = {
        margin: 10,
        filename: `invoice_${username}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      };
      await html2pdf().set(opt).from(area).save();
      toast("تم إنشاء PDF ✅");
    }catch(e){
      console.error(e);
      alert("فشل تصدير PDF. جرّب متصفح Chrome.");
    }finally{
      area.style.display = "none";
    }
  }

  // =========================
  // UI Events
  // =========================
  $("goUserBtn").onclick = () => location.href = "./index.html";
  $("logoutTopBtn").onclick = logout;

  $("adminLoginBtn").onclick = adminLogin;

  $("btnGenPass").onclick = genPassword;
  $("btnAddUser").onclick = addUser;

  $("btnReloadUsers").onclick = () => loadUsers(true);
  $("btnPrevUsers").onclick = () => { state.page = Math.max(0, state.page-1); loadUsers(false); };
  $("btnNextUsers").onclick = () => { state.page += 1; loadUsers(false); };
  $("searchUser").addEventListener("input", () => loadUsers(true));

  $("userSelect").addEventListener("change", async () => {
    $("invoiceSelect").innerHTML = `<option value="">— اختر فاتورة —</option>`;
    $("opsTbody").innerHTML = "";
    $("invMeta").textContent = "—";
    $("totalBadge").textContent = "المجموع: 0";
    currentOps = [];
    if($("userSelect").value) await loadInvoicesForUser();
  });

  $("btnLoadInvoices").onclick = loadInvoicesForUser;
  $("btnOpenInvoice").onclick = openSelectedInvoice;
  $("btnDeleteInvoice").onclick = deleteSelectedInvoice;
  $("btnPDF").onclick = exportPdf;

  $("btnToday").onclick = () => {
    const d = new Date();
    $("fromDate").value = ymd(d);
    $("toDate").value = ymd(d);
    if($("userSelect").value) loadInvoicesForUser();
  };
  $("btnLast7").onclick = () => {
    const now = new Date();
    const from = new Date(now); from.setDate(from.getDate()-7);
    $("fromDate").value = ymd(from);
    $("toDate").value = ymd(now);
    if($("userSelect").value) loadInvoicesForUser();
  };
  $("btnClearDates").onclick = () => {
    $("fromDate").value = "";
    $("toDate").value = "";
    if($("userSelect").value) loadInvoicesForUser();
  };

  // =========================
  // Boot
  // =========================
  initClient();

  const sess = loadAdminSession();
  if(sess?.is_admin){
    showPanel();
    loadUsers(true);
  }else{
    showLogin();
  }
</script>

</body>
</html>
