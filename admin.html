<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” HAYEK SPOT</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    :root{ --bg:#071820; --panel:rgba(255,255,255,.05); --line:rgba(255,255,255,.1); --txt:#eaf4ff; --blue:#1f62ff; --danger:#ff6b6b; --ok:#49e39a; }
    body{margin:0; background:var(--bg); color:var(--txt); font-family:system-ui; direction:rtl}
    .header{display:flex; justify-content:space-between; padding:20px; border-bottom:1px solid var(--line); backdrop-filter:blur(10px)}
    .container{max-width:1100px; margin:auto; padding:20px}
    .stats-row{display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:15px; margin-bottom:30px}
    .card{background:var(--panel); border:1px solid var(--line); border-radius:15px; padding:20px}
    table{width:100%; border-collapse:collapse; margin-top:15px}
    th{text-align:right; color:#888; font-size:13px; padding:12px}
    td{padding:15px 12px; border-bottom:1px solid rgba(255,255,255,0.05)}
    .btn-sm{padding:6px 12px; border-radius:8px; border:none; cursor:pointer; font-size:12px; margin-left:5px; background:#333; color:#fff}
    .user-link{color:var(--blue); cursor:pointer; text-decoration:underline; font-weight:bold}
    
    /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„ÙÙˆØ§ØªÙŠØ± */
    #invoiceModal{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:1000; padding:20px; backdrop-filter:blur(8px)}
    .modal-content{background:#0d2129; border:1px solid var(--line); max-width:700px; margin:40px auto; border-radius:20px; padding:25px}
    .badge{padding:4px 8px; border-radius:6px; font-size:11px}
    .bg-ok{background:var(--ok); color:#000}
    .bg-err{background:var(--danger); color:#fff}
  </style>
</head>
<body>

  <div class="header">
    <div style="display:flex; gap:15px; align-items:center">
        <span class="badge bg-ok">Ø£Ø¯Ù…Ù†: Ù…ØªØµÙ„</span>
        <h3 style="margin:0" id="adminDisplayName">admin</h3>
    </div>
    <button class="btn-sm bg-err" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
  </div>

  <div class="container">
    <div class="stats-row">
        <div class="card" style="text-align:center">
            <h2 id="totalUsersCount">0</h2>
            <p style="color:#888; margin:0">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
        </div>
        <div class="card" style="text-align:center">
            <h2 id="totalInvoicesCount">0</h2>
            <p style="color:#888; margin:0">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</p>
        </div>
        <div class="card">
            <select id="timeFilter" onchange="refreshData()" style="width:100%; background:#000; color:#fff; border:1px solid var(--line); padding:10px; border-radius:8px">
                <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
                <option value="7days" selected>Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
                <option value="all">Ø§Ù„ÙƒÙ„</option>
            </select>
        </div>
    </div>

    <div class="card">
        <h4 style="margin:0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆÙ†Ø´Ø§Ø·Ù‡Ù…</h4>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø±Ø¶)</th>
                    <th>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                    <th>Ø¢Ø®Ø± Ù†Ø´Ø§Ø·</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
        </table>
    </div>
  </div>

  <div id="invoiceModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
            <h3 id="modalTitle">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
            <div>
                <button class="btn-sm bg-ok" id="exportPdfBtn">ØªØµØ¯ÙŠØ± PDF ğŸ“„</button>
                <button class="btn-sm" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
        <table id="userInvoicesTable">
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
            </thead>
            <tbody id="invoiceListBody"></tbody>
        </table>
    </div>
  </div>

  <script>
    const SB_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
    const SB_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";
    const sb = supabase.createClient(SB_URL, SB_KEY);
    
    let currentViewingUser = ""; // Ù„Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØªÙˆØ­ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù„ØªØµØ¯ÙŠØ±

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
    const session = JSON.parse(localStorage.getItem("HAYEK_SESSION") || "{}");
    if (session.role !== "admin") { location.href = "index.html"; }
    document.getElementById("adminDisplayName").textContent = session.username;

    async function refreshData() {
        // ØªØ­Ø¯ÙŠØ« Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù„Ø®Øµ
        const { count: uCount } = await sb.from('app_users').select('*', { count: 'exact', head: true });
        const { count: iCount } = await sb.from('app_invoices').select('*', { count: 'exact', head: true });
        document.getElementById("totalUsersCount").textContent = uCount;
        document.getElementById("totalInvoicesCount").textContent = iCount;
        
        loadUsers();
    }

    async function loadUsers() {
        const tbody = document.getElementById("userTableBody");
        tbody.innerHTML = "<tr><td colspan='5'>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>";

        const { data: users } = await sb.from('app_users').select('*').order('last_seen', { ascending: false });

        tbody.innerHTML = "";
        for (const u of users) {
            const { count: invs } = await sb.from('app_invoices').select('*', { count: 'exact', head: true }).eq('username', u.username);
            
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="user-link" onclick="viewInvoices('${u.username}')">${u.username}</span></td>
                <td>${invs || 0}</td>
                <td>${u.last_seen ? new Date(u.last_seen).toLocaleTimeString('ar-EG') : '---'}</td>
                <td><span class="badge ${u.blocked ? 'bg-err' : 'bg-ok'}">${u.blocked ? 'Ù…Ø­Ø¸ÙˆØ±' : 'Ù†Ø´Ø·'}</span></td>
                <td>
                    <button class="btn-sm" onclick="resetDevice('${u.username}')">Ù…Ø³Ø­ Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
                    <button class="btn-sm bg-err" onclick="deleteUser('${u.username}')">Ø­Ø°Ù</button>
                </td>
            `;
            tbody.appendChild(tr);
        }
    }

    async function viewInvoices(username) {
        currentViewingUser = username;
        document.getElementById("invoiceModal").style.display = "block";
        document.getElementById("modalTitle").textContent = `ÙÙˆØ§ØªÙŠØ±: ${username}`;
        const list = document.getElementById("invoiceListBody");
        list.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

        const { data: invs } = await sb.from('app_invoices').select('*').eq('username', username).order('created_at', { ascending: false });
        
        list.innerHTML = "";
        invs.forEach(inv => {
            list.innerHTML += `
                <tr>
                    <td>#${inv.id}</td>
                    <td>${new Date(inv.created_at).toLocaleDateString('ar-EG')}</td>
                    <td style="color:var(--ok)">${inv.total}</td>
                    <td><span class="badge bg-ok">${inv.status}</span></td>
                </tr>`;
        });
    }

    // ÙˆØ¸ÙŠÙØ© ØªØµØ¯ÙŠØ± PDF Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙØªÙˆØ­ (Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØµØ¯ÙŠØ± Ù…Ù„Ù PDF)
    document.getElementById("exportPdfBtn").onclick = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`User Report: ${currentViewingUser}`, 14, 15);
        doc.autoTable({ html: '#userInvoicesTable', theme: 'grid', headStyles: { fillColor: [31, 98, 255] } });
        doc.save(`Invoices_${currentViewingUser}.pdf`);
    };

    function closeModal() { document.getElementById("invoiceModal").style.display = "none"; }
    function logout() { localStorage.clear(); location.href = "index.html"; }

    async function resetDevice(u) {
        await sb.from('app_users').update({ device_id: null }).eq('username', u);
        alert("ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù€ " + u);
    }

    refreshData();
  </script>
</body>
</html>
