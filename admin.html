<div id="invoiceModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:1000; padding:20px; backdrop-filter:blur(5px);">
    <div style="background:var(--bg); border:1px solid var(--line); max-width:600px; margin:20px auto; border-radius:20px; padding:25px; max-height:80vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 id="modalTitle" style="margin:0">فواتير المستخدم</h3>
            <button class="btn-sm bg-err" onclick="closeModal()">إغلاق</button>
        </div>
        <table style="width:100%">
            <thead>
                <tr>
                    <th>رقم الفاتورة</th>
                    <th>التاريخ</th>
                    <th>المبلغ</th>
                    <th>الحالة</th>
                </tr>
            </thead>
            <tbody id="invoiceDetailsList">
                </tbody>
        </table>
    </div>
</div>

<script>
    // --- أضف هذه الدوال داخل قسم الـ Script الموجود سابقاً ---

    // دالة لفتح النافذة وجلب فواتير المستخدم المختار
    async function viewUserInvoices(username) {
        const modal = document.getElementById("invoiceModal");
        const list = document.getElementById("invoiceDetailsList");
        const title = document.getElementById("modalTitle");
        
        modal.style.display = "block";
        title.textContent = `فواتير: ${username}`;
        list.innerHTML = "<tr><td colspan='4'>جاري تحميل الفواتير...</td></tr>";

        try {
            // جلب البيانات من جدول app_invoices
            const { data: invoices, error } = await sb
                .from('app_invoices')
                .select('*')
                .eq('username', username)
                .order('created_at', { ascending: false });

            if (error) throw error;

            list.innerHTML = "";
            if (invoices.length === 0) {
                list.innerHTML = "<tr><td colspan='4'>لا توجد فواتير لهذا المستخدم</td></tr>";
                return;
            }

            invoices.forEach(inv => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>#${inv.id}</td>
                    <td>${new Date(inv.created_at).toLocaleDateString('ar-EG')}</td>
                    <td style="color:var(--ok)">${inv.total || 0}</td>
                    <td><span class="badge ${inv.status === 'closed' ? 'bg-ok' : 'bg-err'}">${inv.status}</span></td>
                `;
                list.appendChild(row);
            });
        } catch (err) {
            list.innerHTML = `<tr><td colspan='4' style="color:var(--danger)">خطأ: ${err.message}</td></tr>`;
        }
    }

    function closeModal() {
        document.getElementById("invoiceModal").style.display = "none";
    }

    // --- تعديل بسيط في دالة loadUsers ليصبح الاسم قابلاً للضغط ---
    // ابحث عن السطر الذي يعرض اسم المستخدم (u.username) في دالة loadUsers واستبدله بهذا:
    /*
    <td>
        <b style="cursor:pointer; color:var(--blue); text-decoration:underline" 
           onclick="viewUserInvoices('${u.username}')">${u.username}</b>
        <br><small style="color:var(--mut)">${u.is_admin ? 'أدمن' : 'مستخدم'}</small>
    </td>
    */
</script>
