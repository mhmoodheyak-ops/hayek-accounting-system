<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Hayek - Calculator + Invoice PDF</title>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --card2:#0f1727;
      --txt:#eaf0ff;
      --muted:#9fb0d6;
      --line:#223154;
      --btn:#1b2a4a;
      --btn2:#2a3f72;
      --accent:#22c55e;
      --danger:#ef4444;
      --shadow: 0 14px 35px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:18px;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #16244a 0%, var(--bg) 60%);
      color:var(--txt);
      display:flex; justify-content:center;
    }
    .app{width:100%; max-width:520px; display:grid; gap:14px;}
    .card{
      background: linear-gradient(180deg, var(--card) 0%, var(--card2) 100%);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .header{
      padding:16px 16px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .title{font-size:18px; font-weight:800; margin:0 0 6px}
    .sub{margin:0; color:var(--muted); font-size:13px}
    .content{padding:14px 16px 16px;}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, textarea{
      width:100%;
      background:#0c1426;
      border:1px solid rgba(255,255,255,.09);
      color:var(--txt);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:56px; resize:vertical}
    .row{display:grid; gap:10px}
    .row2{display:grid; grid-template-columns: 1fr 140px; gap:10px}
    @media (max-width:420px){
      .row2{grid-template-columns:1fr}
    }
    .btns{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px}
    button{
      border:0; cursor:pointer;
      padding:12px 12px;
      border-radius:14px;
      font-weight:800;
      color:var(--txt);
      background: var(--btn);
      border:1px solid rgba(255,255,255,.10);
      transition:.12s transform ease, .12s opacity ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{transform: scale(.985); opacity:.92}
    .primary{background: linear-gradient(180deg, var(--btn2) 0%, #20345f 100%)}
    .success{background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%); color:#05210f}
    .danger{background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%)}
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }

    /* جدول العمليات داخل واجهة التطبيق */
    .opsWrap{margin-top:12px; border:1px solid rgba(255,255,255,.08); border-radius:14px; overflow:hidden}
    table{width:100%; border-collapse:collapse}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); font-size:13px; vertical-align:top}
    th{color:var(--muted); font-weight:800; text-align:right; background:rgba(255,255,255,.03)}
    .num{white-space:nowrap; text-align:left; direction:ltr; font-variant-numeric: tabular-nums;}
    .muted{color:var(--muted)}
    .totalBar{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 10px;
      background: rgba(34,197,94,.10);
      border-top:1px solid rgba(34,197,94,.30);
      font-weight:900;
    }
    .toast{
      margin-top:10px;
      font-size:12px; color:var(--muted)
    }

    /* ====== منطقة PDF (لا تعمل display:none) ======
       نخليها "خارج الشاشة" لكن مرئية للـ html2pdf */
    .pdf-stage{
      position: fixed;
      left: -9999px;
      top: 0;
      width: 794px; /* تقريب A4 على 96dpi */
      background: #fff;
      color:#111;
      direction: rtl;
      padding: 18px;
      border-radius: 0;
      box-shadow: none;
    }
    .pdf-title{margin:0 0 6px; font-size:18px; font-weight:900}
    .pdf-meta{margin:0 0 10px; font-size:12px; color:#444}
    .pdf-box{
      border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin-bottom:12px;
    }
    .pdf-table th{
      background:#f3f4f6; color:#111;
      border-bottom:1px solid #e5e7eb;
    }
    .pdf-table td{
      border-bottom:1px solid #e5e7eb;
      color:#111;
    }
    .pdf-total{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px;
      background:#ecfdf5;
      border:1px solid #a7f3d0;
      border-radius:12px;
      font-weight:900;
    }
    .brand{
      margin-top:10px;
      font-size:11px;
      color:#6b7280;
      text-align:center;
    }
  </style>
</head>
<body>
  <div class="app">

    <div class="card">
      <div class="header">
        <p class="title">حاسبة الفواتير + جدول العمليات</p>
        <p class="sub">كل عملية تنضاف كصف في الجدول، والتصدير يسحب نفس الجدول داخل PDF.</p>
      </div>

      <div class="content">
        <div class="row">
          <div class="row2">
            <div>
              <label>اسم الزبون</label>
              <input id="customerName" placeholder="مثال: أحمد محمد" />
            </div>
            <div>
              <label>التاريخ</label>
              <input id="invDate" />
            </div>
          </div>

          <div class="row2">
            <div>
              <label>وصف العملية (اختياري)</label>
              <input id="opDesc" placeholder="مثال: أجرة تركيب / بيع قطعة..." />
            </div>
            <div>
              <label>المبلغ</label>
              <input id="opAmount" inputmode="decimal" placeholder="0" />
            </div>
          </div>

          <div class="btns">
            <button class="primary" id="addBtn">إضافة العملية</button>
            <button class="danger" id="clearBtn">مسح كل العمليات</button>
          </div>

          <div class="opsWrap">
            <table>
              <thead>
                <tr>
                  <th style="width:44px">#</th>
                  <th>العملية</th>
                  <th style="width:140px">المبلغ</th>
                </tr>
              </thead>
              <tbody id="opsBody">
                <tr><td colspan="3" class="muted" style="text-align:center; padding:14px">لا توجد عمليات بعد</td></tr>
              </tbody>
            </table>
            <div class="totalBar">
              <span>الإجمالي</span>
              <span class="num" id="totalTxt">0</span>
            </div>
          </div>

          <div class="btns" style="margin-top:12px">
            <button class="success" id="pdfBtn">تصدير PDF</button>
            <button id="demoBtn">إضافة مثال سريع</button>
          </div>

          <div class="toast">
            تلميح: إذا كتبت مبلغ فقط واضغط <span class="kbd">إضافة</span> رح ينضاف سطر.  
            *التصدير يقرأ من منطقة PDF المخفية (ليست display:none) لضمان ظهور الجدول دائمًا.
          </div>
        </div>
      </div>
    </div>

    <!-- ====== Printable Area for PDF (must be visible to renderer) ====== -->
    <div id="printable-area" class="pdf-stage" aria-hidden="true">
      <h2 class="pdf-title">فاتورة / كشف حساب</h2>
      <p class="pdf-meta" id="pdfMeta">—</p>

      <div class="pdf-box">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:12px">
          <div><strong>اسم الزبون:</strong> <span id="pdfCustomer">—</span></div>
          <div><strong>التاريخ:</strong> <span id="pdfDate">—</span></div>
        </div>
      </div>

      <div class="pdf-box">
        <table class="pdf-table" style="width:100%; border-collapse:collapse">
          <thead>
            <tr>
              <th style="text-align:right; padding:10px; width:44px">#</th>
              <th style="text-align:right; padding:10px">العملية</th>
              <th style="text-align:right; padding:10px; width:140px">المبلغ</th>
            </tr>
          </thead>
          <tbody id="pdfOpsBody"></tbody>
        </table>
      </div>

      <div class="pdf-total">
        <span>الإجمالي</span>
        <span class="num" id="pdfTotal">0</span>
      </div>

      <div class="brand">تم تطوير النظام بواسطة الحايك للحلول الرقمية</div>
    </div>

  </div>

<script>
  // ===== Utilities =====
  const $ = (id) => document.getElementById(id);

  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function safeVibrate(ms=20){
    try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){}
  }

  function parseAmount(v){
    if(!v) return 0;
    const cleaned = String(v).replace(/[^\d.,-]/g,'').replace(',', '.');
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  function formatMoney(n){
    // عرض بسيط بدون عملة (تقدر تضيف ₺ إذا بدك)
    return (Math.round(n * 100) / 100).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
  }

  // ===== State =====
  let ops = [];

  function render(){
    // App table
    const body = $('opsBody');
    body.innerHTML = '';

    if(ops.length === 0){
      body.innerHTML = `<tr><td colspan="3" class="muted" style="text-align:center; padding:14px">لا توجد عمليات بعد</td></tr>`;
      $('totalTxt').textContent = '0';
      return;
    }

    let total = 0;
    ops.forEach((op, idx) => {
      total += op.amount;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="muted">${idx+1}</td>
        <td>${escapeHtml(op.desc || '—')}</td>
        <td class="num">${formatMoney(op.amount)}</td>
      `;
      body.appendChild(tr);
    });

    $('totalTxt').textContent = formatMoney(total);
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c) => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
  }

  function addOperation(desc, amount){
    const a = parseAmount(amount);
    if(a === 0){
      alert('أدخل مبلغ صحيح (غير صفر).');
      return;
    }
    ops.push({
      desc: (desc || '').trim(),
      amount: a
    });
    $('opDesc').value = '';
    $('opAmount').value = '';
    safeVibrate(15);
    render();
  }

  function clearAll(){
    if(!confirm('هل تريد مسح كل العمليات؟')) return;
    ops = [];
    safeVibrate(30);
    render();
  }

  // ===== PDF Sync =====
  function syncPdfArea(){
    const name = ($('customerName').value || '').trim() || '—';
    const date = ($('invDate').value || '').trim() || '—';

    $('pdfCustomer').textContent = name;
    $('pdfDate').textContent = date;

    const meta = `عدد العمليات: ${ops.length} — تم الإنشاء: ${new Date().toLocaleString('ar')}`;
    $('pdfMeta').textContent = meta;

    const pdfBody = $('pdfOpsBody');
    pdfBody.innerHTML = '';

    let total = 0;

    if(ops.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="3" style="padding:10px; color:#6b7280; text-align:center">لا توجد عمليات</td>`;
      pdfBody.appendChild(tr);
      $('pdfTotal').textContent = '0';
      return;
    }

    ops.forEach((op, idx) => {
      total += op.amount;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:10px; color:#374151">${idx+1}</td>
        <td style="padding:10px; color:#111827">${escapeHtml(op.desc || '—')}</td>
        <td style="padding:10px; color:#111827" class="num">${formatMoney(op.amount)}</td>
      `;
      pdfBody.appendChild(tr);
    });

    $('pdfTotal').textContent = formatMoney(total);
  }

  async function exportPdf(){
    // أهم نقطة لحل اختفاء الجدول:
    // 1) نبني جدول الـ PDF داخل printable-area
    // 2) ننتظر فريمين (render) قبل الحفظ
    syncPdfArea();

    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

    const customer = ($('customerName').value || '').trim() || 'بدون-اسم';
    const date = ($('invDate').value || todayISO());
    const filename = `Invoice-${customer}-${date}.pdf`.replace(/[\\/:*?"<>|]/g,'-');

    const element = $('printable-area');

    const opt = {
      margin:       8,
      filename:     filename,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  {
        scale: 2,
        useCORS: true,
        backgroundColor: '#ffffff',
        logging: false,
        windowWidth: element.scrollWidth
      },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
    };

    try{
      safeVibrate(25);
      await html2pdf().set(opt).from(element).save();
    }catch(err){
      console.error(err);
      alert('حصل خطأ أثناء تصدير PDF. افتح Console وشوف الخطأ.');
    }
  }

  // ===== Wire up =====
  $('invDate').value = todayISO();

  $('addBtn').addEventListener('click', () => {
    addOperation($('opDesc').value, $('opAmount').value);
  });

  $('opAmount').addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      e.preventDefault();
      addOperation($('opDesc').value, $('opAmount').value);
    }
  });

  $('clearBtn').addEventListener('click', clearAll);
  $('pdfBtn').addEventListener('click', exportPdf);

  $('demoBtn').addEventListener('click', () => {
    addOperation('بيع قطعة', '150');
    addOperation('أجرة تركيب', '75');
    addOperation('خصم', '-20');
  });

  // init
  render();
</script>
</body>
</html>
