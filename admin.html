<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HAYEK SPOT — لوحة الإدارة</title>

  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#071820" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Config + Auth -->
  <script src="./config.js?v=3"></script>
  <script src="./auth.js?v=3"></script>

  <!-- نفس ستايل مشروعك -->
  <link rel="stylesheet" href="./style.css?v=3" />

  <style>
    /* تحسينات بسيطة داخل الأدمن */
    .pageTitle{font-weight:900;font-size:16px}
    .subTitle{color:var(--muted);font-size:12px;margin-top:2px}
    .topRight{display:flex;gap:10px;align-items:center}
    .searchRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .searchRow input{
      flex:1;min-width:220px;
      border:1px solid var(--stroke);
      background:#07131a55;
      color:var(--text);
      padding:12px 14px;border-radius:14px;outline:none
    }
    .gridAdmin{display:grid;grid-template-columns: 1.25fr .75fr;gap:12px}
    @media (max-width: 980px){ .gridAdmin{grid-template-columns:1fr} }
    .smallPill{font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid #ffffff2a;background:#07131a44}
    .rowBtns{display:flex;gap:8px;flex-wrap:wrap}
    .rowBtns .btn{padding:8px 10px;border-radius:10px;font-size:13px}
    .modalBack{position:fixed;inset:0;background:#000000aa;display:none;z-index:9999;align-items:center;justify-content:center;padding:14px}
    .modal{width:min(980px,100%);background:#07131a;border:1px solid #ffffff22;border-radius:16px;box-shadow:0 30px 90px #00000066;overflow:hidden}
    .modalHead{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #ffffff22;background:#0b2230}
    .modalBody{padding:12px 14px;max-height:75vh;overflow:auto}
    .modalTitle{font-weight:900}
    .muted{color:var(--muted)}
    .twoCols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 820px){ .twoCols{grid-template-columns:1fr} }
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .pill{border-style:solid;border-color:#ffffff2a}
  </style>
</head>

<body>
  <!-- شريط علوي -->
  <div class="topbar">
    <div class="brand">
      <span class="dot" id="netDot"></span>
      <div class="titles">
        <div class="title pageTitle">HAYEK SPOT</div>
        <div class="subtitle subTitle">لوحة الإدارة — الفواتير + المستخدمين</div>
      </div>
    </div>

    <div class="topRight">
      <span class="smallPill" id="adminName">—</span>
      <button class="btn" id="btnRefresh">تحديث</button>
      <button class="btn danger" id="btnLogout">خروج</button>
    </div>
  </div>

  <div class="wrap">
    <!-- تبويبات -->
    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="invoices">الفواتير</button>
        <button class="tab" data-tab="users">المستخدمين</button>
      </div>

      <!-- ===== فواتير ===== -->
      <div class="tabpane" id="tab-invoices">
        <div class="searchRow">
          <input id="qInvoices" placeholder="بحث: اسم المستخدم / اسم الزبون / رقم الفاتورة (آخر 6 أرقام)..." />
          <button class="btn primary" id="btnLoadInvoices">تحميل الفواتير</button>
        </div>

        <div class="kpi" style="margin-top:10px">
          <span class="pill">عدد الفواتير: <b id="kpiInvoices">0</b></span>
          <span class="pill">إجمالي مجموع الفواتير: <b id="kpiTotal">0</b></span>
        </div>

        <div class="gridAdmin" style="margin-top:12px">
          <!-- جدول الفواتير -->
          <div class="card" style="margin:0">
            <h3 class="h3">قائمة الفواتير</h3>
            <div class="tableWrap">
              <table class="tbl">
                <thead>
                  <tr>
                    <th>التاريخ</th>
                    <th>المستخدم</th>
                    <th>الزبون</th>
                    <th>الإجمالي</th>
                    <th>الحالة</th>
                    <th>رقم</th>
                    <th>إجراءات</th>
                  </tr>
                </thead>
                <tbody id="invTbody"></tbody>
              </table>
            </div>
            <div class="toast" id="toastInv"></div>
          </div>

          <!-- تفاصيل سريعة -->
          <div class="card" style="margin:0">
            <h3 class="h3">تفاصيل الفاتورة</h3>
            <div class="field"><label>رقم الفاتورة</label><input id="dInvId" readonly></div>
            <div class="field"><label>المستخدم</label><input id="dUser" readonly></div>
            <div class="field"><label>الزبون</label><input id="dCust" readonly></div>
            <div class="field"><label>الإجمالي</label><input id="dTotal" readonly></div>
            <div class="field"><label>الحالة</label><input id="dStatus" readonly></div>

            <div class="btnRow">
              <button class="btn primary" id="btnViewOps" disabled>عرض العمليات</button>
              <button class="btn" id="btnPDF" disabled>تصدير PDF</button>
            </div>

            <div class="hint subtle" style="margin-top:8px">
              ملاحظة: تصدير PDF هنا سيخرج بنفس تنسيق ملف المستخدم (أعلى/أسفل + جدول العمليات).
            </div>

            <div class="toast" id="toastSide"></div>
          </div>
        </div>
      </div>

      <!-- ===== مستخدمين ===== -->
      <div class="tabpane hidden" id="tab-users">
        <div class="searchRow">
          <input id="qUsers" placeholder="بحث: اسم المستخدم..." />
          <button class="btn primary" id="btnLoadUsers">تحميل المستخدمين</button>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 class="h3">قائمة المستخدمين</h3>
          <div class="tableWrap">
            <table class="tbl">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>اسم المستخدم</th>
                  <th>أدمن</th>
                  <th>محظور</th>
                  <th>Device ID</th>
                  <th>آخر ظهور</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody id="usersTbody"></tbody>
            </table>
          </div>
          <div class="toast" id="toastUsers"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ pdfStage (قبل السكربتات) -->
  <div id="pdfStage" class="pdfStage" aria-hidden="true"></div>

  <!-- مودال العمليات -->
  <div class="modalBack" id="opsModalBack">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="modalTitle">تفاصيل العمليات</div>
          <div class="muted" id="opsMeta">—</div>
        </div>
        <div class="rowBtns">
          <button class="btn" id="btnOpsPDF">تصدير PDF</button>
          <button class="btn danger" id="btnCloseOps">إغلاق</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="tableWrap">
          <table class="tbl">
            <thead>
              <tr>
                <th>#</th>
                <th>الوقت</th>
                <th>البيان</th>
                <th>العملية</th>
                <th>النتيجة</th>
              </tr>
            </thead>
            <tbody id="opsTbody"></tbody>
          </table>
        </div>

        <div class="totalBox" style="margin-top:12px">
          <span class="totalLabel">إجمالي الكشف</span>
          <span class="totalValue" id="opsTotal">0</span>
        </div>

        <div class="toast" id="toastOps"></div>
      </div>
    </div>
  </div>

  <script src="./admin.js?v=3"></script>
</body>
</html>
