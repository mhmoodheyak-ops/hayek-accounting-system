
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† â€” HAYEK SPOT</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    :root{ --bg:#071820; --panel:rgba(255,255,255,.05); --line:rgba(255,255,255,.1); --txt:#eaf4ff; --blue:#1f62ff; --danger:#ff6b6b; --ok:#49e39a; }
    body{margin:0; background:var(--bg); color:var(--txt); font-family:system-ui; direction:rtl; min-height:100vh}
    .header{display:flex; justify-content:space-between; padding:15px 25px; border-bottom:1px solid var(--line); background:rgba(0,0,0,0.2)}
    .container{max-width:1100px; margin:auto; padding:20px}
    .grid-stats{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:25px}
    .card{background:var(--panel); border:1px solid var(--line); border-radius:18px; padding:20px; backdrop-filter:blur(10px)}
    table{width:100%; border-collapse:collapse; margin-top:15px}
    th{text-align:right; color:#888; font-size:12px; padding:10px; border-bottom:1px solid var(--line)}
    td{padding:12px 10px; border-bottom:1px solid rgba(255,255,255,0.03); font-size:14px}
    .btn-sm{padding:7px 14px; border-radius:8px; border:none; cursor:pointer; font-size:12px; transition:0.2s}
    .blue{background:var(--blue); color:#fff}
    .danger-btn{background:rgba(255,107,107,0.1); color:var(--danger)}
    .user-click{color:var(--blue); cursor:pointer; font-weight:bold; text-decoration:underline}
    
    /* Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± */
    #invModal{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:1000; padding:20px; backdrop-filter:blur(10px)}
    .modal-box{background:#0d2129; border:1px solid var(--line); max-width:700px; margin:30px auto; border-radius:24px; padding:25px; max-height:85vh; overflow-y:auto}
    .badge{padding:4px 8px; border-radius:6px; font-size:11px}
    .active-tag{background:rgba(73,227,154,0.1); color:var(--ok)}
  </style>
</head>
<body>

  <div class="header">
    <div style="display:flex; align-items:center; gap:10px">
        <span class="badge active-tag">Ø£Ø¯Ù…Ù†: Ù…ØªØµÙ„</span>
        <strong id="admName">admin</strong>
    </div>
    <button class="btn-sm danger-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
  </div>

  <div class="container">
    <div class="grid-stats">
        <div class="card" style="text-align:center">
            <h2 id="uCount">0</h2>
            <p style="margin:0; color:#888; font-size:13px">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
        </div>
        <div class="card" style="text-align:center">
            <h2 id="iCount">0</h2>
            <p style="margin:0; color:#888; font-size:13px">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</p>
        </div>
        <div class="card">
            <select id="timeRange" onchange="init()" style="width:100%; background:#000; color:#fff; border:1px solid var(--line); padding:8px; border-radius:8px">
                <option value="all">ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª</option>
                <option value="7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
            </select>
        </div>
    </div>

    <div class="card">
        <h3 style="margin:0 0 15px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆÙ†Ø´Ø§Ø·Ù‡Ù…</h3>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                    <th>Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ±</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="userRows"></tbody>
        </table>
    </div>
  </div>

  <div id="invModal">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
            <h3 id="modalUser">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
            <div>
                <button class="btn-sm blue" id="pdfBtn">ØªØµØ¯ÙŠØ± PDF ğŸ“„</button>
                <button class="btn-sm" style="background:#333; color:#fff" onclick="closeM()">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
        <table id="targetTable">
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
            </thead>
            <tbody id="invRows"></tbody>
        </table>
    </div>
  </div>

  <script>
    const SB_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
    const SB_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";
    const sb = supabase.createClient(SB_URL, SB_KEY);

    let viewingNow = "";

    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©
    const sess = JSON.parse(localStorage.getItem("HAYEK_SESSION") || "{}");
    if(sess.role !== "admin") location.href = "index.html";
    document.getElementById("admName").textContent = sess.username;

    async function init() {
        const { count: uc } = await sb.from('app_users').select('*', { count: 'exact', head: true });
        const { count: ic } = await sb.from('app_invoices').select('*', { count: 'exact', head: true });
        document.getElementById("uCount").textContent = uc || 0;
        document.getElementById("iCount").textContent = ic || 0;
        
        loadUsers();
    }

    async function loadUsers() {
        const body = document.getElementById("userRows");
        body.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        const { data: users } = await sb.from('app_users').select('*').order('last_seen', {ascending:false});
        
        body.innerHTML = "";
        for(const u of users) {
            const { count: invs } = await sb.from('app_invoices').select('*', { count: 'exact', head: true }).eq('username', u.username);
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="user-click" onclick="showInv('${u.username}')">${u.username}</span></td>
                <td>${invs || 0}</td>
                <td>${u.last_seen ? new Date(u.last_seen).toLocaleTimeString('ar-EG') : '---'}</td>
                <td><span class="badge ${u.blocked ? 'danger-btn' : 'active-tag'}">${u.blocked ? 'Ù…Ø­Ø¸ÙˆØ±' : 'Ù†Ø´Ø·'}</span></td>
                <td><button class="btn-sm" onclick="resetD('${u.username}')">Ù…Ø³Ø­ Ø§Ù„Ø¬Ù‡Ø§Ø²</button></td>
            `;
            body.appendChild(tr);
        }
    }

    async function showInv(user) {
        viewingNow = user;
        document.getElementById("invModal").style.display = "block";
        document.getElementById("modalUser").textContent = `ÙÙˆØ§ØªÙŠØ±: ${user}`;
        const list = document.getElementById("invRows");
        list.innerHTML = "ØªØ­Ù…ÙŠÙ„...";

        const { data: invs } = await sb.from('app_invoices').select('*').eq('username', user).order('created_at', {ascending:false});
        list.innerHTML = "";
        invs.forEach(i => {
            list.innerHTML += `<tr><td>#${i.id}</td><td>${new Date(i.created_at).toLocaleDateString()}</td><td>${i.total}</td><td>Ù…ØºÙ„Ù‚Ø©</td></tr>`;
        });
    }

    document.getElementById("pdfBtn").onclick = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(`Report: ${viewingNow}`, 14, 15);
        doc.autoTable({ html: '#targetTable', margin: { top: 25 } });
        doc.save(`Invoices_${viewingNow}.pdf`);
    };

    function closeM() { document.getElementById("invModal").style.display="none"; }
    function logout() { localStorage.clear(); location.href="index.html"; }
    async function resetD(u) { await sb.from('app_users').update({device_id: null}).eq('username', u); alert("ØªÙ… Ø§Ù„Ù…Ø³Ø­"); }

    init();
  </script>
</body>
</html>
