<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#111315" />
  <title>لوحة الأمن — HAYEK SPOT</title>

  <style>
    :root{
      --bg:#0f1214; --card:#151a1e; --line:rgba(255,255,255,.14);
      --txt:#fff; --muted:rgba(255,255,255,.72);
      --green:#19C37D; --yellow:#D6A628; --red:#ff505a;
      --radius:22px; --shadow:0 14px 40px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:linear-gradient(180deg,#1b2126,#0f1214);
      color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Arabic","Noto Naskh Arabic",sans-serif;
      padding:18px;
    }
    .wrap{max-width:1200px;margin:0 auto;display:grid;gap:12px}
    .top{
      display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
      padding:14px;border:1px solid var(--line);border-radius:var(--radius);
      background:rgba(0,0,0,.15);box-shadow:var(--shadow);
    }
    .brand b{font-size:18px}
    .brand span{display:block;font-size:12px;color:var(--muted);margin-top:4px}
    .pill{
      font-size:12px;font-weight:900;padding:8px 12px;border-radius:999px;
      background:rgba(25,195,125,.18);border:1px solid rgba(25,195,125,.45);
    }

    .grid{display:grid;grid-template-columns:1fr 1.1fr;gap:12px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;padding:14px;border-bottom:1px solid rgba(255,255,255,.12);
      font-size:16px
    }
    .pad{padding:14px;display:grid;gap:10px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width: 520px){ .row2,.row3{grid-template-columns:1fr} }

    input,select{
      width:100%;
      padding:12px;border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--txt);
      outline:none;
      font-weight:900;
    }
    /* ✅ حل مشكلة النص داخل select */
    select, option{
      color:#fff;
      background:#111315;
    }

    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      color:var(--txt);
      padding:12px;border-radius:16px;
      font-weight:900;cursor:pointer;
    }
    .btn.green{background:rgba(25,195,125,.18);border-color:rgba(25,195,125,.45)}
    .btn.yellow{background:rgba(214,166,40,.16);border-color:rgba(214,166,40,.45);color:#111315}
    .btn.red{background:rgba(255,80,90,.14);border-color:rgba(255,80,90,.35)}
    .btn.small{padding:8px 10px;border-radius:14px;font-size:12px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.10);font-size:13px}
    th{color:var(--muted);text-align:right}
    td.num{text-align:left;direction:ltr;font-weight:900}
    .pillSmall{
      font-size:12px;font-weight:900;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      display:inline-block;
    }
    .pillOpen{background:rgba(25,195,125,.18);border-color:rgba(25,195,125,.45)}
    .pillClosed{background:rgba(214,166,40,.18);border-color:rgba(214,166,40,.45);color:#fff}
    .note{font-size:12px;color:var(--muted);line-height:1.7}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:6px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <b>لوحة الأمن — HAYEK SPOT</b>
        <span>إدارة المستخدمين + فواتير متعددة + طباعة PDF (فاتورة فقط)</span>
      </div>
      <div class="pill" id="build">ADMIN build v999</div>
    </div>

    <div class="grid">
      <!-- USERS -->
      <div class="card">
        <h2>إدارة المستخدمين</h2>
        <div class="pad">
          <div class="row3">
            <input id="uName" placeholder="اسم المستخدم" />
            <input id="uPass" placeholder="كلمة السر" />
            <select id="uRole">
              <option value="user">مستخدم</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div class="row2">
            <button class="btn green" id="saveUser">حفظ المستخدم</button>
            <button class="btn yellow" id="genPass">توليد كلمة سر</button>
          </div>

          <div class="row2">
            <button class="btn" id="refreshUsers">تحديث القائمة</button>
            <input id="searchUser" placeholder="بحث عن مستخدم (جزء من الاسم)..." />
          </div>

          <div class="hr"></div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>الاسم</th>
                  <th class="num">كلمة السر</th>
                  <th>Admin</th>
                  <th>الحالة</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody id="usersBody"></tbody>
            </table>
          </div>

          <div class="note">
            ✓ زر (اختيار) يحدد المستخدم ويجلب فواتيره.<br>
            ⚠ لا تشارك مفاتيح Supabase مع أي شخص.
          </div>
        </div>
      </div>

      <!-- INVOICES -->
      <div class="card">
        <h2>فواتير متعددة للمستخدم</h2>
        <div class="pad">
          <div class="row3">
            <input id="fromDate" type="date" />
            <input id="toDate" type="date" />
            <button class="btn" id="todayBtn">اليوم</button>
          </div>

          <div class="row3">
            <button class="btn" id="last7Btn">آخر 7 أيام</button>
            <button class="btn" id="clearDates">مسح التواريخ</button>
            <button class="btn green" id="refreshInv">تحديث قائمة الفواتير</button>
          </div>

          <div class="row2">
            <select id="invoiceSelect">
              <option value="">— اختر فاتورة —</option>
            </select>
            <button class="btn green" id="openInv">فتح الفاتورة المختارة</button>
          </div>

          <div class="row2">
            <button class="btn yellow" id="printInv">تصدير / طباعة PDF (فاتورة فقط)</button>
            <button class="btn red" id="deleteInv">حذف الفاتورة المختارة</button>
          </div>

          <div class="hr"></div>

          <div class="row2">
            <div class="pillSmall pillOpen" id="invStatus">—</div>
            <div class="pillSmall" id="invTotal" style="direction:ltr">المجموع: 0</div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>الوقت</th>
                  <th>البيان</th>
                  <th class="num">العملية</th>
                  <th class="num">النتيجة</th>
                </tr>
              </thead>
              <tbody id="opsBody"></tbody>
            </table>
          </div>

          <div class="note" id="hint">اختر مستخدم أولاً ثم “تحديث قائمة الفواتير”.</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ========= Supabase REST =========
  const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
  const SUPABASE_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";
  const REST = `${SUPABASE_URL}/rest/v1`;

  const $ = (id)=>document.getElementById(id);

  const toast = (msg) => {
    const d = document.createElement("div");
    d.textContent = msg;
    Object.assign(d.style, {
      position:"fixed", bottom:"18px", left:"50%",
      transform:"translateX(-50%)",
      background:"rgba(17,19,21,.88)",
      color:"#fff", padding:"10px 14px",
      borderRadius:"14px", fontWeight:"1000",
      zIndex:99999, backdropFilter:"blur(8px)",
      border:"1px solid rgba(255,255,255,.18)"
    });
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 1700);
  };

  const apiFetch = async (path, options = {}) => {
    const res = await fetch(`${REST}${path}`, {
      ...options,
      headers: {
        "apikey": SUPABASE_KEY,
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json",
        "Accept": "application/json",
        ...(options.headers || {})
      }
    });
    if (!res.ok) {
      const t = await res.text().catch(()=> "");
      throw new Error(`API ${res.status}: ${t || res.statusText}`);
    }
    const text = await res.text();
    return text ? JSON.parse(text) : null;
  };

  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleString("ar", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch{ return ""; }
  }
  function fmt(n){
    const x = Number(n);
    if (!Number.isFinite(x)) return "0";
    const s = x.toString();
    return s.includes(".") ? x.toFixed(6).replace(/0+$/,"").replace(/\.$/,"") : s;
  }

  const state = {
    selectedUser: null, // {id, username}
    invoices: [],
    selectedInvoiceId: null
  };

  // ========= USERS =========
  async function loadUsers(){
    const rows = await apiFetch(`/app_users?select=id,username,pass,is_admin,blocked&order=username.asc`, { method:"GET" });
    const q = ($("searchUser").value || "").trim().toLowerCase();
    const list = (rows || []).filter(u => !q || (u.username || "").toLowerCase().includes(q));

    const tb = $("usersBody");
    tb.innerHTML = "";
    list.forEach(u=>{
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.textContent = u.username || "";

      const tdPass = document.createElement("td");
      tdPass.className="num";
      tdPass.textContent = u.pass || "";

      const tdAdmin = document.createElement("td");
      tdAdmin.textContent = u.is_admin ? "YES" : "NO";

      const tdState = document.createElement("td");
      const pill = document.createElement("span");
      pill.className = "pillSmall " + (u.blocked ? "" : "pillOpen");
      pill.textContent = u.blocked ? "محظور" : "مفعّل";
      tdState.appendChild(pill);

      const tdAct = document.createElement("td");

      const btnPick = document.createElement("button");
      btnPick.className="btn small";
      btnPick.textContent="اختيار";
      btnPick.onclick = async ()=>{
        state.selectedUser = { id: u.id, username: u.username };
        $("hint").textContent = `المستخدم المحدد: ${u.username}`;
        await loadInvoices();
      };

      const btnBlock = document.createElement("button");
      btnBlock.className="btn small yellow";
      btnBlock.textContent = u.blocked ? "فك" : "حظر";
      btnBlock.onclick = async ()=>{
        await apiFetch(`/app_users?id=eq.${u.id}`, {
          method:"PATCH",
          headers:{ "Prefer":"return=minimal" },
          body: JSON.stringify({ blocked: !u.blocked })
        });
        toast("تم ✅");
        await loadUsers();
      };

      const btnDel = document.createElement("button");
      btnDel.className="btn small red";
      btnDel.textContent="حذف";
      btnDel.onclick = async ()=>{
        await apiFetch(`/app_users?id=eq.${u.id}`, { method:"DELETE" });
        toast("تم الحذف");
        await loadUsers();
      };

      tdAct.append(btnPick, document.createTextNode(" "), btnBlock, document.createTextNode(" "), btnDel);

      tr.append(tdName, tdPass, tdAdmin, tdState, tdAct);
      tb.appendChild(tr);
    });
  }

  async function saveUser(){
    const username = ($("uName").value||"").trim();
    const pass = ($("uPass").value||"").trim();
    const role = $("uRole").value;

    if (!username || !pass) return toast("اكتب الاسم وكلمة السر");

    // upsert by username (إذا موجود: حدّث، إذا لا: أضف)
    const existing = await apiFetch(`/app_users?select=id&limit=1&username=eq.${encodeURIComponent(username)}`, { method:"GET" });
    const found = Array.isArray(existing) ? existing[0] : null;

    if (!found){
      await apiFetch(`/app_users`, {
        method:"POST",
        headers:{ "Prefer":"return=minimal" },
        body: JSON.stringify({
          username, pass,
          is_admin: role === "admin",
          blocked: false
        })
      });
    }else{
      await apiFetch(`/app_users?id=eq.${found.id}`, {
        method:"PATCH",
        headers:{ "Prefer":"return=minimal" },
        body: JSON.stringify({
          pass,
          is_admin: role === "admin"
        })
      });
    }

    toast("تم حفظ المستخدم ✅");
    await loadUsers();
  }

  function genPass(){
    const p = String(Math.floor(100000 + Math.random()*900000));
    $("uPass").value = p;
    toast("تم توليد كلمة سر");
  }

  // ========= INVOICES =========
  function setDateRange(fromISO, toISO){
    $("fromDate").value = fromISO || "";
    $("toDate").value = toISO || "";
  }
  function isoDate(d){
    const x = new Date(d);
    const y = x.getFullYear();
    const m = String(x.getMonth()+1).padStart(2,"0");
    const day = String(x.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  async function loadInvoices(){
    if (!state.selectedUser?.username){
      $("hint").textContent = "اختر مستخدم أولاً.";
      return;
    }

    const u = state.selectedUser.username;
    const from = $("fromDate").value;
    const to = $("toDate").value;

    let query = `/app_invoices?select=id,username,customer_name,status,total,created_at,closed_at&username=eq.${encodeURIComponent(u)}&order=created_at.desc&limit=200`;
    if (from) query += `&created_at=gte.${from}T00:00:00.000Z`;
    if (to) query += `&created_at=lte.${to}T23:59:59.999Z`;

    const rows = await apiFetch(query, { method:"GET" });
    state.invoices = Array.isArray(rows) ? rows : [];

    // fill select
    const sel = $("invoiceSelect");
    sel.innerHTML = `<option value="">— اختر فاتورة —</option>`;

    state.invoices.forEach(inv=>{
      const opt = document.createElement("option");
      opt.value = inv.id;

      const st = (inv.status || "open").toLowerCase();
      const label = `${inv.customer_name || "بدون اسم"} — ${fmtDate(inv.created_at)} — ${st} — total ${fmt(inv.total)}`;

      opt.textContent = label;

      // ✅ حل “النص ما بيبين” داخل dropdown
      opt.style.color = "#fff";
      opt.style.background = "#111315";

      sel.appendChild(opt);
    });

    $("hint").textContent = `تم جلب ${state.invoices.length} فاتورة للمستخدم: ${u}`;
  }

  async function openInvoice(){
    const id = $("invoiceSelect").value;
    if (!id) return toast("اختر فاتورة");

    state.selectedInvoiceId = id;

    const inv = state.invoices.find(x=>x.id===id);
    const st = (inv?.status || "open").toLowerCase();

    $("invStatus").textContent = st === "closed" ? "مغلقة" : "مفتوحة";
    $("invStatus").className = "pillSmall " + (st === "closed" ? "pillClosed" : "pillOpen");
    $("invTotal").textContent = `المجموع: ${fmt(inv?.total)}`;

    const ops = await apiFetch(`/app_operations?select=created_at,label,operation,result&invoice_id=eq.${encodeURIComponent(id)}&order=created_at.asc`, { method:"GET" });

    const tb = $("opsBody");
    tb.innerHTML = "";
    let total = 0;

    (ops || []).forEach(r=>{
      const tr = document.createElement("tr");
      const tdT = document.createElement("td"); tdT.textContent = fmtDate(r.created_at);
      const tdL = document.createElement("td"); tdL.textContent = r.label || "عملية";
      const tdO = document.createElement("td"); tdO.className="num"; tdO.textContent = r.operation || "";
      const tdR = document.createElement("td"); tdR.className="num"; tdR.textContent = r.result ?? "";
      tr.append(tdT, tdL, tdO, tdR);
      tb.appendChild(tr);

      const v = Number(r.result);
      if (Number.isFinite(v)) total += v;
    });

    $("invTotal").textContent = `المجموع: ${fmt(total)}`;
    toast("تم فتح الفاتورة ✅");
  }

  function printInvoice(){
    const id = state.selectedInvoiceId || $("invoiceSelect").value;
    if (!id) return toast("اختر فاتورة أولاً");
    // ✅ طباعة نظيفة من invoice.html فقط
    const url = `./invoice.html?invoice_id=${encodeURIComponent(id)}&print=1`;
    window.open(url, "_blank");
  }

  async function deleteInvoice(){
    const id = state.selectedInvoiceId || $("invoiceSelect").value;
    if (!id) return toast("اختر فاتورة");

    // delete invoice -> FK cascade will delete operations if FK on delete cascade exists
    await apiFetch(`/app_invoices?id=eq.${encodeURIComponent(id)}`, { method:"DELETE" });

    toast("تم حذف الفاتورة");
    state.selectedInvoiceId = null;
    $("opsBody").innerHTML = "";
    await loadInvoices();
  }

  // ========= Events =========
  $("refreshUsers").onclick = ()=>loadUsers().catch(e=>{console.error(e);toast("فشل جلب المستخدمين");});
  $("searchUser").oninput = ()=>loadUsers().catch(()=>{});
  $("saveUser").onclick = ()=>saveUser().catch(e=>{console.error(e);toast("فشل حفظ المستخدم");});
  $("genPass").onclick = ()=>genPass();

  $("todayBtn").onclick = ()=>{
    const d = isoDate(new Date());
    setDateRange(d,d);
  };
  $("last7Btn").onclick = ()=>{
    const now = new Date();
    const from = new Date(now.getTime() - 7*24*3600*1000);
    setDateRange(isoDate(from), isoDate(now));
  };
  $("clearDates").onclick = ()=>setDateRange("","");
  $("refreshInv").onclick = ()=>loadInvoices().catch(e=>{console.error(e);toast("فشل جلب الفواتير");});
  $("openInv").onclick = ()=>openInvoice().catch(e=>{console.error(e);toast("فشل فتح الفاتورة");});
  $("printInv").onclick = ()=>printInvoice();
  $("deleteInv").onclick = ()=>deleteInvoice().catch(e=>{console.error(e);toast("فشل حذف الفاتورة");});

  // Boot
  loadUsers().catch(e=>{console.error(e);toast("فشل بدء الأدمن");});
</script>
</body>
</html>
