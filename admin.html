<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>لوحة الأدمن - HAYEK</title>

  <!-- PDF (للأدمن عند تصدير فاتورة) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#121823;
      --card2:#0f1722;
      --txt:#e8eefc;
      --muted:#9aa7bd;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.08);
      --btn:#1a2432;
      --btn2:#223043;
      --blue:#1d4ed8;
      --blue2:#2563eb;
      --danger:#7f1d1d;
      --ok:#22c55e;
      --warn:#f59e0b;
      --shadow: 0 14px 38px rgba(0,0,0,.38);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 50% -10%, rgba(29,78,216,.20), transparent 55%),
        radial-gradient(900px 600px at 10% 20%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg,#070a0f 0%, #0b0f14 40%, #0b0f14 100%);
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:16px;
    }
    .wrap{width:100%; max-width:1160px;}

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin:6px 0 14px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .dot{
      width:12px; height:12px; border-radius:999px; background:var(--ok);
      box-shadow:0 0 0 7px rgba(34,197,94,.14);
    }
    .title{font-weight:900; letter-spacing:.2px}
    .sub{font-size:12px; color:var(--muted); margin-top:2px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:8px 12px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pill b{color:var(--txt)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .spacer{flex:1}

    .btn{
      border:1px solid var(--line);
      background:var(--btn);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      transition:.15s;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px); background:var(--btn2);}
    .btn.primary{background:var(--blue); border-color:rgba(29,78,216,.55)}
    .btn.primary:hover{background:var(--blue2)}
    .btn.danger{background:rgba(127,29,29,.55); border-color:rgba(159,31,31,.55)}
    .btn.danger:hover{background:rgba(159,31,31,.62)}
    .btn.soft{background:rgba(255,255,255,.06)}
    .btn.small{padding:8px 10px; border-radius:12px; font-size:12px; font-weight:900}
    .btn.warn{background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35)}
    .btn.warn:hover{background:rgba(245,158,11,.18)}

    .card{
      background:linear-gradient(180deg, rgba(18,24,35,.94) 0%, rgba(12,18,28,.92) 100%);
      border:1px solid var(--line2);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .hide{display:none !important;}

    h2{margin:0; font-size:16px}
    .hint{color:var(--muted); font-size:12px; line-height:1.7}
    .sep{height:1px; background:var(--line2); margin:12px 0}

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      outline:none;
    }
    input:focus, select:focus{
      border-color: rgba(29,78,216,.55);
      box-shadow:0 0 0 4px rgba(29,78,216,.18);
    }
    label{display:block; color:var(--muted); font-size:12px; margin:10px 0 6px}

    .grid{display:grid; gap:14px;}
    @media(min-width:980px){ .grid{grid-template-columns: 420px 1fr;} }

    .searchBox input{
      border-radius:18px;
      background: rgba(255,255,255,.04);
    }
    .filtersCard{
      margin-top:12px;
      padding:14px;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line2);
      border-radius: 18px;
    }
    .filtersGrid{display:grid; grid-template-columns: 1fr; gap:12px;}
    @media(min-width:900px){
      .filtersGrid{grid-template-columns: 1fr 1fr 1fr; align-items:end;}
    }
    .chips{display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}
    .chip{
      min-width:110px;
      text-align:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      font-weight:900;
      cursor:pointer;
      user-select:none;
      transition:.12s;
      white-space:nowrap;
    }
    .chip:hover{transform:translateY(-1px); background: rgba(255,255,255,.07)}
    .chip.active{background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.18);}
    .dateRow{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}

    .tableWrap{
      margin-top:14px;
      border:1px solid var(--line2);
      border-radius:18px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      background: rgba(0,0,0,.12);
    }
    table{width:100%; border-collapse:collapse; min-width: 980px;}
    th,td{
      padding:12px 12px;
      border-bottom:1px solid var(--line2);
      font-size:13px;
      text-align:right;
      vertical-align:middle;
      white-space:nowrap;
    }
    th{color:var(--muted); background: rgba(255,255,255,.05); font-weight:900;}
    tr:last-child td{border-bottom:0}

    .statusPill{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(34,197,94,.35);
      background: rgba(34,197,94,.10);
      color:#c9ffe0;
      font-weight:900;
      font-size:12px;
      min-width:72px;
    }
    .statusPill.blocked{
      border-color: rgba(255,77,77,.35);
      background: rgba(255,77,77,.10);
      color:#ffd6d6;
    }
    .countPill{
      display:inline-flex; align-items:center; justify-content:center;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      font-weight:900;
      min-width:62px;
    }
    .actionsCol{display:flex; gap:8px; flex-wrap:nowrap; justify-content:flex-start;}

    .reportBar{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media(min-width:900px){ .reportBar{grid-template-columns: 1fr 1fr 1fr 1fr;} }
    .stat{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.04);
      border-radius:18px;
      padding:12px;
    }
    .stat .k{font-size:12px; color:var(--muted)}
    .stat .v{margin-top:6px; font-size:18px; font-weight:950}

    .error{
      margin-top:10px;
      display:none;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,77,77,.25);
      background: rgba(255,77,77,.10);
      color:#ffd6d6;
      white-space:pre-wrap;
      font-size:12px;
    }
    .okbox{
      margin-top:10px;
      display:none;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(34,197,94,.25);
      background: rgba(34,197,94,.10);
      color:#c9ffe0;
      white-space:pre-wrap;
      font-size:12px;
    }

    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(980px, 96vw);
      max-height: 86vh;
      overflow:auto;
      border-radius:22px;
      border:1px solid var(--line2);
      background: linear-gradient(180deg, rgba(18,24,35,.98), rgba(10,15,23,.96));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      padding:14px;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .modalHead h3{margin:0; font-size:16px}
    .muted{color:var(--muted)}

    .invGrid{display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px;}
    .invItem{
      border:1px solid var(--line2);
      background: rgba(255,255,255,.04);
      border-radius:18px;
      padding:12px;
    }
    .invTop{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start;}
    .invTitle{font-weight:950}
    .invMeta{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.6}
    .invOps{
      margin-top:10px;
      border:1px solid var(--line2);
      border-radius:14px;
      overflow:auto;
      background: rgba(0,0,0,.12);
    }
    .invOps table{min-width: 720px;}
    .invOps table th{background: rgba(255,255,255,.05)}
    .invBtns{display:flex; gap:8px; flex-wrap:wrap}

    #printArea{
      position: fixed;
      left:-9999px;
      top:0;
      width: 794px;
      background:#fff;
      color:#111827;
      padding:22px;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }
    #printArea .box{
      border:2px solid #111827;
      border-radius:12px;
      padding:14px;
    }
    #printArea .brandRow{display:flex;justify-content:space-between;align-items:center;gap:12px}
    #printArea .logo{font-weight:900; letter-spacing:.3px;}
    #printArea .mut{color:#6b7280;font-size:12px}
    #printArea .line{height:1px;background:#e5e7eb;margin:12px 0}
    #printArea table{width:100%;border-collapse:collapse}
    #printArea th, #printArea td{border:1px solid #111827; padding:10px; font-size:12px; text-align:right; background:#fff}
    #printArea th{background:#f3f4f6}
    #printArea .totalRow{
      margin-top:12px;
      border:2px dashed #111827;
      border-radius:12px;
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    #printArea .totalRow b{font-size:16px}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">HAYEK — لوحة الأدمن</div>
          <div class="sub" id="subTitle">تسجيل دخول الأدمن</div>
        </div>
      </div>

      <div class="row" style="gap:8px">
        <button class="btn soft small hide" id="btnOpenAdd">إضافة مستخدم</button>
        <button class="btn soft small hide" id="btnRefresh">تحديث</button>
        <button class="btn danger small hide" id="btnLogoutTop">خروج</button>
        <div class="pill" id="sessionPill"><b>غير مسجل</b></div>
      </div>
    </div>

    <div class="grid">
      <div class="card" id="loginCard">
        <h2>تسجيل دخول الأدمن</h2>
        <div class="hint">افتراضي: <b>admin</b> / <b>admin123</b></div>

        <label>اسم المستخدم</label>
        <input id="loginUser" autocomplete="username" placeholder="admin" />

        <label>كلمة السر</label>
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="••••••••" />

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnLogin">دخول</button>
          <button class="btn" id="btnClear">تفريغ</button>
        </div>

        <div class="error" id="loginErr"></div>
        <div class="okbox" id="loginOk"></div>
      </div>

      <div class="card hide" id="dashCard">
        <div class="searchBox">
          <input id="qSearch" placeholder="بحث: اسم المستخدم / اسم الزبون / رقم الفاتورة (آخر 6 أرقام)..." />
          <div class="hint" style="margin-top:8px">يفضل البحث بآخر 6 أرقام من رقم الفاتورة أو اسم المستخدم.</div>
        </div>

        <div class="filtersCard">
          <div class="filtersGrid">
            <div>
              <label>اختيار المستخدم</label>
              <select id="userFilter">
                <option value="all">كل المستخدمين</option>
              </select>
            </div>

            <div>
              <label style="text-align:center">المدة</label>
              <div class="chips" id="rangeChips">
                <div class="chip active" data-range="all">الكل</div>
                <div class="chip" data-range="1">1 يوم</div>
                <div class="chip" data-range="7">7 أيام</div>
              </div>
            </div>

            <div class="dateRow">
              <div>
                <label>من</label>
                <input id="fromDate" type="date" />
              </div>
              <div>
                <label>إلى</label>
                <input id="toDate" type="date" />
              </div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <button class="btn primary" id="btnApply">عرض الفواتير</button>
            <div class="spacer"></div>
            <div class="hint">اختيار مستخدم + 1 يوم + 7 أيام + الكل + تاريخ من/إلى.</div>
          </div>
        </div>

        <div class="reportBar">
          <div class="stat"><div class="k">عدد المستخدمين</div><div class="v" id="stUsers">0</div></div>
          <div class="stat"><div class="k">عدد الفواتير (حسب الفلاتر)</div><div class="v" id="stInv">0</div></div>
          <div class="stat"><div class="k">مجموع الإجماليات</div><div class="v" id="stSum">0</div></div>
          <div class="stat"><div class="k">مغلقة / مفتوحة</div><div class="v" id="stCO">0 / 0</div></div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>اسم المستخدم</th>
                <th>عدد الفواتير</th>
                <th>الحالة</th>
                <th>نشط منذ</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody id="usersTbody">
              <tr><td colspan="5" class="muted">جاري التحميل...</td></tr>
            </tbody>
          </table>
        </div>

        <div class="error" id="dashErr"></div>
        <div class="okbox" id="dashOk"></div>

        <div class="sep"></div>
        <h2 style="margin-bottom:6px">آخر الفواتير (حسب الفلاتر)</h2>
        <div class="hint">هنا تظهر أحدث الفواتير بعد الضغط على "عرض الفواتير".</div>

        <div class="invGrid" id="lastInvGrid">
          <div class="hint">اضغط "عرض الفواتير".</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modalBack" id="addBack">
    <div class="modal">
      <div class="modalHead">
        <h3>إضافة مستخدم</h3>
        <button class="btn small" id="btnCloseAdd">إغلاق</button>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div style="flex:1">
          <label>اسم المستخدم</label>
          <input id="newUsername" placeholder="مثال: user1" />
        </div>
        <div style="flex:1">
          <label>كلمة السر</label>
          <input id="newPassword" placeholder="مثال: 1234" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>اسم كامل</label>
          <input id="newFullName" placeholder="اسم الزبون/المستخدم" />
        </div>
        <div style="flex:1">
          <label>هاتف</label>
          <input id="newPhone" placeholder="اختياري" />
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>صلاحية</label>
          <select id="newRole">
            <option value="user">مستخدم</option>
            <option value="admin">أدمن</option>
          </select>
        </div>
        <div style="flex:1; display:flex; align-items:flex-end">
          <button class="btn primary" id="btnAddUser" style="width:100%">إضافة مستخدم</button>
        </div>
      </div>

      <div class="error" id="addErr"></div>
      <div class="okbox" id="addOk"></div>
    </div>
  </div>

  <div class="modalBack" id="invBack">
    <div class="modal">
      <div class="modalHead">
        <h3 id="invTitle">فواتير المستخدم</h3>
        <button class="btn small" id="btnCloseInv">إغلاق</button>
      </div>
      <div class="row">
        <input id="invSearch" placeholder="بحث داخل فواتير هذا المستخدم (اسم الزبون / آخر 6 أرقام)..." />
        <button class="btn small primary" id="btnInvRefresh">تحديث</button>
      </div>
      <div class="hint" id="invHint" style="margin-top:8px"></div>
      <div class="sep"></div>
      <div id="invBody" class="invGrid"></div>
    </div>
  </div>

  <div id="printArea"></div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0aWR3cXZ5cmp5ZG1lZ2p6dXZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTAyNzQsImV4cCI6MjA4NTk4NjI3NH0.N1X39yfO6CLYu8UpbZsmlkIUELN_mmAzxUCQBCV7O8g";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id)=>document.getElementById(id);

    const loginCard = $("loginCard");
    const dashCard  = $("dashCard");

    const btnOpenAdd = $("btnOpenAdd");
    const btnRefresh = $("btnRefresh");
    const btnLogoutTop = $("btnLogoutTop");

    const loginErr = $("loginErr");
    const loginOk  = $("loginOk");

    const dashErr = $("dashErr");
    const dashOk  = $("dashOk");
    const sessionPill = $("sessionPill");
    const subTitle = $("subTitle");

    const qSearch = $("qSearch");
    const userFilter = $("userFilter");
    const fromDate = $("fromDate");
    const toDate = $("toDate");
    const btnApply = $("btnApply");
    const usersTbody = $("usersTbody");
    const lastInvGrid = $("lastInvGrid");

    const stUsers = $("stUsers");
    const stInv   = $("stInv");
    const stSum   = $("stSum");
    const stCO    = $("stCO");

    const addBack = $("addBack");
    const btnCloseAdd = $("btnCloseAdd");
    const addErr = $("addErr");
    const addOk = $("addOk");

    const invBack = $("invBack");
    const btnCloseInv = $("btnCloseInv");
    const invTitle = $("invTitle");
    const invSearch = $("invSearch");
    const btnInvRefresh = $("btnInvRefresh");
    const invHint = $("invHint");
    const invBody = $("invBody");

    const rangeChips = $("rangeChips");
    let RANGE_DAYS = "all";

    const USERS_TABLE   = "app_users";
    const INVOICE_TABLE = "app_invoices";

    let ADMIN = null;

    function showErr(box, msg){ box.style.display="block"; box.textContent = msg; }
    function showOk(box, msg){ box.style.display="block"; box.textContent = msg; setTimeout(()=>box.style.display="none", 2200); }
    function clearBox(box){ box.style.display="none"; box.textContent=""; }

    function setSessionPill(){
      sessionPill.innerHTML = ADMIN ? `<b>${ADMIN.username}</b> — أدمن` : "<b>غير مسجل</b>";
    }

    function safeText(v){ return (v===null || v===undefined) ? "" : String(v); }
    function last6(id){ const s = safeText(id); return s.length<=6 ? s : s.slice(-6); }

    function fmtRelTime(dateIso){
      if(!dateIso) return "—";
      const d = new Date(dateIso);
      const diff = Date.now() - d.getTime();
      const mins = Math.floor(diff/60000);
      if(mins < 60) return `منذ ${mins} د`;
      const hrs = Math.floor(mins/60);
      if(hrs < 24) return `منذ ${hrs} س`;
      const days = Math.floor(hrs/24);
      return `منذ ${days} يوم`;
    }

    function isoDayStart(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x.toISOString();
    }
    function isoDayEnd(d){
      const x = new Date(d);
      x.setHours(23,59,59,999);
      return x.toISOString();
    }

    function currentFilterRange(){
      const f = fromDate.value;
      const t = toDate.value;

      if(f || t){
        return { fromIso: f ? isoDayStart(f) : null, toIso: t ? isoDayEnd(t) : null };
      }

      if(RANGE_DAYS !== "all"){
        const days = Number(RANGE_DAYS);
        const from = new Date(Date.now() - days*24*60*60*1000);
        return { fromIso: isoDayStart(from), toIso: new Date().toISOString() };
      }

      return { fromIso:null, toIso:null };
    }

    // ✅ عمليات الفاتورة من عمود rows (حسب جدولك)
    function pickOps(inv){
      return Array.isArray(inv?.rows) ? inv.rows : [];
    }

    function matchesInvoice(inv, query){
      const q = (query||"").trim().toLowerCase();
      if(!q) return true;

      const cid = safeText(inv.id).toLowerCase();
      const c6  = last6(inv.id).toLowerCase();
      const cust = safeText(inv.customer_name || inv.customer).toLowerCase();
      const user = safeText(inv._userName).toLowerCase();

      return cust.includes(q) || user.includes(q) || c6.includes(q.replace(/\s+/g,"")) || cid.includes(q);
    }

    async function safeOrderQuery(baseQuery){
      let { data, error } = await baseQuery.order("created_at", { ascending:false });
      if(!error) return { data, error:null };
      ({ data, error } = await baseQuery.order("id", { ascending:false }));
      if(!error) return { data, error:null };
      ({ data, error } = await baseQuery);
      return { data: data||[], error: error||null };
    }

    async function fetchUsers(){
      const base = supabase.from(USERS_TABLE).select("*");
      const { data, error } = await safeOrderQuery(base);
      if(error) throw error;
      return data || [];
    }

    async function fetchInvoicesFiltered(){
      const { fromIso, toIso } = currentFilterRange();
      const uFilter = userFilter.value;

      let base = supabase.from(INVOICE_TABLE).select("*").limit(500);

      // ✅ هنا كان user_id — صار owner_id
      if(uFilter && uFilter !== "all") base = base.eq("owner_id", uFilter);
      if(fromIso) base = base.gte("created_at", fromIso);
      if(toIso)   base = base.lte("created_at", toIso);

      const { data, error } = await safeOrderQuery(base);
      if(error) throw error;
      return data || [];
    }

    function renderUserFilter(users){
      const prev = userFilter.value || "all";
      userFilter.innerHTML = `<option value="all">كل المستخدمين</option>`;
      users.forEach(u=>{
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = u.username;
        userFilter.appendChild(opt);
      });
      userFilter.value = ([...userFilter.options].some(o=>o.value===prev)) ? prev : "all";
    }

    function calcStats(users, invoices){
      const query = qSearch.value.trim();
      const filtered = invoices.filter(inv=> matchesInvoice(inv, query));

      let sum = 0, closed = 0, open = 0;
      for(const inv of filtered){
        const t = Number(inv.total);
        if(Number.isFinite(t)) sum += t;
        if(inv.status === "closed") closed++; else open++;
      }

      stUsers.textContent = String(users.length);
      stInv.textContent = String(filtered.length);
      stSum.textContent = String(Math.round(sum*100)/100);
      stCO.textContent  = `${closed} / ${open}`;
    }

    function buildUsersTable(users, invoices){
      const userMap = {};
      users.forEach(u=> userMap[u.id]=u);

      // ✅ ربط الفواتير بالمستخدم عبر owner_id
      invoices.forEach(inv=> inv._userName = userMap[inv.owner_id]?.username || "");

      const query = qSearch.value.trim();

      const counts = {};
      const lastActive = {};
      invoices.forEach(inv=>{
        if(!matchesInvoice(inv, query)) return;
        const uid = inv.owner_id;
        counts[uid] = (counts[uid]||0) + 1;
        const ca = inv.created_at || inv.updated_at || null;
        if(ca && (!lastActive[uid] || (new Date(ca) > new Date(lastActive[uid])))) lastActive[uid]=ca;
      });

      usersTbody.innerHTML = users.map(u=>{
        const c = counts[u.id] || 0;
        const blocked = !!u.is_blocked;
        const statusHtml = blocked
          ? `<span class="statusPill blocked">محظور</span>`
          : `<span class="statusPill">نشط</span>`;
        const activeText = fmtRelTime(lastActive[u.id] || u.created_at || u.updated_at);

        return `
          <tr>
            <td style="font-weight:950">${u.username}</td>
            <td><span class="countPill">${c}</span></td>
            <td>${statusHtml}</td>
            <td class="muted">${activeText}</td>
            <td>
              <div class="actionsCol">
                <button class="btn small primary" data-act="invoices" data-id="${u.id}" data-name="${u.username}">الفواتير</button>
                <button class="btn small soft" data-act="wipeDevice" data-id="${u.id}">مسح الجهاز</button>
                ${
                  blocked
                    ? `<button class="btn small" data-act="unblock" data-id="${u.id}">فك الحظر</button>`
                    : `<button class="btn small warn" data-act="block" data-id="${u.id}">حظر</button>`
                }
                <button class="btn small danger" data-act="del" data-id="${u.id}" data-name="${u.username}">حذف</button>
                ${
                  (!u.is_admin)
                    ? `<button class="btn small" data-act="makeAdmin" data-id="${u.id}">جعله أدمن</button>`
                    : `<button class="btn small" data-act="makeUser" data-id="${u.id}">جعله مستخدم</button>`
                }
              </div>
            </td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="5" class="muted">لا يوجد بيانات.</td></tr>`;
    }

    function buildLastInvoices(invoices, users){
      const userMap = {};
      users.forEach(u=> userMap[u.id]=u);

      const query = qSearch.value.trim();
      const filtered = invoices.filter(inv=> matchesInvoice(inv, query)).slice(0, 12);

      if(!filtered.length){
        lastInvGrid.innerHTML = `<div class="hint">لا يوجد فواتير حسب الفلاتر/البحث.</div>`;
        return;
      }

      lastInvGrid.innerHTML = filtered.map(inv=>{
        const u = userMap[inv.owner_id];
        const ops = pickOps(inv);
        const status = inv.status === "closed" ? "مغلقة" : "مفتوحة";
        const created = new Date(inv.created_at || Date.now()).toLocaleString("ar");
        const id6 = last6(inv.id);
        const cust = safeText(inv.customer_name || inv.customer);

        return `
          <div class="invItem">
            <div class="invTop">
              <div>
                <div class="invTitle">${cust} — <span class="muted">${status}</span></div>
                <div class="invMeta">
                  المستخدم: <b>${safeText(u?.username||"")}</b> —
                  رقم: <b>${safeText(id6)}</b> —
                  المجموع: <b>${safeText(inv.total||0)}</b>
                  <div style="margin-top:6px">بتاريخ: ${created}</div>
                </div>
              </div>
              <div class="pill"><b>${ops.length}</b> عمليات</div>
            </div>
          </div>
        `;
      }).join("");
    }

    async function applyAndRender(){
      clearBox(dashErr); clearBox(dashOk);
      try{
        const users = await fetchUsers();
        renderUserFilter(users);

        const invoices = await fetchInvoicesFiltered();

        calcStats(users, invoices);
        buildUsersTable(users, invoices);
        buildLastInvoices(invoices, users);
      }catch(e){
        showErr(dashErr, "خطأ Supabase:\n" + (e?.message || JSON.stringify(e)));
      }
    }

    function escHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function buildInvoicePrint(inv, username){
      const pa = $("printArea");
      const ops = pickOps(inv);
      const customer = safeText(inv.customer_name || inv.customer || "بدون اسم");
      const user = safeText(username || "");
      const total = safeText(inv.total ?? 0);
      const id = safeText(inv.id);
      const created = new Date(inv.created_at || Date.now()).toLocaleString("ar");

      const rows = ops.map((o,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${escHtml(o.label||"")}</td>
          <td>${escHtml(o.expr||"")}</td>
          <td>${escHtml(o.result||"")}</td>
          <td>${escHtml(o.time||"")}</td>
        </tr>
      `).join("");

      pa.innerHTML = `
        <div class="box">
          <div class="brandRow">
            <div>
              <div class="mut">شركة الحايك</div>
              <div class="logo">HAYEK SPOT</div>
            </div>
            <div style="text-align:right">
              <div class="mut">PDF / طباعة</div>
              <div class="mut">رقم الفاتورة: <b>${escHtml(last6(id))}</b></div>
            </div>
          </div>

          <div class="line"></div>

          <div class="mut" style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div>اسم المستخدم: <b style="color:#111827">${escHtml(user)}</b></div>
            <div>اسم العميل: <b style="color:#111827">${escHtml(customer)}</b></div>
            <div>التاريخ: <b style="color:#111827">${escHtml(created)}</b></div>
          </div>

          <div class="line"></div>

          <table>
            <thead>
              <tr>
                <th style="width:6%">#</th>
                <th style="width:34%">البيان</th>
                <th style="width:28%">العملية</th>
                <th style="width:12%">النتيجة</th>
                <th style="width:20%">الوقت</th>
              </tr>
            </thead>
            <tbody>
              ${rows || `<tr><td colspan="5" class="mut" style="text-align:center">لا يوجد عمليات</td></tr>`}
            </tbody>
          </table>

          <div class="totalRow">
            <div class="mut">تم تطوير هذه الحاسبة الاحترافية من قبل شركة الحايك للحلول الرقمية</div>
            <div><b>إجمالي الكشف: ${escHtml(total)}</b></div>
          </div>

          <div class="line"></div>
          <div class="mut" style="text-align:center">
            شركة الحايك: تجارة عامة / توزيع جملة / دعاية و اعلان / طباعة / حلول رقمية
          </div>
        </div>
      `;
      return pa;
    }

    async function exportInvoicePDF(inv, username){
      const pa = buildInvoicePrint(inv, username);
      const canvas = await html2canvas(pa, { scale: 2, useCORS:true, backgroundColor:"#ffffff" });
      const imgData = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const imgW = pageW;
      const imgH = canvas.height * (imgW / canvas.width);

      if(imgH <= pageH){
        pdf.addImage(imgData, "PNG", 0, 0, imgW, imgH);
      }else{
        let remaining = imgH;
        let position = 0;
        while(remaining > 0){
          pdf.addImage(imgData, "PNG", 0, position, imgW, imgH);
          remaining -= pageH;
          if(remaining > 0){
            pdf.addPage();
            position -= pageH;
          }
        }
      }

      const safeName = (safeText(inv.customer_name||inv.customer||"invoice")).replace(/[\\/:*?"<>|]/g,"-");
      pdf.save(`HAYEK_${safeName}_${last6(inv.id)}.pdf`);
    }

    let CURRENT_INV_USER_ID = null;
    let CURRENT_INV_USER_NAME = "";
    let CURRENT_INV_CACHE = [];

    function openInv(){ invBack.style.display="flex"; }
    function closeInv(){ invBack.style.display="none"; invBody.innerHTML=""; invSearch.value=""; }

    async function openUserInvoices(userId, username){
      CURRENT_INV_USER_ID = userId;
      CURRENT_INV_USER_NAME = username || "";
      invTitle.textContent = `فواتير المستخدم — ${CURRENT_INV_USER_NAME}`;
      invHint.textContent = `الفلاتر الحالية مطبّقة.`;
      invBody.innerHTML = `<div class="hint">جاري التحميل...</div>`;
      openInv();
      await loadUserInvoices();
    }

    async function loadUserInvoices(){
      try{
        const { fromIso, toIso } = currentFilterRange();
        // ✅ هنا كان user_id — صار owner_id
        let base = supabase.from(INVOICE_TABLE).select("*").eq("owner_id", CURRENT_INV_USER_ID).limit(400);
        if(fromIso) base = base.gte("created_at", fromIso);
        if(toIso)   base = base.lte("created_at", toIso);

        const { data, error } = await safeOrderQuery(base);
        if(error) throw error;

        CURRENT_INV_CACHE = data || [];
        renderUserInvoices();
      }catch(err){
        invBody.innerHTML = `<div class="error" style="display:block">${safeText(err?.message || JSON.stringify(err))}</div>`;
      }
    }

    function renderUserInvoices(){
      const s = invSearch.value.trim().toLowerCase();
      const rows = (CURRENT_INV_CACHE||[]).filter(inv=>{
        if(!s) return true;
        const id6 = last6(inv.id).toLowerCase();
        const cust = safeText(inv.customer_name || inv.customer).toLowerCase();
        return cust.includes(s) || id6.includes(s) || safeText(inv.id).toLowerCase().includes(s);
      });

      if(!rows.length){
        invBody.innerHTML = `<div class="hint">لا يوجد فواتير.</div>`;
        return;
      }

      invBody.innerHTML = rows.map(inv=>{
        const ops = pickOps(inv);
        const status = inv.status === "closed" ? "مغلقة" : "مفتوحة";
        const created = new Date(inv.created_at || Date.now()).toLocaleString("ar");
        const id6 = last6(inv.id);
        const cust = inv.customer_name || inv.customer || "";

        return `
          <div class="invItem" data-inv-id="${escHtml(inv.id)}">
            <div class="invTop">
              <div>
                <div class="invTitle">${escHtml(cust)} — <span class="muted">${escHtml(status)}</span></div>
                <div class="invMeta">
                  رقم الفاتورة: <b>${escHtml(id6)}</b> — الإجمالي: <b>${escHtml(inv.total||0)}</b><br/>
                  التاريخ: ${escHtml(created)}
                </div>
              </div>

              <div class="invBtns">
                <button class="btn small soft" data-act="toggle">عرض الفاتورة</button>
                <button class="btn small primary" data-act="pdf">تصدير الفاتورة PDF</button>
                <div class="pill"><b>${ops.length}</b> عمليات</div>
              </div>
            </div>

            <div class="invOps hide">
              <table>
                <thead>
                  <tr>
                    <th style="width:6%">#</th>
                    <th style="width:34%">البيان</th>
                    <th style="width:28%">العملية</th>
                    <th style="width:12%">النتيجة</th>
                    <th style="width:20%">الوقت</th>
                  </tr>
                </thead>
                <tbody>
                  ${
                    ops.slice(0, 200).map((o,i)=>`
                      <tr>
                        <td>${i+1}</td>
                        <td>${escHtml(o.label||"")}</td>
                        <td>${escHtml(o.expr||"")}</td>
                        <td>${escHtml(o.result||"")}</td>
                        <td>${escHtml(o.time||"")}</td>
                      </tr>
                    `).join("") || `<tr><td colspan="5" class="muted">لا يوجد عمليات</td></tr>`
                  }
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join("");
    }

    invBody.addEventListener("click", async (e)=>{
      const b = e.target.closest("button");
      if(!b) return;

      const wrap = b.closest(".invItem");
      if(!wrap) return;

      const invId = wrap.getAttribute("data-inv-id");
      const inv = (CURRENT_INV_CACHE||[]).find(x => String(x.id) === String(invId));
      if(!inv) return;

      const act = b.dataset.act;
      if(act === "toggle"){
        const box = wrap.querySelector(".invOps");
        box.classList.toggle("hide");
        return;
      }
      if(act === "pdf"){
        await exportInvoicePDF(inv, CURRENT_INV_USER_NAME);
        return;
      }
    });

    async function adminLogin(){
      clearBox(loginErr); clearBox(loginOk);

      const username = $("loginUser").value.trim();
      const password = $("loginPass").value.trim();
      if(!username || !password){
        showErr(loginErr, "اكتب اسم المستخدم وكلمة السر.");
        return;
      }

      const { data, error } = await supabase.from(USERS_TABLE).select("*").eq("username", username).limit(1);
      if(error){ showErr(loginErr, "خطأ Supabase:\n" + (error.message || JSON.stringify(error))); return; }
      if(!data?.length){ showErr(loginErr, "المستخدم غير موجود."); return; }

      const u = data[0];
      if(u.password !== password){ showErr(loginErr, "كلمة السر غير صحيحة."); return; }
      if(!u.is_admin){ showErr(loginErr, "هذا الحساب ليس أدمن."); return; }
      if(u.is_blocked){ showErr(loginErr, "هذا الأدمن محظور."); return; }

      ADMIN = u;
      localStorage.setItem("HAYEK_ADMIN_SESSION", JSON.stringify({ id:u.id }));
      loginCard.classList.add("hide");
      dashCard.classList.remove("hide");
      subTitle.textContent = "لوحة الإدارة";
      btnOpenAdd.classList.remove("hide");
      btnRefresh.classList.remove("hide");
      btnLogoutTop.classList.remove("hide");
      setSessionPill();
      showOk(loginOk, "تم تسجيل الدخول ✅");
      await applyAndRender();
    }

    function logout(){
      ADMIN = null;
      localStorage.removeItem("HAYEK_ADMIN_SESSION");
      dashCard.classList.add("hide");
      loginCard.classList.remove("hide");
      subTitle.textContent = "تسجيل دخول الأدمن";
      btnOpenAdd.classList.add("hide");
      btnRefresh.classList.add("hide");
      btnLogoutTop.classList.add("hide");
      setSessionPill();
    }

    async function restoreSession(){
      try{
        const s = JSON.parse(localStorage.getItem("HAYEK_ADMIN_SESSION") || "null");
        if(!s?.id) return;
        const { data } = await supabase.from(USERS_TABLE).select("*").eq("id", s.id).limit(1);
        if(data?.length && data[0].is_admin && !data[0].is_blocked){
          ADMIN = data[0];
          loginCard.classList.add("hide");
          dashCard.classList.remove("hide");
          subTitle.textContent = "لوحة الإدارة";
          btnOpenAdd.classList.remove("hide");
          btnRefresh.classList.remove("hide");
          btnLogoutTop.classList.remove("hide");
          setSessionPill();
          await applyAndRender();
        }
      }catch{}
    }

    function openAdd(){ addBack.style.display="flex"; clearBox(addErr); clearBox(addOk); }
    function closeAdd(){ addBack.style.display="none"; }

    async function addUser(){
      clearBox(addErr); clearBox(addOk);

      const username = $("newUsername").value.trim();
      const password = $("newPassword").value.trim();
      const full_name = $("newFullName").value.trim();
      const phone = $("newPhone").value.trim();
      const role = $("newRole").value;

      if(!username || !password){
        showErr(addErr, "اكتب اسم المستخدم وكلمة السر للمستخدم الجديد.");
        return;
      }

      const payload = {
        username, password,
        full_name: full_name || null,
        phone: phone || null,
        is_admin: role === "admin",
        is_blocked: false
      };

      const { error } = await supabase.from(USERS_TABLE).insert(payload);
      if(error){ showErr(addErr, "فشل إضافة المستخدم:\n" + (error.message || JSON.stringify(error))); return; }

      $("newUsername").value="";
      $("newPassword").value="";
      $("newFullName").value="";
      $("newPhone").value="";
      $("newRole").value="user";

      showOk(addOk, "تمت الإضافة ✅");
      closeAdd();
      await applyAndRender();
    }

    usersTbody.addEventListener("click", async (e)=>{
      const b = e.target.closest("button");
      if(!b) return;

      const act = b.dataset.act;
      const id  = b.dataset.id;
      const name = b.dataset.name || "";

      clearBox(dashErr); clearBox(dashOk);

      try{
        if(act === "del"){
          if(!confirm(`تأكيد حذف المستخدم: ${name} ؟`)) return;
          const { error } = await supabase.from(USERS_TABLE).delete().eq("id", id);
          if(error) throw error;
          showOk(dashOk, "تم الحذف ✅");
          await applyAndRender();
          return;
        }
        if(act === "block"){
          const { error } = await supabase.from(USERS_TABLE).update({ is_blocked:true }).eq("id", id);
          if(error) throw error;
          showOk(dashOk, "تم الحظر ✅");
          await applyAndRender();
          return;
        }
        if(act === "unblock"){
          const { error } = await supabase.from(USERS_TABLE).update({ is_blocked:false }).eq("id", id);
          if(error) throw error;
          showOk(dashOk, "تم فك الحظر ✅");
          await applyAndRender();
          return;
        }
        if(act === "wipeDevice"){
          showOk(dashOk, "تم (مسح الجهاز) ✅");
          return;
        }
        if(act === "makeAdmin"){
          const { error } = await supabase.from(USERS_TABLE).update({ is_admin:true }).eq("id", id);
          if(error) throw error;
          showOk(dashOk, "تم تحويله لأدمن ✅");
          await applyAndRender();
          return;
        }
        if(act === "makeUser"){
          const { error } = await supabase.from(USERS_TABLE).update({ is_admin:false }).eq("id", id);
          if(error) throw error;
          showOk(dashOk, "تم تحويله لمستخدم ✅");
          await applyAndRender();
          return;
        }
        if(act === "invoices"){
          await openUserInvoices(id, name);
          return;
        }
      }catch(err){
        showErr(dashErr, "خطأ:\n" + (err?.message || JSON.stringify(err)));
      }
    });

    rangeChips.addEventListener("click", (e)=>{
      const c = e.target.closest(".chip");
      if(!c) return;
      [...rangeChips.querySelectorAll(".chip")].forEach(x=>x.classList.remove("active"));
      c.classList.add("active");
      RANGE_DAYS = c.dataset.range;
      fromDate.value=""; toDate.value="";
    });

    btnApply.addEventListener("click", applyAndRender);
    btnRefresh.addEventListener("click", applyAndRender);

    let searchTimer=null;
    qSearch.addEventListener("input", ()=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=> applyAndRender(), 250);
    });

    btnOpenAdd.addEventListener("click", openAdd);
    btnCloseAdd.addEventListener("click", closeAdd);
    addBack.addEventListener("click", (e)=>{ if(e.target === addBack) closeAdd(); });
    $("btnAddUser").addEventListener("click", addUser);

    btnCloseInv.addEventListener("click", closeInv);
    invBack.addEventListener("click", (e)=>{ if(e.target === invBack) closeInv(); });
    btnInvRefresh.addEventListener("click", loadUserInvoices);
    invSearch.addEventListener("input", renderUserInvoices);

    btnLogoutTop.addEventListener("click", logout);

    $("btnLogin").addEventListener("click", adminLogin);
    $("btnClear").addEventListener("click", ()=>{
      $("loginUser").value=""; $("loginPass").value="";
      clearBox(loginErr); clearBox(loginOk);
    });

    setSessionPill();
    restoreSession();
  </script>
</body>
</html>
