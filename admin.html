<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111315" />
  <title>HAYEK SPOT | Admin</title>

  <style>
    :root{
      --white:#fff; --green:#19C37D; --yellow:#D6A628; --red:#ff505a;
      --bg:#5F6368; --black:#111315; --dark:#2F3337;
      --line: rgba(255,255,255,.18);
      --text:#fff; --muted: rgba(255,255,255,.78);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Arabic","Noto Naskh Arabic",sans-serif;
      display:flex;justify-content:center;padding:16px;
    }
    .wrap{width:min(980px,100%);display:grid;gap:12px}

    .top{
      background: linear-gradient(180deg, rgba(17,19,21,.95), rgba(47,51,55,.95));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .brand{display:grid;gap:4px}
    .brand b{font-size:16px;letter-spacing:.4px}
    .brand span{font-size:12px;color:var(--muted)}
    .pill{
      font-size:12px;font-weight:1000;padding:7px 10px;border-radius:999px;
      background: var(--yellow); color: var(--black);
      white-space:nowrap;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .grid2{display:grid;grid-template-columns: 1fr 1.25fr; gap:12px}
    @media (max-width: 900px){
      .grid2{grid-template-columns: 1fr}
    }

    .sec{padding:14px;display:grid;gap:10px}
    .sec h2{margin:0;font-size:14px}
    .note{font-size:12px;color:var(--muted);line-height:1.7}

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width: 520px){
      .row2,.row3{grid-template-columns:1fr}
    }

    .field{display:grid;gap:6px}
    .field label{font-size:12px;color:var(--muted);font-weight:1000}

    input, select{
      width:100%;padding:12px 12px;border-radius:16px;border:1px solid var(--line);
      background: rgba(17,19,21,.45); color: var(--text); outline:none; font-size:14px;
    }
    input:focus,select:focus{border-color: rgba(25,195,125,.55); box-shadow: 0 0 0 4px rgba(25,195,125,.18)}

    .btn{
      user-select:none;border:1px solid var(--line);background: rgba(255,255,255,.10);
      color: var(--text);padding:12px 12px;border-radius:16px;font-weight:1000;font-size:14px;
      cursor:pointer;touch-action:manipulation;
    }
    .btn.green{background: rgba(25,195,125,.22); border-color: rgba(25,195,125,.45)}
    .btn.yellow{background: rgba(214,166,40,.20); border-color: rgba(214,166,40,.45); color: var(--black)}
    .btn.red{background: rgba(255,80,90,.18); border-color: rgba(255,80,90,.35)}
    .btn.gray{background: rgba(255,255,255,.08)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .toolbar .btn{padding:10px 12px; font-size:13px}

    table{
      width:100%;
      border-collapse:collapse;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--line);
      background: rgba(17,19,21,.25);
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.12);
      font-size:13px;
      text-align:right;
      color: var(--text);
    }
    th{color:var(--muted);font-weight:1000}
    td.num{text-align:left;direction:ltr;font-weight:1000}
    tr:last-child td{border-bottom:none}

    .badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color:#fff;
      white-space:nowrap;
    }
    .badge.g{border-color: rgba(25,195,125,.55); background: rgba(25,195,125,.18)}
    .badge.r{border-color: rgba(255,80,90,.45); background: rgba(255,80,90,.16)}
    .badge.y{border-color: rgba(214,166,40,.55); background: rgba(214,166,40,.16); color:#111315}

    .totalBox{
      display:grid;
      gap:8px;
    }
    .totalLine{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px;
      border:1px dashed rgba(255,255,255,.22);
      border-radius:16px;
      background: rgba(255,255,255,.06);
      font-weight:1000;
      color:#fff;
    }
    .totalLine span:last-child{direction:ltr}

    /* Admin login */
    #adminApp{display:none}
    .center{padding:14px; display:grid; gap:10px}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="brand">
        <b>HAYEK SPOT — Admin</b>
        <span>لوحة إدارة الفواتير والمستخدمين</span>
      </div>
      <div class="pill" id="pill">مغلق</div>
    </div>

    <!-- ✅ Admin Login (ضروري) -->
    <div class="card" id="adminLoginCard">
      <div class="center">
        <h2 style="margin:0;font-size:14px">دخول الأدمن</h2>
        <div class="row2">
          <div class="field">
            <label>اسم الأدمن</label>
            <input id="adminUser" placeholder="مثال: admin" autocomplete="username" />
          </div>
          <div class="field">
            <label>كلمة السر</label>
            <input id="adminPass" type="password" placeholder="••••" autocomplete="current-password" />
          </div>
        </div>

        <div class="row2">
          <button class="btn green" id="adminLoginBtn">دخول</button>
          <button class="btn yellow" id="goIndexBtn">رجوع للحاسبة</button>
        </div>

        <div class="note" id="adminNote">
          ✅ هذه الصفحة لا تعمل إلا للأدمن الحقيقي (is_admin = true).<br>
          ✅ إذا دخل مستخدم عادي بالخطأ لن تظهر له أي بيانات.
        </div>
      </div>
    </div>

    <!-- ✅ Admin App -->
    <div class="grid2" id="adminApp">

      <!-- Users -->
      <div class="card">
        <div class="sec">
          <h2>المستخدمين</h2>

          <div class="row3">
            <div class="field">
              <label>اسم المستخدم</label>
              <input id="newUsername" placeholder="مثال: محمود" />
            </div>
            <div class="field">
              <label>كلمة السر</label>
              <input id="newPass" placeholder="مثال: 123456" />
            </div>
            <div class="field">
              <label>صلاحية</label>
              <select id="newIsAdmin">
                <option value="false">User</option>
                <option value="true">Admin</option>
              </select>
            </div>
          </div>

          <div class="toolbar">
            <button class="btn gray" id="genPass">توليد كلمة سر</button>
            <button class="btn green" id="addUser">إضافة مستخدم</button>
            <button class="btn" id="refreshUsers">تحديث</button>
          </div>

          <div class="row2">
            <div class="field">
              <label>بحث</label>
              <input id="searchUser" placeholder="ابحث بالاسم…" />
            </div>
            <div class="field">
              <label>صفحات</label>
              <div class="toolbar">
                <button class="btn" id="prevUsers">السابق</button>
                <button class="btn" id="nextUsers">التالي</button>
              </div>
            </div>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>اسم</th>
                  <th class="num">السر</th>
                  <th>Admin</th>
                  <th>الحالة</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody id="usersTbody"></tbody>
            </table>
          </div>

          <div class="note">ملاحظة: الحظر يطبق فوراً على المستخدم عند التحقق الدوري.</div>
        </div>
      </div>

      <!-- Invoices -->
      <div class="card">
        <div class="sec">
          <h2>الفواتير</h2>

          <div class="row2">
            <div class="field">
              <label>اختر المستخدم</label>
              <select id="userSelect">
                <option value="">— اختر المستخدم —</option>
              </select>
            </div>
            <div class="field">
              <label>فلترة تاريخ (اختياري)</label>
              <div class="row2" style="gap:8px">
                <input id="fromDate" type="date" />
                <input id="toDate" type="date" />
              </div>
            </div>
          </div>

          <div class="toolbar">
            <button class="btn" id="quickToday">اليوم</button>
            <button class="btn" id="quick7">آخر 7 أيام</button>
            <button class="btn" id="clearDates">مسح الفلاتر</button>
            <button class="btn green" id="loadInvoicesBtn">تحميل فواتير المستخدم</button>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>اسم العميل</th>
                  <th class="num">الإجمالي</th>
                  <th>الحالة</th>
                  <th>إجراء</th>
                </tr>
              </thead>
              <tbody id="invoicesTbody"></tbody>
            </table>
          </div>

          <!-- Invoice Details -->
          <div class="card" id="invoiceCard" style="margin-top:12px">
            <div class="sec">
              <h2>تفاصيل الفاتورة المختارة</h2>
              <div class="toolbar" id="invoiceMeta"></div>

              <div class="toolbar">
                <button class="btn yellow" id="printInvoiceBtn">طباعة / PDF (نظيف)</button>
                <button class="btn red" id="deleteInvoiceBtn">حذف الفاتورة</button>
                <button class="btn red" id="archiveDeleteBtn">أرشفة PDF ثم حذف</button>
              </div>

              <div style="overflow:auto">
                <table>
                  <thead>
                    <tr>
                      <th>الوقت</th>
                      <th>البيان</th>
                      <th class="num">العملية</th>
                      <th class="num">النتيجة</th>
                    </tr>
                  </thead>
                  <tbody id="opsTbody"></tbody>
                </table>
              </div>

              <div class="totalBox" style="margin-top:10px">
                <div class="totalLine">
                  <span>إجمالي الفاتورة:</span>
                  <span id="grandTotal">0</span>
                </div>
                <div id="totalsByLabel"></div>
              </div>

              <div class="row2" style="margin-top:10px">
                <div class="field">
                  <label>تأكيد (اكتب Invoice ID للحذف)</label>
                  <input id="confirmInvoiceId" placeholder="الصق Invoice ID هنا للتأكيد" style="direction:ltr" />
                </div>
                <div class="field">
                  <label>حذف كل بيانات هذا المستخدم (اختياري)</label>
                  <button class="btn red" id="deleteAllUserOpsBtn">حذف كل فواتير المستخدم</button>
                </div>
              </div>

              <div class="note">⚠️ الحذف نهائي. الأرشفة = طباعة PDF ثم حذف.</div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- ✅ admin.js لازم يكون آخر شي + كسر كاش -->
  <script src="./admin.js?v=999"></script>
</body>
</html>
