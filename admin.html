<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>HAYEK SPOT — لوحة الأمن</title>

  <link rel="stylesheet" href="./style.css?v=8000" />

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- خط Amiri (عندك الملفات بالمشروع) -->
  <script src="./amiri-font.js?v=8000"></script>

  <!-- Config -->
  <script src="./config.js?v=8000"></script>
</head>

<body class="app-body">
  <div class="app-wrap">

    <div class="card header-card">
      <div class="header-title">لوحة الأمن</div>
      <div class="header-sub">إدارة المستخدمين والفواتير — مع قفل الجهاز الواحد (device_id) للأمن.</div>
      <div class="status-line" id="statusLine">الحالة: جاهز</div>
    </div>

    <!-- تسجيل دخول الأدمن -->
    <div class="card">
      <div class="card-title">تسجيل الدخول (Admin)</div>

      <div class="grid-2">
        <div class="field">
          <label>اسم المستخدم</label>
          <input id="adminUser" type="text" value="admin" autocomplete="username" />
        </div>
        <div class="field">
          <label>كلمة السر</label>
          <input id="adminPass" type="password" autocomplete="current-password" />
        </div>
      </div>

      <div class="btn-row">
        <button class="btn primary" id="btnAdminLogin">تسجيل دخول</button>
        <button class="btn" id="btnAdminLogout">تسجيل خروج</button>
        <div class="pill" id="adminStatePill">غير مسجل</div>
      </div>

      <div class="note warn">
        ✅ الأدمن يقفل على جهاز واحد فقط (إذا سجل من جهاز ثاني سيتم رفض الدخول).
      </div>
    </div>

    <!-- إدارة المستخدمين -->
    <div class="card">
      <div class="card-title">إدارة المستخدمين</div>

      <div class="grid-3">
        <div class="field">
          <label>اسم مستخدم جديد</label>
          <input id="newUsername" type="text" placeholder="مثال: محمود" />
        </div>
        <div class="field">
          <label>كلمة السر</label>
          <input id="newPassword" type="text" placeholder="1234" />
        </div>
        <div class="field">
          <label>صلاحية</label>
          <select id="newRole">
            <option value="user">مستخدم</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn green" id="btnAddUser">إضافة</button>
        <button class="btn" id="btnRefreshUsers">تحديث قائمة المستخدمين</button>
        <div class="pill">عدد المستخدمين: <span id="usersCount">0</span></div>
      </div>

      <div class="table-wrap">
        <table class="tbl" id="usersTable">
          <thead>
            <tr>
              <th>#</th>
              <th>المستخدم</th>
              <th>Admin</th>
              <th>محظور</th>
              <th>قفل الجهاز</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- فلاتر الفواتير -->
    <div class="card">
      <div class="card-title">فلاتر الفواتير</div>

      <div class="grid-4">
        <div class="field">
          <label>اختر المستخدم</label>
          <select id="pickUser">
            <option value="">— اختر —</option>
          </select>
        </div>

        <div class="field">
          <label>الحالة</label>
          <select id="pickStatus">
            <option value="">الكل</option>
            <option value="منتهية">منتهية</option>
            <option value="مفتوحة">مفتوحة</option>
          </select>
        </div>

        <div class="field">
          <label>من تاريخ</label>
          <input id="fromDate" type="date" />
        </div>

        <div class="field">
          <label>إلى تاريخ</label>
          <input id="toDate" type="date" />
        </div>
      </div>

      <div class="btn-row">
        <button class="btn" id="btnToday">فواتير اليوم</button>
        <button class="btn" id="btnLast7">فواتير آخر 7 أيام</button>
        <button class="btn primary" id="btnLoadInvoices">اعرض الفواتير</button>
        <div class="pill">عدد النتائج: <span id="invCount">0</span></div>
      </div>

      <!-- قائمة منسدلة للفواتير -->
      <div class="grid-2">
        <div class="field">
          <label>اختر فاتورة من القائمة</label>
          <select id="invoiceSelect">
            <option value="">— اختر فاتورة —</option>
          </select>
        </div>

        <div class="field">
          <label>إجراءات الفاتورة</label>
          <div class="btn-row">
            <button class="btn" id="btnOpenInvoice">فتح</button>
            <button class="btn green" id="btnExportInvoicePdf">تصدير PDF</button>
          </div>
        </div>
      </div>

      <!-- معاينة مختصرة -->
      <div class="invoice-preview" id="invoicePreview">
        <div class="muted">اختر فاتورة لعرض التفاصيل…</div>
      </div>
    </div>

  </div>

  <script src="./admin.js?v=8000"></script>
</body>
</html>
