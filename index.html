<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111315" />
  <title>HAYEK SPOT | نظام المحاسبة الذكي</title>

  <style>
    :root{
      --white:#FFFFFF; --green:#19C37D; --gray:#5F6368; --dark:#2F3337; --black:#111315; --yellow:#D6A628;
      --bg: var(--gray);
      --line: rgba(255,255,255,.18);
      --text: var(--white);
      --muted: rgba(255,255,255,.78);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Arabic","Noto Naskh Arabic",sans-serif;
      display:flex;justify-content:center;padding:16px
    }
    .wrap{width:min(440px,100%);display:grid;gap:12px}

    .top{
      background: linear-gradient(180deg, rgba(17,19,21,.95), rgba(47,51,55,.95));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{display:grid;gap:4px}
    .brand b{font-size:16px;letter-spacing:.4px}
    .brand span{font-size:12px;color:var(--muted)}
    .pill{
      font-size:12px;font-weight:1000;padding:7px 10px;border-radius:999px;
      background: var(--yellow); color: var(--black);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* LOGIN */
    .login{padding:14px;display:grid;gap:10px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:grid;gap:6px}
    .field label{font-size:12px;color:var(--muted);font-weight:1000}
    input{
      width:100%;padding:12px 12px;border-radius:16px;border:1px solid var(--line);
      background: rgba(17,19,21,.45); color: var(--text); outline:none; font-size:14px
    }
    input:focus{border-color: rgba(25,195,125,.55); box-shadow: 0 0 0 4px rgba(25,195,125,.18)}
    .btn{
      user-select:none;border:1px solid var(--line);background: rgba(255,255,255,.10);
      color: var(--text);padding:12px 12px;border-radius:16px;font-weight:1000;font-size:14px;
      cursor:pointer;touch-action:manipulation
    }
    .btn.green{background: rgba(25,195,125,.22); border-color: rgba(25,195,125,.45)}
    .btn.yellow{background: rgba(214,166,40,.20); border-color: rgba(214,166,40,.45); color: var(--black)}
    .btn.red{background: rgba(255,80,90,.18); border-color: rgba(255,80,90,.35)}
    .note{font-size:12px;color:var(--muted);line-height:1.7}

    /* APP */
    .app{display:none}
    .screen{padding:14px;border-bottom:1px solid var(--line)}
    .display{
      background: rgba(17,19,21,.55);
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px 14px;
      display:grid; gap:6px;
      position: relative; /* مهم للـ mobileInput */
    }
    .expr{font-size:13px;color:var(--muted);min-height:18px;text-align:left;direction:ltr}
    .result{font-size:30px;font-weight:1000;text-align:left;direction:ltr}
    .labelWrap{margin-top:10px;display:grid;gap:6px}
    .labelWrap .t{font-size:12px;color:var(--muted);font-weight:1000}

    .keys{padding:14px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .key{
      padding:14px 10px;border-radius:18px;border:1px solid var(--line);
      background: rgba(255,255,255,.10);
      font-weight:1000;font-size:16px;cursor:pointer;touch-action:manipulation;
      display:flex;align-items:center;justify-content:center;min-height:52px
    }
    .key.op{background: rgba(214,166,40,.18); border-color: rgba(214,166,40,.45)}
    .key.eq{background: rgba(25,195,125,.25); border-color: rgba(25,195,125,.55)}
    .key.warn{background: rgba(255,255,255,.14)}
    .key.danger{background: rgba(255,80,90,.18); border-color: rgba(255,80,90,.35)}

    .footer{padding:14px;display:grid;gap:10px;border-top:1px solid var(--line);background: rgba(17,19,21,.30)}
    .bigline{
      width:90%;justify-self:center;padding:14px 12px;border-radius:18px;border:1px solid var(--line);
      background: rgba(255,255,255,.10);font-weight:1000;cursor:pointer;touch-action:manipulation
    }

    .log{padding:14px;display:grid;gap:10px;border-top:1px solid var(--line)}
    .log h3{margin:0;font-size:14px}
    table{width:100%;border-collapse:collapse;border-radius:16px;overflow:hidden;border:1px solid var(--line);background: rgba(17,19,21,.25)}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.12);font-size:13px;text-align:right}
    th{color:var(--muted);font-weight:1000}
    td.num{text-align:left;direction:ltr;font-weight:1000}
    tr:last-child td{border-bottom:none}
    .total{
      display:flex;justify-content:space-between;align-items:center;padding:10px 12px;
      border:1px dashed rgba(255,255,255,.22);border-radius:16px;background: rgba(255,255,255,.06);
      font-weight:1000
    }
    .total span:last-child{direction:ltr}

    /* ✅ PDF Styling */
    @media print{
      body{
        background:#fff;
        color:#000;
        padding:0;
        font-family: "Amiri", serif;
      }
      .top,.login,.keys,.footer,.btn,.pill{
        display:none !important;
      }
      .wrap{width:100%}
      .card{box-shadow:none;border:none}
      .screen{border:none}
      h3{
        color:#111;
        border-bottom:2px solid #000;
        padding-bottom:6px;
      }
      table{
        width:100%;
        border-collapse:collapse;
        margin-top:10px;
        border:1px solid #000;
      }
      th{
        background:#f0f0f0;
        color:#000;
        font-weight:900;
        border:1px solid #000;
      }
      td{
        border:1px solid #999;
        padding:8px;
      }
      tr:nth-child(even){
        background:#fafafa;
      }
      .total{
        margin-top:12px;
        font-size:16px;
        font-weight:900;
        border:2px dashed #000;
        background:#fff;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <b>HAYEK SPOT</b>
        <span>نظام المحاسبة الذكي © 2026</span>
      </div>
      <div class="pill" id="statusPill">مقفل</div>
    </div>

    <!-- LOGIN (User) -->
    <div class="card login" id="loginCard">
      <div class="row2">
        <div class="field">
          <label>اسم المستخدم</label>
          <input id="username" placeholder="مثال: محمود" />
        </div>
        <div class="field">
          <label>كلمة السر</label>
          <input id="password" type="password" placeholder="••••" />
        </div>
      </div>

      <div class="row2">
        <button class="btn green" id="loginBtn">دخول</button>
        <button class="btn yellow" id="adminBtn">الأدمن</button>
      </div>

      <div class="note" id="loginNote">
        ✅ الدخول يعتمد على قاعدة البيانات (Supabase) ويعمل من أي جهاز.<br>
        ✅ إذا كان المستخدم محظور، لن يتمكن من الدخول.
      </div>
    </div>

    <!-- APP -->
    <div class="card app" id="appCard">
      <div class="screen">
        <div class="display" id="displayTapArea">
          <div class="expr" id="expr">0</div>
          <div class="result" id="res">0</div>

          <!-- ✅ كيبورد الهاتف للأرقام (مخفي) -->
          <input id="mobileInput" inputmode="decimal" autocomplete="off"
                 style="opacity:0; position:absolute; pointer-events:none; left:-9999px; top:-9999px;">
        </div>

        <div class="labelWrap">
          <div class="t">البيان (اختياري) — يضاف بجانب العملية</div>
          <input id="labelInput" placeholder="مثال: دفعة زبون / مصروف / فاتورة..." />
        </div>
      </div>

      <!-- Keypad -->
      <div class="keys" id="keys">
        <button class="key warn" data-k="C">C</button>
        <button class="key warn" data-k="CE">CE</button>
        <button class="key warn" data-k="BK">⌫</button>
        <button class="key op" data-k="/">÷</button>

        <button class="key" data-k="7">7</button>
        <button class="key" data-k="8">8</button>
        <button class="key" data-k="9">9</button>
        <button class="key op" data-k="*">×</button>

        <button class="key" data-k="4">4</button>
        <button class="key" data-k="5">5</button>
        <button class="key" data-k="6">6</button>
        <button class="key op" data-k="-">−</button>

        <button class="key" data-k="1">1</button>
        <button class="key" data-k="2">2</button>
        <button class="key" data-k="3">3</button>
        <button class="key op" data-k="+">+</button>

        <button class="key" data-k="0">0</button>
        <button class="key" data-k=".">.</button>

        <!-- ✅ = يأخذ مكان زرين -->
        <button class="key eq" data-k="=" style="grid-column: span 2; font-size:20px;">=</button>
      </div>

      <div class="footer">
        <button class="bigline" id="newlineBtn">طف السطر (تسجيل العملية)</button>

        <div class="row2">
          <button class="btn" id="copyTableBtn">نسخ سجل كجدول</button>
          <button class="btn" id="copyResBtn">نسخ النتيجة</button>
        </div>

        <div class="row2">
          <button class="btn green" id="pdfBtn">تصدير PDF</button>
          <button class="btn red" id="clearLogBtn">مسح السجل</button>
        </div>
      </div>

      <div class="log">
        <!-- ✅ عنوان أعلى الـ PDF -->
        <div style="text-align:center; font-size:20px; font-weight:900; margin-bottom:10px;">
          شركة الحايك<br>
          <span style="font-size:14px;">HAYEK SPOT</span>
        </div>

        <h3>سجل العمليات</h3>
        <table>
          <thead>
            <tr>
              <th>البيان</th>
              <th class="num">العملية</th>
              <th class="num">النتيجة</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="total">
          <span>إجمالي الكشف:</span>
          <span id="grandTotal">0</span>
        </div>

        <!-- ✅ نص النهاية الجديد -->
        <div style="margin-top:12px; font-size:12px; line-height:1.8; color:var(--muted);">
          تم تطوير هذه الحاسبة الاحترافية من قبل شركة الحايك<br>
          شركة الحايك / تجارة عامة / توزيع جملة / دعاية و اعلان / طباعة / حلول رقمية /<br>
          05510217646
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // =========================
  // ✅ Supabase (مفاتيحك داخل الكود)
  // =========================
  const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
  const SUPABASE_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";
  const REST = `${SUPABASE_URL}/rest/v1`;

  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const VIBRATE_MS = 12;
  const vibe = () => { try { navigator.vibrate?.(VIBRATE_MS); } catch(_){} };

  const toast = (msg) => {
    const d = document.createElement("div");
    d.textContent = msg;
    Object.assign(d.style, {
      position:"fixed", bottom:"18px", left:"50%",
      transform:"translateX(-50%)",
      background:"rgba(17,19,21,.85)",
      color:"#fff", padding:"10px 14px",
      borderRadius:"14px", fontWeight:"1000",
      zIndex:9999, backdropFilter:"blur(8px)",
      border:"1px solid rgba(255,255,255,.18)"
    });
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 1400);
  };

  const apiFetch = async (path, options = {}) => {
    const res = await fetch(`${REST}${path}`, {
      ...options,
      headers: {
        "apikey": SUPABASE_KEY,
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json",
        "Accept": "application/json",
        ...(options.headers || {})
      }
    });
    if (!res.ok) {
      const t = await res.text().catch(()=> "");
      throw new Error(`API ${res.status}: ${t || res.statusText}`);
    }
    const text = await res.text();
    return text ? JSON.parse(text) : null;
  };

  // =========================
  // Session
  // =========================
  const K_SESSION = "hs_session_v2";
  const saveSession = (obj) => localStorage.setItem(K_SESSION, JSON.stringify(obj));
  const loadSession = () => { try { return JSON.parse(localStorage.getItem(K_SESSION) || "null"); } catch { return null; } };
  const clearSession = () => localStorage.removeItem(K_SESSION);

  // =========================
  // UI refs
  // =========================
  const statusPill = $("statusPill");
  const loginCard  = $("loginCard");
  const appCard    = $("appCard");

  const usernameEl = $("username");
  const passwordEl = $("password");
  const labelInput = $("labelInput");

  const exprEl = $("expr");
  const resEl  = $("res");
  const tbody  = $("tbody");
  const grandTotalEl = $("grandTotal");

  const mobileInput = $("mobileInput");
  const displayTapArea = $("displayTapArea");

  const setLocked = (locked) => {
    statusPill.textContent = locked ? "مقفل" : "مفتوح";
    statusPill.style.background = locked ? "var(--yellow)" : "var(--green)";
    statusPill.style.color = "var(--black)";
    loginCard.style.display = locked ? "grid" : "none";
    appCard.style.display = locked ? "none" : "block";
  };

  // =========================
  // Auth (Supabase table: app_users)
  // =========================
  const loginUser = async (username, pass) => {
    const u = (username || "").trim();
    const p = (pass || "").trim();
    if (!u || !p) { toast("اكتب الاسم وكلمة السر"); return; }

    const q =
      `?select=id,username,is_admin,blocked` +
      `&username=eq.${encodeURIComponent(u)}` +
      `&pass=eq.${encodeURIComponent(p)}` +
      `&limit=1`;

    const rows = await apiFetch(`/app_users${q}`, { method:"GET" });
    const user = Array.isArray(rows) ? rows[0] : null;

    if (!user) { toast("الاسم أو كلمة المرور غير صحيحة"); return; }
    if (user.blocked) { toast("هذا المستخدم محظور ❌"); return; }

    saveSession({ id: user.id, username: user.username, is_admin: !!user.is_admin, ts: Date.now() });
    setLocked(false);
    toast("تم الدخول ✅");
  };

  const logoutUser = () => {
    vibe();
    clearSession();
    setLocked(true);
    toast("تم تسجيل الخروج");
  };

  // =========================
  // Calculator + Log (local)
  // =========================
  const K_LOG = "hs_calc_log_v2";
  let expr = "";
  let lastResult = 0;
  let log = loadLog();

  function loadLog(){ try { return JSON.parse(localStorage.getItem(K_LOG) || "[]"); } catch { return []; } }
  function saveLog(){ localStorage.setItem(K_LOG, JSON.stringify(log)); }

  function formatNumber(n){
    const x = Number(n);
    if (!Number.isFinite(x)) return "0";
    const s = x.toString();
    return s.includes(".") ? x.toFixed(6).replace(/0+$/,"").replace(/\.$/,"") : s;
  }
  function safeEval(expression){
    if (!/^[0-9+\-*/().\s]+$/.test(expression)) return null;
    try{
      // eslint-disable-next-line no-new-func
      const fn = Function(`"use strict"; return (${expression});`);
      const val = fn();
      return Number.isFinite(val) ? val : null;
    }catch{ return null; }
  }

  function render(){
    exprEl.textContent = expr.trim() ? expr : "0";
    const calc = safeEval(expr);
    resEl.textContent = calc === null ? formatNumber(lastResult) : formatNumber(calc);

    tbody.innerHTML = "";
    let total = 0;

    for (const row of log){
      const tr = document.createElement("tr");

      const td1 = document.createElement("td");
      td1.textContent = row.label || "عملية";

      const td2 = document.createElement("td");
      td2.className = "num";
      td2.textContent = row.op;

      const td3 = document.createElement("td");
      td3.className = "num";
      td3.textContent = row.result;

      tr.append(td1, td2, td3);
      tbody.appendChild(tr);

      const r = Number(row.result);
      if (Number.isFinite(r)) total += r;
    }
    grandTotalEl.textContent = formatNumber(total);
    saveLog();
  }

  function newlineCommit(){
    const clean = expr.trim();
    if (!clean) return;

    const val = safeEval(clean);
    if (val === null) return;

    lastResult = val;

    const label = (labelInput.value || "").trim() || "عملية";

    log.unshift({
      label,
      op: clean.replace(/\*/g,"×").replace(/\//g,"÷"),
      result: formatNumber(val),
      ts: Date.now()
    });

    expr = "";
    labelInput.value = "";
    render();
  }

  function clearAll(){ expr=""; lastResult=0; render(); }
  function backspace(){ expr = expr.slice(0,-1); render(); }
  function clearEntry(){
    const m = expr.match(/^(.*?)([+\-*/])\s*[^+\-*/]*$/);
    expr = m ? (m[1] + m[2] + " ") : "";
    render();
  }
  function appendChar(ch){ expr += ch; render(); }

  const onKey = (k) => {
    vibe();
    if (k === "C") return clearAll();
    if (k === "CE") return clearEntry();
    if (k === "BK") return backspace();
    if (k === "=") return newlineCommit();
    if (k === "LOGOUT") return logoutUser();

    if (["/","*","-","+"].includes(k)){
      if (!expr.trim()) return;
      if (/[+\-*/]\s*$/.test(expr)) expr = expr.replace(/[+\-*/]\s*$/,"");
      expr += ` ${k} `;
      return render();
    }

    if (k === "."){
      const lastChunk = expr.split(/[+\-*/]/).pop() ?? "";
      if (lastChunk.includes(".")) return;
    }

    appendChar(k);
  };

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      toast("تم النسخ ✅");
    }catch{
      const ta = document.createElement("textarea");
      ta.value = text; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("تم النسخ ✅");
    }
  }

  function logAsTSV(){
    const header = ["البيان","العملية","النتيجة"].join("\t");
    const rows = log.map(r => [r.label, r.op, r.result].join("\t"));
    return [header, ...rows, `إجمالي الكشف:\t\t${grandTotalEl.textContent}`].join("\n");
  }

  // =========================
  // ✅ كيبورد الهاتف للأرقام
  // =========================
  function focusMobileKeyboard(){
    try{
      mobileInput.focus({ preventScroll:true });
    }catch{
      mobileInput.focus();
    }
  }

  // لمس/نقر على شاشة العرض يفتح كيبورد الأرقام
  displayTapArea.addEventListener("click", focusMobileKeyboard, { passive:true });
  displayTapArea.addEventListener("touchstart", focusMobileKeyboard, { passive:true });

  // استقبال أرقام الكيبورد
  mobileInput.addEventListener("input", () => {
    const v = (mobileInput.value || "").replace(/[^0-9.]/g, "");
    if (v) appendChar(v);
    mobileInput.value = "";
  });

  // =========================
  // Events
  // =========================
  $("loginBtn").addEventListener("click", async () => {
    vibe();
    try{
      await loginUser(usernameEl.value, passwordEl.value);
      // بعد الدخول افتح كيبورد الأرقام
      setTimeout(focusMobileKeyboard, 150);
    }catch(e){
      toast("خطأ اتصال بقاعدة البيانات");
      console.error(e);
    }
  }, { passive:true });

  $("adminBtn").addEventListener("click", () => {
    vibe();
    location.href = "./admin.html";
  }, { passive:true });

  $("keys").addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-k]");
    if (!btn) return;
    onKey(btn.dataset.k);
  }, { passive:true });

  $("newlineBtn").addEventListener("click", () => { vibe(); newlineCommit(); }, { passive:true });
  $("copyTableBtn").addEventListener("click", () => { vibe(); copyText(logAsTSV()); }, { passive:true });
  $("copyResBtn").addEventListener("click", () => { vibe(); copyText(resEl.textContent); }, { passive:true });
  $("pdfBtn").addEventListener("click", () => { vibe(); window.print(); }, { passive:true });
  $("clearLogBtn").addEventListener("click", () => { vibe(); log=[]; render(); toast("تم مسح السجل"); }, { passive:true });

  window.addEventListener("keydown", (e) => {
    const map = { "Enter":"=", "Backspace":"BK", "Escape":"C", "/":"/", "*":"*", "-":"-", "+":"+",
                  ".":"." };
    if (e.key >= "0" && e.key <= "9") return onKey(e.key);
    if (map[e.key]) return onKey(map[e.key]);
  });

  // Boot
  const sess = loadSession();
  setLocked(!sess);
  render();
</script>
</body>
</html>
