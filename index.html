<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HAYEK SPOT — تسجيل الدخول</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --bg:#071820; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.12); --txt:#eaf4ff; --mut:#a7bdd0; --blue:#1f62ff; --danger:#ff6b6b; }
    body{margin:0;min-height:100vh;background:radial-gradient(1200px 600px at 30% 20%, #0f3a3f 0%, var(--bg) 55%);color:var(--txt);display:flex;align-items:center;justify-content:center;padding:16px;font-family:system-ui}
    .card{width:min(500px,100%);background:var(--panel);border:1px solid var(--line);border-radius:22px;padding:25px;backdrop-filter:blur(10px)}
    input{width:100%;padding:14px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.2);color:#fff;margin-bottom:15px;outline:none}
    .btn{width:100%;padding:14px;border-radius:12px;border:none;cursor:pointer;font-weight:bold;margin-top:10px}
    .blue{background:var(--blue);color:#fff}
    .err{color:var(--danger);font-size:13px;text-align:center;margin-top:10px}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 20px">تسجيل الدخول</h2>
    <input id="u" placeholder="اسم المستخدم">
    <input id="p" type="password" placeholder="كلمة السر">
    <button class="btn blue" id="loginBtn">دخول للنظام</button>
    <div class="err" id="err"></div>
  </div>

  <script src="./auth.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    
    // إعداداتك من صورة config.js
    const SB_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
    const SB_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";
    const sb = supabase.createClient(SB_URL, SB_KEY);

    $("loginBtn").onclick = async () => {
      $("err").textContent = "";
      const user = $("u").value.trim();
      const pass = $("p").value.trim();
      
      if(!user || !pass) { $("err").textContent = "أدخل البيانات"; return; }

      try {
        // البحث باستخدام عمود username المحدث
        const { data, error } = await sb
          .from('app_users')
          .select('*')
          .eq('username', user)
          .single();

        if (error || !data) { $("err").textContent = "المستخدم غير موجود"; return; }
        if (String(data.pass) !== pass) { $("err").textContent = "كلمة السر خطأ"; return; }

        // حفظ الجلسة والدخول
        const devId = window.HAYEK_AUTH.getOrCreateDeviceId();
        window.HAYEK_AUTH.setSession({
          username: data.username,
          role: data.is_admin ? "admin" : "user",
          deviceId: devId
        });

        location.href = (data.is_admin ? "admin.html" : "invoice.html");

      } catch (e) {
        $("err").textContent = "فشل الاتصال: " + e.message;
      }
    };
  </script>
</body>
</html>
