<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>تسجيل دخول الأدمن - HAYEK</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#121823; --txt:#e8eefc; --muted:#9aa7bd;
      --line:#243044; --accent:#4da3ff; --danger:#ff4d4d;
      --btn:#1a2433; --btn2:#223149; --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      background:linear-gradient(180deg,#070a10,#0b0f14 40%);
      color:var(--txt); min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .card{
      width:min(420px, 100%);
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(18,24,35,.85);
      backdrop-filter: blur(8px);
      padding:16px;
    }
    h2{ margin:0 0 8px 0; font-size:18px; }
    .sub{ color:var(--muted); font-size:12px; margin-bottom:12px; }
    input{
      width:100%;
      border:1px solid var(--line);
      background:#0f1622;
      color:var(--txt);
      padding:12px;
      border-radius:12px;
      outline:none;
      margin-top:10px;
      font-size:14px;
    }
    button{
      width:100%;
      border:1px solid rgba(77,163,255,.45);
      background:rgba(77,163,255,.10);
      color:var(--txt);
      padding:12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      margin-top:12px;
      font-size:14px;
    }
    button:hover{ background:rgba(77,163,255,.16); }
    .msg{ margin-top:10px; color:var(--muted); font-size:13px; }
    .err{ color:var(--danger); }
    .ok{ color:#35d07f; }
  </style>
</head>
<body>
  <div class="card">
    <h2>تسجيل دخول الأدمن</h2>
    <div class="sub">الدخول يعتمد على جدول <b>app_users</b> (username / pass)</div>

    <input id="u" placeholder="اسم المستخدم" autocomplete="username" />
    <input id="p" placeholder="كلمة السر" type="password" autocomplete="current-password" />
    <button id="login">دخول</button>

    <div id="msg" class="msg">—</div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // بياناتك كما أرسلتها
    const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_j4ubd1htJvuMVOWUKC9w7g_mwVQzHb_";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const msgEl = document.getElementById("msg");
    const setMsg = (t, kind="")=>{
      msgEl.textContent = t;
      msgEl.className = "msg " + (kind || "");
    };

    function getOrCreateDeviceId(){
      const key="HAYEK_DEVICE_ID";
      let id=localStorage.getItem(key);
      if(!id){
        id = (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"-"+Math.random()));
        localStorage.setItem(key,id);
      }
      return id;
    }

    document.getElementById("login").addEventListener("click", async ()=>{
      const username = document.getElementById("u").value.trim();
      const pass = document.getElementById("p").value.trim();

      if(!username || !pass){
        setMsg("أدخل اسم المستخدم وكلمة السر", "err");
        return;
      }

      setMsg("جارٍ التحقق...");

      try{
        const device_id = getOrCreateDeviceId();

        // تحقق من الحساب من جدولك مباشرة
        const { data: user, error } = await supabase
          .from("app_users")
          .select("id,username,pass,is_admin,blocked,device_id")
          .eq("username", username)
          .eq("pass", pass)
          .maybeSingle();

        if(error) throw error;
        if(!user){ setMsg("بيانات الدخول غير صحيحة", "err"); return; }
        if(user.blocked){ setMsg("هذا الحساب محظور", "err"); return; }
        if(!user.is_admin){ setMsg("هذا الحساب ليس أدمن", "err"); return; }

        // ربط الأدمن بجهاز واحد (إذا سبق وربط، لازم نفس الجهاز)
        const existing = (user.device_id || "").trim();
        if(existing && existing !== device_id){
          setMsg("هذا الأدمن مربوط بجهاز آخر", "err");
          return;
        }

        // إذا غير مربوط، اربطه الآن
        if(!existing){
          const { error: e2 } = await supabase
            .from("app_users")
            .update({ device_id })
            .eq("id", user.id);

          if(e2) throw e2;
        }

        // حفظ جلسة أدمن محلية
        localStorage.setItem("HAYEK_ADMIN_SESSION", JSON.stringify({
          id: user.id,
          username: user.username,
          device_id
        }));

        setMsg("تم تسجيل الدخول ✅", "ok");
        location.href = "./admin.html";
      }catch(e){
        console.error(e);
        setMsg("فشل الدخول: " + (e.message || e), "err");
      }
    });
  </script>
</body>
</html>
