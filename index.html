<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111315" />
  <title>HAYEK SPOT | Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠ</title>

  <style>
    :root{
      --white:#fff; --green:#19C37D; --yellow:#D6A628; --bg:#5F6368;
      --line: rgba(255,255,255,.18);
      --text: var(--white);
      --muted: rgba(255,255,255,.78);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Arabic","Noto Naskh Arabic",sans-serif;
      display:flex;justify-content:center;padding:16px
    }
    .wrap{width:min(460px,100%);display:grid;gap:12px}
    .top{
      background: linear-gradient(180deg, rgba(17,19,21,.95), rgba(47,51,55,.95));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .brand{display:grid;gap:4px}
    .brand b{font-size:16px;letter-spacing:.4px}
    .brand span{font-size:12px;color:var(--muted)}
    .pill{
      font-size:12px;font-weight:1000;padding:7px 10px;border-radius:999px;
      background: var(--yellow); color: #111315;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .login{padding:14px;display:grid;gap:10px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:grid;gap:6px}
    .field label{font-size:12px;color:var(--muted);font-weight:1000}
    input{
      width:100%;padding:12px 12px;border-radius:16px;border:1px solid var(--line);
      background: rgba(17,19,21,.45); color: var(--text); outline:none; font-size:14px
    }
    input:focus{border-color: rgba(25,195,125,.55); box-shadow: 0 0 0 4px rgba(25,195,125,.18)}
    .btn{
      user-select:none;border:1px solid var(--line);background: rgba(255,255,255,.10);
      color: var(--text);padding:12px 12px;border-radius:16px;font-weight:1000;font-size:14px;
      cursor:pointer;touch-action:manipulation
    }
    .btn.green{background: rgba(25,195,125,.22); border-color: rgba(25,195,125,.45)}
    .btn.yellow{background: rgba(214,166,40,.20); border-color: rgba(214,166,40,.45); color:#111315}
    .btn.red{background: rgba(255,80,90,.18); border-color: rgba(255,80,90,.35)}
    .note{font-size:12px;color:var(--muted);line-height:1.7}

    .app{display:none}
    .screen{padding:14px;border-bottom:1px solid var(--line)}
    .display{
      background: rgba(17,19,21,.55);
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px;
      display:grid; gap:6px;
    }
    .expr{font-size:13px;color:var(--muted);min-height:18px;text-align:left;direction:ltr}
    .result{font-size:30px;font-weight:1000;text-align:left;direction:ltr}

    .labelWrap{margin-top:10px;display:grid;gap:6px}
    .labelWrap .t{font-size:12px;color:var(--muted);font-weight:1000}

    .keys{padding:14px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .key{
      padding:14px 10px;border-radius:18px;border:1px solid var(--line);
      background: rgba(255,255,255,.10);
      font-weight:1000;font-size:16px;cursor:pointer;touch-action:manipulation;
      display:flex;align-items:center;justify-content:center;min-height:52px
    }
    .key.op{background: rgba(214,166,40,.18); border-color: rgba(214,166,40,.45)}
    .key.eq{background: rgba(25,195,125,.25); border-color: rgba(25,195,125,.55)}
    .key.warn{background: rgba(255,255,255,.14)}

    .footer{padding:14px;display:grid;gap:10px;border-top:1px solid var(--line);background: rgba(17,19,21,.30)}
    .bigline{
      width:90%;justify-self:center;padding:14px 12px;border-radius:18px;border:1px solid var(--line);
      background: rgba(255,255,255,.10);font-weight:1000;cursor:pointer;touch-action:manipulation
    }

    .log{padding:14px;display:grid;gap:10px;border-top:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;border-radius:16px;overflow:hidden;border:1px solid var(--line);background: rgba(17,19,21,.25)}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.12);font-size:13px;text-align:right}
    th{color:var(--muted);font-weight:1000}
    td.num{text-align:left;direction:ltr;font-weight:1000}
    tr:last-child td{border-bottom:none}

    .total{
      display:flex;justify-content:space-between;align-items:center;padding:10px 12px;
      border:1px dashed rgba(255,255,255,.22);border-radius:16px;background: rgba(255,255,255,.06);
      font-weight:1000
    }
    .total span:last-child{direction:ltr}

    /* Modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:9999;
    }
    .modal{
      width:min(420px,100%); background:rgba(17,19,21,.96);
      border:1px solid rgba(255,255,255,.16);
      border-radius:22px; box-shadow: 0 14px 40px rgba(0,0,0,.45);
      padding:14px; display:grid; gap:10px;
    }
    .modal h3{margin:0;font-size:16px}
    .modal .hint{font-size:12px;color:rgba(255,255,255,.75);line-height:1.7}
    .modal .btnRow{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    @media print{
      /* Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ·Ø¨Ø¹ Ù…Ù† Ù‡Ù†Ø§ â€” Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ù† invoice.html */
      body{background:#fff;color:#000}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <b>HAYEK SPOT</b>
        <span>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø°ÙƒÙŠ Â© 2026</span>
      </div>
      <div class="pill" id="statusPill">Ù…Ù‚ÙÙ„</div>
    </div>

    <!-- LOGIN -->
    <div class="card login" id="loginCard">
      <div class="row2">
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="username" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…ÙˆØ¯" autocomplete="username" />
        </div>
        <div class="field">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢" autocomplete="current-password" />
        </div>
      </div>

      <div class="row2">
        <button class="btn green" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn yellow" id="adminBtn">Ø§Ù„Ø£Ø¯Ù…Ù†</button>
      </div>

      <div class="note" id="loginNote">
        âœ… Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙŠØ¹Ù…Ù„ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø².<br>
        âœ… ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„Ù†Ø¸Ø§Ù… Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.<br>
        âœ… Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨: Ù„Ø§Ø²Ù… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„ÙØªØ­ ÙØ§ØªÙˆØ±Ø©.
      </div>
    </div>

    <!-- APP -->
    <div class="card app" id="appCard">
      <div class="screen">
        <div class="display">
          <div class="expr" id="expr">0</div>
          <div class="result" id="res">0</div>
        </div>

        <div class="labelWrap">
          <div class="t">Ø§Ù„Ø¨ÙŠØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” ÙŠØ¶Ø§Ù Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</div>
          <input id="labelInput" placeholder="Ù…Ø«Ø§Ù„: Ø¯ÙØ¹Ø© Ø²Ø¨ÙˆÙ† / Ù…ØµØ±ÙˆÙ / ÙØ§ØªÙˆØ±Ø©..." />
        </div>

        <div style="margin-top:10px" class="total">
          <span>Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</span>
          <span id="invMeta" style="direction:ltr">â€”</span>
        </div>
      </div>

      <div class="keys" id="keys">
        <button class="key warn" data-k="C">C</button>
        <button class="key warn" data-k="CE">CE</button>
        <button class="key warn" data-k="BK">âŒ«</button>
        <button class="key op" data-k="/">Ã·</button>

        <button class="key" data-k="7">7</button>
        <button class="key" data-k="8">8</button>
        <button class="key" data-k="9">9</button>
        <button class="key op" data-k="*">Ã—</button>

        <button class="key" data-k="4">4</button>
        <button class="key" data-k="5">5</button>
        <button class="key" data-k="6">6</button>
        <button class="key op" data-k="-">âˆ’</button>

        <button class="key" data-k="1">1</button>
        <button class="key" data-k="2">2</button>
        <button class="key" data-k="3">3</button>
        <button class="key op" data-k="+">+</button>

        <button class="key" data-k="0">0</button>
        <button class="key" data-k=".">.</button>

        <!-- âœ… (=) ÙŠØ­ÙØ¸ Ø³Ø·Ø± Ù…Ø¨Ø§Ø´Ø±Ø© -->
        <button class="key eq" data-k="=" style="grid-column: span 2; font-size:20px;">= Ø­ÙØ¸</button>
      </div>

      <div class="footer">
        <button class="bigline" id="newlineBtn">Ø·Ù Ø§Ù„Ø³Ø·Ø± (ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©)</button>

        <div class="row2">
          <button class="btn" id="copyTableBtn">Ù†Ø³Ø® Ø³Ø¬Ù„ ÙƒØ¬Ø¯ÙˆÙ„</button>
          <button class="btn" id="copyResBtn">Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        </div>

        <div class="row2">
          <!-- âœ… ØªÙ…: ÙŠØºÙ„Ù‚ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¥Ù„Ø²Ø§Ù…ÙŠ -->
          <button class="btn green" id="doneBtn">ØªÙ… (Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙØ§ØªÙˆØ±Ø©)</button>
          <!-- âœ… ÙŠÙØªØ­ invoice.html Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© -->
          <button class="btn yellow" id="printBtn">Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
        </div>

        <div class="row2">
          <button class="btn red" id="clearLocalBtn">Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ø­Ù„ÙŠ)</button>
          <button class="btn" id="newInvoiceBtn">ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
      </div>

      <div class="log">
        <h3 style="margin:0;font-size:14px">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>

        <table>
          <thead>
            <tr>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
              <th class="num">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
              <th class="num">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="total">
          <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ´Ù:</span>
          <span id="grandTotal">0</span>
        </div>

        <div class="note" id="statusNote"></div>
      </div>
    </div>
  </div>

  <!-- âœ… Modal: Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ø²Ø§Ù…ÙŠ -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <h3>Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¥Ù„Ø²Ø§Ù…ÙŠ)</h3>
      <div class="hint">Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø³ÙŠØªÙ… ÙØªØ­ ÙØ§ØªÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ ØªÙ‚Ø¯Ø± ØªØ¨Ø¯Ø£ Ø§Ù„Ø­Ø³Ø§Ø¨.</div>
      <input id="customerName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø¨Ùˆ Ø£Ø­Ù…Ø¯" />
      <div class="btnRow">
        <button class="btn red" id="logoutBtn">Ø¥Ù„ØºØ§Ø¡ / Ø®Ø±ÙˆØ¬</button>
        <button class="btn green" id="startInvoiceBtn">Ø¨Ø¯Ø¡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
      </div>
    </div>
  </div>

<script>
  // =========================
  // âœ… Supabase REST
  // =========================
  const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
  const SUPABASE_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";
  const REST = `${SUPABASE_URL}/rest/v1`;

  const $ = (id) => document.getElementById(id);
  const VIBRATE_MS = 12;
  const vibe = () => { try { navigator.vibrate?.(VIBRATE_MS); } catch(_){} };

  const toast = (msg) => {
    const d = document.createElement("div");
    d.textContent = msg;
    Object.assign(d.style, {
      position:"fixed", bottom:"18px", left:"50%",
      transform:"translateX(-50%)",
      background:"rgba(17,19,21,.88)",
      color:"#fff", padding:"10px 14px",
      borderRadius:"14px", fontWeight:"1000",
      zIndex:99999, backdropFilter:"blur(8px)",
      border:"1px solid rgba(255,255,255,.18)"
    });
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 1700);
  };

  const apiFetch = async (path, options = {}) => {
    const res = await fetch(`${REST}${path}`, {
      ...options,
      headers: {
        "apikey": SUPABASE_KEY,
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json",
        "Accept": "application/json",
        ...(options.headers || {})
      }
    });
    if (!res.ok) {
      const t = await res.text().catch(()=> "");
      throw new Error(`API ${res.status}: ${t || res.statusText}`);
    }
    const text = await res.text();
    return text ? JSON.parse(text) : null;
  };

  // =========================
  // âœ… Device ID
  // =========================
  const K_DEVICE = "hs_device_id_v1";
  function getDeviceId(){
    let id = localStorage.getItem(K_DEVICE);
    if (id) return id;
    const rnd = crypto?.getRandomValues ? crypto.getRandomValues(new Uint32Array(4)) : [Date.now(), Math.random()*1e9, Math.random()*1e9, Math.random()*1e9];
    id = `dev_${Array.from(rnd).map(n=>Number(n).toString(16)).join("")}_${Date.now().toString(16)}`;
    localStorage.setItem(K_DEVICE, id);
    return id;
  }

  // =========================
  // âœ… Session + Invoice state
  // =========================
  const K_SESSION = "hs_session_v4";
  const K_INV = "hs_current_invoice_v1"; // {invoice_id, customer_name, status}

  const saveSession = (obj) => localStorage.setItem(K_SESSION, JSON.stringify(obj));
  const loadSession = () => { try { return JSON.parse(localStorage.getItem(K_SESSION) || "null"); } catch { return null; } };
  const clearSession = () => { try { localStorage.removeItem(K_SESSION); } catch(_){} };

  const saveInv = (obj)=> localStorage.setItem(K_INV, JSON.stringify(obj));
  const loadInv = ()=> { try { return JSON.parse(localStorage.getItem(K_INV) || "null"); } catch { return null; } };
  const clearInv = ()=> { try { localStorage.removeItem(K_INV); } catch(_){} };

  const statusPill = $("statusPill");
  const loginCard  = $("loginCard");
  const appCard    = $("appCard");

  const usernameEl = $("username");
  const passwordEl = $("password");

  const modalBack = $("modalBack");
  const customerNameEl = $("customerName");

  const labelInput = $("labelInput");
  const exprEl = $("expr");
  const resEl  = $("res");
  const tbody  = $("tbody");
  const grandTotalEl = $("grandTotal");
  const invMetaEl = $("invMeta");
  const statusNote = $("statusNote");

  const setLocked = (locked) => {
    statusPill.textContent = locked ? "Ù…Ù‚ÙÙ„" : "Ù…ÙØªÙˆØ­";
    statusPill.style.background = locked ? "var(--yellow)" : "var(--green)";
    statusPill.style.color = "#111315";
    loginCard.style.display = locked ? "grid" : "none";
    appCard.style.display = locked ? "none" : "block";
  };

  function showCustomerModal(show){
    modalBack.style.display = show ? "flex" : "none";
  }

  function forceLogout(msg){
    clearSession();
    clearInv();
    setLocked(true);
    showCustomerModal(false);
    if (msg) toast(msg);
  }

  // =========================
  // âœ… Auth + Device bind
  // =========================
  const loginUser = async (username, pass) => {
    const u = (username || "").trim();
    const p = (pass || "").trim();
    if (!u || !p) { toast("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±"); return false; }

    const deviceId = getDeviceId();

    const q =
      `?select=id,username,pass,is_admin,blocked,device_id` +
      `&username=eq.${encodeURIComponent(u)}` +
      `&pass=eq.${encodeURIComponent(p)}` +
      `&limit=1`;

    const rows = await apiFetch(`/app_users${q}`, { method:"GET" });
    const user = Array.isArray(rows) ? rows[0] : null;

    if (!user) { toast("Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); return false; }

    // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø¨Ø¯Ù„ "Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¸ÙˆØ±"
    if (user.blocked) { toast("ÙŠÙˆØ¬Ø¯ Ø®Ø·Ø§Ø¡ Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©"); return false; }

    if (!user.device_id){
      await apiFetch(`/app_users?id=eq.${user.id}`, {
        method:"PATCH",
        headers:{ "Prefer":"return=minimal" },
        body: JSON.stringify({ device_id: deviceId, last_seen: new Date().toISOString() })
      });
    } else if (user.device_id !== deviceId){
      toast("Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø± âŒ");
      return false;
    } else {
      try{
        await apiFetch(`/app_users?id=eq.${user.id}`, {
          method:"PATCH",
          headers:{ "Prefer":"return=minimal" },
          body: JSON.stringify({ last_seen: new Date().toISOString() })
        });
      }catch(_){}
    }

    saveSession({ id: user.id, username: user.username, is_admin: !!user.is_admin, device_id: deviceId, ts: Date.now() });
    return true;
  };

  // =========================
  // âœ… Invoice create/close
  // =========================
  async function createInvoiceForCustomer(customerName){
    const sess = loadSession();
    if (!sess?.username) throw new Error("No session");

    // RPC create_invoice(p_username, p_device_id) -> uuid
    const data = await apiFetch(`/rpc/create_invoice`, {
      method:"POST",
      body: JSON.stringify({
        p_username: sess.username,
        p_device_id: getDeviceId()
      })
    });

    const invoiceId = (typeof data === "string") ? data : (data?.id || data);
    if (!invoiceId) throw new Error("create_invoice failed");

    // update invoice with customer_name + status open
    await apiFetch(`/app_invoices?id=eq.${encodeURIComponent(invoiceId)}`, {
      method:"PATCH",
      headers:{ "Prefer":"return=minimal" },
      body: JSON.stringify({
        customer_name: customerName,
        status: "open"
      })
    });

    saveInv({ invoice_id: invoiceId, customer_name: customerName, status:"open" });
    invMetaEl.textContent = invoiceId;
    statusNote.textContent = `ÙØ§ØªÙˆØ±Ø© Ù…ÙØªÙˆØ­Ø© Ø¨Ø§Ø³Ù…: ${customerName}`;
    toast("ØªÙ… ÙØªØ­ ÙØ§ØªÙˆØ±Ø© âœ…");
    return invoiceId;
  }

  async function closeInvoice(){
    const sess = loadSession();
    const inv = loadInv();
    if (!sess?.id || !inv?.invoice_id) { toast("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø©"); return; }
    if ((inv.status || "open") !== "open") { toast("Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…ØºÙ„Ù‚Ø© Ø£ØµÙ„Ø§Ù‹"); return; }

    if (!logRows.length){
      toast("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØºÙ„Ø§Ù‚ ÙØ§ØªÙˆØ±Ø© ÙØ§Ø±ØºØ©");
      return;
    }

    const total = computeTotal();
    await apiFetch(`/app_invoices?id=eq.${encodeURIComponent(inv.invoice_id)}`, {
      method:"PATCH",
      headers:{ "Prefer":"return=minimal" },
      body: JSON.stringify({
        status: "closed",
        closed_at: new Date().toISOString(),
        total: total
      })
    });

    saveInv({ ...inv, status:"closed" });
    toast("ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙØ§ØªÙˆØ±Ø© âœ…");
    statusNote.textContent = `ÙØ§ØªÙˆØ±Ø© Ù…ØºÙ„Ù‚Ø© Ø¨Ø§Ø³Ù…: ${inv.customer_name}`;
    render();
  }

  function openPrint(){
    const inv = loadInv();
    if (!inv?.invoice_id){ toast("Ø§ÙØªØ­ ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹"); return; }
    if ((inv.status || "open") !== "closed"){
      toast("Ù„Ø§Ø²Ù… ØªØ¶ØºØ· (ØªÙ…) Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©");
      return;
    }
    // âœ… Ø·Ø¨Ø§Ø¹Ø© Ù†Ø¸ÙŠÙØ© Ù…Ù† ØµÙØ­Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    const url = `./invoice.html?invoice_id=${encodeURIComponent(inv.invoice_id)}&print=1`;
    window.open(url, "_blank");
  }

  // =========================
  // âœ… Operations (per invoice)
  // =========================
  let expr = "";
  let lastResult = 0;
  let logRows = []; // from DB

  function formatNumber(n){
    const x = Number(n);
    if (!Number.isFinite(x)) return "0";
    const s = x.toString();
    return s.includes(".") ? x.toFixed(6).replace(/0+$/,"").replace(/\.$/,"") : s;
  }
  function safeEval(expression){
    if (!/^[0-9+\-*/().\s]+$/.test(expression)) return null;
    try{
      const fn = Function(`"use strict"; return (${expression});`);
      const val = fn();
      return Number.isFinite(val) ? val : null;
    }catch{ return null; }
  }

  function computeTotal(){
    return logRows.reduce((acc,r)=>{
      const v = Number(r.result);
      return Number.isFinite(v) ? acc+v : acc;
    }, 0);
  }

  function fmtTime(iso){
    try{
      const d = new Date(iso);
      return d.toLocaleTimeString("ar", { hour:"2-digit", minute:"2-digit", second:"2-digit" });
    }catch{ return ""; }
  }

  function render(){
    exprEl.textContent = expr.trim() ? expr : "0";
    const calc = safeEval(expr);
    resEl.textContent = calc === null ? formatNumber(lastResult) : formatNumber(calc);

    const inv = loadInv();
    invMetaEl.textContent = inv?.invoice_id ? inv.invoice_id : "â€”";

    const tb = tbody;
    tb.innerHTML = "";

    logRows.forEach(r=>{
      const tr = document.createElement("tr");

      const tdT = document.createElement("td");
      tdT.textContent = fmtTime(r.created_at);

      const tdL = document.createElement("td");
      tdL.textContent = r.label || "Ø¹Ù…Ù„ÙŠØ©";

      const tdO = document.createElement("td");
      tdO.className = "num";
      tdO.textContent = r.operation || "";

      const tdR = document.createElement("td");
      tdR.className = "num";
      tdR.textContent = r.result ?? "";

      tr.append(tdT, tdL, tdO, tdR);
      tb.appendChild(tr);
    });

    grandTotalEl.textContent = formatNumber(computeTotal());

    if (!inv?.invoice_id){
      statusNote.textContent = "âš ï¸ Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„ÙØªØ­ ÙØ§ØªÙˆØ±Ø©.";
    } else if ((inv.status || "open") === "open"){
      statusNote.textContent = `âœ… ÙØ§ØªÙˆØ±Ø© Ù…ÙØªÙˆØ­Ø© Ø¨Ø§Ø³Ù…: ${inv.customer_name || "â€”"} â€” Ø§Ø¶ØºØ· (ØªÙ…) Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.`;
    } else {
      statusNote.textContent = `ğŸ”’ ÙØ§ØªÙˆØ±Ø© Ù…ØºÙ„Ù‚Ø© Ø¨Ø§Ø³Ù…: ${inv.customer_name || "â€”"} â€” ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© / PDF.`;
    }
  }

  async function loadInvoiceOperations(){
    const inv = loadInv();
    if (!inv?.invoice_id){
      logRows = [];
      render();
      return;
    }
    const rows = await apiFetch(`/app_operations?select=created_at,label,operation,result&invoice_id=eq.${encodeURIComponent(inv.invoice_id)}&order=created_at.asc`, { method:"GET" });
    logRows = Array.isArray(rows) ? rows : [];
    render();
  }

  async function addOperationRow(operation, result){
    const sess = loadSession();
    const inv = loadInv();
    if (!sess?.id || !inv?.invoice_id){
      toast("Ù„Ø§Ø²Ù… ØªÙØªØ­ ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹");
      return;
    }
    if ((inv.status || "open") !== "open"){
      toast("Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…ØºÙ„Ù‚Ø© â€” Ø§ÙØªØ­ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©");
      return;
    }

    const label = (labelInput.value || "").trim() || "Ø¹Ù…Ù„ÙŠØ©";
    const payload = {
      user_id: sess.id,
      username: sess.username,
      invoice_id: inv.invoice_id,
      label,
      operation,
      result: String(result),
      device_id: getDeviceId()
    };

    await apiFetch(`/app_operations`, {
      method:"POST",
      headers:{ "Prefer":"return=representation" },
      body: JSON.stringify(payload)
    });

    labelInput.value = "";
    await loadInvoiceOperations();
  }

  function newlineCommit(){
    const inv = loadInv();
    if (!inv?.invoice_id){
      toast("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      showCustomerModal(true);
      return;
    }
    if ((inv.status || "open") !== "open"){
      toast("Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…ØºÙ„Ù‚Ø© â€” Ø§ÙØªØ­ ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©");
      return;
    }

    const clean = expr.trim();
    if (!clean) return;

    const val = safeEval(clean);
    if (val === null) return;

    lastResult = val;

    const opDisplay = clean.replace(/\*/g,"Ã—").replace(/\//g,"Ã·");
    const resultText = formatNumber(val);

    expr = "";
    render();

    addOperationRow(opDisplay, resultText).catch(e=>{
      console.error(e);
      toast("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø³Ø·Ø±");
    });
  }

  function clearAll(){ expr=""; lastResult=0; render(); }
  function backspace(){ expr = expr.slice(0,-1); render(); }
  function clearEntry(){
    const m = expr.match(/^(.*?)([+\-*/])\s*[^+\-*/]*$/);
    expr = m ? (m[1] + m[2] + " ") : "";
    render();
  }
  function appendChar(ch){ expr += ch; render(); }

  const onKey = (k) => {
    vibe();
    if (k === "C") return clearAll();
    if (k === "CE") return clearEntry();
    if (k === "BK") return backspace();
    if (k === "=") return newlineCommit(); // âœ… Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ

    if (["/","*","-","+"].includes(k)){
      if (!expr.trim()) return;
      if (/[+\-*/]\s*$/.test(expr)) expr = expr.replace(/[+\-*/]\s*$/,"");
      expr += ` ${k} `;
      return render();
    }

    if (k === "."){
      const lastChunk = expr.split(/[+\-*/]/).pop() ?? "";
      if (lastChunk.includes(".")) return;
    }

    appendChar(k);
  };

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      toast("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…");
    }catch{
      const ta = document.createElement("textarea");
      ta.value = text; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…");
    }
  }

  function logAsTSV(){
    const header = ["Ø§Ù„ÙˆÙ‚Øª","Ø§Ù„Ø¨ÙŠØ§Ù†","Ø§Ù„Ø¹Ù…Ù„ÙŠØ©","Ø§Ù„Ù†ØªÙŠØ¬Ø©"].join("\t");
    const rows = logRows.map(r => [fmtTime(r.created_at), r.label, r.operation, r.result].join("\t"));
    return [header, ...rows, `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ´Ù:\t\t\t${grandTotalEl.textContent}`].join("\n");
  }

  // =========================
  // âœ… UI Events
  // =========================
  $("loginBtn").addEventListener("click", async () => {
    vibe();
    try{
      const ok = await loginUser(usernameEl.value, passwordEl.value);
      if (!ok) return;
      setLocked(false);

      // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ ÙØ§ØªÙˆØ±Ø© Ù…ÙØªÙˆØ­Ø©: Ø§Ø·Ù„Ø¨ Ø§Ø³Ù… Ø¹Ù…ÙŠÙ„
      const inv = loadInv();
      if (!inv || (inv.status !== "open")){
        showCustomerModal(true);
        customerNameEl.value = "";
        customerNameEl.focus();
      } else {
        await loadInvoiceOperations();
      }

      toast("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…");
    }catch(e){
      console.error(e);
      toast("Ø®Ø·Ø£ Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    }
  }, { passive:true });

  $("adminBtn").addEventListener("click", () => {
    vibe();
    location.href = "./admin.html?v=999";
  }, { passive:true });

  $("keys").addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-k]");
    if (!btn) return;
    onKey(btn.dataset.k);
  }, { passive:true });

  $("newlineBtn").addEventListener("click", () => { vibe(); newlineCommit(); }, { passive:true });

  $("copyTableBtn").addEventListener("click", () => {
    vibe();
    const inv = loadInv();
    if (!inv?.invoice_id) return toast("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ§ØªÙˆØ±Ø©");
    if ((inv.status || "open") !== "closed") return toast("Ù„Ø§Ø²Ù… (ØªÙ…) Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø³Ø®");
    copyText(logAsTSV());
  }, { passive:true });

  $("copyResBtn").addEventListener("click", () => { vibe(); copyText(resEl.textContent); }, { passive:true });

  $("doneBtn").addEventListener("click", async () => {
    vibe();
    try{ await closeInvoice(); }
    catch(e){ console.error(e); toast("ÙØ´Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙØ§ØªÙˆØ±Ø©"); }
  }, { passive:true });

  $("printBtn").addEventListener("click", () => { vibe(); openPrint(); }, { passive:true });

  $("clearLocalBtn").addEventListener("click", () => { vibe(); expr=""; lastResult=0; render(); toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±Ø¶"); }, { passive:true });

  $("newInvoiceBtn").addEventListener("click", () => {
    vibe();
    clearInv();
    logRows = [];
    expr = "";
    lastResult = 0;
    render();
    showCustomerModal(true);
    customerNameEl.value = "";
    customerNameEl.focus();
  }, { passive:true });

  $("logoutBtn").addEventListener("click", () => { vibe(); forceLogout("ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬"); }, { passive:true });

  $("startInvoiceBtn").addEventListener("click", async () => {
    vibe();
    const name = (customerNameEl.value || "").trim();
    if (!name) return toast("Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ø²Ø§Ù…ÙŠ");
    try{
      showCustomerModal(false);
      await createInvoiceForCustomer(name);
      await loadInvoiceOperations();
    }catch(e){
      console.error(e);
      toast("ÙØ´Ù„ ÙØªØ­ ÙØ§ØªÙˆØ±Ø©");
      showCustomerModal(true);
    }
  }, { passive:true });

  window.addEventListener("keydown", (e) => {
    const map = { "Enter":"=", "Backspace":"BK", "Escape":"C", "/":"/", "*":"*", "-":"-", "+":"+",
                  ".":"." };
    if (e.key >= "0" && e.key <= "9") return onKey(e.key);
    if (map[e.key]) return onKey(map[e.key]);
  });

  // Boot
  (async function boot(){
    const sess = loadSession();
    setLocked(!sess);
    render();

    if (sess?.id){
      const inv = loadInv();
      if (!inv || inv.status !== "open"){
        showCustomerModal(true);
      } else {
        await loadInvoiceOperations();
      }
    }
  })();
</script>
</body>
</html>
