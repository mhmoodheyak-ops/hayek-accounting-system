
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HAYEK SPOT — تسجيل الدخول</title>
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#071820" />
  <style>
    :root{
      --bg:#071820; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.12);
      --txt:#eaf4ff; --mut:#a7bdd0; --blue:#1f62ff; --danger:#ff6b6b;
    }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Tahoma,Arial}
    body{margin:0;min-height:100vh;background:radial-gradient(1200px 600px at 30% 20%, #0f3a3f 0%, var(--bg) 55%);color:var(--txt);display:flex;align-items:center;justify-content:center;padding:16px}
    .card{width:min(560px,100%);background:var(--panel);border:1px solid var(--line);border-radius:22px;box-shadow:0 20px 70px rgba(0,0,0,.45);backdrop-filter:blur(10px);padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .dot{width:10px;height:10px;border-radius:50%;background:#49e39a;box-shadow:0 0 0 6px rgba(73,227,154,.12)}
    .mut{color:var(--mut);font-size:13px}
    label{display:block;color:var(--mut);font-size:13px;margin:10px 0 6px}
    input{width:100%;padding:14px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--txt);font-size:16px;outline:none}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{flex:1;border:none;border-radius:16px;padding:14px;font-size:16px;cursor:pointer}
    .btn.blue{background:var(--blue);color:#fff}
    .btn.gray{background:rgba(255,255,255,.08);color:#fff}
    .err{margin-top:10px;color:var(--danger);font-size:13px;min-height:18px}
    .footer{margin-top:12px;text-align:center;color:rgba(255,255,255,.35);font-size:12px}
    .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:rgba(0,0,0,.12)}
  </style>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js?v=1"></script>
  <script src="./auth.js?v=1"></script>
</head>

<body>
  <div class="card">
    <div class="top">
      <div style="display:flex;align-items:center;gap:10px">
        <span class="dot" id="onlineDot"></span>
        <div>
          <div style="font-weight:900;font-size:18px">تسجيل الدخول</div>
          <div class="mut">مرة واحدة فقط — بعدها يدخل تلقائيًا على نفس الجهاز.</div>
        </div>
      </div>
      <div class="pill">
        <span class="mut">Device:</span>
        <b id="devId">—</b>
      </div>
    </div>

    <label>اسم المستخدم</label>
    <input id="u" placeholder="مثال: ابو قروب" autocomplete="username">

    <label>كلمة السر</label>
    <input id="p" type="password" placeholder="••••••" autocomplete="current-password">

    <div class="row">
      <button class="btn blue" id="loginBtn">تسجيل دخول</button>
      <button class="btn gray" id="wipeBtn">مسح بيانات الجهاز</button>
    </div>

    <div class="err" id="err"></div>
    <div class="footer">HAYEK SPOT</div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const onlineDot = $("onlineDot");
  function refreshOnline(){
    onlineDot.style.background = navigator.onLine ? "#49e39a" : "#ffb1b1";
    onlineDot.style.boxShadow = navigator.onLine ? "0 0 0 6px rgba(73,227,154,.12)" : "0 0 0 6px rgba(255,107,107,.12)";
  }
  window.addEventListener("online", refreshOnline);
  window.addEventListener("offline", refreshOnline);
  refreshOnline();

  const devId = window.HAYEK_AUTH.getOrCreateDeviceId();
  $("devId").textContent = devId.slice(0,8);

  // Auto redirect if already logged in
  if (window.HAYEK_AUTH.isAuthed()) {
    const s = window.HAYEK_AUTH.getUser();
    location.href = (s.role === "admin" ? "admin.html" : "invoice.html") + "?v=" + Date.now();
    return;
  }

  function setErr(msg){ $("err").textContent = msg || ""; }

  function getSB(){
    const cfg = window.APP_CONFIG || {};
    if(!cfg.SUPABASE_URL || !cfg.SUPABASE_ANON_KEY) return null;
    return supabase.createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY);
  }

  // robust: supports username column = "username" OR "t"
  async function findUserRow(sb, username){
    const table = window.APP_CONFIG.TABLE_USERS;
    // OR filter works for both possibilities
    const { data, error } = await sb
      .from(table)
      .select("*")
      .or(`username.eq.${username},t.eq.${username}`);
    if (error) throw error;
    return (data && data[0]) ? data[0] : null;
  }

  function rowUsername(row){
    return row?.username ?? row?.t ?? "";
  }

  $("wipeBtn").onclick = () => {
    // wipe all hayek keys
    Object.keys(localStorage).forEach(k=>{
      if (k.startsWith("HAYEK_")) localStorage.removeItem(k);
    });
    setErr("تم مسح بيانات الجهاز.");
  };

  $("loginBtn").onclick = async () => {
    setErr("");
    const u = ($("u").value||"").trim();
    const p = ($("p").value||"").trim();
    if(!u || !p){ setErr("أدخل اسم المستخدم وكلمة السر."); return; }

    const sb = getSB();
    if(!sb){ setErr("Supabase غير مضبوط داخل config.js"); return; }

    try{
      const row = await findUserRow(sb, u);
      if(!row){ setErr("اسم المستخدم غير موجود."); return; }

      if (row.blocked === true) { setErr("هذا الحساب محظور."); return; }

      const pass = String(row.pass ?? "");
      if (pass !== p){ setErr("كلمة السر غير صحيحة."); return; }

      // device lock: first login binds device_id (except admins)
      const isAdmin = (row.is_admin === true);
      const rowDevice = row.device_id ? String(row.device_id) : "";

      if (!isAdmin) {
        if (!rowDevice) {
          // bind device on first login
          const { error } = await sb.from(window.APP_CONFIG.TABLE_USERS)
            .update({ device_id: devId })
            .or(`username.eq.${u},t.eq.${u}`);
          if (error) { setErr("فشل ربط الجهاز."); return; }
        } else if (rowDevice !== devId) {
          setErr("هذا الحساب مربوط بجهاز آخر.");
          return;
        }
      }

      // session
      window.HAYEK_AUTH.setSession({
        username: rowUsername(row) || u,
        role: isAdmin ? "admin" : "user",
        deviceId: devId,
        loggedAt: new Date().toISOString(),
      });

      // go
      location.href = (isAdmin ? "admin.html" : "invoice.html") + "?v=" + Date.now();
    }catch(e){
      console.log(e);
      setErr("خطأ في الاتصال بالسيرفر.");
    }
  };

  // Register SW
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
})();
</script>
</body>
</html>
