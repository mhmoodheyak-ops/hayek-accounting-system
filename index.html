<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>حاسبة الحايك</title>

  <link rel="stylesheet" href="style.css?v=1" />

  <!-- Supabase + Config + Auth -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js?v=1"></script>
  <script src="auth.js?v=1"></script>

  <!-- jsPDF + AutoTable + Font (لـ PDF العربي) -->
  <script src="jspdf.umd.min.js?v=1"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="amiri-font.js?v=1"></script>
</head>

<body>
  <!-- شريط علوي -->
  <header class="topbar">
    <div class="brand">
      <div class="dot online" id="netDot" title="متصل"></div>
      <div class="titles">
        <div class="title">حاسبة الحايك</div>
        <div class="subtitle">سجل + فاتورة + PDF + أوفلاين</div>
      </div>
    </div>
    <button class="btn ghost" id="btnLogout">خروج</button>
  </header>

  <!-- محتوى -->
  <main class="wrap">

    <!-- تبويبات -->
    <section class="tabs">
      <button class="tab active" data-tab="calc">الحاسبة</button>
      <button class="tab" data-tab="history">سجل العمليات</button>
      <button class="tab" data-tab="invoice">فاتورة</button>
      <button class="tab" data-tab="tools">أدوات</button>
    </section>

    <!-- معلومات الفاتورة + فتح/إغلاق -->
    <section class="card header-card">
      <div class="grid2">
        <div class="field">
          <label>اسم العميل</label>
          <input id="customerName" type="text" placeholder="مثال: أبو علي" autocomplete="off" />
          <div class="hint">بمجرد كتابة اسم العميل سيتم فتح فاتورة تلقائياً (بالخلفية).</div>
        </div>

        <div class="field">
          <label>حالة الفاتورة</label>
          <div class="pill" id="invoiceStatusPill">لا توجد فاتورة</div>
          <div class="btnRow">
            <button class="btn primary" id="btnOpenInvoice">فتح فاتورة جديدة</button>
            <button class="btn danger" id="btnCloseInvoice">إغلاق الفاتورة</button>
            <button class="btn" id="btnPDF">تصدير PDF</button>
          </div>
          <div class="hint subtle" id="closeHint">
            قبل التصدير/النسخ يجب إغلاق الفاتورة.
          </div>
        </div>
      </div>

      <div class="toast" id="toast" aria-live="polite"></div>
    </section>

    <!-- TAB: الحاسبة -->
    <section class="card tabpane" id="tab-calc">
      <div class="calcTop">
        <div class="exprBox">
          <input id="noteInput" class="noteInput" type="text" placeholder="اكتب اسم/وصف (مثال: محارم)" />
          <input id="exprInput" class="exprInput" type="text" placeholder="اكتب العملية أو استخدم الأزرار (مثال: 5+5*2)" inputmode="decimal" />
        </div>

        <div class="toggles">
          <label class="chk">
            <input type="checkbox" id="chkPerLine" checked />
            <span>كل عملية بسطر</span>
          </label>
          <label class="chk">
            <input type="checkbox" id="chkVibrate" checked />
            <span>اهتزاز عند الضغط</span>
          </label>
        </div>

        <div class="bigResult" id="bigResult">0</div>
      </div>

      <!-- لوحة الأرقام (موبايل) -->
      <div class="pad">
        <button class="k op" data-k="+">+</button>
        <button class="k del" data-k="DEL">⌫</button>
        <button class="k" data-k="(">(</button>
        <button class="k" data-k=")">)</button>

        <button class="k op" data-k="*">×</button>
        <button class="k num" data-k="7">7</button>
        <button class="k num" data-k="8">8</button>
        <button class="k num" data-k="9">9</button>

        <button class="k op" data-k="-">-</button>
        <button class="k num" data-k="4">4</button>
        <button class="k num" data-k="5">5</button>
        <button class="k num" data-k="6">6</button>

        <button class="k op" data-k="/">÷</button>
        <button class="k num" data-k="1">1</button>
        <button class="k num" data-k="2">2</button>
        <button class="k num" data-k="3">3</button>

        <button class="k eq" data-k="=">=</button>
        <button class="k" data-k="±">±</button>
        <button class="k num" data-k="0">0</button>
        <button class="k" data-k=".">.</button>

        <button class="k wide clearLine" data-k="CLEAR_LINE">مسح السطر بالكامل</button>
      </div>

      <div class="actionsRow">
        <button class="btn" id="btnCopyResult">نسخ النتيجة</button>
        <button class="btn" id="btnCopyTable">نسخ كجدول</button>
        <button class="btn danger" id="btnClearHistory">مسح السجل</button>
      </div>
    </section>

    <!-- TAB: سجل -->
    <section class="card tabpane hidden" id="tab-history">
      <h3 class="h3">سجل العمليات</h3>
      <div class="tableWrap">
        <table class="tbl" id="historyTable">
          <thead>
            <tr>
              <th>الوقت</th>
              <th>البيان</th>
              <th>العملية</th>
              <th>النتيجة</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </section>

    <!-- TAB: فاتورة -->
    <section class="card tabpane hidden" id="tab-invoice">
      <div class="invoicePreview" id="invoicePreview">
        <div class="invHead">
          <div class="invTitle">
            <div class="invCompany">شركة الحايك</div>
            <div class="invBrand">HAYEK SPOT</div>
          </div>
          <div class="invMeta">
            <div><b>اسم المستخدم:</b> <span id="invUser">—</span></div>
            <div><b>اسم العميل:</b> <span id="invCust">—</span></div>
            <div><b>رقم الفاتورة:</b> <span id="invId">—</span></div>
            <div><b>التاريخ:</b> <span id="invDate">—</span></div>
          </div>
        </div>

        <div class="tableWrap">
          <table class="tbl">
            <thead>
              <tr>
                <th>الوقت</th>
                <th>البيان</th>
                <th>العملية</th>
                <th>النتيجة</th>
              </tr>
            </thead>
            <tbody id="invBody"></tbody>
          </table>
        </div>

        <div class="totalBox">
          <div class="totalLabel">إجمالي الكشف:</div>
          <div class="totalValue" id="invTotal">0</div>
        </div>

        <div class="footerNote">
          تم تطوير هذه الحاسبة الاحترافية من قبل شركة الحايك — 05510217646
        </div>
      </div>
    </section>

    <!-- TAB: أدوات -->
    <section class="card tabpane hidden" id="tab-tools">
      <h3 class="h3">أدوات</h3>
      <div class="toolsGrid">
        <button class="btn" id="btnToday">فاتورة اليوم</button>
        <button class="btn" id="btnLast7">آخر 7 أيام</button>
        <button class="btn" id="btnRebuild">تحديث الشاشة</button>
      </div>
      <div class="hint subtle">
        ملاحظة: الأوفلاين (بدون نت) سنفعّله بالخطوة التالية عبر service-worker.
      </div>
    </section>

  </main>

  <script src="app.js?v=1"></script>
</body>
</html>
