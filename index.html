<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HAYEK SPOT — تسجيل الدخول</title>
  <style>
    :root{--bg:#071820;--card:rgba(255,255,255,.06);--line:rgba(255,255,255,.12);--txt:#eaf4ff;--mut:#9db1c1;--btn:#1f62ff;}
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Tahoma,Arial}
    body{margin:0;min-height:100vh;background:radial-gradient(1200px 600px at 30% 20%, #0f3a3f 0%, var(--bg) 55%);color:var(--txt);display:flex;align-items:center;justify-content:center;padding:18px}
    .card{width:min(520px,100%);background:var(--card);border:1px solid var(--line);border-radius:22px;padding:22px;box-shadow:0 20px 70px rgba(0,0,0,.45);backdrop-filter:blur(10px)}
    h1{margin:0 0 6px;font-size:28px}
    .sub{color:var(--mut);margin:0 0 16px;font-size:14px}
    label{display:block;color:var(--mut);font-size:13px;margin:10px 0 6px}
    input{width:100%;padding:14px 14px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--txt);font-size:16px;outline:none}
    .row{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    button{cursor:pointer;border:none;border-radius:14px;padding:12px 14px;font-size:15px}
    .primary{background:var(--btn);color:#fff;flex:1}
    .ghost{background:rgba(255,255,255,.08);color:#fff}
    .err{margin-top:12px;color:#ffb6b6;background:rgba(255,0,0,.08);border:1px solid rgba(255,0,0,.18);padding:10px;border-radius:12px;display:none}
    .pill{display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid var(--line);padding:8px 10px;border-radius:999px;color:var(--mut);font-size:13px}
    .dot{width:10px;height:10px;border-radius:50%;background:#49e39a;box-shadow:0 0 0 6px rgba(73,227,154,.12)}
    .footer{margin-top:14px;text-align:center;color:rgba(255,255,255,.35);font-size:12px}
  </style>
</head>
<body>

  <div class="card">
    <div class="pill"><span class="dot" id="dot"></span><span id="dev">Device: …</span></div>
    <h1>تسجيل الدخول</h1>
    <p class="sub">مرة واحدة فقط — بعدها يدخل تلقائيًا على نفس الجهاز.</p>

    <label>اسم المستخدم</label>
    <input id="u" autocomplete="username" placeholder="مثال: lab_top">

    <label>كلمة السر</label>
    <input id="p" type="password" autocomplete="current-password" placeholder="••••••">

    <div class="row">
      <button class="primary" id="btn">تسجيل دخول</button>
      <button class="ghost" id="wipe">مسح بيانات الجهاز</button>
    </div>

    <div class="err" id="errBox"></div>
    <div class="footer">HAYEK SPOT</div>
  </div>

  <!-- config + auth -->
  <script src="./config.js?v=1"></script>
  <script src="./auth.js?v=1"></script>

  <script>
    const $ = (id)=>document.getElementById(id);
    const errBox = $("errBox");
    function showErr(msg){ errBox.style.display="block"; errBox.textContent=msg; }
    function hideErr(){ errBox.style.display="none"; errBox.textContent=""; }

    // device id
    try{
      const id = window.HAYEK_AUTH?.getOrCreateDeviceId?.() || "—";
      $("dev").textContent = "Device: " + String(id).slice(-8);
    }catch{}

    // auto redirect if already authed
    (function(){
      if (window.HAYEK_AUTH && window.__HAYEK_AUTH_LOADED__ && window.HAYEK_AUTH.isAuthed()) {
        const s = window.HAYEK_AUTH.getUser() || {};
        if (s.role === "admin") location.href = "admin.html?v=" + Date.now();
        else location.href = "invoice.html?v=" + Date.now();
      }
    })();

    $("btn").onclick = async () => {
      hideErr();
      if (!window.HAYEK_AUTH || !window.__HAYEK_AUTH_LOADED__) {
        showErr("auth.js غير محمل بشكل صحيح. تأكد أن الملف موجود بنفس المجلد.");
        return;
      }
      const u = $("u").value;
      const p = $("p").value;

      try{
        const s = await window.HAYEK_AUTH.login(u,p);
        if (s.role === "admin") location.href = "admin.html?v=" + Date.now();
        else location.href = "invoice.html?v=" + Date.now();
      }catch(e){
        const code = String(e && e.message || e);
        if (code === "NOT_FOUND") showErr("اسم المستخدم غير موجود.");
        else if (code === "BAD_PASS") showErr("كلمة السر غير صحيحة.");
        else if (code === "BLOCKED") showErr("هذا المستخدم محظور.");
        else if (code === "DEVICE_LOCK") showErr("هذا الحساب مربوط بجهاز آخر.");
        else if (code === "NO_SUPABASE") showErr("config.js غير صحيح أو مفاتيح Supabase غير موجودة.");
        else showErr("خطأ في الاتصال بالسيرفر.");
      }
    };

    $("wipe").onclick = () => {
      try{ window.HAYEK_AUTH.resetDeviceData(); }catch{}
      location.reload();
    };
  </script>
</body>
</html>
