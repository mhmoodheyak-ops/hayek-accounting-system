<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>HAYEK SPOT — تسجيل الدخول</title>

  <link rel="stylesheet" href="style.css?v=1" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Config (SUPABASE_URL / SUPABASE_ANON_KEY) -->
  <script src="config.js?v=1"></script>

  <!-- Auth -->
  <script src="auth.js?v=1"></script>

  <!-- Optional font helper -->
  <script src="amiri-font.js?v=1"></script>

  <style>
    /* صفحة تسجيل دخول داكنة مرتبة */
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background: radial-gradient(1200px 600px at 70% 20%, rgba(32,92,110,.55), transparent 60%),
                  radial-gradient(1200px 700px at 20% 80%, rgba(12,40,60,.75), transparent 55%),
                  linear-gradient(180deg, #071521, #06131e);
      color:#eaf4ff;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
    }

    .card{
      width:min(560px, 92vw);
      border-radius: 22px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 20px 70px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      padding: 22px;
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom: 14px;
    }
    .brand{
      font-weight:800;
      letter-spacing:.5px;
      font-size: 18px;
    }
    .sub{
      opacity:.85;
      font-size: 13px;
      margin-top: 2px;
    }
    .pill{
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      color:#cfe6ff;
      white-space:nowrap;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    label{
      display:block;
      font-size: 13px;
      opacity:.9;
      margin-bottom: 6px;
    }
    input{
      width:100%;
      box-sizing:border-box;
      padding: 14px 14px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color:#fff;
      outline:none;
      font-size: 15px;
    }
    input::placeholder{ color: rgba(255,255,255,.45); }

    .rowBtns{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    button{
      border:0;
      cursor:pointer;
      border-radius: 14px;
      padding: 13px 16px;
      font-weight: 700;
      font-size: 14px;
    }
    .primary{
      flex:1;
      min-width: 180px;
      background: linear-gradient(180deg, #2b6cff, #1f56d9);
      color:#fff;
    }
    .ghost{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      color:#d9ecff;
    }
    .msg{
      margin-top: 10px;
      font-size: 13px;
      color: #ffb9b9;
      min-height: 18px;
    }
    .footer{
      margin-top: 12px;
      text-align:center;
      opacity:.55;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="card" id="card">
    <div class="top">
      <div>
        <div class="brand">تسجيل الدخول</div>
        <div class="sub">مرة واحدة فقط — بعدها يدخل تلقائيًا على نفس الجهاز.</div>
      </div>
      <div class="pill" id="devPill">Device: —</div>
    </div>

    <div class="grid">
      <div>
        <label>اسم المستخدم</label>
        <input id="username" placeholder="مثال: ابو علي" autocomplete="username" />
      </div>
      <div>
        <label>كلمة السر</label>
        <input id="password" type="password" placeholder="••••••" autocomplete="current-password" />
      </div>
    </div>

    <div class="rowBtns">
      <button class="primary" id="btnLogin">تسجيل دخول</button>
      <button class="ghost" id="btnReset">مسح بيانات الجهاز</button>
    </div>

    <div class="msg" id="msg"></div>
    <div class="footer">HAYEK SPOT</div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function goAfterLogin(user){
      if (user?.isAdmin) {
        window.location.href = "admin.html?v=" + Date.now();
      } else {
        // ✅ واجهة المستخدم عندك هي invoice.html
        window.location.href = "invoice.html?v=" + Date.now();
      }
    }

    // إذا auth جاهز وجلسة موجودة => دخول تلقائي
    if (window.HAYEK_AUTH && window.__HAYEK_AUTH_LOADED__ && window.HAYEK_AUTH.isAuthed()){
      goAfterLogin(window.HAYEK_AUTH.getUser());
    }

    // عرض Device
    try{
      const did = window.HAYEK_AUTH?.getOrCreateDeviceId?.() || "—";
      $("devPill").textContent = "Device: " + String(did).slice(-8);
    }catch{}

    $("btnLogin").onclick = async () => {
      $("msg").textContent = "";
      const u = $("username").value;
      const p = $("password").value;

      const res = await window.HAYEK_AUTH.login(u, p);
      if (!res.ok){
        $("msg").textContent = res.msg || "فشل تسجيل الدخول.";
        return;
      }
      goAfterLogin(res.user);
    };

    $("btnReset").onclick = () => {
      // مسح جلسة الدخول + تثبيت الجهاز (لإعادة الربط إذا لزم)
      localStorage.removeItem("HAYEK_AUTH_SESSION_V1");
      localStorage.removeItem("HAYEK_AUTH_DEVICE_ID_V1");
      $("msg").textContent = "تم مسح بيانات الجهاز. أعد تحميل الصفحة.";
    };
  </script>
</body>
</html>
