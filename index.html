<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>حاسبة الحايك - سجل + PDF</title>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- Arabic fonts for jsPDF (small helper pack) -->
  <script src="https://cdn.jsdelivr.net/npm/@bajzar/arabic-fonts@1.0.0/arabic.js"></script>

  <style>
    :root{
      --bg:#f4f6f9;
      --card:#ffffff;
      --txt:#1a1a1a;
      --muted:#6b7280;
      --btn:#eef2f7;
      --btn2:#e7edf7;
      --accent:#2563eb;
      --danger:#ef4444;
      --ok:#10b981;
      --shadow: 0 12px 30px rgba(0,0,0,.08);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--txt);
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      display:flex;
      justify-content:center;
      padding:16px;
    }
    .app{
      width:min(480px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    header{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    header .title{
      font-weight:800;
      font-size:16px;
      line-height:1.2;
    }
    header .sub{
      color:var(--muted);
      font-size:12px;
      margin-top:4px;
    }
    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(37,99,235,.08);
      color:var(--accent);
      font-weight:700;
      white-space:nowrap;
    }

    .display{
      padding:14px 16px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .expr{
      width:100%;
      border:1px solid rgba(0,0,0,.08);
      background:#fbfcfe;
      padding:12px 12px;
      border-radius:16px;
      font-size:18px;
      outline:none;
      direction:ltr;
      text-align:left;
    }
    .result{
      font-size:30px;
      font-weight:900;
      text-align:left;
      direction:ltr;
      padding:2px 2px 0 2px;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }

    .pad{
      padding:14px 16px 16px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    button{
      border:0;
      border-radius:18px;
      padding:14px 10px;
      font-size:18px;
      font-weight:800;
      background:var(--btn);
      color:var(--txt);
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{transform:translateY(1px)}
    .op{ background:var(--btn2); }
    .eq{ background:rgba(16,185,129,.12); color:#0f766e; }
    .del{ background:rgba(239,68,68,.12); color:#b91c1c; }
    .wide{
      grid-column: 1 / -1;
      padding:16px 10px;
      font-size:20px;
      background:rgba(239,68,68,.12);
      color:#b91c1c;
      width:90%;
      justify-self:center;
    }

    .tools{
      padding:12px 16px 16px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      border-top:1px solid rgba(0,0,0,.06);
    }
    .tool{
      flex:1 1 120px;
      background:#f7f9fe;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:none;
      font-size:14px;
      padding:12px 10px;
      border-radius:16px;
    }
    .tool.primary{ background:rgba(37,99,235,.10); color:var(--accent); font-weight:900; }
    .tool.ok{ background:rgba(16,185,129,.12); color:#0f766e; font-weight:900; }
    .tool.danger{ background:rgba(239,68,68,.10); color:#b91c1c; font-weight:900; }

    .log{
      padding:14px 16px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .log h3{
      margin:0;
      font-size:14px;
      color:var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .logBox{
      border:1px solid rgba(0,0,0,.08);
      background:#fbfcfe;
      border-radius:18px;
      padding:10px;
      max-height:280px;
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td{
      padding:8px 6px;
      border-bottom:1px solid rgba(0,0,0,.06);
      vertical-align:top;
    }
    th{
      color:var(--muted);
      font-weight:800;
      position:sticky;
      top:0;
      background:#fbfcfe;
    }
    td.exprTd{direction:ltr; text-align:left; font-weight:800;}
    td.resTd{direction:ltr; text-align:left; font-weight:900;}
    .empty{
      color:var(--muted);
      font-size:13px;
      padding:12px 6px;
      text-align:center;
    }
    footer{
      text-align:center;
      color:var(--muted);
      font-size:12px;
      padding:4px 6px 10px;
    }
  </style>
</head>

<body>
  <div class="app">

    <div class="card">
      <header>
        <div>
          <div class="title">حاسبة الحايك</div>
          <div class="sub">سجل العمليات + نسخ جدول + PDF</div>
        </div>
        <div class="badge" id="statusBadge">جاهز</div>
      </header>

      <div class="display">
        <input id="expr" class="expr" inputmode="decimal" autocomplete="off" placeholder="مثال: 12.5*3-7/2" />
        <div class="result" id="result">0</div>
        <div class="hint">
          <span>اهتزاز عند الضغط ✅</span>
          <span>كل عملية بسطر ✅</span>
        </div>
      </div>

      <!-- Keypad (with swapped number layout) -->
      <div class="pad">
        <!-- Row 1 -->
        <button class="op" data-k="(">(</button>
        <button class="op" data-k=")">)</button>
        <button class="del" id="backspace">⌫</button>
        <button class="op" data-k="/">÷</button>

        <!-- Row 2: swapped 7->9 positions: 9 8 7 -->
        <button data-k="9">9</button>
        <button data-k="8">8</button>
        <button data-k="7">7</button>
        <button class="op" data-k="*">×</button>

        <!-- Row 3: swapped 4->6 positions: 6 5 4 -->
        <button data-k="6">6</button>
        <button data-k="5">5</button>
        <button data-k="4">4</button>
        <button class="op" data-k="-">−</button>

        <!-- Row 4: swapped 1->3 positions: 3 2 1 -->
        <button data-k="3">3</button>
        <button data-k="2">2</button>
        <button data-k="1">1</button>
        <button class="op" data-k="+">+</button>

        <!-- Row 5 -->
        <button data-k=".">.</button>
        <button data-k="0">0</button>
        <button class="op" id="plusMinus">±</button>
        <button class="eq" id="equals">=</button>

        <!-- Big clear line button -->
        <button class="wide" id="clearLine">مسح السطر بالكامل</button>
      </div>

      <div class="tools">
        <button class="tool ok" id="copyResult">نسخ النتيجة</button>
        <button class="tool primary" id="copyTable">نسخ السجل كجدول</button>
        <button class="tool primary" id="exportPdf">تصدير PDF</button>
        <button class="tool danger" id="clearLog">حذف السجل</button>
      </div>

      <footer>تم تطوير الحاسبة من قبل الحايك للحلول الرقمية</footer>
    </div>

    <div class="card">
      <div class="log">
        <h3>
          <span>سجل العمليات</span>
          <span id="logCount" style="color:var(--muted); font-weight:900;">0</span>
        </h3>
        <div class="logBox" id="logBox">
          <div class="empty" id="emptyState">لا يوجد عمليات بعد.</div>
          <table id="logTable" style="display:none;">
            <thead>
              <tr>
                <th>#</th>
                <th>العملية</th>
                <th>النتيجة</th>
                <th>الوقت</th>
              </tr>
            </thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<script>
(() => {
  const exprEl = document.getElementById('expr');
  const resultEl = document.getElementById('result');
  const badgeEl = document.getElementById('statusBadge');

  const logBody = document.getElementById('logBody');
  const logTable = document.getElementById('logTable');
  const emptyState = document.getElementById('emptyState');
  const logCount = document.getElementById('logCount');

  const STORAGE_KEY = 'hayek_calc_log_v1';

  let log = loadLog();

  function vibrate(ms=18){
    try { if (navigator.vibrate) navigator.vibrate(ms); } catch(e){}
  }

  function setBadge(text, ok=true){
    badgeEl.textContent = text;
    badgeEl.style.background = ok ? 'rgba(16,185,129,.12)' : 'rgba(239,68,68,.12)';
    badgeEl.style.color = ok ? '#0f766e' : '#b91c1c';
  }

  function sanitizeExpression(s){
    // Allow: digits . + - * / ( ) spaces
    // Convert Arabic comma/decimal if any
    return String(s || '')
      .replace(/[،]/g, '.')
      .replace(/[^\d\.\+\-\*\/\(\)\s]/g, '')
      .trim();
  }

  function safeEval(exp){
    // exp is sanitized; still avoid eval injection by strict pattern
    const cleaned = sanitizeExpression(exp);
    if(!cleaned) return { ok:true, value:0, cleaned:'' };

    // prevent invalid sequences (basic)
    if(!/^[\d\.\+\-\*\/\(\)\s]+$/.test(cleaned)) return { ok:false, error:'صيغة غير صالحة' };

    // Disallow multiple dots in a number segment (simple check)
    const parts = cleaned.split(/[\+\-\*\/\(\)\s]+/).filter(Boolean);
    for(const p of parts){
      const dots = (p.match(/\./g) || []).length;
      if(dots > 1) return { ok:false, error:'خطأ بالنقطة العشرية' };
    }

    try{
      // eslint-disable-next-line no-new-func
      const fn = new Function('return (' + cleaned + ');');
      const val = fn();
      if (typeof val !== 'number' || !isFinite(val)) return { ok:false, error:'نتيجة غير صالحة' };
      return { ok:true, value:val, cleaned };
    }catch(e){
      return { ok:false, error:'تحقق من العملية' };
    }
  }

  function formatNumber(n){
    // Keep up to 10 decimal digits, trim trailing zeros
    const s = (Math.round(n * 1e10) / 1e10).toString();
    return s;
  }

  function updateLive(){
    const exp = sanitizeExpression(exprEl.value);
    const r = safeEval(exp);
    if(r.ok){
      resultEl.textContent = formatNumber(r.value);
      setBadge('جاهز', true);
    }else{
      resultEl.textContent = '—';
      setBadge(r.error, false);
    }
  }

  function appendToExpr(k){
    const start = exprEl.selectionStart ?? exprEl.value.length;
    const end = exprEl.selectionEnd ?? exprEl.value.length;
    const before = exprEl.value.slice(0, start);
    const after  = exprEl.value.slice(end);
    exprEl.value = before + k + after;
    const pos = start + k.length;
    exprEl.setSelectionRange(pos, pos);
    exprEl.focus();
    updateLive();
  }

  function backspace(){
    const start = exprEl.selectionStart ?? exprEl.value.length;
    const end = exprEl.selectionEnd ?? exprEl.value.length;
    if(start !== end){
      const before = exprEl.value.slice(0, start);
      const after  = exprEl.value.slice(end);
      exprEl.value = before + after;
      exprEl.setSelectionRange(start, start);
    } else if(start > 0){
      exprEl.value = exprEl.value.slice(0, start-1) + exprEl.value.slice(start);
      exprEl.setSelectionRange(start-1, start-1);
    }
    exprEl.focus();
    updateLive();
  }

  function clearLine(){
    exprEl.value = '';
    exprEl.focus();
    updateLive();
  }

  function togglePlusMinus(){
    // Toggle sign of last number segment
    const v = exprEl.value;
    const i = v.search(/([0-9.]+)\s*$/);
    if(i === -1) return;
    const m = v.match(/([0-9.]+)\s*$/);
    if(!m) return;
    const num = m[1];
    const before = v.slice(0, v.length - num.length);
    // check if before ends with "-(" or operator?
    // simple: if before ends with "-" and previous is operator, remove it, else add "-"
    const trimmedBefore = before.replace(/\s+$/, '');
    if(trimmedBefore.endsWith('-') && /[\+\-\*\/\(]$/.test(trimmedBefore.slice(-1))){
      // not robust; keep simple
    }
    // If number already has unary minus right before it
    if(/-\s*$/.test(trimmedBefore)){
      // remove that minus
      exprEl.value = trimmedBefore.replace(/-\s*$/, '') + num;
    }else{
      exprEl.value = before + '-' + num;
    }
    exprEl.focus();
    updateLive();
  }

  function nowStr(){
    const d = new Date();
    const pad = n => String(n).padStart(2,'0');
    return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function addLogItem(expression, value){
    const item = {
      id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
      expr: expression,
      res: value,
      t: nowStr()
    };
    log.unshift(item);
    if(log.length > 200) log = log.slice(0,200); // limit
    saveLog();
    renderLog();
  }

  function renderLog(){
    logCount.textContent = String(log.length);
    if(log.length === 0){
      emptyState.style.display = 'block';
      logTable.style.display = 'none';
      logBody.innerHTML = '';
      return;
    }
    emptyState.style.display = 'none';
    logTable.style.display = 'table';
    logBody.innerHTML = '';
    log.forEach((it, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${log.length - idx}</td>
        <td class="exprTd">${escapeHtml(it.expr)}</td>
        <td class="resTd">${escapeHtml(it.res)}</td>
        <td>${escapeHtml(it.t)}</td>
      `;
      logBody.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    }[c]));
  }

  function saveLog(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(log));
  }
  function loadLog(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      setBadge('تم النسخ ✅', true);
    }catch(e){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      setBadge('تم النسخ ✅', true);
    }
  }

  function buildTSVTable(){
    // Copy as table-friendly TSV (Excel/Sheets/WhatsApp paste)
    const rows = [];
    rows.push(['#','العملية','النتيجة','الوقت'].join('\t'));
    log.slice().reverse().forEach((it, idx) => {
      rows.push([idx+1, it.expr, it.res, it.t].join('\t'));
    });
    return rows.join('\n');
  }

  function exportPDF(){
    if(log.length === 0){
      setBadge('السجل فارغ', false);
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'p', unit:'pt', format:'a4' });

    // Try to register Arabic font if available from the arabic-fonts package
    // The package exposes multiple fonts; we attempt common keys safely.
    let fontName = 'helvetica';
    try{
      // Try several possible exports (varies by package build)
      const fontObj = window.arabicFont || window.ArabicFonts || window.arabicFonts;
      // Prefer Amiri if present
      if(fontObj){
        const candidates = [
          { vfs: fontObj.AmiriRegular?.vfs, name:'Amiri', file:'Amiri-Regular.ttf' },
          { vfs: fontObj.CairoRegular?.vfs, name:'Cairo', file:'Cairo-Regular.ttf' },
          { vfs: fontObj.NotoNaskhArabicRegular?.vfs, name:'NotoNaskhArabic', file:'NotoNaskhArabic-Regular.ttf' },
        ];
        const found = candidates.find(c => c.vfs);
        if(found){
          doc.addFileToVFS(found.file, found.vfs);
          doc.addFont(found.file, found.name, 'normal');
          doc.setFont(found.name);
          fontName = found.name;
        }
      }
    }catch(e){}

    doc.setFont(fontName);
    doc.setFontSize(14);
    doc.text('تم تطوير الحاسبة من قبل الحايك للحلول الرقمية', 40, 45, { align:'right' });
    doc.setFontSize(11);
    doc.text(`تاريخ التصدير: ${nowStr()}`, 40, 65, { align:'right' });

    const body = log.slice().reverse().map((it, idx) => ([
      String(idx+1),
      it.expr,
      it.res,
      it.t
    ]));

    doc.autoTable({
      startY: 85,
      head: [['#','العملية','النتيجة','الوقت']],
      body,
      styles: {
        font: fontName,
        fontSize: 10,
        cellPadding: 6,
        halign: 'right',
        valign: 'middle'
      },
      headStyles: {
        halign: 'right'
      },
      columnStyles: {
        0: { halign:'center', cellWidth: 34 },
        1: { halign:'left' },   // expression LTR looks better
        2: { halign:'left', cellWidth: 90 },
        3: { halign:'center', cellWidth: 120 }
      },
      didParseCell: function(data){
        // Make expression/result left-to-right visually
        if(data.section === 'body'){
          if(data.column.index === 1 || data.column.index === 2){
            data.cell.styles.halign = 'left';
          }
        }
      },
      margin: { left: 40, right: 40 }
    });

    doc.save('Hayek-Calculator-Log.pdf');
    setBadge('تم تصدير PDF ✅', true);
  }

  // Events
  exprEl.addEventListener('input', updateLive);

  document.querySelectorAll('[data-k]').forEach(btn => {
    btn.addEventListener('click', () => {
      vibrate();
      const k = btn.getAttribute('data-k');
      // Show nicer glyphs but store operators as JS ones
      appendToExpr(k);
    });
  });

  document.getElementById('backspace').addEventListener('click', () => { vibrate(); backspace(); });
  document.getElementById('clearLine').addEventListener('click', () => { vibrate(25); clearLine(); setBadge('تم مسح السطر', true); });

  document.getElementById('equals').addEventListener('click', () => {
    vibrate(22);
    const exp = sanitizeExpression(exprEl.value);
    const r = safeEval(exp);
    if(!exp){
      setBadge('اكتب عملية أولاً', false);
      return;
    }
    if(r.ok){
      const val = formatNumber(r.value);
      resultEl.textContent = val;
      addLogItem(r.cleaned, val);
      setBadge('تم تسجيل العملية ✅', true);
    }else{
      setBadge(r.error, false);
    }
  });

  document.getElementById('plusMinus').addEventListener('click', () => { vibrate(); togglePlusMinus(); });

  document.getElementById('copyResult').addEventListener('click', async() => {
    vibrate();
    const txt = resultEl.textContent || '0';
    await copyText(txt);
  });

  document.getElementById('copyTable').addEventListener('click', async() => {
    vibrate();
    if(log.length === 0){ setBadge('السجل فارغ', false); return; }
    await copyText(buildTSVTable());
  });

  document.getElementById('exportPdf').addEventListener('click', () => { vibrate(); exportPDF(); });

  document.getElementById('clearLog').addEventListener('click', () => {
    vibrate(30);
    log = [];
    saveLog();
    renderLog();
    setBadge('تم حذف السجل', true);
  });

  // Init
  renderLog();
  updateLive();
})();
</script>
</body>
</html>
