<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111315" />
  <title>HAYEK SPOT | Invoice</title>

  <style>
    :root{
      --white:#fff; --green:#19C37D; --yellow:#D6A628; --black:#111315; --dark:#2F3337;
      --bg:#5F6368;
      --line: rgba(0,0,0,.10);
      --muted: rgba(0,0,0,.65);
      --shadow: 0 14px 40px rgba(0,0,0,.18);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Arabic","Noto Naskh Arabic",sans-serif;
      background:#f4f6f7;
      color:#111;
      padding:16px;
    }

    .wrap{width:min(820px, 100%); margin:0 auto; display:grid; gap:12px}

    .card{
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:14px 14px;
      background:
        radial-gradient(520px 180px at 50% -10%, rgba(25,195,125,.18), rgba(0,0,0,0) 70%),
        radial-gradient(520px 180px at 10% 30%, rgba(214,166,40,.18), rgba(0,0,0,0) 70%),
        #ffffff;
      border-bottom:1px solid rgba(0,0,0,.10);
    }

    .brand{display:grid; gap:4px}
    .brand b{font-size:18px; letter-spacing:.3px}
    .brand span{font-size:12px; color: var(--muted)}

    .btnRow{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border:1px solid rgba(0,0,0,.12);
      background:#fff;
      color:#111;
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.green{background: rgba(25,195,125,.14); border-color: rgba(25,195,125,.35)}
    .btn.yellow{background: rgba(214,166,40,.16); border-color: rgba(214,166,40,.35)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    .meta{
      padding:14px;
      display:grid;
      gap:10px;
    }

    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(0,0,0,.10);
      background:#fafafa;
      border-radius:999px;
      padding:7px 10px;
      white-space:nowrap;
    }
    .chip strong{direction:ltr}

    .hero{
      padding:14px;
      display:grid;
      gap:10px;
      border-top:1px solid rgba(0,0,0,.08);
      border-bottom:1px solid rgba(0,0,0,.08);
      background:
        radial-gradient(700px 260px at 50% 0%, rgba(214,166,40,.12), rgba(0,0,0,0) 70%),
        radial-gradient(700px 240px at 20% 50%, rgba(25,195,125,.10), rgba(0,0,0,0) 65%),
        #fff;
    }

    .bannerBox{
      text-align:center;
      padding:14px 12px;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
    }
    .bannerTitle{font-weight:1000; font-size:26px; line-height:1.1}
    .bannerSub{margin-top:6px; font-weight:1000; letter-spacing:2px; color:#0f7d4f}

    table{
      width:100%;
      border-collapse:collapse;
      border:1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid rgba(0,0,0,.08);
      font-size:13px;
      text-align:right;
      vertical-align:top;
    }
    th{
      background:#f6f6f6;
      font-weight:1000;
      color:#111;
      border-bottom:1px solid rgba(0,0,0,.14);
    }
    td.num{direction:ltr; text-align:left; font-weight:900}
    tr:last-child td{border-bottom:none}

    .total{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
      padding:12px 12px;
      border:2px dashed rgba(0,0,0,.35);
      border-radius:16px;
      background:#fff;
      font-weight:1000;
      font-size:16px;
    }
    .total span:last-child{direction:ltr}

    .footerBox{
      margin-top:12px;
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.12);
      background:#111;
      color:#fff;
      display:grid;
      gap:8px;
      text-align:center;
    }
    .footerMain{font-weight:1000; font-size:15px; line-height:1.7}
    .footerLine{font-weight:1000; font-size:13px; color:#D6A628; line-height:1.8}
    .footerPhone{
      font-weight:1000;
      font-size:18px;
      direction:ltr;
      color:#19C37D;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.18);
      border-radius:14px;
      padding:10px 12px;
      display:inline-block;
      margin:0 auto;
    }

    .note{
      font-size:12px;
      color: var(--muted);
      line-height:1.8;
    }

    /* ✅ طباعة واضحة بدون تغبيش */
    @media print{
      body{background:#fff; padding:0}
      .btnRow{display:none !important}
      .card{box-shadow:none; border:none; border-radius:0}
      .topbar{border:none}
      .wrap{width:100%; margin:0}
      table{page-break-inside:auto}
      tr{page-break-inside:avoid; page-break-after:auto}
      .footerBox{break-inside: avoid; page-break-inside: avoid}
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="card">
      <div class="topbar">
        <div class="brand">
          <b>HAYEK SPOT</b>
          <span>فاتورة رسمية — طباعة/PDF</span>
        </div>

        <div class="btnRow">
          <button class="btn green" id="printBtn">طباعة / PDF</button>
          <button class="btn yellow" id="reloadBtn">تحديث</button>
        </div>
      </div>

      <div class="meta">
        <div class="chips" id="chips">
          <div class="chip">Invoice: <strong id="invId">—</strong></div>
          <div class="chip">العميل: <span id="customer">—</span></div>
          <div class="chip">المستخدم: <span id="username">—</span></div>
          <div class="chip">التاريخ: <span id="date">—</span></div>
          <div class="chip">الحالة: <span id="status">—</span></div>
        </div>

        <div class="hero">
          <div class="bannerBox">
            <div class="bannerTitle">شركة الحايك</div>
            <div class="bannerSub">HAYEK SPOT</div>
          </div>

          <div class="note" id="hint">جارٍ تحميل الفاتورة…</div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>الوقت</th>
                  <th>البيان</th>
                  <th class="num">العملية</th>
                  <th class="num">النتيجة</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="total">
            <span>إجمالي الكشف:</span>
            <span id="grandTotal">0</span>
          </div>

          <div class="footerBox">
            <div class="footerMain">تم تطوير هذه الحاسبة الاحترافية من قبل شركة الحايك</div>
            <div class="footerLine">شركة الحايك / تجارة عامة / توزيع جملة / دعاية و اعلان / طباعة / حلول رقمية /</div>
            <div class="footerPhone">05510217646</div>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
  // =========================
  // ✅ Supabase REST
  // =========================
  const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
  const SUPABASE_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";
  const REST = `${SUPABASE_URL}/rest/v1`;
  const $ = (id)=>document.getElementById(id);

  const apiFetch = async (path, options = {}) => {
    const res = await fetch(`${REST}${path}`, {
      ...options,
      headers: {
        "apikey": SUPABASE_KEY,
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json",
        "Accept": "application/json",
        ...(options.headers || {})
      }
    });
    if (!res.ok) {
      const t = await res.text().catch(()=> "");
      throw new Error(`API ${res.status}: ${t || res.statusText}`);
    }
    const text = await res.text();
    return text ? JSON.parse(text) : null;
  };

  function qs(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }

  function fmtDateTime(ts){
    try{
      const d = new Date(ts);
      return d.toLocaleString("ar-EG", { hour12:true });
    }catch{ return String(ts||""); }
  }
  function fmtTime(ts){
    try{
      const d = new Date(ts);
      return d.toLocaleTimeString("ar", { hour:"2-digit", minute:"2-digit", second:"2-digit" });
    }catch{ return ""; }
  }
  function safeNum(x){
    const n = Number(x);
    return Number.isFinite(n) ? n : 0;
  }
  function formatNumber(n){
    const x = Number(n);
    if (!Number.isFinite(x)) return "0";
    const s = x.toString();
    return s.includes(".") ? x.toFixed(6).replace(/0+$/,"").replace(/\.$/,"") : s;
  }

  async function loadInvoiceAndOps(invoiceId){
    $("hint").textContent = "جارٍ تحميل الفاتورة…";
    $("tbody").innerHTML = "";
    $("grandTotal").textContent = "0";

    // 1) Invoice (مرن: invoice_id أو id)
    let inv = null;
    try{
      const r1 = await apiFetch(`/app_invoices?select=invoice_id,id,username,customer_name,status,total,created_at,closed_at&limit=1&invoice_id=eq.${encodeURIComponent(invoiceId)}`, { method:"GET" });
      inv = Array.isArray(r1) ? r1[0] : null;
    }catch(_){}

    if (!inv){
      try{
        const r2 = await apiFetch(`/app_invoices?select=invoice_id,id,username,customer_name,status,total,created_at,closed_at&limit=1&id=eq.${encodeURIComponent(invoiceId)}`, { method:"GET" });
        inv = Array.isArray(r2) ? r2[0] : null;
      }catch(_){}
    }

    if (!inv){
      $("hint").textContent = "لم يتم العثور على الفاتورة ❌";
      $("invId").textContent = invoiceId || "—";
      return;
    }

    const shownId = inv.invoice_id || inv.id || invoiceId;

    $("invId").textContent = shownId;
    $("customer").textContent = inv.customer_name || "—";
    $("username").textContent = inv.username || "—";
    $("status").textContent = inv.status || "—";
    $("date").textContent = fmtDateTime(inv.closed_at || inv.created_at);

    // 2) Operations
    const ops = await apiFetch(
      `/app_operations?select=created_at,label,operation,result&order=created_at.asc&invoice_id=eq.${encodeURIComponent(shownId)}`,
      { method:"GET" }
    );

    const rows = Array.isArray(ops) ? ops : [];
    if (!rows.length){
      $("hint").textContent = "لا توجد سطور داخل هذه الفاتورة.";
    } else {
      $("hint").textContent = "";
    }

    let total = 0;
    const tb = $("tbody");
    tb.innerHTML = "";

    rows.forEach(r=>{
      const tr = document.createElement("tr");

      const tdT = document.createElement("td");
      tdT.textContent = fmtTime(r.created_at);

      const tdL = document.createElement("td");
      tdL.textContent = r.label || "عملية";

      const tdO = document.createElement("td");
      tdO.className = "num";
      tdO.textContent = r.operation || "";

      const tdR = document.createElement("td");
      tdR.className = "num";
      tdR.textContent = r.result ?? "";

      total += safeNum(r.result);

      tr.append(tdT, tdL, tdO, tdR);
      tb.appendChild(tr);
    });

    // إذا كان total موجود بالفاتورة وخانة العمليات تعطي 0، نعتمد الحساب من السطور
    const finalTotal = Number.isFinite(Number(inv.total)) ? Number(inv.total) : total;
    $("grandTotal").textContent = formatNumber(finalTotal);

    // ✅ إذا تم فتح الصفحة بطلب print=1 اطبع تلقائي بعد التحميل
    if (qs("print") === "1"){
      setTimeout(()=> window.print(), 350);
    }
  }

  $("printBtn").addEventListener("click", ()=> window.print());
  $("reloadBtn").addEventListener("click", ()=> location.reload());

  // Boot
  const invoiceId = qs("invoice_id") || "";
  loadInvoiceAndOps(invoiceId).catch(err=>{
    console.error(err);
    $("hint").textContent = "خطأ اتصال أثناء تحميل الفاتورة.";
  });
</script>
</body>
</html>
