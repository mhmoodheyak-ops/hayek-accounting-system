<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>HAYEK — نظام الفاتورة</title>

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#071018; --panel:#0e1b26; --line:rgba(255,255,255,.08);
      --txt:#e9f1ff; --muted:#98a8c2; --blue:#1f5bd8; --blue2:#2967ee;
      --shadow:0 12px 35px rgba(0,0,0,.35); --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 700px at 50% -10%, rgba(31,91,216,.18), transparent 55%),
                  radial-gradient(900px 600px at 10% 20%, rgba(34,197,94,.10), transparent 55%),
                  linear-gradient(180deg,#061018 0%, #071018 50%, #061018 100%);
      color:var(--txt); min-height:100vh; display:flex; justify-content:center; padding:14px;
    }
    .wrap{width:100%; max-width:420px}
    .top{display:flex; align-items:center; justify-content:space-between; padding:10px 10px 14px}
    .brand{display:flex; align-items:center; gap:10px}
    .dot{width:12px;height:12px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 6px rgba(34,197,94,.12)}
    .ttl{font-weight:900}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{border:1px solid var(--line); background:rgba(255,255,255,.04); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted)}
    .card{
      background: linear-gradient(180deg, rgba(14,27,38,.95) 0%, rgba(10,20,30,.92) 100%);
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px;
    }
    .hint{color:var(--muted); font-size:12px; line-height:1.6}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input{
      width:100%; padding:12px 12px; border-radius:14px; border:1px solid var(--line);
      background: rgba(0,0,0,.18); color:var(--txt); outline:none;
    }
    input:focus{border-color:rgba(31,91,216,.55); box-shadow:0 0 0 4px rgba(31,91,216,.18)}
    .row{display:flex; gap:10px}
    .row>*{flex:1}
    .btn{
      width:100%; padding:12px 12px; border-radius:16px; border:1px solid var(--line);
      background: rgba(255,255,255,.06); color:var(--txt); font-weight:900; cursor:pointer; transition:.15s;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.08)}
    .btn.blue{background:var(--blue); border-color:rgba(31,91,216,.2)}
    .btn.blue:hover{background:var(--blue2)}
    .btn.small{width:auto; padding:9px 12px; border-radius:14px; font-size:12px}
    .sep{height:1px; background:var(--line); margin:12px 0}
    .error{
      margin-top:10px; display:none; padding:10px; border-radius:14px;
      border:1px solid rgba(255,77,77,.25); background:rgba(255,77,77,.10);
      color:#ffd6d6; white-space:pre-wrap; font-size:12px;
    }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:16px;
      background:rgba(0,0,0,.75); border:1px solid rgba(255,255,255,.10);
      padding:10px 12px; border-radius:999px; color:#eaf2ff; font-size:12px; display:none; z-index:9999;
      max-width:92vw; text-align:center;
    }
    .tabs{display:flex; gap:10px; margin-top:8px; margin-bottom:10px}
    .tab{
      flex:1; padding:10px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.05); color:var(--txt); font-weight:900; cursor:pointer;
    }
    .tab.active{background:rgba(31,91,216,.22); border-color:rgba(31,91,216,.25)}
    .calcBox{border:1px solid var(--line); background:rgba(0,0,0,.12); border-radius:18px; padding:12px}
    .exprTitle{font-size:12px; color:var(--muted); margin-bottom:8px}
    .expr{
      width:100%; border:1px solid var(--line); background:rgba(0,0,0,.18); border-radius:16px;
      padding:12px; text-align:right; min-height:46px; display:flex; align-items:center; justify-content:flex-end;
      white-space:nowrap; overflow:auto; font-weight:800;
    }
    .resLine{margin-top:10px; display:flex; justify-content:flex-end; gap:8px; color:var(--muted); font-size:12px}
    .resLine b{font-size:14px; color:var(--txt)}
    .keys{margin-top:12px; display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px}
    .key{
      border:0; border-radius:14px; background:rgba(255,255,255,.10);
      color:var(--txt); padding:14px 0; font-size:16px; font-weight:900; cursor:pointer;
    }
    .key:hover{transform:translateY(-1px); background:rgba(255,255,255,.12)}
    .key.op{background:rgba(255,255,255,.12)}
    .key.eq{grid-column:1 / span 2; background:var(--blue)}
    .key.eq:hover{background:var(--blue2)}
    .key.back{grid-column:3 / span 2}
    .actions2{margin-top:12px; display:grid; grid-template-columns:1fr; gap:10px}
    .footerNote{margin-top:10px; text-align:center; font-size:11px; color:var(--muted); line-height:1.6}
    .logTable{margin-top:10px; border:1px solid var(--line); border-radius:18px; overflow:hidden; background:rgba(0,0,0,.10)}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 10px; border-bottom:1px solid var(--line); font-size:12px; text-align:right; vertical-align:top}
    th{color:var(--muted); background:rgba(255,255,255,.05)}
    tr:last-child td{border-bottom:0}
    .muted{color:var(--muted)}
    .hide{display:none !important}

    /* PDF hidden */
    #printArea{position:fixed; left:-9999px; top:0; width:794px; background:#fff; color:#111827; padding:22px; direction:rtl; font-family:Arial,"Segoe UI",Tahoma,sans-serif;}
    .p-box{border:2px solid #111; border-radius:16px; padding:14px 16px; margin-bottom:14px;}
    .p-header{text-align:center; padding:18px 16px;}
    .p-title{font-weight:900; font-size:18px; margin:0;}
    .p-subtitle{margin-top:6px; font-size:12px; color:#0a7a55; font-weight:800;}
    .p-field{display:flex; justify-content:space-between; gap:10px; padding:10px 12px; border:2px solid #111; border-radius:14px; margin-bottom:10px;}
    .p-field .k{font-size:12px; font-weight:900;}
    .p-field .v{font-size:12px; font-weight:800;}
    .p-tableWrap{border:2px solid #111; border-radius:16px; overflow:hidden;}
    #printArea table{width:100%; border-collapse:collapse; background:#fff;}
    #printArea thead th{font-size:12px; font-weight:900; padding:10px; border-bottom:2px solid #111; background:#fff;}
    #printArea tbody td{font-size:12px; padding:10px; border-bottom:1px solid #111; background:#fff;}
    #printArea tbody tr:last-child td{border-bottom:0;}
    .p-totalBox{border:2px dashed #111; border-radius:16px; padding:12px 14px; display:flex; justify-content:space-between; margin-top:12px; font-weight:900;}
    .p-foot{border:2px solid #111; border-radius:16px; padding:14px 16px; margin-top:14px; text-align:center;}
    .p-foot .small{font-size:12px; color:#555; font-weight:800; line-height:1.8;}
    .p-phone{display:inline-block; margin-top:10px; border:2px solid #0a7a55; color:#0a7a55; border-radius:999px; padding:10px 18px; font-weight:900; font-size:16px;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="ttl">HAYEK — نظام الفاتورة</div>
          <div class="sub" id="subtitle">تسجيل دخول المستخدم</div>
        </div>
      </div>
      <div class="pill" id="pill"><b>غير مسجل</b></div>
    </div>

    <div class="card" id="loginCard">
      <div class="hint">ادخل اسم المستخدم وكلمة السر (من الأدمن).</div>
      <label>اسم المستخدم</label>
      <input id="loginUser" autocomplete="username" />
      <label>كلمة السر</label>
      <input id="loginPass" type="password" autocomplete="current-password" />
      <div class="row" style="margin-top:12px">
        <button class="btn blue" id="btnLogin">دخول</button>
        <button class="btn" id="btnClear">تفريغ</button>
      </div>
      <div class="error" id="loginErr"></div>
    </div>

    <div class="card hide" id="appCard">
      <div class="row" style="align-items:center">
        <button class="btn small" id="btnLogout">خروج</button>
      </div>

      <div class="sep"></div>

      <label>اسم الزبون (إجباري)</label>
      <!-- ✅ ذاكرة + اقتراحات -->
      <input id="customerName" placeholder="مثال: أبو أحمد" list="custList" autocomplete="off" />
      <datalist id="custList"></datalist>

      <label>اسم المنتج / البيان (اختياري)</label>
      <!-- ✅ ذاكرة + اقتراحات -->
      <input id="itemName" placeholder="مثال: قداحة" list="itemList" autocomplete="off" />
      <datalist id="itemList"></datalist>

      <div class="tabs">
        <button class="tab active" id="tabCalc">الحاسبة</button>
        <button class="tab" id="tabLog">سجل العمليات</button>
      </div>

      <div id="viewCalc">
        <div class="calcBox">
          <div class="exprTitle">العملية الحسابية (من أزرار الشاشة)</div>
          <div class="expr" id="exprView"></div>
          <div class="resLine"><span>النتيجة:</span> <b id="resView">0</b></div>

          <div class="keys" id="keys">
            <button class="key op" data-k="÷">÷</button>
            <button class="key" data-k="9">9</button>
            <button class="key" data-k="8">8</button>
            <button class="key" data-k="7">7</button>

            <button class="key op" data-k="×">×</button>
            <button class="key" data-k="6">6</button>
            <button class="key" data-k="5">5</button>
            <button class="key" data-k="4">4</button>

            <button class="key op" data-k="-">-</button>
            <button class="key" data-k="3">3</button>
            <button class="key" data-k="2">2</button>
            <button class="key" data-k="1">1</button>

            <button class="key op" data-k="+">+</button>
            <button class="key" data-k="(">(</button>
            <button class="key" data-k="0">0</button>
            <button class="key" data-k=")">)</button>

            <button class="key eq" id="btnEq">=</button>
            <button class="key back" id="btnBack">⌫</button>
          </div>

          <div class="actions2">
            <button class="btn" id="btnClearOps">مسح العمليات</button>
            <button class="btn blue" id="btnPDF">تصدير PDF</button>
          </div>

          <div class="footerNote">تم تطوير هذه الحاسبة الاحترافية من قبل شركة الحايك للحلول الرقمية</div>
        </div>
      </div>

      <div id="viewLog" class="hide">
        <div class="logTable">
          <table>
            <thead>
              <tr>
                <th style="width:52%">البيان</th>
                <th style="width:26%">العملية</th>
                <th style="width:22%">الوقت</th>
              </tr>
            </thead>
            <tbody id="logBody">
              <tr><td colspan="3" class="muted">لا يوجد عمليات بعد.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="error" id="appErr"></div>
    </div>

    <div id="printArea"></div>
    <div class="toast" id="toast"></div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0aWR3cXZ5cmp5ZG1lZ2p6dXZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTAyNzQsImV4cCI6MjA4NTk4NjI3NH0.N1X39yfO6CLYu8UpbZsmlkIUELN_mmAzxUCQBCV7O8g";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id)=>document.getElementById(id);

    const loginCard = $("loginCard");
    const appCard   = $("appCard");
    const loginErr  = $("loginErr");
    const appErr    = $("appErr");
    const subtitle  = $("subtitle");
    const pill      = $("pill");

    const tabCalc   = $("tabCalc");
    const tabLog    = $("tabLog");
    const viewCalc  = $("viewCalc");
    const viewLog   = $("viewLog");

    const custInput = $("customerName");
    const itemInput = $("itemName");

    const custList  = $("custList");
    const itemList  = $("itemList");

    const exprView  = $("exprView");
    const resView   = $("resView");
    const logBody   = $("logBody");
    const toastEl   = $("toast");

    const USERS_TABLE   = "app_users";
    const INVOICE_TABLE = "app_invoices";

    // =========================
    // ✅ ذاكرة النص التنبؤي (اقتراحات)
    // =========================
    const SUG_CUSTOMERS_KEY = "HAYEK_SUG_CUSTOMERS";
    const SUG_ITEMS_KEY     = "HAYEK_SUG_ITEMS";
    const MAX_SUG = 60;

    function readSug(key){
      try{
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        return Array.isArray(arr) ? arr.filter(Boolean) : [];
      }catch{ return []; }
    }
    function writeSug(key, arr){
      localStorage.setItem(key, JSON.stringify(arr.slice(0, MAX_SUG)));
    }
    function addSug(key, value){
      const v = String(value || "").trim();
      if(!v) return;

      // تنظيف بسيط + منع تكرار بنفس النص
      const arr = readSug(key);
      const norm = v.toLowerCase();

      const filtered = arr.filter(x => String(x).toLowerCase() !== norm);
      filtered.unshift(v); // أحدث شيء أولاً
      writeSug(key, filtered);
      renderSug(); // تحديث فوري
    }
    function renderDatalist(el, values){
      el.innerHTML = values.map(v => `<option value="${escapeHtml(v)}"></option>`).join("");
    }
    function renderSug(){
      renderDatalist(custList, readSug(SUG_CUSTOMERS_KEY));
      renderDatalist(itemList, readSug(SUG_ITEMS_KEY));
    }

    // (اختياري) عند خروج المؤشر من الحقل نحفظ القيمة كاقتراح
    custInput?.addEventListener("change", ()=> addSug(SUG_CUSTOMERS_KEY, custInput.value));
    itemInput?.addEventListener("change", ()=> addSug(SUG_ITEMS_KEY, itemInput.value));

    function showErr(box, msg){ box.style.display="block"; box.textContent = msg; }
    function clearErr(box){ box.style.display="none"; box.textContent = ""; }
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      setTimeout(()=> toastEl.style.display="none", 1400);
    }
    function nowTime(){ return new Date().toLocaleTimeString("ar",{hour:"2-digit", minute:"2-digit"}); }

    function uuid(){
      if(window.crypto?.randomUUID) return crypto.randomUUID();
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c=>{
        const r = (Math.random()*16)|0, v = c==="x" ? r : (r&0x3)|0x8;
        return v.toString(16);
      });
    }

    // ------- STATE -------
    let USER = null;
    let invoiceId = null;
    let invoiceOpen = false;

    let ops = [];
    let expr = "";
    let lastResult = 0;

    // ------- SUPABASE SAVE (FIXED) -------
    async function saveInvoice(status){
      if(!invoiceId || !USER?.id) return { ok:false, msg:"no-invoice" };

      const customer = custInput.value.trim();

      const total = calcTotal();
      const payload = {
        id: invoiceId,
        owner_id: USER.id,
        rows: buildRowsWithMeta(customer),
        total: total,
        status: status,
        closed_at: status === "closed" ? new Date().toISOString() : null
      };

      const { data, error } = await supabase
        .from(INVOICE_TABLE)
        .upsert(payload, { onConflict: "id" })
        .select("id")
        .limit(1);

      if(error){
        return { ok:false, msg: (error.message || JSON.stringify(error)) };
      }
      return { ok:true, id: (data?.[0]?.id || invoiceId) };
    }

    function buildRowsWithMeta(customer){
      const meta = {
        __meta: true,
        customer: customer || "",
        user: USER?.username || "",
        saved_at: new Date().toISOString()
      };
      return [meta, ...ops];
    }

    // ------- LOGIN -------
    async function login(){
      clearErr(loginErr);
      const username = $("loginUser").value.trim();
      const password = $("loginPass").value.trim();

      if(!username || !password){
        showErr(loginErr, "اكتب اسم المستخدم وكلمة السر.");
        return;
      }

      const { data, error } = await supabase.from(USERS_TABLE).select("*").eq("username", username).limit(1);
      if(error){ showErr(loginErr, "خطأ اتصال:\n" + (error.message||"")); return; }
      if(!data?.length){ showErr(loginErr, "المستخدم غير موجود."); return; }

      const u = data[0];
      if(u.password !== password){ showErr(loginErr, "كلمة السر غير صحيحة."); return; }
      if(u.is_blocked){ showErr(loginErr, "هذا الحساب محظور."); return; }

      USER = u;
      localStorage.setItem("HAYEK_USER_SESSION", JSON.stringify({ id:u.id }));
      loginCard.classList.add("hide");
      appCard.classList.remove("hide");
      subtitle.textContent = "فاتورة المستخدم";
      pill.innerHTML = `<b>${u.username}</b>`;
      resetAll(true);

      // ✅ حمّل الاقتراحات فوراً بعد الدخول
      renderSug();
    }

    async function restoreSession(){
      try{
        const s = JSON.parse(localStorage.getItem("HAYEK_USER_SESSION")||"null");
        if(!s?.id) return;
        const { data } = await supabase.from(USERS_TABLE).select("*").eq("id", s.id).limit(1);
        if(data?.length && !data[0].is_blocked){
          USER = data[0];
          loginCard.classList.add("hide");
          appCard.classList.remove("hide");
          subtitle.textContent = "فاتورة المستخدم";
          pill.innerHTML = `<b>${USER.username}</b>`;
          resetAll(true);

          // ✅ حمّل الاقتراحات فوراً
          renderSug();
        }
      }catch{}
    }

    function logout(){
      USER = null;
      localStorage.removeItem("HAYEK_USER_SESSION");
      loginCard.classList.remove("hide");
      appCard.classList.add("hide");
      subtitle.textContent = "تسجيل دخول المستخدم";
      pill.innerHTML = "<b>غير مسجل</b>";
    }

    // ------- UI / Tabs -------
    function setTab(which){
      if(which==="calc"){
        tabCalc.classList.add("active");
        tabLog.classList.remove("active");
        viewCalc.classList.remove("hide");
        viewLog.classList.add("hide");
      }else{
        tabLog.classList.add("active");
        tabCalc.classList.remove("active");
        viewLog.classList.remove("hide");
        viewCalc.classList.add("hide");
      }
    }

    // ------- Core -------
    function resetAll(silent=false){
      clearErr(appErr);
      invoiceId = null;
      invoiceOpen = false;
      ops = [];
      expr = "";
      lastResult = 0;
      exprView.textContent = "";
      resView.textContent = "0";
      renderLog();
      if(!silent){
        custInput.value = "";
        itemInput.value = "";
      }
    }

    function requireCustomer(){
      const c = custInput.value.trim();
      if(!c){
        showErr(appErr, "اكتب اسم الزبون أولاً (إجباري).");
        custInput.focus();
        return null;
      }
      clearErr(appErr);

      // ✅ خزّن اسم الزبون كاقتراح (ذاكرة)
      addSug(SUG_CUSTOMERS_KEY, c);

      return c;
    }

    async function ensureInvoiceOpened(){
      const customer = requireCustomer();
      if(!customer) return false;
      if(invoiceOpen) return true;

      invoiceId = uuid();
      invoiceOpen = true;

      const r = await saveInvoice("open");
      if(!r.ok){
        showErr(appErr, "فشل الحفظ (open):\n" + r.msg + "\n\n✅ تأكد أن عمود id Primary Key في Supabase.");
        return false;
      }
      return true;
    }

    function calcTotal(){
      let t = 0;
      for(const o of ops){
        const n = Number(o.result);
        if(Number.isFinite(n)) t += n;
      }
      if(!ops.length && Number.isFinite(lastResult)) t = lastResult;
      return Math.round(t*100)/100;
    }

    function sanitizeForEval(s){
      return s.replaceAll("×","*").replaceAll("÷","/").replaceAll("٫",".").replaceAll(",",".");
    }
    function safeEval(s){
      const cleaned = sanitizeForEval(s).trim();
      if(!cleaned) return 0;
      if(!/^[0-9+\-*/().\s]+$/.test(cleaned)) throw new Error("bad");
      const fn = new Function("return ("+cleaned+");");
      const val = fn();
      if(!Number.isFinite(val)) return 0;
      return Math.round(val*100)/100;
    }
    function updatePreview(){
      try{ resView.textContent = String(safeEval(expr)); }
      catch{ resView.textContent = "0"; }
    }
    function setExpr(v){
      expr = v;
      exprView.textContent = expr || "";
      updatePreview();
    }
    function press(k){
      setExpr(expr + String(k));
      if(navigator.vibrate) navigator.vibrate(10);
    }
    function backspace(){
      if(!expr) return;
      setExpr(expr.slice(0,-1));
      if(navigator.vibrate) navigator.vibrate(10);
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderLog(){
      if(!ops.length){
        logBody.innerHTML = `<tr><td colspan="3" class="muted">لا يوجد عمليات بعد.</td></tr>`;
        return;
      }
      logBody.innerHTML = ops.map(o=>{
        const t = o.time || nowTime();
        const exp = (o.expr ? `${o.expr} = ${o.result}` : `${o.result}`);
        return `
          <tr>
            <td><b>${escapeHtml(o.label||"عملية")}</b><div class="muted" style="margin-top:4px">${escapeHtml(exp)}</div></td>
            <td>${escapeHtml(exp)}</td>
            <td>${escapeHtml(t)}</td>
          </tr>
        `;
      }).join("");
    }

    async function equalsAndLog(){
      clearErr(appErr);
      const customer = requireCustomer();
      if(!customer) return;

      const ok = await ensureInvoiceOpened();
      if(!ok) return;

      let result = 0;
      try{ result = safeEval(expr); }
      catch{ showErr(appErr, "صيغة العملية غير صحيحة."); return; }

      lastResult = result;

      const item = itemInput.value.trim();
      const label = item || "عملية";

      // ✅ خزّن اسم المنتج/البيان كاقتراح (ذاكرة)
      if(item) addSug(SUG_ITEMS_KEY, item);

      ops.unshift({
        label,
        expr: expr || "",
        result,
        at: new Date().toISOString(),
        time: nowTime()
      });

      renderLog();
      setExpr("");
      toast("تمت الإضافة ✅");

      const r = await saveInvoice("open");
      if(!r.ok){
        showErr(appErr, "فشل الحفظ بعد إضافة العملية:\n" + r.msg + "\n\n✅ غالباً id ليس Primary Key.");
      }
    }

    async function clearOperations(){
      clearErr(appErr);
      ops = [];
      expr = "";
      lastResult = 0;
      exprView.textContent = "";
      resView.textContent = "0";
      renderLog();

      if(invoiceOpen){
        const r = await saveInvoice("open");
        if(!r.ok) showErr(appErr, "فشل الحفظ:\n" + r.msg);
      }
      toast("تم المسح ✅");
    }

    function buildPrintArea(){
      const pa = $("printArea");
      const customer = (custInput.value.trim() || "—");
      const user = (USER?.full_name || USER?.username || "—");
      const invId = String(invoiceId || "—");
      const dateText = new Date().toLocaleString("ar",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
      const total = calcTotal();

      const rows = ops.slice().reverse().map(o=>`
        <tr>
          <td style="width:24%">${escapeHtml(o.time || "")}</td>
          <td style="width:34%">${escapeHtml(o.label || "")}</td>
          <td style="width:26%">${escapeHtml(o.expr || "")}</td>
          <td style="width:16%">${escapeHtml(o.result)}</td>
        </tr>
      `).join("");

      pa.innerHTML = `
        <div class="p-box p-header">
          <div class="p-title">شركة الحايك</div>
          <div class="p-subtitle">HAYEK SPOT</div>
        </div>

        <div class="p-field"><div class="k">اسم المستخدم</div><div class="v" style="direction:rtl;text-align:right">${escapeHtml(user)}</div></div>
        <div class="p-field"><div class="k">اسم العميل</div><div class="v" style="direction:rtl;text-align:right">${escapeHtml(customer)}</div></div>
        <div class="p-field"><div class="k">رقم الفاتورة</div><div class="v">${escapeHtml(invId)}</div></div>
        <div class="p-field"><div class="k">التاريخ</div><div class="v" style="direction:ltr">${escapeHtml(dateText)}</div></div>

        <div class="p-tableWrap">
          <table>
            <thead><tr><th>الوقت</th><th>البيان</th><th>العملية</th><th>النتيجة</th></tr></thead>
            <tbody>${rows || `<tr><td colspan="4" style="padding:14px;font-weight:800;color:#555">لا يوجد عمليات</td></tr>`}</tbody>
          </table>
        </div>

        <div class="p-totalBox"><div>إجمالي الكشف:</div><div>${escapeHtml(total)}</div></div>

        <div class="p-foot">
          <div class="small">تم تطوير هذه الحاسبة الاحترافية من قبل شركة الحايك</div>
          <div class="small">شركة الحايك / تجارة عامة / توزيع جملة / دعاية و اعلان / طباعة / حلول رقمية</div>
          <div class="p-phone">05510217646</div>
        </div>
      `;
      return pa;
    }

    async function exportPDF(){
      clearErr(appErr);

      const customer = requireCustomer();
      if(!customer) return;

      const ok = await ensureInvoiceOpened();
      if(!ok) return;

      const r = await saveInvoice("closed");
      if(!r.ok){
        showErr(appErr, "فشل إغلاق/حفظ الفاتورة:\n" + r.msg + "\n\n✅ الحل: اجعل id Primary Key في جدول app_invoices.");
        return;
      }

      // ✅ تأكيد حفظ اسم الزبون ضمن الاقتراحات قبل التصدير
      addSug(SUG_CUSTOMERS_KEY, customer);

      const pa = buildPrintArea();
      const canvas = await html2canvas(pa,{scale:2,useCORS:true,backgroundColor:"#ffffff"});
      const imgData = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p","mm","a4");

      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const imgW = pageW;
      const imgH = canvas.height * (imgW / canvas.width);

      if(imgH <= pageH){
        pdf.addImage(imgData,"PNG",0,0,imgW,imgH);
      }else{
        let remaining = imgH;
        let position = 0;
        while(remaining > 0){
          pdf.addImage(imgData,"PNG",0,position,imgW,imgH);
          remaining -= pageH;
          if(remaining > 0){ pdf.addPage(); position -= pageH; }
        }
      }

      const safeName = (customer || "invoice").replace(/[\\/:*?"<>|]/g,"-");
      pdf.save(`HAYEK_${safeName}.pdf`);

      toast("تم تنزيل PDF ✅");
      resetAll(false);
    }

    // ------- binds -------
    $("btnLogin").addEventListener("click", login);
    $("btnClear").addEventListener("click", ()=>{ $("loginUser").value=""; $("loginPass").value=""; clearErr(loginErr); });
    $("btnLogout").addEventListener("click", logout);

    tabCalc.addEventListener("click", ()=>setTab("calc"));
    tabLog.addEventListener("click", ()=>setTab("log"));

    $("keys").addEventListener("click", (e)=>{
      const b = e.target.closest("button");
      if(!b) return;
      const k = b.dataset.k;
      if(!k) return;
      press(k);
    });

    $("btnBack").addEventListener("click", backspace);
    $("btnEq").addEventListener("click", equalsAndLog);
    $("btnPDF").addEventListener("click", exportPDF);
    $("btnClearOps").addEventListener("click", clearOperations);

    setTab("calc");

    // ✅ حمّل الاقتراحات من البداية
    renderSug();

    restoreSession();
  </script>
</body>
</html>
