<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>HAYEK â€” Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</title>

  <!-- âœ… PWA / ICON (FINAL) -->
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <meta name="theme-color" content="#071820">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- PDF (Ù†ÙØ¨Ù‚ÙŠÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ø­ØªÙ‰ Ù„Ø§ Ù†ÙƒØ³Ø± Ø´ÙŠØ¡) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- âœ… NEW: AutoTable Ù„Ø¹Ù…Ù„ PDF Ù†ØµÙŠ Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹ -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#071018; --panel:#0e1b26; --line:rgba(255,255,255,.08);
      --txt:#e9f1ff; --muted:#98a8c2; --blue:#1f5bd8; --blue2:#2967ee;
      --shadow:0 12px 35px rgba(0,0,0,.35); --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 700px at 50% -10%, rgba(31,91,216,.18), transparent 55%),
                  radial-gradient(900px 600px at 10% 20%, rgba(34,197,94,.10), transparent 55%),
                  linear-gradient(180deg,#061018 0%, #071018 50%, #061018 100%);
      color:var(--txt); min-height:100vh; display:flex; justify-content:center; padding:14px;
    }
    .wrap{width:100%; max-width:420px}
    .top{display:flex; align-items:center; justify-content:space-between; padding:10px 10px 14px}
    .brand{display:flex; align-items:center; gap:10px}
    .dot{width:12px;height:12px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 6px rgba(34,197,94,.12)}
    .ttl{font-weight:900}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{border:1px solid var(--line); background:rgba(255,255,255,.04); padding:6px 10px; border-radius:999px; font-size:12px; color:var(--muted)}
    .card{
      background: linear-gradient(180deg, rgba(14,27,38,.95) 0%, rgba(10,20,30,.92) 100%);
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px;
      position:relative;
    }

    .hint{
      color:#dbe8ff;
      font-size:14px;
      line-height:1.9;
      font-weight:900;
    }

    label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin:10px 0 6px;
      font-weight:800;
    }

    input{
      width:100%; padding:12px 12px; border-radius:14px; border:1px solid var(--line);
      background: rgba(0,0,0,.18); color:var(--txt); outline:none;
      font-size:14px;
      font-weight:800;
    }
    input:focus{border-color:rgba(31,91,216,.55); box-shadow:0 0 0 4px rgba(31,91,216,.18)}
    .row{display:flex; gap:10px}
    .row>*{flex:1}
    .btn{
      width:100%; padding:12px 12px; border-radius:16px; border:1px solid var(--line);
      background: rgba(255,255,255,.06); color:var(--txt); font-weight:900; cursor:pointer; transition:.15s;
      font-size:14px;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.08)}
    .btn.blue{background:var(--blue); border-color:rgba(31,91,216,.2)}
    .btn.blue:hover{background:var(--blue2)}
    .btn.small{width:auto; padding:9px 12px; border-radius:14px; font-size:12px}
    .btn.danger{background:rgba(255,77,77,.14); border-color:rgba(255,77,77,.25)}
    .btn.danger:hover{background:rgba(255,77,77,.20)}
    .sep{height:1px; background:var(--line); margin:12px 0}
    .error{
      margin-top:10px; display:none; padding:10px; border-radius:14px;
      border:1px solid rgba(255,77,77,.25); background:rgba(255,77,77,.10);
      color:#ffd6d6; white-space:pre-wrap; font-size:12px;
    }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%); bottom:16px;
      background:rgba(0,0,0,.75); border:1px solid rgba(255,255,255,.10);
      padding:10px 12px; border-radius:999px; color:#eaf2ff; font-size:12px; display:none; z-index:9999;
      max-width:92vw; text-align:center;
    }
    .tabs{display:flex; gap:10px; margin-top:8px; margin-bottom:10px}
    .tab{
      flex:1; padding:10px 10px; border-radius:999px; border:1px solid var(--line);
      background:rgba(255,255,255,.05); color:var(--txt); font-weight:900; cursor:pointer;
      font-size:13px;
    }
    .tab.active{background:rgba(31,91,216,.22); border-color:rgba(31,91,216,.25)}
    .calcBox{border:1px solid var(--line); background:rgba(0,0,0,.12); border-radius:18px; padding:12px}

    .exprTitle{
      font-size:14px;
      color:#cfe0ff;
      margin-bottom:8px;
      font-weight:900;
    }

    .expr{
      width:100%;
      border:2px solid rgba(0,0,0,.16);
      background:#ffffff;
      color:#000000;
      border-radius:16px;
      padding:12px;
      text-align:right;
      min-height:52px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      white-space:nowrap;
      overflow:auto;
      font-weight:1000;
      font-size:20px;
    }

    .resLine{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      color:var(--muted);
      font-size:13px;
      font-weight:900;
    }

    .resLine b{
      color:#000;
      font-size:18px;
      font-weight:1000;
      background:#fff;
      border:2px solid rgba(0,0,0,.12);
      padding:6px 10px;
      border-radius:12px;
      min-width:70px;
      text-align:center;
      display:inline-block;
    }

    .keys{margin-top:12px; display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px}
    .key{
      border:0; border-radius:14px; background:rgba(255,255,255,.10);
      color:var(--txt); padding:14px 0; font-size:18px; font-weight:900; cursor:pointer;
    }
    .key:hover{transform:translateY(-1px); background:rgba(255,255,255,.12)}
    .key.op{background:rgba(255,255,255,.12)}
    .key.eq{grid-column:1 / span 2; background:var(--blue)}
    .key.eq:hover{background:var(--blue2)}
    .key.back{grid-column:3 / span 2}

    /* âœ… NEW: Ø£Ø²Ø±Ø§Ø± Ù…ØªØ¹Ø¯Ø¯Ø© */
    .actions2{margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .actions2 .full{grid-column:1 / span 2}

    .footerNote{
      margin-top:10px;
      text-align:center;
      font-size:12px;
      color:#cfe0ff;
      line-height:1.8;
      font-weight:900;
    }

    .logTable{margin-top:10px; border:1px solid var(--line); border-radius:18px; overflow:hidden; background:rgba(0,0,0,.10)}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 10px; border-bottom:1px solid var(--line); font-size:12px; text-align:right; vertical-align:top}
    th{color:var(--muted); background:rgba(255,255,255,.05)}
    tr:last-child td{border-bottom:0}
    .muted{color:var(--muted)}
    .hide{display:none !important}

    /* area used Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ù„Ù„ØµÙˆØ± - Ù†ØªØ±ÙƒÙ‡ */
    #printArea{
      position:fixed; left:-9999px; top:0;
      width:794px;
      background:#fff;
      color:#111827;
      padding:22px;
      direction:rtl;
      font-family:Arial,"Segoe UI",Tahoma,sans-serif;
    }

    /* âœ… Voice mic buttons */
    .hayekMicWrap{display:flex; gap:10px; align-items:center}
    .hayekMicBtn{
      width:46px; min-width:46px; height:46px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      font-weight:1000;
      cursor:pointer;
      transition:.15s;
      display:flex; align-items:center; justify-content:center;
    }
    .hayekMicBtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.08)}
    .hayekMicBtn.on{background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35)}

    /* âœ… NEW: AI Panel (Ø­Ø§ÙŠÙƒ) */
    .aiFab{
      position:fixed;
      right:16px;
      bottom:78px;
      width:56px; height:56px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(31,91,216,.35);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      display:none;
      z-index:9998;
      cursor:pointer;
      color:#fff;
      font-weight:1000;
    }
    .aiFab:hover{transform:translateY(-1px); background:rgba(31,91,216,.45)}
    .aiPanel{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:140px;
      width:min(520px, 94vw);
      max-height:60vh;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,20,30,.96);
      box-shadow: 0 20px 70px rgba(0,0,0,.45);
      z-index:9999;
      display:none;
      overflow:hidden;
    }
    .aiHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .aiTitle{
      display:flex; align-items:center; gap:10px;
      font-weight:1000;
    }
    .aiBadge{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(34,197,94,.30);
      background: rgba(34,197,94,.14);
      font-size:12px;
      color:#d9ffe9;
      font-weight:900;
    }
    .aiBody{
      padding:12px;
      overflow:auto;
      max-height:44vh;
    }
    .aiMsg{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding:10px 12px;
      border-radius:16px;
      margin-bottom:10px;
      line-height:1.75;
      font-weight:800;
      font-size:13px;
    }
    .aiMsg.me{background: rgba(31,91,216,.10); border-color: rgba(31,91,216,.18)}
    .aiMsg.hayek{background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.18)}
    .aiFoot{
      display:flex; gap:10px; padding:12px;
      border-top:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    .aiFoot input{
      flex:1;
      margin:0;
      border-radius:16px;
    }
    .aiMiniBtns{display:flex; gap:8px}
    .aiMiniBtn{
      width:auto; padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:#fff;
      cursor:pointer;
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }
    .aiMiniBtn:hover{transform:translateY(-1px); background:rgba(255,255,255,.10)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="ttl">HAYEK â€” Ù†Ø¸Ø§Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
          <div class="sub" id="subtitle">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
        </div>
      </div>
      <div class="pill" id="pill"><b>ØºÙŠØ± Ù…Ø³Ø¬Ù„</b></div>
    </div>

    <!-- âœ… FIX: loginCard ØµØ§Ø± FORM Ø­ØªÙ‰ Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ­ÙØ¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± -->
    <form class="card" id="loginCard" autocomplete="on">
      <div class="hint">Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†).</div>
      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
      <input id="loginUser" autocomplete="username" name="username" />
      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
      <input id="loginPass" type="password" autocomplete="current-password" name="password" />
      <div class="row" style="margin-top:12px">
        <button class="btn blue" type="submit">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" id="btnClear" type="button">ØªÙØ±ÙŠØº</button>
      </div>
      <div class="error" id="loginErr"></div>
    </form>

    <div class="card hide" id="appCard">
      <div class="row" style="align-items:center; justify-content:space-between">
        <button class="btn small" id="btnLogout" type="button">Ø®Ø±ÙˆØ¬</button>
        <!-- âœ… NEW: ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ø³ØªÙ…Ø§Ø¹ "Ø­Ø§ÙŠÙƒ" -->
        <button class="btn small" id="btnWake" type="button">ğŸ§ Ø­Ø§ÙŠÙƒ: Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>

      <div class="sep"></div>

      <!-- âœ… Voice language toggle -->
      <div class="hayekMicLang" id="voiceLangRow" style="display:flex; gap:10px; align-items:center; margin:6px 0 10px;">
        <div style="flex:1; color:var(--muted); font-weight:900; font-size:12px;">Ù„ØºØ© Ø§Ù„ØµÙˆØª:</div>
        <button class="btn small" id="hayekLangAR" type="button">Ø¹Ø±Ø¨ÙŠ</button>
        <button class="btn small" id="hayekLangTR" type="button">TÃ¼rkÃ§e</button>
      </div>

      <label>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
      <div class="hayekMicWrap">
        <input id="customerName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø¨Ùˆ Ø£Ø­Ù…Ø¯" list="custList" autocomplete="off" />
        <button class="hayekMicBtn" id="hayekMicCustomer" type="button" title="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª Ù„Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">ğŸ¤</button>
      </div>
      <datalist id="custList"></datalist>

      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„Ø¨ÙŠØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <div class="hayekMicWrap">
        <input id="itemName" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø¯Ø§Ø­Ø©" list="itemList" autocomplete="off" />
        <button class="hayekMicBtn" id="hayekMicItem" type="button" title="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">ğŸ¤</button>
      </div>
      <datalist id="itemList"></datalist>

      <!-- âœ… Smart voice add -->
      <div style="margin-top:10px" id="smartVoiceRow">
        <button class="btn" id="hayekSmartAdd" type="button">ğŸ™ï¸ Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù„ØµÙˆØª (Ø§Ø³Ù… + Ø¹Ù…Ù„ÙŠØ©)</button>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabCalc" type="button">Ø§Ù„Ø­Ø§Ø³Ø¨Ø©</button>
        <button class="tab" id="tabLog" type="button">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
      </div>

      <div id="viewCalc">
        <div class="calcBox">
          <div class="exprTitle">Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© (Ù…Ù† Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø©)</div>
          <div class="expr" id="exprView"></div>
          <div class="resLine"><span>Ø§Ù„Ù†ØªÙŠØ¬Ø©:</span> <b id="resView">0</b></div>

          <div class="keys" id="keys">
            <button class="key op" data-k="Ã·" type="button">Ã·</button>
            <button class="key" data-k="9" type="button">9</button>
            <button class="key" data-k="8" type="button">8</button>
            <button class="key" data-k="7" type="button">7</button>

            <button class="key op" data-k="Ã—" type="button">Ã—</button>
            <button class="key" data-k="6" type="button">6</button>
            <button class="key" data-k="5" type="button">5</button>
            <button class="key" data-k="4" type="button">4</button>

            <button class="key op" data-k="-" type="button">-</button>
            <button class="key" data-k="3" type="button">3</button>
            <button class="key" data-k="2" type="button">2</button>
            <button class="key" data-k="1" type="button">1</button>

            <button class="key op" data-k="+" type="button">+</button>
            <button class="key" data-k="(" type="button">(</button>
            <button class="key" data-k="0" type="button">0</button>
            <button class="key" data-k=")" type="button">)</button>

            <button class="key eq" id="btnEq" type="button">=</button>
            <button class="key back" id="btnBack" type="button">âŒ«</button>
          </div>

          <!-- âœ… NEW: Ø£Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙÙŠØ© -->
          <div class="actions2">
            <button class="btn" id="btnClearOps" type="button">Ù…Ø³Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
            <button class="btn danger" id="btnDelLast" type="button">Ø­Ø°Ù Ø¢Ø®Ø± Ø³Ø·Ø±</button>

            <button class="btn" id="btnPrint80" type="button">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© 80Ù…Ù…</button>
            <button class="btn blue" id="btnPDF" type="button">ØªØµØ¯ÙŠØ± PDF (Ø®ÙÙŠÙ)</button>

            <button class="btn full" id="btnOpenAI" type="button">ğŸ¤– Ø§ÙØªØ­ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ (Ø­Ø§ÙŠÙƒ)</button>
          </div>

          <div class="footerNote" id="footerNote">ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù…Ù† Ù‚Ø¨Ù„ Ø´Ø±ÙƒØ© Ø§Ù„Ø­Ø§ÙŠÙƒ Ù„Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</div>
        </div>
      </div>

      <div id="viewLog" class="hide">
        <div class="logTable">
          <table>
            <thead>
              <tr>
                <th style="width:44%">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                <th style="width:26%">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                <th style="width:20%">Ø§Ù„ÙˆÙ‚Øª</th>
                <th style="width:10%">Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody id="logBody">
              <tr><td colspan="4" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯.</td></tr>
            </tbody>
          </table>
        </div>

        <div style="margin-top:10px">
          <button class="btn danger" id="btnClearLogAll" type="button">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>
      </div>

      <div class="error" id="appErr"></div>
    </div>

    <div id="printArea"></div>
    <div class="toast" id="toast"></div>
  </div>

  <!-- âœ… NEW: Ø²Ø± Ø¹Ø§Ø¦Ù… + Ù„ÙˆØ­Ø© "Ø­Ø§ÙŠÙƒ" -->
  <button class="aiFab" id="aiFab" type="button" title="Ø­Ø§ÙŠÙƒ">Ø­</button>

  <div class="aiPanel" id="aiPanel">
    <div class="aiHead">
      <div class="aiTitle">
        <span>ğŸ¤–</span>
        <span id="aiName">Ø­Ø§ÙŠÙƒ</span>
        <span class="aiBadge" id="aiBadge">Ø¬Ø§Ù‡Ø²</span>
      </div>
      <div class="aiMiniBtns">
        <button class="aiMiniBtn" id="aiHelp" type="button">Ù…Ø³Ø§Ø¹Ø¯Ø©</button>
        <button class="aiMiniBtn" id="aiClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
    <div class="aiBody" id="aiBody"></div>
    <div class="aiFoot">
      <input id="aiInput" placeholder="Ø§ÙƒØªØ¨: Ø­Ø§ÙŠÙƒ ØµØ¯Ù‘Ø± pdf / Ø§Ø­Ø°Ù Ø¢Ø®Ø± Ø³Ø·Ø± / Ø§Ø·Ø¨Ø¹ 80Ù…Ù… / Ø£Ø¶Ù Ø¨Ø·Ø§Ø·Ø§ 5x6.5" autocomplete="off" />
      <button class="aiMiniBtn" id="aiSend" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>

  <!-- âœ… Voice-to-text (Arabic + Turkish) + Smart Add -->
  <script>
  (function(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

    const LANG_KEY = "HAYEK_VOICE_LANG_V1";
    function getLang(){ return localStorage.getItem(LANG_KEY) || "ar-SA"; }
    function setLang(v){ localStorage.setItem(LANG_KEY, v); refreshLangUI(); }
    function refreshLangUI(){
      const arBtn = document.getElementById("hayekLangAR");
      const trBtn = document.getElementById("hayekLangTR");
      if(!arBtn || !trBtn) return;
      const v = getLang();
      arBtn.style.opacity = (v === "ar-SA") ? "1" : "0.65";
      trBtn.style.opacity = (v === "tr-TR") ? "1" : "0.65";
    }

    function attachMic(btnId, inputId){
      const btn = document.getElementById(btnId);
      const input = document.getElementById(inputId);
      if(!btn || !input) return;

      if(!SR){
        btn.style.opacity = "0.6";
        btn.title = "ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ Ù†Øµ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­";
        btn.addEventListener("click", ()=> alert("âŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ Ù†Øµ.\nØ¬Ø±Ù‘Ø¨ Google Chrome."));
        return;
      }

      const rec = new SR();
      rec.interimResults = true;
      rec.continuous = false;

      let listening = false;

      function off(){
        listening = false;
        btn.classList.remove("on");
        btn.textContent = "ğŸ¤";
      }
      function on(){
        listening = true;
        btn.classList.add("on");
        btn.textContent = "â¹";
      }

      rec.onresult = (e) => {
        let finalText = "";
        let interim = "";
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const t = e.results[i][0].transcript;
          if (e.results[i].isFinal) finalText += t;
          else interim += t;
        }
        const text = (finalText || interim).trim();
        if(text){
          input.value = text;
          input.dispatchEvent(new Event("input", { bubbles:true }));
          input.dispatchEvent(new Event("change", { bubbles:true }));
        }
      };

      rec.onend = off;
      rec.onerror = off;

      btn.addEventListener("click", ()=>{
        try{
          if(listening){ rec.stop(); return; }
          rec.lang = getLang();
          on();
          rec.start();
        }catch{
          off();
          alert("âŒ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.\nØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…Ø§ÙŠÙƒ Ù„Ù„ØµÙØ­Ø©.");
        }
      });
    }

    // --- helpers for smart parse ---
    const AR2EN = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    function toLatinDigits(s){
      return String(s||"").replace(/[Ù -Ù©]/g, d => AR2EN[d] || d);
    }
    function normalizeExpr(s){
      let x = toLatinDigits(s);
      x = x.replace(/\s+/g,"");
      x = x.replaceAll("_","-");
      x = x.replace(/[xX*]/g,"Ã—");
      x = x.replace(/\//g,"Ã·");
      x = x.replace(/âˆ’/g,"-");
      return x;
    }
    function parseSmart(text){
      const t0 = toLatinDigits(String(text||"")).trim();
      if(!t0) return null;

      const m = t0.match(/[0-9]/);
      if(!m || m.index == null) return null;

      const idx = m.index;
      const item = t0.slice(0, idx).trim();
      const exprRaw = t0.slice(idx).trim();
      const expr = normalizeExpr(exprRaw);

      if(!expr) return null;
      return { item, expr };
    }

    function attachSmart(btnId){
      const btn = document.getElementById(btnId);
      if(!btn) return;

      if(!SR){
        btn.style.opacity = "0.6";
        btn.title = "ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ Ù†Øµ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­";
        btn.addEventListener("click", ()=> alert("âŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ù„Ù‰ Ù†Øµ.\nØ¬Ø±Ù‘Ø¨ Google Chrome."));
        return;
      }

      const rec = new SR();
      rec.interimResults = true;
      rec.continuous = false;

      let listening = false;

      function off(){
        listening = false;
        btn.classList.remove("on");
        btn.textContent = "ğŸ™ï¸ Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù„ØµÙˆØª (Ø§Ø³Ù… + Ø¹Ù…Ù„ÙŠØ©)";
      }
      function on(){
        listening = true;
        btn.classList.add("on");
        btn.textContent = "â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
      }

      rec.onresult = (e) => {
        let finalText = "";
        let interim = "";
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const t = e.results[i][0].transcript;
          if (e.results[i].isFinal) finalText += t;
          else interim += t;
        }
        const text = (finalText || interim).trim();
        if(!text) return;

        if(finalText && finalText.trim()){
          const parsed = parseSmart(finalText);
          if(!parsed){
            alert("âŒ Ù…Ø§ Ù‚Ø¯Ø±Øª Ø£ÙÙ‡Ù… Ø§Ù„ØµÙŠØºØ©.\nÙ…Ø«Ø§Ù„: Ø¹Ù„Ø¨Ø© Ø´Ø§Ù…Ø¨Ùˆ 5x10\nØ£Ùˆ: 10_3\nØ£Ùˆ: 10 Ã·4\nØ£Ùˆ: 10 +10");
            return;
          }

          const item = (parsed.item || "").trim();
          const expr = (parsed.expr || "").trim();

          if(!window.HAYEK_VOICE_ADD_LINE){
            alert("âŒ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ØºÙŠØ± Ø¬Ø§Ù‡Ø².\nØ­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø© ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            return;
          }
          window.HAYEK_VOICE_ADD_LINE(item, expr);
        }
      };

      rec.onend = off;
      rec.onerror = off;

      btn.addEventListener("click", ()=>{
        try{
          if(listening){ rec.stop(); return; }
          rec.lang = getLang();
          on();
          rec.start();
        }catch{
          off();
          alert("âŒ ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†.\nØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…Ø§ÙŠÙƒ Ù„Ù„ØµÙØ­Ø©.");
        }
      });
    }

    // bind inputs mics
    attachMic("hayekMicCustomer", "customerName");
    attachMic("hayekMicItem", "itemName");

    // bind lang
    const arBtn = document.getElementById("hayekLangAR");
    const trBtn = document.getElementById("hayekLangTR");
    if(arBtn) arBtn.addEventListener("click", ()=> setLang("ar-SA"));
    if(trBtn) trBtn.addEventListener("click", ()=> setLang("tr-TR"));

    // bind smart
    attachSmart("hayekSmartAdd");

    refreshLangUI();
  })();
  </script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";

    const HAYEK_SYNC_URL = `${SUPABASE_URL}/functions/v1/hayek-sync`;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id)=>document.getElementById(id);

    const loginCard = $("loginCard");
    const appCard   = $("appCard");
    const loginErr  = $("loginErr");
    const appErr    = $("appErr");
    const subtitle  = $("subtitle");
    const pill      = $("pill");

    const tabCalc   = $("tabCalc");
    const tabLog    = $("tabLog");
    const viewCalc  = $("viewCalc");
    const viewLog   = $("viewLog");

    const custInput = $("customerName");
    const itemInput = $("itemName");

    const custList  = $("custList");
    const itemList  = $("itemList");

    const exprView  = $("exprView");
    const resView   = $("resView");
    const logBody   = $("logBody");
    const toastEl   = $("toast");

    // NEW UI
    const btnDelLast = $("btnDelLast");
    const btnPrint80 = $("btnPrint80");
    const btnOpenAI  = $("btnOpenAI");
    const btnClearLogAll = $("btnClearLogAll");

    const aiFab   = $("aiFab");
    const aiPanel = $("aiPanel");
    const aiBody  = $("aiBody");
    const aiInput = $("aiInput");
    const aiSend  = $("aiSend");
    const aiClose = $("aiClose");
    const aiHelp  = $("aiHelp");
    const aiNameEl= $("aiName");
    const aiBadge = $("aiBadge");
    const btnWake = $("btnWake");

    const footerNote = $("footerNote");
    const voiceLangRow = $("voiceLangRow");
    const smartVoiceRow = $("smartVoiceRow");

    const USERS_TABLE   = "app_users";
    const INVOICE_TABLE = "app_invoices";

    function showErr(box, msg){ box.style.display="block"; box.textContent = msg; }
    function clearErr(box){ box.style.display="none"; box.textContent = ""; }
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      setTimeout(()=> toastEl.style.display="none", 1400);
    }
    function nowTime(){ return new Date().toLocaleTimeString("ar",{hour:"2-digit", minute:"2-digit"}); }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // âœ… Features + Assistant name (Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†)
    // =========================
    const DEFAULT_ASSISTANT_NAME = "Ø­Ø§ÙŠÙƒ";
    let ASSISTANT_NAME = DEFAULT_ASSISTANT_NAME;

    // flags Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø¥Ø°Ø§ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù…Ø§ ÙŠØµÙŠØ± Ù…Ø´ÙƒÙ„Ø©)
    let FEATURES = {
      footer_enabled: true,
      ai_enabled: true,
      print80_enabled: true,
      voice_enabled: true
    };

    function applyFeatures(){
      // footer
      if(footerNote) footerNote.style.display = FEATURES.footer_enabled ? "" : "none";

      // AI
      const aiOn = !!FEATURES.ai_enabled;
      if(btnOpenAI) btnOpenAI.style.display = aiOn ? "" : "none";
      if(aiFab) aiFab.style.display = (aiOn && USER) ? "block" : "none";
      if(!aiOn) closeAI();

      // print80
      if(btnPrint80) btnPrint80.style.display = FEATURES.print80_enabled ? "" : "none";

      // voice
      const vOn = !!FEATURES.voice_enabled;
      if(voiceLangRow) voiceLangRow.style.display = vOn ? "flex" : "none";
      if(smartVoiceRow) smartVoiceRow.style.display = vOn ? "" : "none";

      // assistant name
      if(aiNameEl) aiNameEl.textContent = ASSISTANT_NAME || DEFAULT_ASSISTANT_NAME;
    }

    // =========================
    // âœ… Net Check
    // =========================
    let NET_OK = false;
    let NET_LAST = 0;
    let NET_INFLIGHT = false;

    async function isNetOK(timeoutMs = 4500){
      try{
        const ctrl = new AbortController();
        const t = setTimeout(()=>ctrl.abort(), timeoutMs);

        const url = `${SUPABASE_URL}/rest/v1/${encodeURIComponent(INVOICE_TABLE)}?select=id&limit=1`;

        const res = await fetch(url, {
          method: "GET",
          mode: "cors",
          cache: "no-store",
          signal: ctrl.signal,
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: "Bearer " + SUPABASE_ANON_KEY
          }
        });

        clearTimeout(t);
        if(!res || !res.ok) return false;
        return true;
      }catch{
        return false;
      }
    }

    async function refreshNetState(force=false){
      const now = Date.now();
      if(!force && (now - NET_LAST) < 2500) return NET_OK;
      if(NET_INFLIGHT) return NET_OK;

      NET_INFLIGHT = true;
      try{
        const ok = await isNetOK();
        NET_OK = !!ok;
        NET_LAST = now;
        return NET_OK;
      }finally{
        NET_INFLIGHT = false;
      }
    }

    function netNow(){ return !!NET_OK; }
    async function kickNet(){ await refreshNetState(true); }

    window.addEventListener("online", async ()=>{
      await kickNet();
      await qSyncSilently(true);
      await syncDeviceIdIfNeeded();
      await refreshUserFeatures();
    });

    window.addEventListener("focus", async ()=>{
      await kickNet();
      await qSyncSilently(true);
      await syncDeviceIdIfNeeded();
      await refreshUserFeatures();
    });

    document.addEventListener("visibilitychange", async ()=>{
      if(!document.hidden){
        await kickNet();
        await qSyncSilently(true);
        await syncDeviceIdIfNeeded();
        await refreshUserFeatures();
      }
    });

    window.addEventListener("pageshow", async ()=>{
      await kickNet();
      await qSyncSilently(true);
      await syncDeviceIdIfNeeded();
      await refreshUserFeatures();
    });

    setInterval(async ()=>{
      await refreshNetState(false);
      await qSyncSilently(false);
    }, 8000);

    // =========================
    // âœ… OFFLINE QUEUE
    // =========================
    const OFFLINE_QUEUE_KEY = "HAYEK_OFFLINE_INVOICES_V1";

    function qRead(){
      try{ return JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || "[]"); }
      catch{ return []; }
    }
    function qWrite(arr){
      localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(Array.isArray(arr)?arr:[]));
    }
    function qAdd(payload){
      const arr = qRead();
      const filtered = arr.filter(x => x?.id !== payload?.id);
      filtered.push({ ...payload, __queued_at: new Date().toISOString() });
      qWrite(filtered);
    }

    function cleanInvoicePayload(p){
      if(!p || typeof p !== "object") return null;

      const out = { ...p };
      delete out.__queued_at;
      delete out.__meta;
      delete out.__local;

      for(const k of Object.keys(out)){
        if(out[k] === undefined) delete out[k];
      }
      return out;
    }

    let __syncing = false;

    async function qSyncSilently(force=false){
      if(__syncing) return;

      const arr = qRead();
      if(!arr.length) return;

      if(!force){
        await refreshNetState(false);
        if(!netNow()) return;
      }

      __syncing = true;
      try{
        const keep = [];
        for(const raw of arr){
          try{
            const payload = cleanInvoicePayload(raw);
            if(!payload?.id){
              continue;
            }

            const { error } = await supabase
              .from(INVOICE_TABLE)
              .upsert(payload, { onConflict: "id" });

            if(error) keep.push(raw);
          }catch{
            keep.push(raw);
          }
        }
        qWrite(keep);
      }finally{
        __syncing = false;
      }
    }

    // =========================
    // âœ… Offline Login Cache
    // =========================
    const OFFLINE_USER_KEY = "HAYEK_OFFLINE_LAST_USER_V1";
    function saveOfflineUser(u){
      try{
        const slim = {
          id: u?.id || null,
          username: u?.username || "",
          password: u?.password || "",
          full_name: u?.full_name || "",
          is_blocked: !!u?.is_blocked,
          device_id: u?.device_id || null,
          // âœ… NEW: Ø­ÙØ¸ Ø§Ù„Ù…ÙŠØ²Ø§Øª ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ù„Ù„Ø£ÙˆÙÙ„Ø§ÙŠÙ†
          features: u?.features || FEATURES,
          assistant_name: u?.assistant_name || ASSISTANT_NAME,
          saved_at: new Date().toISOString()
        };
        localStorage.setItem(OFFLINE_USER_KEY, JSON.stringify(slim));
      }catch{}
    }
    function readOfflineUser(){
      try{
        const v = JSON.parse(localStorage.getItem(OFFLINE_USER_KEY) || "null");
        if(!v || typeof v !== "object") return null;
        return v;
      }catch{ return null; }
    }

    // =========================
    // âœ… Device/Tab Locks
    // =========================
    function getOrCreateDeviceId(){
      const KEY = "HAYEK_DEVICE_ID_V1";
      let v = localStorage.getItem(KEY);
      if(!v){
        v = (crypto?.randomUUID?.() || ("dev_" + Math.random().toString(16).slice(2) + Date.now()));
        localStorage.setItem(KEY, v);
      }
      return v;
    }

    function getOrCreateTabId(){
      const KEY = "HAYEK_TAB_ID_V1";
      let v = sessionStorage.getItem(KEY);
      if(!v){
        v = (crypto?.randomUUID?.() || ("tab_" + Math.random().toString(16).slice(2) + Date.now()));
        sessionStorage.setItem(KEY, v);
      }
      return v;
    }

    let TAB_BLOCKED = false;
    let TAB_TIMER = null;
    let TAB_USERNAME = null;

    function lockKeyFor(username){ return `HAYEK_ACTIVE_TAB_LOCK::${username}`; }
    function nowMs(){ return Date.now(); }

    function readLock(username){
      try{
        const raw = localStorage.getItem(lockKeyFor(username));
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || typeof obj !== "object") return null;
        return obj;
      }catch{ return null; }
    }

    function writeLock(username, objOrNull){
      try{
        if(!objOrNull) localStorage.removeItem(lockKeyFor(username));
        else localStorage.setItem(lockKeyFor(username), JSON.stringify(objOrNull));
      }catch{}
    }

    function stopSingleTabGuard(){
      if(TAB_TIMER) clearInterval(TAB_TIMER);
      TAB_TIMER = null;
      TAB_BLOCKED = false;
      TAB_USERNAME = null;
    }

    function startSingleTabGuard(username){
      stopSingleTabGuard();
      TAB_USERNAME = username;

      const tabId = getOrCreateTabId();
      const TTL = 12000;
      const HEARTBEAT = 4000;

      function isStale(lock){
        if(!lock?.ts) return true;
        return (nowMs() - Number(lock.ts)) > TTL;
      }

      function tryAcquire(){
        const lock = readLock(username);

        if(!lock || isStale(lock) || lock.tabId === tabId){
          writeLock(username, { tabId, ts: nowMs() });
          TAB_BLOCKED = false;
          return true;
        }

        TAB_BLOCKED = true;
        if(!sessionStorage.getItem(`HAYEK_TAB_BLOCKED_SHOWN::${username}`)){
          sessionStorage.setItem(`HAYEK_TAB_BLOCKED_SHOWN::${username}`, "1");
          showErr(loginErr, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙØªÙˆØ­ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¢Ø®Ø±.\nØ£ØºÙ„Ù‚ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¢Ø®Ø± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.");
        }
        return false;
      }

      tryAcquire();

      TAB_TIMER = setInterval(()=>{
        if(!TAB_USERNAME) return;

        const lock = readLock(username);

        if(lock && lock.tabId === tabId){
          writeLock(username, { tabId, ts: nowMs() });
          TAB_BLOCKED = false;
          return;
        }

        tryAcquire();
      }, HEARTBEAT);

      window.addEventListener("storage", (e)=>{
        if(e.key === lockKeyFor(username)){
          tryAcquire();
        }
      });

      window.addEventListener("beforeunload", ()=>{
        try{
          const lock = readLock(username);
          if(lock && lock.tabId === tabId){
            writeLock(username, null);
          }
        }catch{}
      });
    }

    async function enforceDeviceLockForUserRow(u){
      const deviceId = getOrCreateDeviceId();

      await refreshNetState(false);
      if(!netNow()){
        if(!u.device_id){
          u.device_id = deviceId;
          saveOfflineUser(u);
          return u;
        }
        if(u.device_id !== deviceId){
          throw new Error("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¬Ù‘Ù„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±.\nØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù‡Ø§Ø².");
        }
        return u;
      }

      if(!u.device_id){
        const { error: uerr } = await supabase
          .from(USERS_TABLE)
          .update({ device_id: deviceId })
          .eq("id", u.id)
          .is("device_id", null);

        if(uerr) throw new Error(uerr.message || "ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« device_id");

        const { data, error } = await supabase
          .from(USERS_TABLE)
          .select("*")
          .eq("id", u.id)
          .limit(1);

        if(error) throw new Error(error.message || "ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
        if(!data?.length) throw new Error("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
        u = data[0];
      }

      if(u.device_id !== deviceId){
        throw new Error("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¬Ù‘Ù„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±.\nØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¬Ù‡Ø§Ø².");
      }

      return u;
    }

    async function syncDeviceIdIfNeeded(){
      await refreshNetState(false);
      if(!netNow()) return;

      try{
        if(!USER?.id) return;
        const deviceId = getOrCreateDeviceId();

        if(!USER.device_id){
          const { error } = await supabase
            .from(USERS_TABLE)
            .update({ device_id: deviceId })
            .eq("id", USER.id)
            .is("device_id", null);

          if(!error){
            USER.device_id = deviceId;
            saveOfflineUser(USER);
          }
        }
      }catch{}
    }

    // =========================
    // âœ… Suggestions
    // =========================
    const SUG_CUSTOMERS_KEY = "HAYEK_SUG_CUSTOMERS";
    const SUG_ITEMS_KEY     = "HAYEK_SUG_ITEMS";
    const MAX_SUG = 60;

    function readSug(key){
      try{
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        return Array.isArray(arr) ? arr.filter(Boolean) : [];
      }catch{ return []; }
    }
    function writeSug(key, arr){
      localStorage.setItem(key, JSON.stringify(arr.slice(0, MAX_SUG)));
    }
    function addSug(key, value){
      const v = String(value || "").trim();
      if(!v) return;

      const arr = readSug(key);
      const norm = v.toLowerCase();

      const filtered = arr.filter(x => String(x).toLowerCase() !== norm);
      filtered.unshift(v);
      writeSug(key, filtered);
      renderSug();
    }
    function renderDatalist(el, values){
      el.innerHTML = values.map(v => `<option value="${escapeHtml(v)}"></option>`).join("");
    }
    function renderSug(){
      renderDatalist(custList, readSug(SUG_CUSTOMERS_KEY));
      renderDatalist(itemList, readSug(SUG_ITEMS_KEY));
    }

    custInput?.addEventListener("change", ()=> addSug(SUG_CUSTOMERS_KEY, custInput.value));
    itemInput?.addEventListener("change", ()=> addSug(SUG_ITEMS_KEY, itemInput.value));

    function uuid(){
      if(window.crypto?.randomUUID) return crypto.randomUUID();
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c=>{
        const r = (Math.random()*16)|0, v = c==="x" ? r : (r&0x3)|0x8;
        return v.toString(16);
      });
    }

    // ------- STATE -------
    let USER = null;
    let invoiceId = null;
    let invoiceOpen = false;

    let ops = [];
    let expr = "";
    let lastResult = 0;

    // ------- SUPABASE SAVE -------
    async function saveInvoice(status){
      if(!invoiceId || !USER?.id) return { ok:false, msg:"no-invoice" };

      const customer = custInput.value.trim();
      const total = calcTotal();

      const payload = {
        id: invoiceId,
        owner_id: USER.id,
        customer_name: customer || null,
        customer: customer || null,
        rows: buildRowsWithMeta(customer),
        total: total,
        status: status,
        closed_at: status === "closed" ? new Date().toISOString() : null
      };

      await refreshNetState(false);

      if(!netNow()){
        qAdd(payload);
        return { ok:true, id: invoiceId, queued:true };
      }

      try{
        const { data, error } = await supabase
          .from(INVOICE_TABLE)
          .upsert(payload, { onConflict: "id" })
          .select("id")
          .limit(1);

        if(error){
          qAdd(payload);
          return { ok:true, id: invoiceId, queued:true };
        }
        return { ok:true, id: (data?.[0]?.id || invoiceId) };
      }catch{
        qAdd(payload);
        return { ok:true, id: invoiceId, queued:true };
      }
    }

    function buildRowsWithMeta(customer){
      const meta = {
        __meta: true,
        customer: customer || "",
        user: USER?.username || "",
        saved_at: new Date().toISOString()
      };
      return [meta, ...ops];
    }

    // =========================
    // âœ… LOGIN Ø¹Ø¨Ø± Edge Function (hayek-sync)
    // =========================
    async function apiLoginViaEdge(username, password){
      const deviceId = getOrCreateDeviceId();

      const res = await fetch(HAYEK_SYNC_URL, {
        method: "POST",
        headers: {
          "content-type": "application/json",
          "x-hayek-device": deviceId,
          "x-hayek-user": String(username||""),
          "x-hayek-pass": String(password||"")
        },
        body: JSON.stringify({ action: "login" })
      });

      const data = await res.json().catch(()=>null);
      if(!res.ok || !data?.ok){
        const err = data?.error || ("HTTP_" + res.status);
        throw new Error(err);
      }
      return data.user;
    }

    function mapEdgeError(err){
      const e = String(err||"");
      if(e === "USER_NOT_FOUND") return "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
      if(e === "BAD_PASSWORD") return "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
      if(e === "USER_BLOCKED") return "Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­Ø¸ÙˆØ±.";
      if(e === "Missing headers") return "Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø·Ù„Ø¨ (headers).";
      return "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:\n" + e;
    }

    // âœ… NEW: Ù‚Ø±Ø§Ø¡Ø© Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¬Ø¯ÙˆÙ„ app_users (Ø¥Ø°Ø§ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©)
    async function refreshUserFeatures(){
      try{
        if(!USER?.id) return;

        await refreshNetState(false);
        if(!netNow()){
          // offline: Ù…Ù† Ø§Ù„ÙƒØ§Ø´
          const cached = readOfflineUser();
          if(cached?.id === USER.id){
            FEATURES = { ...FEATURES, ...(cached.features || {}) };
            ASSISTANT_NAME = cached.assistant_name || ASSISTANT_NAME;
            applyFeatures();
          }
          return;
        }

        // Ù†Ù‚Ø±Ø£ Ø¨Ø´ÙƒÙ„ Ù…Ø±Ù† (Ù„Ùˆ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Supabase Ù‚Ø¯ ÙŠØ±Ø¬Ù‘Ø¹ error)
        const { data, error } = await supabase
          .from(USERS_TABLE)
          .select("id, assistant_name, footer_enabled, ai_enabled, print80_enabled, voice_enabled")
          .eq("id", USER.id)
          .limit(1);

        if(error || !data?.length){
          applyFeatures();
          return;
        }

        const row = data[0] || {};
        ASSISTANT_NAME = (row.assistant_name || ASSISTANT_NAME || DEFAULT_ASSISTANT_NAME);

        // Ø¥Ø°Ø§ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© null/undefined Ù†ØªØ±Ùƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        const next = { ...FEATURES };
        if(typeof row.footer_enabled === "boolean") next.footer_enabled = row.footer_enabled;
        if(typeof row.ai_enabled === "boolean") next.ai_enabled = row.ai_enabled;
        if(typeof row.print80_enabled === "boolean") next.print80_enabled = row.print80_enabled;
        if(typeof row.voice_enabled === "boolean") next.voice_enabled = row.voice_enabled;

        FEATURES = next;

        // Ø§Ø­ÙØ¸ Ø¶Ù…Ù† USER Ù„Ù„ÙƒØ§Ø´
        USER.features = FEATURES;
        USER.assistant_name = ASSISTANT_NAME;
        saveOfflineUser(USER);

        applyFeatures();
      }catch{
        applyFeatures();
      }
    }

    // ------- LOGIN -------
    async function login(){
      clearErr(loginErr);
      const username = $("loginUser").value.trim();
      const password = $("loginPass").value.trim();

      if(!username || !password){
        showErr(loginErr, "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.");
        return;
      }

      await refreshNetState(true);

      if(!netNow()){
        const cached = readOfflineUser();
        if(!cached){
          showErr(loginErr, "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².\nØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù…Ø¹ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£ÙˆÙ„Ø§Ù‹.");
          return;
        }
        if(cached.is_blocked){
          showErr(loginErr, "Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­Ø¸ÙˆØ±.");
          return;
        }
        if(cached.username !== username || cached.password !== password){
          showErr(loginErr, "âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª.\nØ£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ø®Ø± Ø­Ø³Ø§Ø¨ Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².");
          return;
        }

        let u = cached;

        try{
          u = await enforceDeviceLockForUserRow(u);
        }catch(e){
          showErr(loginErr, e?.message || "ØªÙ… Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„");
          return;
        }

        startSingleTabGuard(u.username);
        if(TAB_BLOCKED) return;

        USER = u;
        // restore features/name from cached
        FEATURES = { ...FEATURES, ...(u.features || {}) };
        ASSISTANT_NAME = u.assistant_name || ASSISTANT_NAME;
        applyFeatures();

        localStorage.setItem("HAYEK_USER_SESSION", JSON.stringify({ id:u.id, offline:true }));

        loginCard.classList.add("hide");
        appCard.classList.remove("hide");
        subtitle.textContent = "ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
        pill.innerHTML = `<b>${u.username}</b>`;
        resetAll(true);

        renderSug();
        toast("ÙˆØ¶Ø¹ Ø£ÙˆÙÙ„Ø§ÙŠÙ† âœ…");
        aiFab.style.display = (FEATURES.ai_enabled ? "block" : "none");
        return;
      }

      try{
        const edgeUser = await apiLoginViaEdge(username, password);

        let u = {
          id: edgeUser.id,
          username: edgeUser.username,
          full_name: edgeUser.full_name || "",
          device_id: edgeUser.device_id || null,
          is_blocked: !!edgeUser.is_blocked,
          password: password
        };

        if(u.is_blocked){
          showErr(loginErr, "Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­Ø¸ÙˆØ±.");
          return;
        }

        try{
          u = await enforceDeviceLockForUserRow(u);
        }catch(e){
          showErr(loginErr, e?.message || "ØªÙ… Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„");
          return;
        }

        startSingleTabGuard(u.username);
        if(TAB_BLOCKED) return;

        USER = u;
        localStorage.setItem("HAYEK_USER_SESSION", JSON.stringify({ id:u.id, offline:false }));
        saveOfflineUser(u);

        loginCard.classList.add("hide");
        appCard.classList.remove("hide");
        subtitle.textContent = "ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
        pill.innerHTML = `<b>${u.username}</b>`;
        resetAll(true);

        renderSug();

        await qSyncSilently(true);
        await syncDeviceIdIfNeeded();

        await refreshUserFeatures();
      }catch(e){
        showErr(loginErr, mapEdgeError(e?.message || e));
      }
    }

    async function restoreSession(){
      try{
        const s = JSON.parse(localStorage.getItem("HAYEK_USER_SESSION")||"null");
        if(!s?.id) return;

        await refreshNetState(true);

        if(!netNow()){
          const cached = readOfflineUser();
          if(!cached || cached.id !== s.id) return;
          if(cached.is_blocked){
            localStorage.removeItem("HAYEK_USER_SESSION");
            return;
          }

          let u = cached;

          try{
            u = await enforceDeviceLockForUserRow(u);
          }catch(e){
            localStorage.removeItem("HAYEK_USER_SESSION");
            showErr(loginErr, e?.message || "ØªÙ… Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„");
            return;
          }

          startSingleTabGuard(u.username);
          if(TAB_BLOCKED) return;

          USER = u;
          FEATURES = { ...FEATURES, ...(u.features || {}) };
          ASSISTANT_NAME = u.assistant_name || ASSISTANT_NAME;
          applyFeatures();

          loginCard.classList.add("hide");
          appCard.classList.remove("hide");
          subtitle.textContent = "ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
          pill.innerHTML = `<b>${USER.username}</b>`;
          resetAll(true);
          renderSug();

          aiFab.style.display = (FEATURES.ai_enabled ? "block" : "none");
          return;
        }

        const { data, error } = await supabase.from(USERS_TABLE).select("*").eq("id", s.id).limit(1);
        if(error) return;
        if(!data?.length) return;

        let u = data[0];
        if(u.is_blocked){
          localStorage.removeItem("HAYEK_USER_SESSION");
          return;
        }

        const cached = readOfflineUser();
        const pass = cached?.password || "";

        u = { ...u, password: pass };

        try{
          u = await enforceDeviceLockForUserRow(u);
        }catch(e){
          localStorage.removeItem("HAYEK_USER_SESSION");
          showErr(loginErr, e?.message || "ØªÙ… Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„");
          return;
        }

        startSingleTabGuard(u.username);
        if(TAB_BLOCKED) return;

        USER = u;
        saveOfflineUser(u);

        loginCard.classList.add("hide");
        appCard.classList.remove("hide");
        subtitle.textContent = "ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
        pill.innerHTML = `<b>${USER.username}</b>`;
        resetAll(true);
        renderSug();

        await qSyncSilently(true);
        await syncDeviceIdIfNeeded();

        await refreshUserFeatures();
      }catch{}
    }

    function logout(){
      USER = null;
      localStorage.removeItem("HAYEK_USER_SESSION");
      stopSingleTabGuard();

      closeAI();
      if(aiFab) aiFab.style.display = "none";

      loginCard.classList.remove("hide");
      appCard.classList.add("hide");
      subtitle.textContent = "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
      pill.innerHTML = "<b>ØºÙŠØ± Ù…Ø³Ø¬Ù„</b>";
    }

    function setTab(which){
      if(which==="calc"){
        tabCalc.classList.add("active");
        tabLog.classList.remove("active");
        viewCalc.classList.remove("hide");
        viewLog.classList.add("hide");
      }else{
        tabLog.classList.add("active");
        tabCalc.classList.remove("active");
        viewLog.classList.remove("hide");
        viewCalc.classList.add("hide");
      }
    }

    function resetAll(silent=false){
      clearErr(appErr);
      invoiceId = null;
      invoiceOpen = false;
      ops = [];
      expr = "";
      lastResult = 0;
      exprView.textContent = "";
      resView.textContent = "0";
      renderLog();
      if(!silent){
        custInput.value = "";
        itemInput.value = "";
      }
    }

    function requireCustomer(){
      const c = custInput.value.trim();
      if(!c){
        showErr(appErr, "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£ÙˆÙ„Ø§Ù‹ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ).");
        custInput.focus();
        return null;
      }
      clearErr(appErr);
      addSug(SUG_CUSTOMERS_KEY, c);
      return c;
    }

    async function ensureInvoiceOpened(){
      const customer = requireCustomer();
      if(!customer) return false;
      if(invoiceOpen) return true;

      invoiceId = uuid();
      invoiceOpen = true;

      const r = await saveInvoice("open");
      if(!r.ok){
        showErr(appErr, "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ (open):\n" + r.msg + "\n\nâœ… ØªØ£ÙƒØ¯ Ø£Ù† Ø¹Ù…ÙˆØ¯ id Primary Key ÙÙŠ Supabase.");
        return false;
      }
      return true;
    }

    function calcTotal(){
      let t = 0;
      for(const o of ops){
        const n = Number(o.result);
        if(Number.isFinite(n)) t += n;
      }
      if(!ops.length && Number.isFinite(lastResult)) t = lastResult;
      return Math.round(t*100)/100;
    }

    function sanitizeForEval(s){
      return s.replaceAll("Ã—","*").replaceAll("Ã·","/").replaceAll("Ù«",".").replaceAll(",",".");

    }
    function safeEval(s){
      const cleaned = sanitizeForEval(s).trim();
      if(!cleaned) return 0;
      if(!/^[0-9+\-*/().\s]+$/.test(cleaned)) throw new Error("bad");
      const fn = new Function("return ("+cleaned+");");
      const val = fn();
      if(!Number.isFinite(val)) return 0;
      return Math.round(val*100)/100;
    }
    function updatePreview(){
      try{ resView.textContent = String(safeEval(expr)); }
      catch{ resView.textContent = "0"; }
    }
    function setExpr(v){
      expr = v;
      exprView.textContent = expr || "";
      updatePreview();
    }
    function press(k){
      setExpr(expr + String(k));
      if(navigator.vibrate) navigator.vibrate(10);
    }
    function backspace(){
      if(!expr) return;
      setExpr(expr.slice(0,-1));
      if(navigator.vibrate) navigator.vibrate(10);
    }

    // âœ… NEW: Ø­Ø°Ù Ø³Ø·Ø±/Ø£Ø³Ø·Ø±
    async function deleteOpAt(index){
      try{
        if(index < 0 || index >= ops.length) return;
        ops.splice(index, 1);
        renderLog();
        toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø± âœ…");

        if(invoiceOpen){
          const r = await saveInvoice("open");
          if(!r.ok) showErr(appErr, "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù:\n" + r.msg);
        }
        await qSyncSilently(false);
      }catch(e){
        showErr(appErr, "ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø±:\n" + (e?.message || e));
      }
    }

    async function deleteLastOp(){
      if(!ops.length){
        toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø·ÙˆØ± Ù„Ù„Ø­Ø°Ù");
        return;
      }
      await deleteOpAt(0); // Ù„Ø£Ù† ops.unshift => Ø¢Ø®Ø± Ø¥Ø¶Ø§ÙØ© ÙÙŠ index 0
    }

    function renderLog(){
      if(!ops.length){
        logBody.innerHTML = `<tr><td colspan="4" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯.</td></tr>`;
        return;
      }

      logBody.innerHTML = ops.map((o, idx)=>{
        const t = o.time || nowTime();
        const exp = (o.expr ? `${o.expr} = ${o.result}` : `${o.result}`);
        return `
          <tr>
            <td><b>${escapeHtml(o.label||"Ø¹Ù…Ù„ÙŠØ©")}</b><div class="muted" style="margin-top:4px">${escapeHtml(exp)}</div></td>
            <td>${escapeHtml(exp)}</td>
            <td>${escapeHtml(t)}</td>
            <td><button class="btn small danger" data-del="${idx}" type="button" style="padding:8px 10px;border-radius:12px">ğŸ—‘</button></td>
          </tr>
        `;
      }).join("");
    }

    async function equalsAndLog(){
      clearErr(appErr);
      const customer = requireCustomer();
      if(!customer) return;

      const ok = await ensureInvoiceOpened();
      if(!ok) return;

      let result = 0;
      try{ result = safeEval(expr); }
      catch{ showErr(appErr, "ØµÙŠØºØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©."); return; }

      lastResult = result;

      const item = itemInput.value.trim();
      const label = item || "Ø¹Ù…Ù„ÙŠØ©";
      if(item) addSug(SUG_ITEMS_KEY, item);

      ops.unshift({
        label,
        expr: expr || "",
        result,
        at: new Date().toISOString(),
        time: nowTime()
      });

      renderLog();
      setExpr("");
      toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…");

      const r = await saveInvoice("open");
      if(!r.ok){
        showErr(appErr, "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:\n" + r.msg + "\n\nâœ… ØºØ§Ù„Ø¨Ø§Ù‹ id Ù„ÙŠØ³ Primary Key.");
      }

      await qSyncSilently(false);
    }

    async function clearOperations(){
      clearErr(appErr);
      ops = [];
      expr = "";
      lastResult = 0;
      exprView.textContent = "";
      resView.textContent = "0";
      renderLog();

      if(invoiceOpen){
        const r = await saveInvoice("open");
        if(!r.ok) showErr(appErr, "ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸:\n" + r.msg);
      }
      toast("ØªÙ… Ø§Ù„Ù…Ø³Ø­ âœ…");
      await qSyncSilently(false);
    }

    // =========================
    // âœ… PDF Ø®ÙÙŠÙ (Ù†ØµÙŠ) Ø¨Ø¯Ù„ Ø§Ù„ØµÙˆØ± â€” Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ø­Ø¬Ù…
    // =========================
    function buildPdfRows(){
      // Ù†Ø±ØªØ¨ Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
      const rows = ops.slice().reverse().map(o=>{
        const label = o.label || "";
        const ex = o.expr || "";
        const res = (o.result ?? "");
        const tm = o.time || "";
        return [tm, label, ex, String(res)];
      });
      return rows;
    }

    async function exportPDF(){
      clearErr(appErr);

      const customer = requireCustomer();
      if(!customer) return;

      const ok = await ensureInvoiceOpened();
      if(!ok) return;

      const r = await saveInvoice("closed");
      if(!r.ok){
        showErr(appErr, "ÙØ´Ù„ Ø¥ØºÙ„Ø§Ù‚/Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:\n" + r.msg + "\n\nâœ… Ø§Ù„Ø­Ù„: Ø§Ø¬Ø¹Ù„ id Primary Key ÙÙŠ Ø¬Ø¯ÙˆÙ„ app_invoices.");
        return;
      }

      addSug(SUG_CUSTOMERS_KEY, customer);

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p","mm","a4");

      const user = (USER?.full_name || USER?.username || "â€”");
      const invId = String(invoiceId || "â€”");
      const dateText = new Date().toLocaleString("ar",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
      const total = calcTotal();

      // Header
      pdf.setFont("helvetica","bold");
      pdf.setFontSize(16);
      pdf.text("HAYEK SPOT", 105, 14, { align:"center" });
      pdf.setFontSize(10);
      pdf.setFont("helvetica","normal");
      pdf.text(`Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user}`, 14, 24);
      pdf.text(`Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customer}`, 14, 30);
      pdf.text(`Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${invId}`, 14, 36);
      pdf.text(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateText}`, 14, 42);
      pdf.text(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${String(total)}`, 14, 48);

      // Table (Ù†ØµÙŠ)
      const rows = buildPdfRows();
      const head = [["Ø§Ù„ÙˆÙ‚Øª","Ø§Ù„Ø¨ÙŠØ§Ù†","Ø§Ù„Ø¹Ù…Ù„ÙŠØ©","Ø§Ù„Ù†ØªÙŠØ¬Ø©"]];
      pdf.autoTable({
        head,
        body: rows.length ? rows : [["â€”","Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª","â€”","â€”"]],
        startY: 54,
        styles: { fontSize: 9, cellPadding: 2.2 },
        headStyles: { fontStyle:"bold" },
        margin: { left: 12, right: 12 }
      });

      // Footer
      const yEnd = pdf.lastAutoTable?.finalY ? (pdf.lastAutoTable.finalY + 10) : 270;
      pdf.setFontSize(9);
      pdf.text("ØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù…Ù† Ù‚Ø¨Ù„ Ø´Ø±ÙƒØ© Ø§Ù„Ø­Ø§ÙŠÙƒ", 105, Math.min(yEnd, 285), { align:"center" });

      const safeName = (customer || "invoice").replace(/[\\/:*?"<>|]/g,"-");
      pdf.save(`HAYEK_${safeName}.pdf`);

      toast("ØªÙ… ØªÙ†Ø²ÙŠÙ„ PDF âœ… (Ø®ÙÙŠÙ)");
      resetAll(false);

      await qSyncSilently(false);
    }

    // =========================
    // âœ… Ø·Ø¨Ø§Ø¹Ø© 80Ù…Ù… Bluetooth (ESC/POS)
    // =========================
    function build80mmText(){
      const customer = (custInput.value.trim() || "â€”");
      const user = (USER?.full_name || USER?.username || "â€”");
      const invId = String(invoiceId || "â€”");
      const dateText = new Date().toLocaleString("ar",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
      const total = calcTotal();

      const lines = [];
      lines.push("================================");
      lines.push("            HAYEK SPOT           ");
      lines.push("================================");
      lines.push(`Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user}`);
      lines.push(`Ø§Ù„Ø¹Ù…ÙŠÙ„: ${customer}`);
      lines.push(`ÙØ§ØªÙˆØ±Ø©: ${invId}`);
      lines.push(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${dateText}`);
      lines.push("--------------------------------");

      const rows = ops.slice().reverse();
      if(!rows.length){
        lines.push("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª");
      }else{
        for(const o of rows){
          const tm = o.time || "";
          const lbl = o.label || "";
          const ex  = o.expr || "";
          const res = String(o.result ?? "");
          lines.push(`${tm} | ${lbl}`);
          if(ex) lines.push(`  ${ex} = ${res}`);
          else lines.push(`  = ${res}`);
          lines.push("--------------------------------");
        }
      }

      lines.push(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${String(total)}`);
      lines.push("================================");
      lines.push("ØªÙ… ØªØ·ÙˆÙŠØ±Ù‡ Ù…Ù† Ù‚Ø¨Ù„ Ø´Ø±ÙƒØ© Ø§Ù„Ø­Ø§ÙŠÙƒ");
      lines.push("05510217646");
      lines.push("\n\n");
      return lines.join("\n");
    }

    async function print80mm(){
      clearErr(appErr);

      if(!FEATURES.print80_enabled){
        showErr(appErr, "Ù…ÙŠØ²Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© 80Ù…Ù… ØºÙŠØ± Ù…ÙØ¹Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
        return;
      }

      const customer = requireCustomer();
      if(!customer) return;

      const ok = await ensureInvoiceOpened();
      if(!ok) return;

      // Ø­ÙØ¸ open Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
      await saveInvoice("open");

      if(!("bluetooth" in navigator)){
        showErr(appErr, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²/Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Bluetooth.\nØ¬Ø±Ù‘Ø¨ Google Chrome Ø¹Ù„Ù‰ Android.");
        return;
      }

      try{
        toast("Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ø¨Ø¹Ø©...");
        // ÙƒØ«ÙŠØ± Ù…Ù† Ø·Ø§Ø¨Ø¹Ø§Øª ESC/POS ØªØ³ØªØ®Ø¯Ù… Ø®Ø¯Ù…Ø§Øª Ù…Ø®ØªÙ„ÙØ©.
        // Ù†Ø¶Ø¹ Ø£ÙƒØ«Ø± UUID Ø´Ø§Ø¦Ø¹Ø© (FFE0/FFE1) + fallback.
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [
            0xFFE0,
            "0000ffe0-0000-1000-8000-00805f9b34fb",
            "0000fff0-0000-1000-8000-00805f9b34fb",
            0xFFF0
          ]
        });

        const server = await device.gatt.connect();

        let service = null;
        const tryServices = [
          "0000ffe0-0000-1000-8000-00805f9b34fb",
          "0000fff0-0000-1000-8000-00805f9b34fb"
        ];

        for(const suuid of tryServices){
          try{
            service = await server.getPrimaryService(suuid);
            if(service) break;
          }catch{}
        }

        if(!service){
          // Ø¢Ø®Ø± Ù…Ø­Ø§ÙˆÙ„Ø©: Ø£ÙˆÙ„ Service Ù…ØªØ§Ø­
          const services = await server.getPrimaryServices().catch(()=>[]);
          service = services?.[0] || null;
        }

        if(!service){
          throw new Error("Ù„Ù… Ø£Ø¬Ø¯ Service Ù„Ù„Ø·Ø§Ø¨Ø¹Ø©.");
        }

        let ch = null;
        const tryChars = [
          "0000ffe1-0000-1000-8000-00805f9b34fb",
          "0000fff1-0000-1000-8000-00805f9b34fb"
        ];

        for(const cuuid of tryChars){
          try{
            ch = await service.getCharacteristic(cuuid);
            if(ch) break;
          }catch{}
        }

        if(!ch){
          // fallback: Ø£ÙˆÙ„ Characteristic Ù‚Ø§Ø¨Ù„ Ù„Ù„ÙƒØªØ§Ø¨Ø©
          const chars = await service.getCharacteristics().catch(()=>[]);
          ch = chars?.[0] || null;
        }

        if(!ch){
          throw new Error("Ù„Ù… Ø£Ø¬Ø¯ Characteristic Ù„Ù„ÙƒØªØ§Ø¨Ø©.");
        }

        const text = build80mmText();

        const encoder = new TextEncoder(); // UTF-8
        // Ø¨Ø¹Ø¶ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø§Øª Ù„Ø§ ØªØ­Ø¨ UTF-8 Ù„Ù„Ø¹Ø±Ø¨ÙŠØŒ Ù„ÙƒÙ† ÙƒØ«ÙŠØ± Ù…Ù†Ù‡Ø§ ÙŠØ·Ø¨Ø¹ Ø¹Ø±Ø¨ÙŠ ÙƒØµÙˆØ±Ø©.
        // Ù‡Ù†Ø§ Ø·Ø¨Ø§Ø¹Ø© Ù†ØµÙŠØ© - Ø¥Ø°Ø§ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© Ù„Ø§ ØªØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø³ØªØ¸Ù‡Ø± Ø±Ù…ÙˆØ².
        // (ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ø§Ø¹Ø© ØµÙˆØ±Ø©ØŒ Ù„ÙƒÙ† Ù‡Ø°Ø§ ÙŠØ²ÙŠØ¯ Ø­Ø¬Ù…/ØªØ¹Ù‚ÙŠØ¯.)
        const data = encoder.encode(text);

        // ESC/POS: init + cut (Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©)
        const init = new Uint8Array([0x1B,0x40]);         // ESC @
        const cut  = new Uint8Array([0x1D,0x56,0x00]);    // GS V 0 (Ù‚Øµ)

        // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù„Ù‰ Ø¯ÙØ¹Ø§Øª
        async function writeChunk(u8){
          // Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ØªØ­ØªØ§Ø¬ writeValueWithoutResponse
          if(ch.writeValueWithoutResponse){
            await ch.writeValueWithoutResponse(u8);
          }else{
            await ch.writeValue(u8);
          }
        }

        await writeChunk(init);

        const CHUNK = 180; // Ø¢Ù…Ù† Ù„Ù„Ø¨Ù„ÙˆØªÙˆØ«
        for(let i=0;i<data.length;i+=CHUNK){
          await writeChunk(data.slice(i, i+CHUNK));
          await new Promise(r=>setTimeout(r, 30));
        }

        await writeChunk(cut).catch(()=>{});

        toast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© âœ…");
      }catch(e){
        showErr(appErr, "âŒ ÙØ´Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Bluetooth:\n" + (e?.message || e));
      }
    }

    // =========================
    // âœ… AI "Ø­Ø§ÙŠÙƒ" (Ù…Ø­Ù„ÙŠ) ÙŠÙ†ÙØ° Ø£ÙˆØ§Ù…Ø± Ø¨Ø¯Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    // =========================
    function openAI(){
      if(!FEATURES.ai_enabled){
        toast("Ø§Ù„Ù…ÙŠØ²Ø© ØºÙŠØ± Ù…ÙØ¹Ù„Ø©");
        return;
      }
      aiPanel.style.display = "block";
      aiFab.style.display = "block";
      aiInput.focus();
      aiBadge.textContent = netNow() ? "Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†" : "Ø£ÙˆÙÙ„Ø§ÙŠÙ†";
      aiNameEl.textContent = ASSISTANT_NAME || DEFAULT_ASSISTANT_NAME;
      if(!aiBody.dataset.welcomed){
        aiBody.dataset.welcomed = "1";
        addHayekMsg(`Ø£Ù‡Ù„Ø§Ù‹! Ø£Ù†Ø§ ${aiNameEl.textContent}. Ù‚Ù„: "${aiNameEl.textContent} Ù…Ø³Ø§Ø¹Ø¯Ø©" Ø£Ùˆ Ø¬Ø±Ù‘Ø¨: "${aiNameEl.textContent} ØµØ¯Ù‘Ø± pdf".`);
      }
    }
    function closeAI(){
      aiPanel.style.display = "none";
    }
    function addMsg(text, who){
      const div = document.createElement("div");
      div.className = "aiMsg " + (who === "me" ? "me" : "hayek");
      div.textContent = String(text || "");
      aiBody.appendChild(div);
      aiBody.scrollTop = aiBody.scrollHeight;
    }
    function addMeMsg(t){ addMsg(t, "me"); }
    function addHayekMsg(t){ addMsg(t, "hayek"); }

    function normCmd(s){
      return String(s||"").trim().replace(/\s+/g," ");
    }

    function stripWake(text){
      // ÙŠÙ‚Ø¨Ù„: Ø­Ø§ÙŠÙƒ ... / hayek ... / Ù‡ÙŠÙƒ ... (Ø£Ø­ÙŠØ§Ù†Ø§Ù‹)
      const t = normCmd(text);
      const n = (ASSISTANT_NAME || DEFAULT_ASSISTANT_NAME).trim();
      const low = t.toLowerCase();

      const candidates = [
        n,
        "Ø­Ø§ÙŠÙƒ",
        "hayek",
        "Ù‡ÙŠÙƒ"
      ];

      for(const c of candidates){
        if(!c) continue;
        const cLow = c.toLowerCase();
        if(low === cLow) return "";
        if(low.startsWith(cLow + " ")) return t.slice(c.length).trim();
      }
      return t;
    }

    function parseAddLine(text){
      // Ù…Ø«Ø§Ù„: "Ø£Ø¶Ù Ø¨Ø·Ø§Ø·Ø§ 5x6.5" / "Ø§Ø¶Ù Ù‚Ø¯Ø§Ø­Ø© 10-3" / "Ø£Ø¶Ù 5x6.5"
      const t = text.trim();
      const m = t.match(/^(Ø£Ø¶Ù|Ø§Ø¶Ù|Ø¶ÙŠÙ|Ø³Ø¬Ù„)\s+/);
      if(!m) return null;

      const rest = t.replace(m[0], "").trim();
      if(!rest) return null;

      // Ø£ÙˆÙ„ Ø±Ù‚Ù…
      const firstDigit = rest.match(/[0-9Ù -Ù©]/);
      if(!firstDigit || firstDigit.index == null) return { item: rest, expr: "" };

      const idx = firstDigit.index;
      const item = rest.slice(0, idx).trim();
      const expr = rest.slice(idx).trim();

      return { item, expr };
    }

    async function runHayekCommand(rawText){
      if(!USER){
        addHayekMsg("Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }

      // Ù„Ø§Ø²Ù… Ø§Ø³Ù… Ø²Ø¨ÙˆÙ† Ù„Ø£ØºÙ„Ø¨ Ø§Ù„Ø£ÙˆØ§Ù…Ø±
      const cmd = stripWake(rawText);
      const c = cmd.trim();

      if(!c){
        addHayekMsg("Ù†Ø¹Ù…ØŸ Ù‚Ù„ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø¢Ù†.");
        return;
      }

      const lc = c.toLowerCase();

      if(lc.includes("Ù…Ø³Ø§Ø¹Ø¯Ø©") || lc === "help"){
        addHayekMsg(
          `Ø£ÙˆØ§Ù…Ø±ÙŠ:\n`+
          `- ${aiNameEl.textContent} ØµØ¯Ù‘Ø± pdf\n`+
          `- ${aiNameEl.textContent} Ø§Ø·Ø¨Ø¹ 80Ù…Ù…\n`+
          `- ${aiNameEl.textContent} Ø§Ø­Ø°Ù Ø¢Ø®Ø± Ø³Ø·Ø±\n`+
          `- ${aiNameEl.textContent} Ù…Ø³Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª\n`+
          `- ${aiNameEl.textContent} Ø§ÙØªØ­ Ø§Ù„Ø³Ø¬Ù„\n`+
          `- ${aiNameEl.textContent} Ø§ÙØªØ­ Ø§Ù„Ø­Ø§Ø³Ø¨Ø©\n`+
          `- ${aiNameEl.textContent} Ø£Ø¶Ù Ø¨Ø·Ø§Ø·Ø§ 5x6.5`
        );
        return;
      }

      if(lc.includes("Ø§ÙØªØ­ Ø§Ù„Ø³Ø¬Ù„") || lc.includes("Ø§Ù„Ø³Ø¬Ù„") || lc.includes("Ø³Ø¬Ù„")){
        setTab("log");
        addHayekMsg("ØªÙ… ÙØªØ­ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª âœ…");
        return;
      }

      if(lc.includes("Ø§ÙØªØ­ Ø§Ù„Ø­Ø§Ø³Ø¨Ø©") || lc.includes("Ø§Ù„Ø­Ø§Ø³Ø¨Ø©")){
        setTab("calc");
        addHayekMsg("ØªÙ… ÙØªØ­ Ø§Ù„Ø­Ø§Ø³Ø¨Ø© âœ…");
        return;
      }

      if(lc.includes("Ù…Ø³Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª") || lc.includes("Ø§Ù…Ø³Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª") || lc.includes("ØªÙØ±ÙŠØº Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª")){
        await clearOperations();
        addHayekMsg("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª âœ…");
        return;
      }

      if(lc.includes("Ø§Ø­Ø°Ù Ø§Ø®Ø± Ø³Ø·Ø±") || lc.includes("Ø§Ø­Ø°Ù Ø¢Ø®Ø± Ø³Ø·Ø±") || lc.includes("Ø­Ø°Ù Ø§Ø®Ø± Ø³Ø·Ø±") || lc.includes("Ø­Ø°Ù Ø¢Ø®Ø± Ø³Ø·Ø±")){
        await deleteLastOp();
        addHayekMsg("ØªÙ… Ø­Ø°Ù Ø¢Ø®Ø± Ø³Ø·Ø± âœ…");
        return;
      }

      if(lc.includes("ØµØ¯Ù‘Ø±") || lc.includes("ØªØµØ¯ÙŠØ±") || lc.includes("pdf")){
        await exportPDF();
        addHayekMsg("ØªÙ… âœ… (Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ù„Ù: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª).");
        return;
      }

      if(lc.includes("Ø§Ø·Ø¨Ø¹") || lc.includes("Ø·Ø¨Ø§Ø¹Ø©") || lc.includes("80") || lc.includes("Ù¨Ù ")){
        await print80mm();
        addHayekMsg("Ø­Ø§ÙˆÙ„Øª Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© âœ… (Ø¥Ø°Ø§ ÙØ´Ù„Øª: Ø¬Ø±Ù‘Ø¨ Chrome Android + Ø·Ø§Ø¨Ø¹Ø© ØªØ¯Ø¹Ù… BLE).");
        return;
      }

      const add = parseAddLine(c);
      if(add){
        const item = add.item || "";
        const expr = add.expr || "";
        if(item && itemInput){
          itemInput.value = item;
          itemInput.dispatchEvent(new Event("change", { bubbles:true }));
        }
        if(expr){
          // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ø³Ø§Ø± Smart Add
          if(window.HAYEK_VOICE_ADD_LINE){
            await window.HAYEK_VOICE_ADD_LINE(item, expr);
            addHayekMsg("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…");
            return;
          }
        }
        addHayekMsg("Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„ØµÙŠØºØ©: Ø£Ø¶Ù Ø¨Ø·Ø§Ø·Ø§ 5x6.5");
        return;
      }

      addHayekMsg("Ù„Ù… Ø£ÙÙ‡Ù… Ø§Ù„Ø£Ù…Ø±. Ù‚Ù„: Ø­Ø§ÙŠÙƒ Ù…Ø³Ø§Ø¹Ø¯Ø©");
    }

    // =========================
    // âœ… Wake word listening ("Ø­Ø§ÙŠÙƒ")
    // =========================
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let wakeRec = null;
    let WAKE_ON = false;

    function setWakeBtn(){
      btnWake.textContent = `ğŸ§ ${ASSISTANT_NAME || DEFAULT_ASSISTANT_NAME}: ` + (WAKE_ON ? "ØªØ´ØºÙŠÙ„" : "Ø¥ÙŠÙ‚Ø§Ù");
    }

    function startWake(){
      if(!SR){
        toast("Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… (Ø¬Ø±Ù‘Ø¨ Chrome)");
        WAKE_ON = false;
        setWakeBtn();
        return;
      }
      if(wakeRec) return;

      wakeRec = new SR();
      wakeRec.lang = (localStorage.getItem("HAYEK_VOICE_LANG_V1") || "ar-SA");
      wakeRec.continuous = true;
      wakeRec.interimResults = true;

      let lastFinal = "";

      wakeRec.onresult = async (e)=>{
        let finalText = "";
        let interim = "";
        for(let i=e.resultIndex;i<e.results.length;i++){
          const t = e.results[i][0].transcript;
          if(e.results[i].isFinal) finalText += t;
          else interim += t;
        }

        const text = (finalText || interim || "").trim();
        if(!text) return;

        // Ù„Ø§ Ù†Ù†ÙØ° Ø¥Ù„Ø§ Ø¹Ù„Ù‰ final Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø±
        if(finalText && finalText.trim()){
          const t = finalText.trim();
          if(t === lastFinal) return;
          lastFinal = t;

          // Ø¥Ø°Ø§ Ù†Ø§Ø¯Ù‰ "Ø­Ø§ÙŠÙƒ" Ø¶Ù…Ù† Ø§Ù„Ø¬Ù…Ù„Ø©
          const name = (ASSISTANT_NAME || DEFAULT_ASSISTANT_NAME).trim();
          const hasWake = t.includes(name) || t.toLowerCase().includes("hayek") || t.includes("Ø­Ø§ÙŠÙƒ") || t.includes("Ù‡ÙŠÙƒ");
          if(hasWake){
            openAI();
            addMeMsg(t);
            await runHayekCommand(t);
          }
        }
      };

      wakeRec.onerror = ()=>{
        // Ù„Ø§ Ù†Ø²Ø¹Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      };
      wakeRec.onend = ()=>{
        // Ø¥Ø°Ø§ WAKE_ON Ø±Ø¬Ù‘Ø¹ ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
        if(WAKE_ON){
          try{ wakeRec.start(); }catch{}
        }
      };

      try{
        wakeRec.start();
        WAKE_ON = true;
        setWakeBtn();
        toast(`Ø§Ø³ØªÙ…Ø§Ø¹ ${ASSISTANT_NAME || DEFAULT_ASSISTANT_NAME} âœ…`);
      }catch{
        WAKE_ON = false;
        setWakeBtn();
      }
    }

    function stopWake(){
      WAKE_ON = false;
      setWakeBtn();
      try{
        if(wakeRec){
          wakeRec.onend = null;
          wakeRec.stop();
        }
      }catch{}
      wakeRec = null;
      toast(`ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹`);
    }

    function toggleWake(){
      if(WAKE_ON) stopWake();
      else startWake();
    }

    // =========================
    // âœ… EXPOSE: Smart voice add line
    // =========================
    window.HAYEK_VOICE_ADD_LINE = async (item, expression)=>{
      try{
        const c = custInput.value.trim();
        if(!c){
          showErr(appErr, "Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£ÙˆÙ„Ø§Ù‹ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ).");
          custInput.focus();
          return;
        }
        clearErr(appErr);

        if(item && String(item).trim()){
          itemInput.value = String(item).trim();
          itemInput.dispatchEvent(new Event("input", { bubbles:true }));
          itemInput.dispatchEvent(new Event("change", { bubbles:true }));
        }

        const exprNorm = String(expression||"").trim();
        if(!exprNorm){
          showErr(appErr, "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…Ù„ÙŠØ© Ø­Ø³Ø§Ø¨ÙŠØ©.");
          return;
        }

        const finalExpr = exprNorm.replaceAll("_","-");

        setExpr(finalExpr);
        await equalsAndLog();
      }catch(e){
        showErr(appErr, "ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù„ØµÙˆØª:\n" + (e?.message || e));
      }
    };

    // =========================
    // âœ… binds
    // =========================
    document.getElementById("loginCard").addEventListener("submit", (e)=>{
      e.preventDefault();
      login();
    });

    $("btnClear").addEventListener("click", ()=>{
      $("loginUser").value="";
      $("loginPass").value="";
      clearErr(loginErr);
    });
    $("btnLogout").addEventListener("click", logout);

    tabCalc.addEventListener("click", ()=>setTab("calc"));
    tabLog.addEventListener("click", ()=>setTab("log"));

    $("keys").addEventListener("click", (e)=>{
      const b = e.target.closest("button");
      if(!b) return;
      const k = b.dataset.k;
      if(!k) return;
      press(k);
    });

    $("btnBack").addEventListener("click", backspace);
    $("btnEq").addEventListener("click", equalsAndLog);
    $("btnPDF").addEventListener("click", exportPDF);
    $("btnClearOps").addEventListener("click", clearOperations);

    // NEW buttons
    btnDelLast.addEventListener("click", deleteLastOp);
    btnPrint80.addEventListener("click", print80mm);
    btnOpenAI.addEventListener("click", openAI);
    btnClearLogAll.addEventListener("click", clearOperations);

    // delete row buttons (delegation)
    logBody.addEventListener("click", (e)=>{
      const b = e.target.closest("button[data-del]");
      if(!b) return;
      const idx = Number(b.dataset.del);
      if(Number.isFinite(idx)) deleteOpAt(idx);
    });

    // AI UI binds
    aiFab.addEventListener("click", openAI);
    aiClose.addEventListener("click", closeAI);
    aiHelp.addEventListener("click", ()=>{
      openAI();
      addMeMsg(`${aiNameEl.textContent} Ù…Ø³Ø§Ø¹Ø¯Ø©`);
      runHayekCommand(`${aiNameEl.textContent} Ù…Ø³Ø§Ø¹Ø¯Ø©`);
    });
    aiSend.addEventListener("click", async ()=>{
      const t = aiInput.value.trim();
      if(!t) return;
      aiInput.value = "";
      openAI();
      addMeMsg(t);
      await runHayekCommand(t);
    });
    aiInput.addEventListener("keydown", async (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        aiSend.click();
      }
    });

    // Wake toggle
    btnWake.addEventListener("click", toggleWake);

    setTab("calc");
    renderSug();

    // init features display (before login)
    applyFeatures();
    setWakeBtn();

    refreshNetState(true).then(async ()=>{
      await qSyncSilently(false);
    });

    restoreSession().then(()=>{
      // Ø¨Ø¹Ø¯ restoreSession: Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù… Ø­Ø³Ø¨ Ø§Ù„Ù…ÙŠØ²Ø§Øª
      if(aiFab) aiFab.style.display = (FEATURES.ai_enabled && USER) ? "block" : "none";
      applyFeatures();
    });

    try{
      if("serviceWorker" in navigator){
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      }
    }catch{}
  </script>
</body>
</html>
