<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HAYEK SPOT — الحاسبة</title>

  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#071820" />

  <!-- PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#071820; --panel:rgba(255,255,255,.06); --line:rgba(255,255,255,.12);
      --txt:#eaf4ff; --mut:#a7bdd0; --blue:#1f62ff; --red:#ff5a6b;
    }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Tahoma,Arial}
    body{margin:0;min-height:100vh;background:radial-gradient(1200px 600px at 30% 20%, #0f3a3f 0%, var(--bg) 55%);color:var(--txt)}
    .wrap{max-width:980px;margin:18px auto;padding:16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .dot{width:12px;height:12px;border-radius:50%;background:#49e39a;box-shadow:0 0 0 6px rgba(73,227,154,.12)}
    .btnSmall{border:none;border-radius:999px;padding:10px 14px;background:rgba(255,255,255,.08);color:#fff;cursor:pointer}
    .btnSmall.danger{background:rgba(255,90,107,.18);border:1px solid rgba(255,90,107,.35)}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:22px;box-shadow:0 20px 70px rgba(0,0,0,.45);backdrop-filter:blur(10px);overflow:hidden}
    .head{padding:16px;border-bottom:1px solid var(--line);display:flex;gap:12px;flex-wrap:wrap;align-items:end}
    .field{flex:1;min-width:220px}
    label{display:block;color:var(--mut);font-size:13px;margin:0 0 6px}
    input{width:100%;padding:14px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--txt);font-size:16px;outline:none}
    input[readonly]{opacity:.95}
    .tabs{display:flex;gap:10px;margin-inline-start:auto}
    .tab{border:none;border-radius:999px;padding:10px 14px;background:rgba(255,255,255,.08);color:#fff;cursor:pointer}
    .tab.active{background:rgba(31,98,255,.35);border:1px solid rgba(31,98,255,.55)}
    .body{padding:16px}
    .row2{display:flex;gap:12px;flex-wrap:wrap}
    .panel{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:18px;padding:14px;flex:1;min-width:300px}
    .kpad{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    .k{padding:18px;border:none;border-radius:16px;background:rgba(255,255,255,.08);color:#fff;font-size:18px;cursor:pointer}
    .k.op{background:rgba(255,255,255,.12)}
    .k.eq{background:rgba(31,98,255,.85)}
    .k.wide{grid-column:span 2}
    .tableWrap{margin-top:12px;overflow:auto;border-radius:16px;border:1px solid var(--line)}
    table{width:100%;border-collapse:collapse;min-width:700px;background:transparent}
    th,td{padding:10px;border-bottom:1px dashed rgba(255,255,255,.12);font-size:14px;background:transparent}
    th{color:rgba(255,255,255,.85);text-align:right;background:transparent}
    td{text-align:right;color:rgba(255,255,255,.95)}
    .total{margin-top:12px;border:2px dashed rgba(255,255,255,.18);border-radius:16px;padding:12px;font-size:18px;display:flex;justify-content:space-between;align-items:center}
    .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .a{flex:1;border:none;border-radius:16px;padding:14px;font-size:16px;cursor:pointer;min-width:180px}
    .a.pdf{background:var(--blue);color:#fff}
    .a.new{background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(255,255,255,.14)}
    .a.danger{background:rgba(255,90,107,.18);color:#fff;border:1px solid rgba(255,90,107,.35)}
    .foot{margin-top:10px;text-align:center;color:rgba(255,255,255,.55);font-size:12px;line-height:1.7}

    /* شاشة قفل */
    #lock{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:9999;display:none;align-items:center;justify-content:center;padding:16px}
    #lock .box{width:min(520px,100%);background:#0b1820;border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:18px;text-align:center}
  </style>
</head>

<body>
  <div id="lock">
    <div class="box">
      <h3>تسجيل الدخول مطلوب</h3>
      <p style="color:#b9cde0;margin:0 0 12px">غير مسموح تصفح الصفحة بدون تسجيل دخول.</p>
      <button class="btnSmall" id="goLogin">الذهاب لتسجيل الدخول</button>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <span class="dot" id="onlineDot"></span>
        <div>
          <div style="font-weight:800;font-size:18px">حاسبة الحايك</div>
          <div style="color:var(--mut);font-size:13px">زر واحد: تصدير PDF</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <button class="btnSmall danger" id="newInvoiceTop">فاتورة جديدة</button>
        <button class="btnSmall" id="logoutBtn">خروج</button>
      </div>
    </div>

    <div class="card">
      <div class="head">
        <div class="field">
          <label>اسم الزبون (إجباري)</label>
          <input id="customerName" placeholder="مثال: أبو إبراهيم">
        </div>

        <div class="field">
          <label>نص السطر (اختياري)</label>
          <input id="lineText" placeholder="مثال: محارم / رز / مصروف...">
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="calc">الحاسبة</button>
          <button class="tab" data-tab="log">سجل العمليات</button>
        </div>
      </div>

      <div class="body">
        <div id="tab_calc">
          <div class="row2">
            <div class="panel">
              <label>العملية الحسابية (من أزرار الشاشة)</label>
              <input id="expr" readonly placeholder="5+5">
              <div style="margin-top:8px;color:var(--mut);font-size:13px">
                النتيجة: <span id="res" style="font-weight:800;color:#fff">0</span>
              </div>

              <div class="kpad" id="pad">
                <button class="k" data-k="7">7</button>
                <button class="k" data-k="8">8</button>
                <button class="k" data-k="9">9</button>
                <button class="k op" data-k="÷">÷</button>

                <button class="k" data-k="4">4</button>
                <button class="k" data-k="5">5</button>
                <button class="k" data-k="6">6</button>
                <button class="k op" data-k="×">×</button>

                <button class="k" data-k="1">1</button>
                <button class="k" data-k="2">2</button>
                <button class="k" data-k="3">3</button>
                <button class="k op" data-k="-">-</button>

                <button class="k op" data-k="(">(</button>
                <button class="k" data-k="0">0</button>
                <button class="k op" data-k=")">)</button>
                <button class="k op" data-k="+">+</button>

                <button class="k wide op" data-k="BACK">⌫</button>
                <button class="k wide eq" data-k="=">=</button>
              </div>

              <div class="actions">
                <button class="a new" id="newInvoiceBtn">فاتورة جديدة</button>
                <button class="a danger" id="clearOpsBtn">حذف العمليات الحالية</button>
                <button class="a pdf" id="pdfBtn">تصدير PDF</button>
              </div>

              <div class="foot">
                تم تطوير هذه الحاسبة الاحترافية من قبل شركة الحايك — 05510217646
              </div>
            </div>

            <div class="panel">
              <div class="tableWrap">
                <table>
                  <thead>
                    <tr>
                      <th>الوقت</th>
                      <th>البيان</th>
                      <th>العملية</th>
                      <th>النتيجة</th>
                    </tr>
                  </thead>
                  <tbody id="rows"></tbody>
                </table>
              </div>

              <div class="total">
                <span>إجمالي الكشف:</span>
                <strong id="total">0</strong>
              </div>
            </div>
          </div>
        </div>

        <div id="tab_log" style="display:none">
          <div class="panel">
            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>الوقت</th>
                    <th>البيان</th>
                    <th>العملية</th>
                    <th>النتيجة</th>
                  </tr>
                </thead>
                <tbody id="rows2"></tbody>
              </table>
            </div>

            <div class="total">
              <span>الإجمالي:</span>
              <strong id="total2">0</strong>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script type="module">
import { supabase } from "./config.js";

(() => {
  const $ = (id)=>document.getElementById(id);

  // ===== AUTH Gate (Supabase) =====
  const lock = $("lock");
  $("goLogin").onclick = () => location.href = "index.html?v=" + Date.now();

  async function gate(){
    const { data } = await supabase.auth.getSession();
    const user = data?.session?.user;

    if(!user){
      lock.style.display = "flex";
      return null;
    }

    // لو admin افتح admin مباشرة
    const email = String(user.email||"").toLowerCase();
    const uname = email.includes("@") ? email.split("@")[0] : email;
    if(uname === "admin"){
      location.href = "admin.html?v=" + Date.now();
      return null;
    }

    return { user, uname };
  }

  // ===== Online dot =====
  const onlineDot = $("onlineDot");
  function refreshOnline(){
    const on = navigator.onLine;
    onlineDot.style.background = on ? "#49e39a" : "#ffb1b1";
    onlineDot.style.boxShadow = on ? "0 0 0 6px rgba(73,227,154,.12)" : "0 0 0 6px rgba(255,107,107,.12)";
  }
  window.addEventListener("online", refreshOnline);
  window.addEventListener("offline", refreshOnline);
  refreshOnline();

  $("logoutBtn").onclick = async () => {
    try{ await supabase.auth.signOut(); }catch{}
    location.href="index.html?v="+Date.now();
  };

  // ===== Tabs =====
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.onclick=()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      tab.classList.add("active");
      const key = tab.getAttribute("data-tab");
      $("tab_calc").style.display = key==="calc" ? "block" : "none";
      $("tab_log").style.display  = key==="log"  ? "block" : "none";
    };
  });

  // ===== Local storage =====
  const LS_CURRENT = "HAYEK_USER_CURRENT_INVOICE_V4";
  function jparse(s, fallback){ try { return JSON.parse(s) ?? fallback; } catch { return fallback; } }
  function jset(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
  function nowIso(){ return new Date().toISOString(); }
  function nowTime(){
    const d = new Date();
    return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
  }
  function vibrateTiny(){ try{ navigator.vibrate && navigator.vibrate(18);}catch{} }

  // ===== State =====
  const state = { invoice:null, expr:"", lastResult:0 };

  const customerName = $("customerName");
  const lineText = $("lineText");
  const exprInput = $("expr");
  const resEl = $("res");
  const rowsEl = $("rows");
  const rows2El = $("rows2");
  const totalEl = $("total");
  const total2El = $("total2");

  function uuid(){
    return (crypto?.randomUUID?.() || ("inv_" + Math.random().toString(16).slice(2) + Date.now()));
  }

  function ensureInvoiceLocal(username){
    const cust = (customerName.value||"").trim();
    if(!cust) return null;

    if(!state.invoice || state.invoice.status !== "open"){
      state.invoice = {
        id: uuid(),
        username,
        customer_name: cust,
        created_at: nowIso(),
        status: "open",
        rows: [],
        total: 0,
      };
      jset(LS_CURRENT, state.invoice);
    } else {
      state.invoice.customer_name = cust;
      jset(LS_CURRENT, state.invoice);
    }
    return state.invoice;
  }

  function loadCurrent(username){
    const cur = jparse(localStorage.getItem(LS_CURRENT), null);
    if(cur && cur.username === username && cur.status === "open"){
      state.invoice = cur;
      customerName.value = cur.customer_name || "";
    }
  }

  // ===== Calculator safe eval =====
  function setExpr(v){ state.expr = v; exprInput.value = v; }
  function appendToken(tok){
    if(tok==="BACK"){ setExpr(state.expr.slice(0,-1)); return; }
    if(tok==="×") tok="*";
    if(tok==="÷") tok="/";
    if(!/^[0-9+\-*/().]$/.test(tok)) return;
    setExpr(state.expr + tok);
  }
  function safeEval(expr){
    const cleaned=(expr||"").replace(/\s+/g,"");
    if(!cleaned) throw 0;
    if(!/^[0-9+\-*/().]+$/.test(cleaned)) throw 0;
    const val = Function('"use strict";return ('+cleaned+');')();
    const n = Number(val);
    if(!Number.isFinite(n)) throw 0;
    return n;
  }

  $("pad").addEventListener("click",(e)=>{
    const btn = e.target.closest(".k"); if(!btn) return;
    const k = btn.getAttribute("data-k");
    vibrateTiny();
    if(k==="=") commitLine();
    else appendToken(k);
  });

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function render(){
    const inv = state.invoice;
    const arr = inv?.rows || [];
    rowsEl.innerHTML = arr.map((r)=>`
      <tr>
        <td>${escapeHtml(r.t||"")}</td>
        <td>${escapeHtml(r.text||"—")}</td>
        <td>${escapeHtml(r.expr||"")}</td>
        <td>${escapeHtml(String(r.result ?? ""))}</td>
      </tr>
    `).join("");
    rows2El.innerHTML = rowsEl.innerHTML;
    totalEl.textContent  = String(inv?.total ?? 0);
    total2El.textContent = String(inv?.total ?? 0);
  }

  async function commitLine(){
    if(!window.__HAYEK_USER__) return;

    let inv = ensureInvoiceLocal(window.__HAYEK_USER__);
    if(!inv){ alert("أدخل اسم الزبون"); customerName.focus(); return; }

    const expr = (state.expr||"").trim();
    if(!expr) return;

    let result;
    try{ result = safeEval(expr); }catch{ resEl.textContent="خطأ"; return; }

    const text = (lineText.value||"").trim();
    const row = { t: nowTime(), text, expr, result };

    inv.rows.push(row);
    inv.total = inv.rows.reduce((a,r)=>a + Number(r.result||0), 0);
    inv.customer_name = (customerName.value||"").trim();

    jset(LS_CURRENT, inv);
    state.invoice = inv;

    state.lastResult = result;
    resEl.textContent = String(result);

    lineText.value = "";
    setExpr("");
    render();
  }

  function clearOnlyOps(){
    if(!window.__HAYEK_USER__) return;

    const inv = ensureInvoiceLocal(window.__HAYEK_USER__);
    if(!inv) { alert("أدخل اسم الزبون"); customerName.focus(); return; }
    inv.rows = [];
    inv.total = 0;
    jset(LS_CURRENT, inv);
    state.invoice = inv;
    resEl.textContent = "0";
    setExpr("");
    render();
  }

  function newInvoice(){
    localStorage.removeItem(LS_CURRENT);
    state.invoice = null;
    resEl.textContent = "0";
    setExpr("");
    render();
    if((customerName.value||"").trim() && window.__HAYEK_USER__){
      ensureInvoiceLocal(window.__HAYEK_USER__);
      render();
    }
  }

  $("clearOpsBtn").onclick = ()=>{ vibrateTiny(); if(confirm("حذف العمليات الحالية؟")) clearOnlyOps(); };
  $("newInvoiceBtn").onclick = ()=>{ vibrateTiny(); if(confirm("فتح فاتورة جديدة؟")) newInvoice(); };
  $("newInvoiceTop").onclick = ()=>{ vibrateTiny(); if(confirm("فتح فاتورة جديدة؟")) newInvoice(); };

  // PDF export
  function buildInvoiceHtml(inv){
    const rowsHtml = (inv.rows||[]).map((r, i)=>`
      <tr>
        <td style="border:1px solid #111;padding:8px;text-align:center;width:10%">${i+1}</td>
        <td style="border:1px solid #111;padding:8px;text-align:center;width:16%">${escapeHtml(r.t||"")}</td>
        <td style="border:1px solid #111;padding:8px;text-align:right;width:34%">${escapeHtml(r.text||"عملية")}</td>
        <td style="border:1px solid #111;padding:8px;text-align:center;width:20%">${escapeHtml(r.expr||"")}</td>
        <td style="border:1px solid #111;padding:8px;text-align:center;width:20%;font-weight:900">${escapeHtml(String(r.result ?? ""))}</td>
      </tr>
    `).join("");

    const invNo = String(inv.id || "").slice(-6);

    return `
      <div style="direction:rtl;font-family:Arial,system-ui; background:#fff; color:#111; padding:18px;">
        <div style="border:2px solid #111;border-radius:14px;padding:16px;">
          <div style="text-align:center;font-weight:900;font-size:24px;margin-bottom:4px;">شركة الحايك</div>
          <div style="text-align:center;font-weight:900;font-size:20px;color:#0a7c3a;margin-bottom:10px;">HAYEK SPOT</div>

          <div style="display:flex;justify-content:space-between;gap:12px;font-size:13px;margin-bottom:10px;flex-wrap:wrap">
            <div>اسم الزبون: <b>${escapeHtml(inv.customer_name||"-")}</b></div>
            <div>اسم المستخدم: <b>${escapeHtml(inv.username||"-")}</b></div>
            <div>رقم الفاتورة: <b>${escapeHtml(invNo)}</b></div>
            <div>التاريخ: <b>${new Date().toLocaleString("ar")}</b></div>
          </div>

          <div style="border-top:1px solid #111;margin:10px 0"></div>

          <div style="font-weight:900;margin:6px 0 10px;">تفاصيل العمليات</div>

          <table style="width:100%;border-collapse:collapse;font-size:13px;background:#fff">
            <thead>
              <tr style="background:#f3f3f3">
                <th style="border:1px solid #111;padding:8px;text-align:center;">#</th>
                <th style="border:1px solid #111;padding:8px;text-align:center;">الوقت</th>
                <th style="border:1px solid #111;padding:8px;text-align:center;">البيان</th>
                <th style="border:1px solid #111;padding:8px;text-align:center;">العملية</th>
                <th style="border:1px solid #111;padding:8px;text-align:center;">النتيجة</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml || `<tr><td colspan="5" style="border:1px solid #111;padding:14px;text-align:center;color:#666">لا يوجد عمليات</td></tr>`}
            </tbody>
          </table>

          <div style="margin-top:12px;border:2px dashed #111;border-radius:12px;padding:10px;display:flex;justify-content:space-between;font-weight:900">
            <span>إجمالي الكشف:</span>
            <span>${escapeHtml(String(inv.total || 0))}</span>
          </div>

          <div style="margin-top:12px;border:2px solid #111;border-radius:14px;padding:12px;text-align:center;font-size:12px;line-height:1.8">
            تم تطوير هذه الحاسبة الاحترافية من قبل شركة الحايك<br/>
            <span style="display:inline-block;margin-top:8px;border:2px solid #0a7c3a;color:#0a7c3a;border-radius:12px;padding:8px 16px;font-weight:900;font-size:16px;">05510217646</span>
          </div>
        </div>
      </div>
    `;
  }

  async function exportPDF(){
    if(!window.__HAYEK_USER__) return;

    const inv = ensureInvoiceLocal(window.__HAYEK_USER__);
    if(!inv){ alert("أدخل اسم الزبون"); customerName.focus(); return; }
    if(!inv.rows?.length){ alert("لا يوجد عمليات لتصديرها"); return; }

    const tmp = document.createElement("div");
    tmp.style.position="fixed"; tmp.style.left="-99999px"; tmp.style.top="0"; tmp.style.width="794px";
    tmp.innerHTML = buildInvoiceHtml(inv);
    document.body.appendChild(tmp);

    const canvas = await html2canvas(tmp, { scale: 2, backgroundColor:"#ffffff" });
    tmp.remove();

    const imgData = canvas.toDataURL("image/jpeg", 0.95);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p","pt","a4");

    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const imgW = pageW;
    const imgH = canvas.height * (imgW / canvas.width);

    let y = 0;
    let remaining = imgH;
    while (remaining > 0) {
      pdf.addImage(imgData, "JPEG", 0, y, imgW, imgH);
      remaining -= pageH;
      if (remaining > 0) { pdf.addPage(); y -= pageH; }
    }

    const cust = (inv.customer_name||"invoice").trim().replace(/\s+/g,"_");
    const invNo = String(inv.id||"").slice(-6);
    pdf.save(`HAYEK_${cust}_${invNo}.pdf`);
  }

  $("pdfBtn").onclick = () => { vibrateTiny(); exportPDF(); };

  // ✅ تشغيل بعد Gate
  (async ()=>{
    const g = await gate();
    if(!g) return;
    window.__HAYEK_USER__ = g.uname;

    loadCurrent(g.uname);
    render();

    // فتح تلقائي عند إدخال اسم الزبون
    let custTm = null;
    customerName.addEventListener("input", ()=>{
      clearTimeout(custTm);
      custTm = setTimeout(()=>{
        const cust = (customerName.value||"").trim();
        if(cust){
          ensureInvoiceLocal(g.uname);
          render();
        }
      }, 350);
    });
  })();

})();
</script>
</body>
</html>
