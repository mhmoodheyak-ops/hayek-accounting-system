<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111315" />
  <title>HAYEK SPOT — فاتورة</title>

  <style>
    :root{
      --white:#FFFFFF;
      --green:#19C37D;
      --yellow:#D6A628;
      --bg1:#0f1113;
      --bg2:#1a1f24;
      --card: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.16);
      --text:#fff;
      --muted: rgba(255,255,255,.78);
      --shadow: 0 16px 46px rgba(0,0,0,.45);
      --radius: 22px;
      --ink:#111315;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(900px 420px at 30% 0%, rgba(25,195,125,.14), rgba(0,0,0,0) 55%),
                  radial-gradient(900px 420px at 80% 10%, rgba(214,166,40,.14), rgba(0,0,0,0) 58%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Arabic","Noto Naskh Arabic",sans-serif;
      padding:16px;
      display:flex;
      justify-content:center;
    }
    .wrap{width:min(980px,100%); display:grid; gap:12px}

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 14px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(17,19,21,.92), rgba(47,51,55,.92));
      box-shadow: var(--shadow);
    }
    .brand{display:grid; gap:3px}
    .brand b{font-size:16px; letter-spacing:.4px}
    .brand span{font-size:12px; color:var(--muted)}

    .pill{
      padding:8px 12px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);
      color:#fff;
      white-space:nowrap;
    }
    .pill.ok{background: rgba(25,195,125,.20); border-color: rgba(25,195,125,.45)}
    .pill.warn{background: rgba(214,166,40,.20); border-color: rgba(214,166,40,.45); color:#111315}
    .pill.bad{background: rgba(255,80,90,.18); border-color: rgba(255,80,90,.35)}

    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Header banner (تعريفي) */
    .hero{
      padding:16px;
      border-bottom:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(900px 260px at 50% 0%, rgba(214,166,40,.22), rgba(0,0,0,0) 70%),
        radial-gradient(700px 240px at 20% 40%, rgba(25,195,125,.18), rgba(0,0,0,0) 65%),
        rgba(17,19,21,.18);
    }
    .banner{
      position:relative;
      text-align:center;
      padding:16px 14px;
      border-radius:20px;
      background: linear-gradient(135deg, rgba(255,255,255,.96), rgba(255,255,255,.88));
      color:#111315;
      border:1px solid rgba(0,0,0,.10);
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .banner::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(450px 160px at 50% -10%, rgba(214,166,40,.42), rgba(0,0,0,0) 70%);
      pointer-events:none;
    }
    .banner::after{
      content:"";
      position:absolute; top:-60px; left:-60px;
      width:160px; height:160px; border-radius:50%;
      background: rgba(25,195,125,.22);
      pointer-events:none;
    }
    .bannerTitle{
      position:relative;
      font-weight:1000;
      font-size:26px;
      line-height:1.12;
    }
    .bannerSub{
      position:relative;
      margin-top:6px;
      font-weight:1000;
      font-size:14px;
      letter-spacing:2px;
      color:#0f7d4f;
    }
    .badgeRow{
      position:relative;
      margin-top:10px;
      display:flex; justify-content:center; gap:8px; flex-wrap:wrap;
    }
    .badge{
      font-size:12px;
      font-weight:1000;
      padding:7px 10px;
      border-radius:999px;
      background: rgba(17,19,21,.08);
      border:1px solid rgba(17,19,21,.10);
      color:#111315;
      box-shadow: 0 6px 16px rgba(0,0,0,.10);
      white-space:nowrap;
    }

    .content{padding:16px; display:grid; gap:12px}

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:820px){
      .grid{grid-template-columns:1fr}
    }
    .box{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(17,19,21,.35);
      border-radius:18px;
      padding:12px 12px;
      display:grid;
      gap:6px;
      min-height:64px;
    }
    .box label{font-size:12px; color:var(--muted); font-weight:1000}
    .box b{font-size:16px; direction:ltr; text-align:left}
    .box b.ar{direction:rtl; text-align:right}

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding:0 16px 16px;
    }
    .btn{
      user-select:none;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color:#fff;
      padding:12px 14px;
      border-radius:16px;
      font-weight:1000;
      cursor:pointer;
      touch-action:manipulation;
      min-width:170px;
    }
    .btn.green{background: rgba(25,195,125,.22); border-color: rgba(25,195,125,.45)}
    .btn.yellow{background: rgba(214,166,40,.20); border-color: rgba(214,166,40,.45); color:#111315}
    .btn.gray{min-width:auto}

    /* Table */
    .tableWrap{
      border:1px solid rgba(255,255,255,.16);
      border-radius:18px;
      overflow:hidden;
      background: rgba(17,19,21,.22);
    }
    table{width:100%; border-collapse:collapse}
    thead th{
      padding:12px 10px;
      font-size:13px;
      font-weight:1000;
      color:#111315;
      background: linear-gradient(135deg, rgba(214,166,40,.95), rgba(25,195,125,.65));
      border-bottom:1px solid rgba(0,0,0,.12);
      text-align:right;
    }
    tbody td{
      padding:11px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      font-size:13px;
      color:#fff;
      text-align:right;
      vertical-align:top;
    }
    tbody tr:nth-child(even) td{
      background: rgba(255,255,255,.04);
    }
    td.num{direction:ltr; text-align:left; font-weight:1000}
    .total{
      margin-top:12px;
      display:flex; justify-content:space-between; align-items:center;
      border:2px dashed rgba(255,255,255,.26);
      border-radius:18px;
      padding:12px 12px;
      background: rgba(255,255,255,.06);
      font-weight:1000;
    }
    .total span:last-child{direction:ltr; text-align:left}

    /* Footer banner (تعريفي) */
    .footerBanner{
      margin-top:14px;
      text-align:center;
      padding:16px 14px;
      border-radius:20px;
      background: linear-gradient(135deg, rgba(17,19,21,.96), rgba(47,51,55,.96));
      color:#FFFFFF;
      border: 1px solid rgba(255,255,255,.16);
      box-shadow: 0 14px 34px rgba(0,0,0,.45);
      position:relative;
      overflow:hidden;
    }
    .footerBanner::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(520px 180px at 50% -10%, rgba(25,195,125,.28), rgba(0,0,0,0) 70%);
      pointer-events:none;
    }
    .footerMain{position:relative; font-weight:1000; font-size:16px; line-height:1.7}
    .footerLine{position:relative; margin-top:6px; font-weight:1000; font-size:14px; line-height:1.8; color:var(--yellow)}
    .footerPhone{
      position:relative;
      margin-top:10px;
      font-weight:1000;
      font-size:20px;
      direction:ltr;
      color: var(--green);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:10px 12px;
      display:inline-block;
    }

    .hint{padding:10px 16px; color:var(--muted); font-size:12px}

    /* PRINT (PDF) */
    @media print{
      body{background:#fff !important; color:#000 !important; padding:0 !important}
      .topbar, .actions, .hint{display:none !important}
      .wrap{width:100% !important}
      .card{box-shadow:none !important; border:none !important; background:#fff !important}
      .hero{background:#fff !important; border-bottom:none !important}
      .banner{box-shadow:none !important; border:2px solid #000 !important}
      .bannerSub{color:#0b7a4a !important}

      .box{background:#fff !important; border:1px solid #000 !important; color:#000 !important}
      .box label{color:#333 !important}
      .box b{color:#000 !important}

      .tableWrap{border:1px solid #000 !important; background:#fff !important}
      thead th{
        background:#f0f0f0 !important;
        color:#000 !important;
        border-bottom:1px solid #000 !important;
      }
      tbody td{color:#000 !important; border-bottom:1px solid #999 !important}
      tbody tr:nth-child(even) td{background:#fafafa !important}

      .total{
        border:2px dashed #000 !important;
        background:#fff !important;
        color:#000 !important;
      }
      .footerBanner{
        box-shadow:none !important;
        border:2px solid #111 !important;
        background:#111 !important;
        color:#fff !important;
        break-inside: avoid !important;
        page-break-inside: avoid !important;
      }
      .footerPhone{background:#fff !important; color:#19C37D !important; border:2px solid #19C37D !important}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <b>HAYEK SPOT — فاتورة</b>
        <span id="subTitle">...</span>
      </div>
      <div class="pill" id="statusPill">...</div>
    </div>

    <div class="card">
      <div class="hero">
        <div class="banner">
          <div class="bannerTitle">شركة الحايك</div>
          <div class="bannerSub">HAYEK SPOT</div>
          <div class="badgeRow">
            <div class="badge">فاتورة رسمية</div>
            <div class="badge">سجل عمليات كامل</div>
            <div class="badge">طباعة / PDF</div>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="grid">
          <div class="box">
            <label>اسم المستخدم</label>
            <b class="ar" id="username">—</b>
          </div>
          <div class="box">
            <label>اسم العميل</label>
            <b class="ar" id="customer">—</b>
          </div>
          <div class="box">
            <label>رقم الفاتورة</label>
            <b id="invoiceId">—</b>
          </div>
          <div class="box">
            <label>التاريخ</label>
            <b class="ar" id="date">—</b>
          </div>
        </div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:190px">الوقت</th>
                <th>البيان</th>
                <th class="num" style="width:170px">العملية</th>
                <th class="num" style="width:120px">النتيجة</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- rows -->
            </tbody>
          </table>
        </div>

        <div class="total">
          <span>إجمالي الكشف:</span>
          <span id="grandTotal">0</span>
        </div>

        <div class="footerBanner">
          <div class="footerMain">تم تطوير هذه الحاسبة الاحترافية من قبل شركة الحايك</div>
          <div class="footerLine">شركة الحايك / تجارة عامة / توزيع جملة / دعاية و اعلان / طباعة / حلول رقمية /</div>
          <div class="footerPhone">05510217646</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn green" id="printBtn">تصدير / طباعة PDF</button>
        <button class="btn gray" id="backBtn">رجوع</button>
      </div>

      <div class="hint" id="hint">ملاحظة: لازم تفتح الرابط ومعه invoice_id.</div>
    </div>
  </div>

<script>
  // =========================
  // Supabase REST
  // =========================
  const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
  const SUPABASE_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";
  const REST = `${SUPABASE_URL}/rest/v1`;

  const $ = (id) => document.getElementById(id);

  function toast(msg){
    const d = document.createElement("div");
    d.textContent = msg;
    Object.assign(d.style, {
      position:"fixed", bottom:"18px", left:"50%",
      transform:"translateX(-50%)",
      background:"rgba(17,19,21,.88)",
      color:"#fff", padding:"10px 14px",
      borderRadius:"14px", fontWeight:"1000",
      zIndex:9999, border:"1px solid rgba(255,255,255,.18)"
    });
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 1600);
  }

  async function apiFetch(path, options = {}){
    const res = await fetch(`${REST}${path}`, {
      ...options,
      headers: {
        "apikey": SUPABASE_KEY,
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json",
        "Accept": "application/json",
        ...(options.headers || {})
      }
    });
    if (!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`API ${res.status}: ${t || res.statusText}`);
    }
    const text = await res.text();
    return text ? JSON.parse(text) : null;
  }

  function formatNumber(n){
    const x = Number(n);
    if (!Number.isFinite(x)) return "0";
    const s = x.toString();
    return s.includes(".") ? x.toFixed(6).replace(/0+$/,"").replace(/\.$/,"") : s;
  }

  function fmtDT(dt){
    try{
      const d = new Date(dt);
      if (isNaN(d.getTime())) return "—";
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      // عربي بسيط
      return `${y}/${m}/${da} ${hh}:${mm}`;
    }catch{ return "—"; }
  }

  function setStatusPill(status){
    const p = $("statusPill");
    if (status === "closed"){
      p.textContent = "مغلقة";
      p.className = "pill warn";
    } else if (status === "open"){
      p.textContent = "مفتوحة";
      p.className = "pill ok";
    } else {
      p.textContent = "غير معروف";
      p.className = "pill bad";
    }
  }

  function getInvoiceIdFromUrl(){
    const u = new URL(location.href);
    return u.searchParams.get("invoice_id") || "";
  }

  async function loadInvoice(invoice_id){
    // invoice
    const qInv =
      `?select=id,username,customer_name,status,created_at,closed_at` +
      `&id=eq.${encodeURIComponent(invoice_id)}` +
      `&limit=1`;

    const invRows = await apiFetch(`/app_invoices${qInv}`, { method:"GET" });
    const inv = Array.isArray(invRows) ? invRows[0] : null;
    if (!inv) throw new Error("لم يتم العثور على الفاتورة");

    // operations
    const qOps =
      `?select=label,operation,result,created_at` +
      `&invoice_id=eq.${encodeURIComponent(invoice_id)}` +
      `&order=created_at.asc`;

    const ops = await apiFetch(`/app_operations${qOps}`, { method:"GET" });
    return { inv, ops: Array.isArray(ops) ? ops : [] };
  }

  function render({ inv, ops }){
    $("invoiceId").textContent = inv.id || "—";
    $("username").textContent = inv.username || "—";
    $("customer").textContent = inv.customer_name || "—";
    $("date").textContent = fmtDT(inv.closed_at || inv.created_at);
    setStatusPill(inv.status || "open");

    $("subTitle").textContent = `رقم الفاتورة: ${inv.id} — ${fmtDT(inv.closed_at || inv.created_at)}`;

    const tbody = $("tbody");
    tbody.innerHTML = "";

    let total = 0;

    for (const row of ops){
      const tr = document.createElement("tr");

      const tdT = document.createElement("td");
      tdT.textContent = fmtDT(row.created_at);

      const tdL = document.createElement("td");
      tdL.textContent = (row.label || "عملية");

      const tdO = document.createElement("td");
      tdO.className = "num";
      tdO.textContent = (row.operation || "").toString();

      const tdR = document.createElement("td");
      tdR.className = "num";
      tdR.textContent = formatNumber(row.result);

      tr.append(tdT, tdL, tdO, tdR);
      tbody.appendChild(tr);

      const r = Number(row.result);
      if (Number.isFinite(r)) total += r;
    }

    $("grandTotal").textContent = formatNumber(total);
    $("hint").textContent = `عدد السطور: ${ops.length}`;
  }

  // Buttons
  $("printBtn").addEventListener("click", () => window.print());
  $("backBtn").addEventListener("click", () => history.length > 1 ? history.back() : location.href = "./admin.html?v=999");

  // Boot
  (async () => {
    const invoice_id = getInvoiceIdFromUrl();
    if (!invoice_id){
      setStatusPill("bad");
      $("statusPill").textContent = "خطأ";
      $("subTitle").textContent = "مفقود invoice_id في الرابط";
      $("hint").textContent = "افتح الرابط هكذا: invoice.html?v=999&invoice_id=XXXX";
      return;
    }

    try{
      const data = await loadInvoice(invoice_id);
      render(data);
    }catch(e){
      console.error(e);
      $("statusPill").textContent = "خطأ";
      $("statusPill").className = "pill bad";
      $("subTitle").textContent = "لم يتم تحميل الفاتورة";
      $("hint").textContent = e?.message || "حدث خطأ";
      toast($("hint").textContent);
    }
  })();
</script>
</body>
</html>
