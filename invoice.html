<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>HAYEK SPOT — فاتورة</title>

  <!-- ستايل موحّد -->
  <link rel="stylesheet" href="./style.css?v=999">

  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <!-- html2pdf (أفضل خيار للغة العربية لأنه يصوّر الصفحة) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* إضافات بسيطة خاصة بالصفحة */
    .page-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .kv{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .kv .badge{ font-weight:900; }
    .monoSmall{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; opacity:.9; }
    .empty{
      border:1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      padding: 14px;
      color: var(--muted);
      margin-top: 12px;
      line-height: 1.8;
    }
    @media print{
      body{ padding:0; background:#fff !important; }
      .topbar, .card.controls{ display:none !important; }
      .card{ box-shadow:none !important; border:none !important; }
      .print-area{ display:block !important; }
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="topbar">
      <div class="brand">
        <h1>فاتورة — HAYEK SPOT</h1>
        <div class="sub">عرض الفاتورة + طباعة / PDF</div>
      </div>

      <div class="page-actions">
        <div id="pill" class="pill closed">غير متصل</div>
        <a class="btn" href="./index.html?v=999">الرجوع</a>
      </div>
    </div>

    <!-- Controls -->
    <div class="card controls">
      <div class="hd">
        <h2>تحميل الفاتورة</h2>
        <div class="muted">يمكنك تمرير المعطيات من الرابط أو إدخالها هنا</div>
      </div>

      <div class="bd">
        <div class="row">
          <div class="field">
            <label>اسم المستخدم (username)</label>
            <input id="username" placeholder="مثال: محمود" />
          </div>

          <div class="field">
            <label>رقم الفاتورة (invoice_id)</label>
            <input id="invoiceId" placeholder="مثال: 550e8400-e29b-41d4-a716-446655440000" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn blue" id="btnLoad">تحميل</button>
          <button class="btn" id="btnCopyLink">نسخ رابط الفاتورة</button>
          <button class="btn green" id="btnPDF">تصدير PDF</button>
          <button class="btn" id="btnPrint">طباعة</button>
        </div>

        <div class="sep"></div>

        <div class="kv">
          <div class="badge" id="metaUser">المستخدم: —</div>
          <div class="badge" id="metaInv">الفاتورة: —</div>
          <div class="badge" id="metaDate">التاريخ: —</div>
          <div class="badge" id="metaTotal">المجموع: 0</div>
        </div>

        <div class="empty" id="hintBox">
          ✅ افتح الصفحة بهذا الشكل (مثال):<br>
          <span class="monoSmall">invoice.html?v=999&u=Mahmood&id=INVOICE_ID</span><br>
          أو اكتب القيم واضغط <b>تحميل</b>.
        </div>
      </div>
    </div>

    <!-- Invoice view -->
    <div class="card">
      <div class="hd">
        <h2>تفاصيل الفاتورة</h2>
        <div class="muted">العمليات ضمن نفس invoice_id</div>
      </div>

      <div class="bd">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:22%">الوقت</th>
                <th style="width:38%">البيان</th>
                <th style="width:20%">العملية</th>
                <th style="width:20%">النتيجة</th>
              </tr>
            </thead>
            <tbody id="opsTbody"></tbody>
          </table>
        </div>

        <!-- Printable area (يُستخدم للتصدير) -->
        <div id="printArea" class="print-area" style="display:none; margin-top:12px;">
          <h3 style="margin:0 0 10px 0;">فاتورة — HAYEK SPOT</h3>
          <div id="printMeta" style="font-size:12px; color:#333; margin-bottom:8px;"></div>
          <div id="printTotal" style="font-weight:900; margin-bottom:10px;"></div>
          <div id="printTable"></div>
        </div>
      </div>
    </div>

  </div>

<script>
/* =========================
   CONFIG
   ========================= */
const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
const SUPABASE_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";

/* =========================
   Helpers
   ========================= */
const $ = (id) => document.getElementById(id);

function vibrate(ms=15){ try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){} }

function setPill(ok, msg){
  const pill = $("pill");
  pill.textContent = msg || (ok ? "متصل" : "غير متصل");
  pill.classList.toggle("open", !!ok);
  pill.classList.toggle("closed", !ok);
}

function safeNum(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : 0;
}

function fmtDateTime(ts){
  try{
    const d = new Date(ts);
    return d.toLocaleString("ar-EG", { hour12:true });
  }catch(e){
    return String(ts || "");
  }
}

function getQS(){
  const p = new URLSearchParams(location.search);
  return {
    u: (p.get("u") || "").trim(),
    id: (p.get("id") || "").trim()
  };
}

function buildLink(username, invoiceId){
  const base = location.origin + location.pathname.replace(/\/[^\/]*$/, "/") + "invoice.html";
  return `${base}?v=999&u=${encodeURIComponent(username)}&id=${encodeURIComponent(invoiceId)}`;
}

async function copyText(txt){
  try{
    await navigator.clipboard.writeText(txt);
    alert("✅ تم النسخ");
  }catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    alert("✅ تم النسخ");
  }
}

/* =========================
   Supabase init
   ========================= */
let client = null;
(function init(){
  try{
    client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    setPill(true, "متصل");
  }catch(e){
    console.error(e);
    setPill(false, "غير متصل");
    alert("خطأ إعداد Supabase");
  }

  const qs = getQS();
  if(qs.u) $("username").value = qs.u;
  if(qs.id) $("invoiceId").value = qs.id;

  // تحميل تلقائي لو موجودين بالرابط
  if(qs.u && qs.id){
    loadInvoice();
  }
})();

/* =========================
   Main
   ========================= */
async function loadInvoice(){
  if(!client) return;

  const username = ($("username").value || "").trim();
  const invoiceId = ($("invoiceId").value || "").trim();

  $("hintBox").style.display = "none";
  $("opsTbody").innerHTML = "";

  if(!username || !invoiceId){
    $("hintBox").style.display = "block";
    $("hintBox").innerHTML = "⚠️ اكتب اسم المستخدم ورقم الفاتورة ثم اضغط <b>تحميل</b>.";
    return;
  }

  setPill(true, "جاري التحميل…");

  // 1) invoice meta
  let invRow = null;
  try{
    const { data, error } = await client
      .from("app_invoices")
      .select("id, username, total, created_at")
      .eq("id", invoiceId)
      .maybeSingle();

    if(error) throw error;
    invRow = data || null;
  }catch(e){
    console.warn("Invoice meta fetch:", e);
  }

  // 2) operations by invoice_id
  const { data: ops, error } = await client
    .from("app_operations")
    .select("created_at, statement, operation, result, invoice_id, username")
    .eq("username", username)
    .eq("invoice_id", invoiceId)
    .order("created_at", { ascending:true });

  if(error){
    console.error(error);
    setPill(false, "خطأ");
    alert("خطأ تحميل العمليات: " + error.message);
    return;
  }

  // Render table
  const rows = ops || [];
  if(rows.length === 0){
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 4;
    td.style.color = "var(--muted)";
    td.style.padding = "14px";
    td.textContent = "لا توجد عمليات ضمن هذه الفاتورة.";
    tr.appendChild(td);
    $("opsTbody").appendChild(tr);
  }else{
    rows.forEach(r=>{
      const tr = document.createElement("tr");

      const tdT = document.createElement("td");
      tdT.textContent = fmtDateTime(r.created_at);

      const tdS = document.createElement("td");
      tdS.textContent = r.statement || "";

      const tdO = document.createElement("td");
      tdO.textContent = r.operation || "";

      const tdR = document.createElement("td");
      tdR.textContent = (r.result === null || r.result === undefined) ? "" : String(r.result);

      tr.append(tdT, tdS, tdO, tdR);
      $("opsTbody").appendChild(tr);
    });
  }

  // Totals / meta
  const calcTotal = rows.reduce((s,r)=> s + safeNum(r.result), 0);
  const finalTotal = invRow ? safeNum(invRow.total) : calcTotal;
  const createdAt = invRow?.created_at || (rows[0]?.created_at || null);

  $("metaUser").textContent = "المستخدم: " + username;
  $("metaInv").textContent = "الفاتورة: " + invoiceId;
  $("metaDate").textContent = "التاريخ: " + (createdAt ? fmtDateTime(createdAt) : "—");
  $("metaTotal").textContent = "المجموع: " + finalTotal.toFixed(2);

  setPill(true, "جاهز");
  vibrate(20);
}

/* =========================
   PDF / Print
   ========================= */
function buildPrint(){
  const username = ($("username").value || "").trim();
  const invoiceId = ($("invoiceId").value || "").trim();

  const metaText = `المستخدم: ${username} | الفاتورة: ${invoiceId} | ${$("metaDate").textContent.replace("التاريخ:","").trim()}`;
  $("printMeta").textContent = metaText;
  $("printTotal").textContent = $("metaTotal").textContent;

  const htmlTable = `
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="text-align:right; padding:8px;">الوقت</th>
          <th style="text-align:right; padding:8px;">البيان</th>
          <th style="text-align:right; padding:8px;">العملية</th>
          <th style="text-align:right; padding:8px;">النتيجة</th>
        </tr>
      </thead>
      <tbody>
        ${Array.from($("opsTbody").querySelectorAll("tr")).map(tr=>{
          const tds = tr.querySelectorAll("td");
          if(tds.length < 4){
            return `<tr><td colspan="4" style="padding:10px; color:#666;">${(tds[0]?.textContent||"")}</td></tr>`;
          }
          return `<tr>
            <td style="padding:8px; border-bottom:1px solid #eee;">${tds[0]?.textContent||""}</td>
            <td style="padding:8px; border-bottom:1px solid #eee;">${tds[1]?.textContent||""}</td>
            <td style="padding:8px; border-bottom:1px solid #eee;">${tds[2]?.textContent||""}</td>
            <td style="padding:8px; border-bottom:1px solid #eee;">${tds[3]?.textContent||""}</td>
          </tr>`;
        }).join("")}
      </tbody>
    </table>
  `;
  $("printTable").innerHTML = htmlTable;

  $("printArea").style.display = "block";
}

async function exportPDF(){
  const username = ($("username").value || "user").trim() || "user";
  buildPrint();

  try{
    const opt = {
      margin: 10,
      filename: `invoice_${username}.pdf`,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
    };
    await html2pdf().set(opt).from($("printArea")).save();
  }catch(e){
    console.error(e);
    alert("فشل تصدير PDF. جرّب متصفح Chrome.");
  }finally{
    $("printArea").style.display = "none";
  }
}

/* =========================
   Events
   ========================= */
$("btnLoad").onclick = loadInvoice;

$("btnCopyLink").onclick = async () => {
  const username = ($("username").value || "").trim();
  const invoiceId = ($("invoiceId").value || "").trim();
  if(!username || !invoiceId){
    alert("اكتب اسم المستخدم ورقم الفاتورة أولاً");
    return;
  }
  await copyText(buildLink(username, invoiceId));
  vibrate(15);
};

$("btnPDF").onclick = exportPDF;

$("btnPrint").onclick = () => {
  buildPrint();
  window.print();
  // نخفي بعد الطباعة
  setTimeout(()=>{ $("printArea").style.display = "none"; }, 700);
};
</script>
</body>
</html>
