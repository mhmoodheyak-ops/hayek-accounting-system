<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>HAYEK — الفاتورة</title>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b0f14; --card:#121823; --txt:#e8eefc; --muted:#9aa7bd;
      --line:#243041; --btn:#1a2432; --btn2:#233044; --danger:#ff4d4d; --ok:#22c55e;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#070a0f 0%, #0b0f14 40%, #0b0f14 100%);
      color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      min-height:100vh; display:flex; justify-content:center; padding:16px;
    }
    .wrap{width:100%; max-width:900px;}
    .topbar{display:flex; justify-content:space-between; align-items:center; margin:8px 0 16px; gap:12px}
    .brand{display:flex; align-items:center; gap:10px}
    .dot{width:12px;height:12px;border-radius:50%; background:var(--ok); box-shadow:0 0 0 6px rgba(34,197,94,.15)}
    .title{font-weight:800}
    .sub{color:var(--muted); font-size:13px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(36,48,65,.85);
      color:var(--muted); font-size:12px;
      white-space:nowrap;
    }

    .card{
      background:rgba(18,24,35,.92);
      border:1px solid rgba(36,48,65,.7);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(8px);
      margin-bottom:14px;
    }
    h2{margin:0 0 10px; font-size:16px}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
    input, select, textarea{
      width:100%; padding:12px 12px;
      border-radius:12px; border:1px solid rgba(36,48,65,.85);
      background:#0e141e; color:var(--txt);
      outline:none;
    }
    textarea{min-height:44px; resize:vertical}
    .row{display:flex; gap:10px; align-items:center}
    .row > *{flex:1}
    .btn{
      border:1px solid rgba(36,48,65,.85);
      background:var(--btn);
      color:var(--txt);
      padding:11px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      transition:.15s;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); background:var(--btn2)}
    .btn.primary{background:#1d4ed8; border-color:#1d4ed8}
    .btn.primary:hover{background:#2563eb}
    .btn.danger{background:#3a1414; border-color:#5a1f1f; color:#ffd4d4}
    .btn.danger:hover{background:#4a1818}
    .btn.big{width:100%; padding:14px 12px; border-radius:14px}
    .sep{height:1px; background:rgba(36,48,65,.7); margin:12px 0}
    .hint{color:var(--muted); font-size:12px; line-height:1.6}
    .error{
      color:#ffd0d0; background:rgba(255,77,77,.08);
      border:1px solid rgba(255,77,77,.25);
      padding:10px; border-radius:12px; margin-top:10px; display:none;
      white-space:pre-wrap;
    }
    .okbox{
      color:#c9ffe0; background:rgba(34,197,94,.08);
      border:1px solid rgba(34,197,94,.25);
      padding:10px; border-radius:12px; margin-top:10px; display:none;
      white-space:pre-wrap;
    }

    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px}
    th,td{border-bottom:1px solid rgba(36,48,65,.7); padding:10px; text-align:right; font-size:13px}
    th{color:var(--muted); background:rgba(10,14,20,.55)}
    tr:last-child td{border-bottom:0}
    .kpi{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .kpi b{font-size:18px}
    .hide{display:none !important;}

    #printArea{
      background:#ffffff;
      color:#111827;
      border-radius:16px;
      padding:16px;
    }
    #printArea h3{margin:0 0 8px; font-size:18px}
    #printArea .pmuted{color:#6b7280; font-size:12px}
    #printArea table th{background:#f3f4f6; color:#111827}
    #printArea table td, #printArea table th{border-bottom:1px solid #e5e7eb}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">HAYEK — نظام الفاتورة</div>
          <div class="sub" id="subTitle">تسجيل دخول المستخدم</div>
        </div>
      </div>
      <div class="pill" id="sessionPill"><b>غير مسجل</b></div>
    </div>

    <div class="card" id="loginCard">
      <h2>تسجيل دخول</h2>
      <div class="hint">ادخل اسم المستخدم وكلمة السر (من الأدمن).</div>
      <label>اسم المستخدم</label>
      <input id="loginUser" autocomplete="username" />
      <label>كلمة السر</label>
      <input id="loginPass" type="password" autocomplete="current-password" />
      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnLogin">دخول</button>
        <button class="btn" id="btnClear">تفريغ</button>
      </div>
      <div class="error" id="loginErr"></div>
    </div>

    <div class="card hide" id="appCard">
      <div class="row" style="align-items:flex-start">
        <div style="flex:1">
          <h2 style="margin-bottom:6px">إنشاء فاتورة</h2>
          <div class="hint">أضف عمليات، ثم أغلق الفاتورة أو صدّر PDF.</div>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end">
          <button class="btn danger" id="btnLogout">خروج</button>
        </div>
      </div>

      <div class="sep"></div>

      <label>اسم الزبون</label>
      <input id="customerName" placeholder="مثال: أبو أحمد" />

      <div class="row">
        <div>
          <label>نص العملية</label>
          <input id="lineText" placeholder="مثال: أجرة تركيب" />
        </div>
        <div>
          <label>العملية</label>
          <select id="op">
            <option value="+">جمع +</option>
            <option value="-">طرح -</option>
            <option value="*">ضرب ×</option>
            <option value="/">قسمة ÷</option>
          </select>
        </div>
        <div>
          <label>الرقم</label>
          <input id="amount" type="number" inputmode="decimal" placeholder="0" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnAddLine">إضافة للسجل</button>
        <button class="btn" id="btnNewInvoice">فاتورة جديدة</button>
      </div>

      <div class="sep"></div>

      <div class="kpi">
        <div class="hint">عدد العمليات: <b id="linesCount">0</b></div>
        <div>المجموع: <b id="total">0</b></div>
      </div>

      <div style="margin-top:12px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>النص</th>
              <th>العملية</th>
              <th>الرقم</th>
              <th>النتيجة</th>
              <th>حذف</th>
            </tr>
          </thead>
          <tbody id="linesTbody"></tbody>
        </table>
      </div>

      <div class="sep"></div>

      <button class="btn big primary" id="btnExport">تصدير PDF</button>
      <button class="btn big" id="btnClose" style="margin-top:10px">إغلاق الفاتورة (حفظ نهائي)</button>

      <div class="error" id="appErr"></div>
      <div class="okbox" id="appOk"></div>
    </div>

    <div class="hide" id="printArea"></div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ✅ مفاتيحك الصحيحة
    const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0aWR3cXZ5cmp5ZG1lZ2p6dXZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0MTAyNzQsImV4cCI6MjA4NTk4NjI3NH0.N1X39yfO6CLYu8UpbZsmlkIUELN_mmAzxUCQBCV7O8g";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id)=>document.getElementById(id);

    const loginCard = el("loginCard");
    const appCard   = el("appCard");
    const loginErr  = el("loginErr");
    const appErr    = el("appErr");
    const appOk     = el("appOk");
    const sessionPill = el("sessionPill");
    const subTitle  = el("subTitle");

    let USER = null;
    let invoiceId = null;
    let lines = [];
    let running = 0;

    function showErr(box, msg){ box.style.display="block"; box.textContent=msg; }
    function clearErr(box){ box.style.display="none"; box.textContent=""; }
    function showOk(msg){ appOk.style.display="block"; appOk.textContent=msg; setTimeout(()=>appOk.style.display="none", 1800); }

    function setSessionPill(){
      if(!USER){ sessionPill.innerHTML="<b>غير مسجل</b>"; return; }
      sessionPill.innerHTML = `<b>${USER.username}</b>`;
    }

    function fmtOp(op){
      if(op==="+") return "+";
      if(op==="-") return "-";
      if(op==="*") return "×";
      if(op==="/") return "÷";
      return op;
    }

    function recalc(){
      running = 0;
      for(const l of lines){
        const n = Number(l.amount||0);
        if(l.op==="+") running = running + n;
        else if(l.op==="-") running = running - n;
        else if(l.op==="*") running = running * n;
        else if(l.op==="/") running = n===0 ? running : (running / n);
        l.result = running;
      }
      el("total").textContent = Number.isFinite(running) ? (Math.round(running*100)/100) : "0";
      el("linesCount").textContent = String(lines.length);
    }

    function renderLines(){
      const tb = el("linesTbody");
      tb.innerHTML = "";
      lines.forEach((l, idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${l.text||""}</td>
          <td>${fmtOp(l.op)}</td>
          <td>${l.amount}</td>
          <td>${(Math.round((l.result||0)*100)/100)}</td>
          <td><button class="btn danger" data-i="${idx}" style="padding:6px 10px;border-radius:10px;font-size:12px">حذف</button></td>
        `;
        tb.appendChild(tr);
      });
      tb.querySelectorAll("button[data-i]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const i = Number(b.dataset.i);
          lines.splice(i,1);
          recalc();
          renderLines();
          autoSave();
        });
      });
    }

    async function login(){
      clearErr(loginErr);
      const username = el("loginUser").value.trim();
      const password = el("loginPass").value.trim();
      if(!username || !password){
        showErr(loginErr, "اكتب اسم المستخدم وكلمة السر.");
        return;
      }

      const { data, error } = await supabase
        .from("app_users")
        .select("*")
        .eq("username", username)
        .limit(1);

      if(error){
        showErr(loginErr, "خطأ Supabase:\n" + (error.message || JSON.stringify(error)));
        return;
      }
      if(!data?.length){
        showErr(loginErr, "المستخدم غير موجود.");
        return;
      }

      const u = data[0];
      if(u.password !== password){
        showErr(loginErr, "كلمة السر غير صحيحة.");
        return;
      }
      if(u.is_blocked){
        showErr(loginErr, "هذا الحساب محظور.");
        return;
      }

      USER = u;
      localStorage.setItem("HAYEK_USER_SESSION", JSON.stringify({ id:u.id, username:u.username }));
      loginCard.classList.add("hide");
      appCard.classList.remove("hide");
      subTitle.textContent = "فاتورة المستخدم";
      setSessionPill();
      await newInvoice();
    }

    function logout(){
      USER = null;
      localStorage.removeItem("HAYEK_USER_SESSION");
      appCard.classList.add("hide");
      loginCard.classList.remove("hide");
      subTitle.textContent = "تسجيل دخول المستخدم";
      setSessionPill();
    }

    async function restoreSession(){
      try{
        const s = JSON.parse(localStorage.getItem("HAYEK_USER_SESSION") || "null");
        if(!s?.id) return;
        const { data } = await supabase.from("app_users").select("*").eq("id", s.id).limit(1);
        if(data?.length && !data[0].is_blocked){
          USER = data[0];
          loginCard.classList.add("hide");
          appCard.classList.remove("hide");
          subTitle.textContent = "فاتورة المستخدم";
          setSessionPill();
          await newInvoice();
        }
      }catch{}
    }

    async function newInvoice(){
      clearErr(appErr);
      lines = [];
      running = 0;
      invoiceId = null;
      el("customerName").value = "";
      el("lineText").value = "";
      el("amount").value = "";
      el("op").value = "+";
      recalc();
      renderLines();
      showOk("فاتورة جديدة ✅");
    }

    async function ensureInvoice(){
      const customer = el("customerName").value.trim();
      if(!customer){
        showErr(appErr, "اكتب اسم الزبون أولاً.");
        return false;
      }

      if(invoiceId) return true;

      const payload = {
        user_id: USER.id,
        customer_name: customer,
        lines: [],
        total: 0,
        status: "open"
      };

      const { data, error } = await supabase
        .from("app_invoices")
        .insert(payload)
        .select("*")
        .limit(1);

      if(error){
        showErr(appErr, "فشل إنشاء الفاتورة:\n" + (error.message || JSON.stringify(error)));
        return false;
      }

      invoiceId = data[0].id;
      return true;
    }

    async function autoSave(){
      if(!invoiceId) return;
      const customer = el("customerName").value.trim();
      const total = Number(el("total").textContent) || 0;

      const { error } = await supabase
        .from("app_invoices")
        .update({ customer_name: customer, lines: lines, total: total })
        .eq("id", invoiceId);

      if(error){
        showErr(appErr, "حصل خطأ بالحفظ:\n" + (error.message || JSON.stringify(error)));
      }else{
        clearErr(appErr);
      }
    }

    async function addLine(){
      clearErr(appErr);

      const ok = await ensureInvoice();
      if(!ok) return;

      const text = el("lineText").value.trim();
      const op = el("op").value;
      const amount = Number(el("amount").value);

      if(!text){
        showErr(appErr, "اكتب نص العملية.");
        return;
      }
      if(!Number.isFinite(amount)){
        showErr(appErr, "اكتب رقم صحيح.");
        return;
      }

      lines.push({ text, op, amount, result: 0, at: new Date().toISOString() });
      recalc();
      renderLines();

      el("lineText").value = "";
      el("amount").value = "";
      el("op").value = "+";

      await autoSave();
      if(navigator.vibrate) navigator.vibrate(20);
    }

    async function closeInvoice(){
      clearErr(appErr);
      const ok = await ensureInvoice();
      if(!ok) return;

      await autoSave();
      const { error } = await supabase.from("app_invoices").update({ status:"closed" }).eq("id", invoiceId);
      if(error){
        showErr(appErr, "فشل إغلاق الفاتورة:\n" + (error.message || JSON.stringify(error)));
        return;
      }
      showOk("تم إغلاق الفاتورة ✅");
    }

    function buildPrintArea(){
      const customer = el("customerName").value.trim() || "بدون اسم";
      const total = el("total").textContent;

      const pa = el("printArea");
      const rows = lines.map((l,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${l.text||""}</td>
          <td>${fmtOp(l.op)}</td>
          <td>${l.amount}</td>
          <td>${Math.round((l.result||0)*100)/100}</td>
        </tr>
      `).join("");

      pa.innerHTML = `
        <h3>فاتورة — HAYEK</h3>
        <div class="pmuted">الزبون: <b>${customer}</b></div>
        <div class="pmuted">التاريخ: ${new Date().toLocaleString()}</div>
        <div style="height:10px"></div>

        <table style="width:100%; border-collapse:collapse">
          <thead>
            <tr>
              <th style="padding:8px; text-align:right">#</th>
              <th style="padding:8px; text-align:right">العملية</th>
              <th style="padding:8px; text-align:right">الرمز</th>
              <th style="padding:8px; text-align:right">الرقم</th>
              <th style="padding:8px; text-align:right">النتيجة</th>
            </tr>
          </thead>
          <tbody>${rows || `<tr><td colspan="5" style="padding:10px; color:#6b7280">لا يوجد عمليات</td></tr>`}</tbody>
        </table>

        <div style="height:12px"></div>
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center">
          <div class="pmuted">عدد العمليات: <b>${lines.length}</b></div>
          <div style="font-size:18px">المجموع: <b>${total}</b></div>
        </div>
        <div style="margin-top:10px; font-size:11px; color:#6b7280">
          تم تطوير الحاسبة من قبل الحايك للحلول الرقمية
        </div>
      `;
      pa.classList.remove("hide");
      return pa;
    }

    async function exportPDF(){
      clearErr(appErr);
      const ok = await ensureInvoice();
      if(!ok) return;

      await autoSave();

      const pa = buildPrintArea();
      const canvas = await html2canvas(pa, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
      const imgData = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const imgW = pageW;
      const imgH = canvas.height * (imgW / canvas.width);

      if(imgH <= pageH){
        pdf.addImage(imgData, "PNG", 0, 0, imgW, imgH);
      }else{
        let remaining = imgH;
        let position = 0;
        while(remaining > 0){
          pdf.addImage(imgData, "PNG", 0, position, imgW, imgH);
          remaining -= pageH;
          if(remaining > 0){
            pdf.addPage();
            position -= pageH;
          }
        }
      }

      pa.classList.add("hide");
      const name = (el("customerName").value.trim() || "invoice") + ".pdf";
      pdf.save(name);
      showOk("تم تنزيل PDF ✅");
    }

    el("btnLogin").addEventListener("click", login);
    el("btnClear").addEventListener("click", ()=>{ el("loginUser").value=""; el("loginPass").value=""; clearErr(loginErr); });
    el("btnLogout").addEventListener("click", logout);

    el("btnAddLine").addEventListener("click", addLine);
    el("btnNewInvoice").addEventListener("click", newInvoice);
    el("btnClose").addEventListener("click", closeInvoice);
    el("btnExport").addEventListener("click", exportPDF);

    el("customerName").addEventListener("input", ()=>{
      if(invoiceId) autoSave();
    });

    restoreSession();
    setSessionPill();
  </script>
</body>
</html>
