<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HAYEK SPOT — الحاسبة</title>

  <style>
    :root{--bg:#0b1f2a;--card:#122b3a;--muted:#9fb6c6;--accent:#1e90ff}
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Tahoma,Arial}
    body{margin:0;min-height:100vh;background:linear-gradient(135deg,#0b1f2a,#0f3a3f);color:#fff}
    .app{max-width:900px;margin:34px auto;padding:18px}
    .card{background:rgba(18,43,58,.92);border:1px solid rgba(255,255,255,.06);border-radius:20px;padding:18px;box-shadow:0 22px 70px rgba(0,0,0,.38)}
    h1{margin:0 0 12px;font-size:26px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.06);color:#d9eefc;font-size:12px}
    .dot{width:10px;height:10px;border-radius:999px;background:#49e39a;box-shadow:0 0 0 6px rgba(73,227,154,.12)}
    label{font-size:13px;color:var(--muted)}
    input{width:100%;padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.18);color:#fff;margin:6px 0 14px;font-size:16px;outline:none}
    input[readonly]{background:rgba(0,0,0,.28);color:#bfffe0}
    .calc{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:6px}
    .calc button{padding:18px;font-size:18px;border-radius:14px;border:none;background:#17394b;color:#fff}
    .calc button.op{background:#1f4f6b}
    .calc button.eq{background:var(--accent)}
    .actions{display:flex;gap:10px;margin-top:14px}
    .actions button{flex:1;padding:14px;border-radius:14px;border:none;font-size:15px;cursor:pointer}
    .pdf{background:var(--accent);color:#fff}
    .wa{background:#25d366;color:#051b10}
    .table{width:100%;border-collapse:collapse;margin-top:12px}
    .table th,.table td{border-bottom:1px dashed rgba(120,170,190,.35);padding:8px;font-size:14px}
    .total{margin-top:12px;border:2px dashed rgba(120,170,190,.35);padding:12px;border-radius:12px;font-size:18px;display:flex;justify-content:space-between;align-items:center}
    .footer{text-align:center;margin-top:10px;font-size:12px;color:#9bb}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);display:flex;align-items:center;justify-content:center;z-index:999}
    .overlay.hidden{display:none}
    .overlay .box{background:#0f1e26;padding:20px 18px;border-radius:16px;border:1px solid rgba(255,255,255,.08);max-width:360px;text-align:center}
    .overlay .box button{margin-top:10px;background:var(--accent);color:#fff;border:none;border-radius:12px;padding:12px 14px;cursor:pointer}
  </style>

  <script src="config.js?v=1"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="auth.js?v=1"></script>

  <!-- PDF libs (محلية عندك) -->
  <script src="jspdf.umd.min.js"></script>
  <script src="jspdf.plugin.autotable.min.js"></script>
  <script src="amiri-font.js"></script>
</head>

<body>
  <!-- Gate -->
  <div id="lock" class="overlay hidden">
    <div class="box">
      <h3 style="margin:0 0 8px">تسجيل الدخول مطلوب</h3>
      <div style="color:#b9d4e2;font-size:13px">غير مسموح تصفح الصفحة بدون دخول.</div>
      <button id="goLogin">الذهاب لتسجيل الدخول</button>
    </div>
  </div>

  <div class="app">
    <div class="card">
      <div class="topbar">
        <div class="pill"><span class="dot" id="onlineDot"></span><span id="userPill">—</span></div>
        <div class="pill" id="invPill">—</div>
        <div class="pill" style="cursor:pointer" id="logoutBtn">خروج</div>
      </div>

      <h1>حاسبة الحايك</h1>

      <label>اسم الزبون (إجباري)</label>
      <input id="customer" placeholder="مثال: أبو إبراهيم">

      <label>نص السطر (اختياري)</label>
      <input id="textNote" placeholder="مثال: محارم / رز / مصروف...">

      <label>العملية الحسابية (من أزرار الشاشة)</label>
      <input id="expr" readonly placeholder="5+5">

      <div class="calc" id="pad">
        <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button><button class="op" data-k="/">÷</button>
        <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button><button class="op" data-k="*">×</button>
        <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button><button class="op" data-k="-">−</button>
        <button data-k="C" class="op">C</button><button data-k="0">0</button><button data-k="=" class="eq">=</button><button class="op" data-k="+">+</button>
      </div>

      <table class="table">
        <thead>
          <tr><th>الوقت</th><th>البيان</th><th>العملية</th><th>النتيجة</th></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>

      <div class="total">
        <span>إجمالي الكشف:</span>
        <strong id="sum">0</strong>
      </div>

      <div class="actions">
        <button class="pdf" id="pdfBtn">تصدير PDF</button>
        <button class="wa" id="waBtn">إرسال واتساب (PDF)</button>
      </div>

      <div class="footer">تم تطوير هذه الحاسبة الاحترافية من قبل شركة الحايك — 05510217646</div>
    </div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);

  // ===== Gate =====
  const lock = $("lock");
  const goLogin = $("goLogin");

  function hardLock(){
    lock.classList.remove("hidden");
  }

  if (!window.__HAYEK_AUTH_LOADED__ || !window.HAYEK_AUTH || !window.HAYEK_AUTH.isAuthed()) {
    hardLock();
    goLogin.onclick = () => location.href = "index.html?v=" + Date.now();
    return;
  }

  const session = window.HAYEK_AUTH.getUser() || {};
  $("userPill").textContent = "المستخدم: " + (session.username || "—");

  // ===== Online dot =====
  const onlineDot = $("onlineDot");
  function refreshOnline(){
    const on = navigator.onLine;
    onlineDot.style.background = on ? "#49e39a" : "#ff8080";
    onlineDot.style.boxShadow = on ? "0 0 0 6px rgba(73,227,154,.12)" : "0 0 0 6px rgba(255,128,128,.12)";
  }
  window.addEventListener("online", refreshOnline);
  window.addEventListener("offline", refreshOnline);
  refreshOnline();

  // ===== Invoice state (local only) =====
  const LS = "HAYEK_SIMPLE_INV_V1";
  let inv = { id: crypto.randomUUID(), customer:"", rows:[], total:0, createdAt: new Date().toISOString() };

  function load(){
    try{
      const x = JSON.parse(localStorage.getItem(LS) || "null");
      if (x && x.id) inv = x;
    }catch{}
  }
  function save(){ localStorage.setItem(LS, JSON.stringify(inv)); }
  load();

  function shortId(){ return String(inv.id).slice(-6); }

  function renderMeta(){
    const cust = ($("customer").value || "").trim();
    $("invPill").textContent = cust ? ("فاتورة: " + shortId()) : "—";
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function renderTable(){
    $("rows").innerHTML = inv.rows.map(r => `
      <tr>
        <td>${escapeHtml(r.time)}</td>
        <td>${escapeHtml(r.note || "—")}</td>
        <td>${escapeHtml(r.expr)}</td>
        <td>${escapeHtml(String(r.result))}</td>
      </tr>
    `).join("");
    $("sum").textContent = inv.total;
  }

  function nowTime(){
    const d=new Date();
    return String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
  }

  function safeEval(expr){
    const cleaned = (expr||"").replace(/\s+/g,"");
    if (!/^[0-9+\-*/().]+$/.test(cleaned)) throw new Error("bad");
    // eslint-disable-next-line no-new-func
    const val = Function('"use strict";return ('+cleaned+')')();
    const n = Number(val);
    if (!Number.isFinite(n)) throw new Error("nan");
    return n;
  }

  function setExpr(v){ $("expr").value = v; }
  function append(k){ setExpr(($("expr").value || "") + k); }

  $("pad").addEventListener("click",(e)=>{
    const b=e.target.closest("button"); if(!b) return;
    const k=b.getAttribute("data-k");
    if (navigator.vibrate) try{ navigator.vibrate(12);}catch{}
    if (k==="C"){ setExpr(""); return; }
    if (k==="="){ commit(); return; }
    append(k);
  });

  $("customer").addEventListener("input", ()=>{
    const cust = ($("customer").value||"").trim();
    inv.customer = cust;
    save(); renderMeta();
  });

  function commit(){
    const cust = ($("customer").value||"").trim();
    if (!cust){ $("customer").focus(); return; }

    const expr = ($("expr").value||"").trim();
    if (!expr) return;

    let res;
    try{ res = safeEval(expr); }catch{ return; }

    const note = ($("textNote").value||"").trim();
    inv.customer = cust;
    inv.rows.push({ time: nowTime(), note, expr, result: res });
    inv.total = inv.rows.reduce((a,r)=>a+Number(r.result||0),0);
    save();

    $("expr").value="";
    $("textNote").value="";
    renderMeta();
    renderTable();
  }

  renderMeta();
  renderTable();

  $("logoutBtn").onclick = ()=>{
    window.HAYEK_AUTH.logout();
    location.href="index.html?v="+Date.now();
  };

  // ===== PDF (Arabic + autoTable) =====
  function ensureAmiri(doc){
    try{
      // amiri-font.js لازم يعرّف window.AMIRI_TTF_BASE64 (أو مشابه)
      // إذا ملفك اسمه مختلف داخلياً، عدّل السطرين الجايين حسب المتغير الموجود عندك
      const b64 = window.AMIRI_TTF_BASE64 || window.AMIRI_FONT_BASE64;
      if (!b64) return false;
      doc.addFileToVFS("Amiri-Regular.ttf", b64);
      doc.addFont("Amiri-Regular.ttf", "Amiri", "normal");
      doc.setFont("Amiri", "normal");
      return true;
    }catch{
      return false;
    }
  }

  function buildPdf(invSnap){
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) throw new Error("jsPDF missing");
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    // Arabic font (best effort)
    const hasAmiri = ensureAmiri(doc);
    if (!hasAmiri) doc.setFont("helvetica","normal");

    const phone = "05510217646";

    const head = [
      [{ content:"الوقت", styles:{halign:"right"} },
       { content:"البيان", styles:{halign:"right"} },
       { content:"العملية", styles:{halign:"right"} },
       { content:"النتيجة", styles:{halign:"right"} }]
    ];

    const body = (invSnap.rows||[]).map(r => ([
      String(r.time||""),
      String(r.note||"—"),
      String(r.expr||""),
      String(r.result??"")
    ]));

    doc.setFontSize(16);
    doc.text("شركة الحايك", 520, 58, { align:"right" });
    doc.setFontSize(14);
    doc.text("HAYEK SPOT", 520, 78, { align:"right" });

    doc.setFontSize(12);
    doc.text(("الزبون: " + (invSnap.customer||"—")), 520, 110, { align:"right" });
    doc.text(("رقم: " + String(invSnap.id).slice(-6)), 520, 128, { align:"right" });
    doc.text(("التاريخ: " + new Date().toLocaleString()), 520, 146, { align:"right" });

    doc.autoTable({
      startY: 170,
      head,
      body,
      theme: "grid",
      styles: { font: hasAmiri ? "Amiri" : "helvetica", fontSize: 10, cellPadding: 6, halign:"right" },
      headStyles: { fillColor: [240,240,240], textColor: [0,0,0], halign:"right" },
      columnStyles: { 0:{cellWidth:90}, 1:{cellWidth:200}, 2:{cellWidth:150}, 3:{cellWidth:80} },
      margin: { left: 52, right: 52 },
      didDrawPage: (data) => {
        const page = doc.internal.getNumberOfPages();
        const h = doc.internal.pageSize.getHeight();
        doc.setFontSize(10);
        doc.text(("إجمالي: " + (invSnap.total||0)), 520, h - 64, { align:"right" });
        doc.text(("تم تطوير هذه الحاسبة الاحترافية من قبل شركة الحايك — " + phone), 300, h - 44, { align:"center" });
        doc.text(("صفحة " + page), 60, h - 44, { align:"left" });
      }
    });

    return doc;
  }

  function snapshotAndReset(){
    const cust = ($("customer").value||"").trim();
    if (!cust) { $("customer").focus(); return null; }
    if (!inv.rows.length) return null;

    const snap = JSON.parse(JSON.stringify(inv)); // deep copy
    // reset for next invoice
    inv = { id: crypto.randomUUID(), customer:"", rows:[], total:0, createdAt: new Date().toISOString() };
    localStorage.setItem(LS, JSON.stringify(inv));
    $("customer").value="";
    $("textNote").value="";
    $("expr").value="";
    renderMeta(); renderTable();
    return snap;
  }

  $("pdfBtn").onclick = ()=>{
    const snap = snapshotAndReset();
    if (!snap) return;
    const doc = buildPdf(snap);
    doc.save(("HAYEK_"+(snap.customer||"invoice").replace(/\s+/g,"_")+"_"+String(snap.id).slice(-6)+".pdf"));
  };

  $("waBtn").onclick = async ()=>{
    const snap = snapshotAndReset();
    if (!snap) return;

    const doc = buildPdf(snap);
    const blob = doc.output("blob");
    const file = new File([blob], ("HAYEK_"+String(snap.id).slice(-6)+".pdf"), { type:"application/pdf" });

    // أفضل خيار على الهاتف: إرسال ملف مباشرة
    try{
      if (navigator.share && navigator.canShare && navigator.canShare({ files:[file] })) {
        await navigator.share({ files:[file], title:"فاتورة", text:"فاتورة HAYEK SPOT" });
        return;
      }
    }catch{}

    // fallback: افتح واتساب (ثم المستخدم يرفق الملف يدوي)
    window.open("https://wa.me/?text=" + encodeURIComponent("فاتورة HAYEK SPOT جاهزة (PDF)."), "_blank");
    // (الملف تم تنزيله تلقائياً؟ لا. لذلك الأفضل يضغط تصدير PDF ثم يرسله)
    // إذا تريد: أعمل خيار "تصدير ثم فتح واتساب" خبرني.
  };
})();
</script>
</body>
</html>
