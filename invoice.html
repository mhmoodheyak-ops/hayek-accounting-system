<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>HAYEK SPOT — صفحة المستخدم (فواتير)</title>

  <!-- CSS -->
  <link rel="stylesheet" href="style.css?v=1000">

  <!-- Supabase (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>

  <!-- html2pdf (PDF يحافظ على العربية + صفحات متعددة) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
  <div class="container">

    <div class="topbar">
      <div class="brand">
        <h1>HAYEK SPOT — صفحة المستخدم</h1>
        <div class="sub">تسجيل بسيط → اسم مشتري (إجباري) → آلة حاسبة → إنهاء الفاتورة (إجباري) → حفظ + PDF</div>
      </div>
      <div class="right">
        <div id="pill" class="pill closed">مغلق</div>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <div class="hd">
        <h2>تسجيل المستخدم</h2>
        <div class="muted">اسم + كلمة سر فقط</div>
      </div>
      <div class="bd">
        <div class="row">
          <div class="field">
            <label>اسم المستخدم</label>
            <input id="loginUser" placeholder="مثال: محمود" autocomplete="username" />
          </div>
          <div class="field">
            <label>كلمة السر</label>
            <input id="loginPass" placeholder="******" type="password" autocomplete="current-password" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn green block" id="btnLogin">دخول</button>
        </div>

        <div class="notice" style="margin-top:10px">
          <div class="warn">⚠ إذا ظهرت رسالة “مغلق” بالأعلى: تأكد من مفاتيح Supabase.</div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appWrap" class="hidden">

      <!-- Invoice start -->
      <div class="card" style="margin-top:14px">
        <div class="hd">
          <h2>بدء فاتورة جديدة</h2>
          <div class="row" style="gap:8px">
            <span class="badge" id="whoBadge">—</span>
            <span class="badge" id="invBadge">لا يوجد فاتورة مفتوحة</span>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div class="field">
              <label>اسم المشتري (إجباري)</label>
              <input id="buyerName" placeholder="اكتب اسم المشتري..." />
            </div>
            <div class="field" style="flex:0 0 220px">
              <label>&nbsp;</label>
              <button class="btn blue block" id="btnStartInvoice">ابدأ الفاتورة</button>
            </div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button class="btn red" id="btnCloseInvoice" disabled>إنهاء الفاتورة (حفظ)</button>
            <button class="btn gray" id="btnCopyTable" disabled>نسخ الجدول</button>
            <button class="btn yellow" id="btnMakePdf" disabled>تصدير PDF</button>
          </div>

          <div class="notice" style="margin-top:10px">
            <div class="ok">✓ الفاتورة تُحفظ تلقائياً على النت حتى يشاهدها الأدمن عند الطلب.</div>
            <div class="muted">ملاحظة: “بيان/ملاحظة” داخل السطر اختياري.</div>
          </div>
        </div>
      </div>

      <!-- Calculator + Table -->
      <div class="calcWrap" style="margin-top:14px">
        <div class="card">
          <div class="hd">
            <h2>الآلة الحاسبة</h2>
            <div class="muted">كل ضغط (=) ينشئ سطر جديد بالفاتورة</div>
          </div>

          <div class="bd">
            <div class="row">
              <div class="field" style="flex:1 1 100%">
                <label>بيان / ملاحظة لهذا السطر (اختياري)</label>
                <input id="lineNote" placeholder="مثال: أجرة نقل / خصم / كمية..." />
              </div>
            </div>

            <div class="display" style="margin-top:10px">
              <div class="expr" id="expr">0</div>
              <div class="mini" id="mini">جاهز…</div>
            </div>

            <div class="keypad" style="margin-top:10px" id="keypad">
              <div class="key dng" data-k="C">C</div>
              <div class="key" data-k="(">(</div>
              <div class="key" data-k=")">)</div>
              <div class="key op" data-k="⌫">⌫</div>

              <div class="key" data-k="7">7</div>
              <div class="key" data-k="8">8</div>
              <div class="key" data-k="9">9</div>
              <div class="key op" data-k="÷">÷</div>

              <div class="key" data-k="4">4</div>
              <div class="key" data-k="5">5</div>
              <div class="key" data-k="6">6</div>
              <div class="key op" data-k="×">×</div>

              <div class="key" data-k="1">1</div>
              <div class="key" data-k="2">2</div>
              <div class="key" data-k="3">3</div>
              <div class="key op" data-k="-">-</div>

              <div class="key" data-k="0">0</div>
              <div class="key" data-k=".">.</div>
              <div class="key op" data-k="+">+</div>
              <div class="key ok" data-k="=">=</div>

              <div class="key wide" data-k="CLRLINE">مسح البيان</div>
              <div class="key wide" data-k="NEG">+/-</div>
            </div>

            <div class="notice" style="margin-top:10px">
              <div class="muted">⚠ لن تعمل الحاسبة قبل “ابدأ الفاتورة”.</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="hd">
            <h2>عمليات الفاتورة</h2>
            <div class="row" style="gap:8px">
              <span class="badge" id="totalBadge">الإجمالي: 0</span>
              <span class="badge" id="rowsBadge">السطور: 0</span>
            </div>
          </div>
          <div class="bd">
            <table>
              <thead>
                <tr>
                  <th style="width:22%">الوقت</th>
                  <th style="width:38%">البيان (اختياري)</th>
                  <th style="width:20%">العملية</th>
                  <th style="width:20%">النتيجة</th>
                </tr>
              </thead>
              <tbody id="opsBody"></tbody>
            </table>

            <div class="notice" style="margin-top:10px">
              <div class="ok">✓ يتم حفظ كل سطر مباشرة على النت.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- PRINT AREA (Hidden) -->
      <div id="printArea">
        <h2 style="text-align:center; margin:0 0 8px 0;">فاتورة — HAYEK SPOT</h2>
        <div class="meta" id="printMeta"></div>
        <div style="font-weight:900; margin-bottom:10px" id="printTotal"></div>
        <div id="printTable"></div>
        <div class="meta" style="margin-top:10px; text-align:center;">
          تم تطوير الحاسبة من قبل الحايك للحلول الرقمية
        </div>
      </div>

    </div><!-- /appWrap -->
  </div><!-- /container -->

<script>
/* =======================
   CONFIG (لا تغيّر إلا إذا تغيّرت بياناتك)
   ======================= */
const SUPABASE_URL = "https://itidwqvyrjydmegjzuvn.supabase.co";
const SUPABASE_KEY = "sb_publishable_j4ubD1htJvuMvOWUKC9w7g_mwVQzHb_";

/* =======================
   Helpers
   ======================= */
const $ = (id) => document.getElementById(id);

function vibrate(ms=18){
  try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(e){}
}
function setPill(ok, msg){
  const pill = $("pill");
  pill.classList.toggle("open", !!ok);
  pill.classList.toggle("closed", !ok);
  pill.textContent = msg || (ok ? "مفتوح" : "مغلق");
}
function fmtDateTime(ts){
  try{
    const d = new Date(ts);
    return d.toLocaleString("ar-EG", { hour12:true });
  }catch(e){
    return String(ts || "");
  }
}
function nowISO(){
  return new Date().toISOString();
}
function safeNum(x){
  const n = Number(x);
  return Number.isFinite(n) ? n : 0;
}
function formatNumber(n){
  const x = safeNum(n);
  // إزالة أصفار زائدة
  const s = x.toFixed(6);
  return s.replace(/\.?0+$/,"");
}
function getDeviceId(){
  const k = "hs_device_id";
  let v = localStorage.getItem(k);
  if(!v){
    v = "dev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    localStorage.setItem(k, v);
  }
  return v;
}

/* =======================
   Supabase Client
   ======================= */
let client = null;
(function init(){
  try{
    if(!window.supabase || !window.supabase.createClient) throw new Error("supabase not loaded");
    client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    setPill(true, "مفتوح");
  }catch(e){
    console.error(e);
    setPill(false, "مغلق");
  }
})();

/* =======================
   State
   ======================= */
const state = {
  loggedIn: false,
  username: "",
  invoiceOpen: false,
  invoiceId: "",
  buyerName: "",
  ops: [],
  total: 0
};

/* =======================
   Auth (simple)
   ======================= */
async function login(){
  if(!client) return alert("Supabase غير جاهز.");

  const u = ($("loginUser").value || "").trim();
  const p = ($("loginPass").value || "").trim();
  if(!u || !p) return alert("اكتب اسم المستخدم وكلمة السر");

  const { data, error } = await client
    .from("app_users")
    .select("username, pass, blocked")
    .eq("username", u)
    .maybeSingle();

  if(error){
    console.error(error);
    return alert("خطأ اتصال: " + error.message);
  }

  if(!data || !data.username){
    return alert("اسم المستخدم غير صحيح");
  }
  if(String(data.pass || "") !== p){
    return alert("كلمة السر غير صحيحة");
  }
  if(data.blocked){
    return alert("عذراً، حسابك موقوف. راجع الأدمن.");
  }

  state.loggedIn = true;
  state.username = u;
  localStorage.setItem("hs_last_user", u);

  $("whoBadge").textContent = "المستخدم: " + u;
  $("loginCard").classList.add("hidden");
  $("appWrap").classList.remove("hidden");

  $("mini").textContent = "تم تسجيل الدخول ✅";
}

function restoreLastUser(){
  const u = localStorage.getItem("hs_last_user") || "";
  if(u) $("loginUser").value = u;
}
restoreLastUser();

/* =======================
   Invoice
   ======================= */
function lockCalc(lock){
  const kp = $("keypad");
  kp.style.opacity = lock ? "0.55" : "1";
  kp.style.pointerEvents = lock ? "none" : "auto";
}
lockCalc(true);

async function startInvoice(){
  if(!client) return alert("Supabase غير جاهز.");
  if(!state.loggedIn) return alert("سجّل الدخول أولاً.");

  const buyer = ($("buyerName").value || "").trim();
  if(!buyer) return alert("اسم المشتري إجباري");

  // reset local state
  state.ops = [];
  state.total = 0;
  state.buyerName = buyer;

  renderOps();

  // create invoice row
  const payload = {
    username: state.username,
    buyer_name: buyer,
    device_id: getDeviceId(),
    total: 0
  };

  const { data, error } = await client
    .from("app_invoices")
    .insert(payload)
    .select("id, created_at")
    .maybeSingle();

  if(error){
    console.error(error);
    return alert("فشل بدء الفاتورة: " + error.message);
  }

  state.invoiceId = data?.id || "";
  state.invoiceOpen = true;

  $("invBadge").textContent = state.invoiceId ? ("فاتورة مفتوحة: #" + String(state.invoiceId).slice(-6)) : "فاتورة مفتوحة";
  $("btnCloseInvoice").disabled = false;

  // خلال الفاتورة: نسخ/PDF غير إلزامي، نخليهم بعد الإنهاء
  $("btnCopyTable").disabled = true;
  $("btnMakePdf").disabled = true;

  // clear calc
  expr = "";
  $("expr").textContent = "0";
  $("mini").textContent = "فاتورة جديدة بدأت ✅ (اضغط = لتسجيل سطر)";

  lockCalc(false);
  vibrate(22);
}

async function closeInvoice(){
  if(!client) return alert("Supabase غير جاهز.");
  if(!state.invoiceOpen || !state.invoiceId) return alert("لا يوجد فاتورة مفتوحة.");

  if(!confirm("تأكيد إنهاء الفاتورة وحفظها؟")) return;

  // update invoice total فقط (حتى لو أعمدتك أقل)
  const { error } = await client
    .from("app_invoices")
    .update({ total: state.total })
    .eq("id", state.invoiceId)
    .eq("username", state.username);

  if(error){
    console.error(error);
    return alert("فشل إنهاء الفاتورة: " + error.message);
  }

  state.invoiceOpen = false;
  $("invBadge").textContent = "فاتورة مغلقة ✅";
  $("btnCloseInvoice").disabled = true;

  // الآن نفعّل النسخ و PDF
  $("btnCopyTable").disabled = false;
  $("btnMakePdf").disabled = false;

  lockCalc(true);
  $("mini").textContent = "تم إغلاق الفاتورة وحفظها ✅";
  vibrate(30);
}

/* =======================
   Calculator
   ======================= */
let expr = "";

function isAllowedExpr(s){
  // only digits/operators/./spaces/parentheses
  return /^[0-9+\-*/().\s]*$/.test(s);
}
function normalizeExpr(s){
  return s.replace(/×/g,"*").replace(/÷/g,"/").trim();
}
function evalExpr(raw){
  const s = normalizeExpr(raw);
  if(!isAllowedExpr(s)) throw new Error("صيغة غير مسموحة");
  // منع أشياء فارغة أو تنتهي بمشغل
  if(!s || /[+\-*/.]$/.test(s)) throw new Error("أكمل العملية");
  // eslint-disable-next-line no-new-func
  const v = Function("return (" + s + ")")();
  if(!Number.isFinite(v)) throw new Error("نتيجة غير صالحة");
  return v;
}

function setExprUI(){
  $("expr").textContent = expr ? expr : "0";
}

async function addLineFromExpr(){
  if(!state.invoiceOpen || !state.invoiceId) return alert("ابدأ الفاتورة أولاً");

  const raw = expr;
  let result;
  try{
    result = evalExpr(raw);
  }catch(e){
    return alert(e.message || "خطأ بالعملية");
  }

  const note = ($("lineNote").value || "").trim(); // optional
  const row = {
    created_at: nowISO(),
    statement: note,
    operation: raw,
    result: result
  };

  // save to Supabase (كل سطر)
  const payload = {
    username: state.username,
    invoice_id: state.invoiceId,
    statement: note || null,
    operation: raw,
    result: result,
    device_id: getDeviceId()
  };

  const { error } = await client.from("app_operations").insert(payload);
  if(error){
    console.error(error);
    return alert("فشل حفظ السطر: " + error.message);
  }

  // local
  state.ops.push(row);
  state.total = state.ops.reduce((a,b)=>a + safeNum(b.result), 0);

  renderOps();

  // بعد التسجيل: اترك البيان مثل ما هو؟ حسب رغبتك… نخليه يمسح لتسهيل
  $("lineNote").value = "";
  expr = formatNumber(result); // خلي الناتج جاهز لسطر جديد
  setExprUI();

  $("mini").textContent = "تم حفظ السطر ✅";
  vibrate(16);
}

function backspace(){
  expr = expr.slice(0,-1);
  setExprUI();
}
function clearAll(){
  expr = "";
  setExprUI();
}
function toggleNeg(){
  // إذا expr رقم فقط
  const s = normalizeExpr(expr);
  if(!s) return;
  if(/^[0-9.]+$/.test(s)){
    expr = (s.startsWith("-") ? s.slice(1) : "-" + s);
  }else{
    // حول آخر رقم فقط (اختياري)، هنا نبسط: نلف الكل
    expr = "-(" + expr + ")";
  }
  setExprUI();
}
function press(k){
  if(!state.invoiceOpen) return;

  if(k === "C"){ clearAll(); return; }
  if(k === "⌫"){ backspace(); return; }
  if(k === "="){ addLineFromExpr(); return; }
  if(k === "CLRLINE"){ $("lineNote").value = ""; vibrate(10); return; }
  if(k === "NEG"){ toggleNeg(); vibrate(10); return; }

  // prevent double operators
  const last = expr.slice(-1);
  const ops = ["+","-","×","÷","*","/"];
  if(ops.includes(k)){
    if(!expr) return;
    if(ops.includes(last)) expr = expr.slice(0,-1) + k;
    else expr += k;
  }else{
    expr += k;
  }
  setExprUI();
}

/* =======================
   Render table
   ======================= */
function renderOps(){
  const body = $("opsBody");
  body.innerHTML = "";

  state.ops.forEach((r) => {
    const tr = document.createElement("tr");

    const tdT = document.createElement("td");
    tdT.textContent = fmtDateTime(r.created_at);

    const tdS = document.createElement("td");
    tdS.textContent = r.statement || "";

    const tdO = document.createElement("td");
    tdO.style.direction = "ltr";
    tdO.style.textAlign = "left";
    tdO.textContent = r.operation || "";

    const tdR = document.createElement("td");
    tdR.style.direction = "ltr";
    tdR.style.textAlign = "left";
    tdR.textContent = formatNumber(r.result);

    tr.append(tdT, tdS, tdO, tdR);
    body.appendChild(tr);
  });

  $("totalBadge").textContent = "الإجمالي: " + formatNumber(state.total);
  $("rowsBadge").textContent = "السطور: " + state.ops.length;
}

/* =======================
   Copy + PDF
   ======================= */
async function copyTable(){
  if(!state.ops.length) return alert("لا يوجد سطور لنسخها");
  // نص منسق (TSV)
  const lines = [];
  lines.push(["الوقت","البيان","العملية","النتيجة"].join("\t"));
  state.ops.forEach(r=>{
    lines.push([fmtDateTime(r.created_at), (r.statement||""), (r.operation||""), formatNumber(r.result)].join("\t"));
  });
  lines.push("");
  lines.push("تم تطوير الحاسبة من قبل الحايك للحلول الرقمية");

  const txt = lines.join("\n");
  try{
    await navigator.clipboard.writeText(txt);
    alert("تم النسخ ✅");
  }catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    alert("تم النسخ ✅");
  }
  vibrate(14);
}

async function makePdf(){
  if(!state.ops.length) return alert("لا يوجد سطور لتصديرها");
  // جهّز printArea
  const meta =
    `المستخدم: ${state.username}\n` +
    `اسم المشتري: ${state.buyerName}\n` +
    `رقم الفاتورة: ${state.invoiceId ? ("#" + String(state.invoiceId).slice(-6)) : "—"}\n` +
    `التاريخ: ${fmtDateTime(nowISO())}`;

  $("printMeta").textContent = meta;
  $("printTotal").textContent = "الإجمالي: " + formatNumber(state.total);

  // table HTML (احترافي + صفحات)
  const rowsHtml = state.ops.map(r=>{
    return `<tr>
      <td>${fmtDateTime(r.created_at)}</td>
      <td>${(r.statement||"").replace(/</g,"&lt;")}</td>
      <td style="direction:ltr;text-align:left">${(r.operation||"").replace(/</g,"&lt;")}</td>
      <td style="direction:ltr;text-align:left">${formatNumber(r.result)}</td>
    </tr>`;
  }).join("");

  $("printTable").innerHTML = `
    <table>
      <thead>
        <tr>
          <th style="width:22%">الوقت</th>
          <th style="width:38%">البيان</th>
          <th style="width:20%">العملية</th>
          <th style="width:20%">النتيجة</th>
        </tr>
      </thead>
      <tbody>${rowsHtml}</tbody>
    </table>
  `;

  const el = $("printArea");
  el.style.display = "block";

  try{
    const fileName = `invoice_${state.username}_${Date.now()}.pdf`;
    const opt = {
      margin: 8,
      filename: fileName,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
      pagebreak: { mode: ["css","legacy"] }
    };
    await html2pdf().set(opt).from(el).save();
  }catch(e){
    console.error(e);
    alert("فشل تصدير PDF. جرّب متصفح Chrome على الكمبيوتر.");
  }finally{
    el.style.display = "none";
  }

  vibrate(20);
}

/* =======================
   Events
   ======================= */
$("btnLogin").onclick = login;
$("btnStartInvoice").onclick = startInvoice;
$("btnCloseInvoice").onclick = closeInvoice;
$("btnCopyTable").onclick = copyTable;
$("btnMakePdf").onclick = makePdf;

$("keypad").addEventListener("click", (ev)=>{
  const k = ev.target?.getAttribute?.("data-k");
  if(!k) return;
  press(k);
  vibrate(8);
});
</script>

</body>
</html>
