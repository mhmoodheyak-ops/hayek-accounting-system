<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HAYEK SPOT — الفاتورة</title>

  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#071820" />

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script src="./config.js?v=2"></script>
  <script src="./auth.js?v=2"></script>

  <style>
    body{
      margin:0;
      min-height:100vh;
      background:#071820;
      color:#eaf4ff;
      font-family:system-ui,Segoe UI,Arial;
    }
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .btn{border:0;border-radius:14px;padding:12px 16px;font-weight:900;cursor:pointer}
    .btn.pdf{background:#1f62ff;color:#fff}
    .btn.logout{background:#ff6b6b;color:#fff}

    .card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:20px;
      padding:16px;
    }

    input{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(0,0,0,.25);
      color:#fff;
      font-size:16px;
      margin-bottom:10px;
    }

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px dashed rgba(255,255,255,.15)}
    th{background:rgba(255,255,255,.08)}

    .total{
      margin-top:12px;
      border:2px dashed rgba(255,255,255,.2);
      border-radius:14px;
      padding:12px;
      display:flex;
      justify-content:space-between;
      font-size:18px;
      font-weight:900;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <h2>الفاتورة</h2>
    <button class="btn logout" id="logoutBtn">خروج</button>
  </div>

  <div class="card">
    <label>اسم الزبون (إجباري)</label>
    <input id="customer" placeholder="اسم الزبون">

    <label>النص</label>
    <input id="text" placeholder="مثال: مصروف / مواد">

    <label>العملية</label>
    <input id="expr" placeholder="5+5" readonly>

    <div style="margin:10px 0">
      <button class="btn pdf" id="addLine">إضافة سطر</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>الوقت</th>
          <th>البيان</th>
          <th>العملية</th>
          <th>النتيجة</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <div class="total">
      <span>الإجمالي</span>
      <span id="total">0</span>
    </div>

    <div style="margin-top:12px;text-align:center">
      <button class="btn pdf" id="pdfBtn">تصدير PDF</button>
    </div>
  </div>

</div>

<script>
(() => {
  const $ = id => document.getElementById(id);

  if (!window.HAYEK_AUTH || !window.HAYEK_AUTH.isAuthed()) {
    location.href = "index.html";
    return;
  }

  $("logoutBtn").onclick = () => {
    window.HAYEK_AUTH.logout();
    location.href = "index.html";
  };

  const rows = [];
  let total = 0;

  $("addLine").onclick = () => {
    const c = $("customer").value.trim();
    if (!c) { alert("أدخل اسم الزبون"); return; }

    const t = $("text").value.trim();
    const e = $("expr").value.trim() || "0";

    let r = 0;
    try { r = eval(e); } catch { alert("عملية غير صحيحة"); return; }

    rows.push({ time:new Date().toLocaleTimeString(), text:t, expr:e, result:r });
    total += r;

    $("rows").innerHTML = rows.map(x => `
      <tr>
        <td>${x.time}</td>
        <td>${x.text}</td>
        <td>${x.expr}</td>
        <td>${x.result}</td>
      </tr>
    `).join("");

    $("total").textContent = total;
    $("text").value = "";
    $("expr").value = "";
  };

  $("pdfBtn").onclick = () => {
    if (!rows.length) { alert("لا يوجد بيانات"); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:"pt", format:"a4" });

    let y = 50;
    doc.setFontSize(18);
    doc.text("فاتورة", 300, y, { align:"center" });

    y += 30;
    doc.setFontSize(12);
    doc.text("الزبون: " + $("customer").value, 520, y, { align:"right" });
    y += 20;

    rows.forEach(r => {
      if (y > 760) { doc.addPage(); y = 50; }
      doc.text(`${r.time} | ${r.text} | ${r.expr} = ${r.result}`, 50, y);
      y += 16;
    });

    y += 20;
    doc.setFontSize(14);
    doc.text("الإجمالي: " + total, 520, y, { align:"right" });

    doc.save("invoice.pdf");
  };
})();
</script>

</body>
</html>
